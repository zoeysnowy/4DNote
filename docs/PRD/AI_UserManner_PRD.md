# AI UserManner PRD - ç”¨æˆ·è¡Œä¸ºæ¨¡å¼å­¦ä¹ ç³»ç»Ÿ

**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2026-01-10  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ  
**ä¼˜å…ˆçº§**: P1 (é«˜çº§åŠŸèƒ½ï¼ŒPhase 3-4)

---

## ğŸ“‹ ç›®å½•

1. [äº§å“æ¦‚è¿°](#äº§å“æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
4. [åŠŸèƒ½è¯¦ç»†è®¾è®¡](#åŠŸèƒ½è¯¦ç»†è®¾è®¡)
5. [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
6. [ä¸ç°æœ‰æ¨¡å—é›†æˆ](#ä¸ç°æœ‰æ¨¡å—é›†æˆ)
7. [å®æ–½è·¯çº¿](#å®æ–½è·¯çº¿)
8. [é£é™©ä¸æŒ‘æˆ˜](#é£é™©ä¸æŒ‘æˆ˜)
9. [æˆåŠŸæŒ‡æ ‡](#æˆåŠŸæŒ‡æ ‡)

---

## äº§å“æ¦‚è¿°

### 1.1 äº§å“å®šä½

UserManner æ˜¯ 4DNote çš„**è‡ªè¿›åŒ–ç”¨æˆ·æ„å›¾å­¦ä¹ ç³»ç»Ÿ**ï¼Œé€šè¿‡åˆ†æç”¨æˆ·è¡Œä¸º Signalï¼Œè‡ªåŠ¨å½’çº³ä¸ªæ€§åŒ–è¡Œä¸ºæ¨¡å¼ï¼Œå¹¶å°†è¿™äº›æ¨¡å¼åº”ç”¨åˆ°æ‰€æœ‰ AI æ™ºèƒ½æœåŠ¡ä¸­ï¼Œå®ç°**è¶Šç”¨è¶Šæ‡‚ä½ **çš„æ™ºèƒ½ä½“éªŒã€‚

**æ ¸å¿ƒä»·å€¼**:
- ğŸ§  **è‡ªåŠ¨å­¦ä¹ **: AI è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·ä¹ æƒ¯ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
- ğŸ¯ **ä¸ªæ€§åŒ–å†³ç­–**: æ¯ä¸ªç”¨æˆ·çš„ AI æœåŠ¡éƒ½åŸºäºå…¶ç‹¬ç‰¹åå¥½ä¼˜åŒ–
- ğŸ”„ **æŒç»­è¿›åŒ–**: é€šè¿‡åé¦ˆé—­ç¯ï¼Œç³»ç»Ÿè‡ªåŠ¨è°ƒæ•´æƒé‡ï¼Œè¶Šç”¨è¶Šå‡†
- ğŸ” **å¯è§£é‡Šæ€§**: ç”¨æˆ·èƒ½ç†è§£ AI ä¸ºä»€ä¹ˆåšå‡ºæŸä¸ªå†³ç­–
- ğŸ›¡ï¸ **éšç§ä¿æŠ¤**: æ‰€æœ‰å­¦ä¹ æ•°æ®æœ¬åœ°å­˜å‚¨ï¼Œä¸ä¸Šä¼ äº‘ç«¯

### 1.2 äº§å“ç›®æ ‡

| ç›®æ ‡ | æŒ‡æ ‡ | ç°çŠ¶ | ç›®æ ‡å€¼ |
|------|------|------|--------|
| **ä¸ªæ€§åŒ–å‡†ç¡®ç‡** | AI å»ºè®®è¢«ç”¨æˆ·é‡‡çº³çš„æ¯”ä¾‹ | - | >70% |
| **å­¦ä¹ é€Ÿåº¦** | ä»æ³¨å†Œåˆ°å»ºç«‹æœ‰æ•ˆ Manner çš„å¤©æ•° | - | <14å¤© |
| **ç”¨æˆ·æ»¡æ„åº¦** | AI æœåŠ¡ä½“éªŒè¯„åˆ†ï¼ˆ1-5ï¼‰ | - | >4.2 |
| **é€‚åº”æ€§** | æƒé‡è°ƒæ•´å“åº”é€Ÿåº¦ï¼ˆæ¥å—/æ‹’ç»åï¼‰ | - | å®æ—¶æ›´æ–° |
| **å†·å¯åŠ¨æ—¶é—´** | æ–°ç”¨æˆ·é¦–ä¸ª Manner ç”Ÿæˆæ—¶é—´ | - | <7å¤© |

### 1.3 é€‚ç”¨åœºæ™¯

**åœºæ™¯ 1: å†…å®¹åå¥½å­¦ä¹ **
- **ç”¨æˆ·è¡Œä¸º**: æ€»æ˜¯åœ¨ä¼šè®®çºªè¦ä¸­æ ‡è®°è¡ŒåŠ¨é¡¹
- **å­¦ä¹ æ¨¡å¼**: "ä¼šè®®è¡ŒåŠ¨é¡¹åå¥½"
- **è‡ªé€‚åº”å†³ç­–**: TaskManager è‡ªåŠ¨æå–ä¼šè®®ä¸­çš„ TODOï¼Œä¼˜å…ˆçº§æå‡

**åœºæ™¯ 2: æ—¶é—´ä¹ æƒ¯è¯†åˆ«**
- **ç”¨æˆ·è¡Œä¸º**: æ¯æ™š 9 ç‚¹åæ ‡è®°æ˜å¤©çš„ä»»åŠ¡
- **å­¦ä¹ æ¨¡å¼**: "æ™šé—´è§„åˆ’ä¹ æƒ¯"
- **è‡ªé€‚åº”å†³ç­–**: 21:00 åæç¤º"è§„åˆ’æ˜å¤©ä»»åŠ¡"ï¼Œè‡ªåŠ¨è®¾ç½® dueDate ä¸ºæ˜å¤©

**åœºæ™¯ 3: æœç´¢æ¨¡å¼ä¼˜åŒ–**
- **ç”¨æˆ·è¡Œä¸º**: 80% çš„æœç´¢æ˜¯æŠ€æœ¯æ–‡æ¡£ç›¸å…³
- **å­¦ä¹ æ¨¡å¼**: "æŠ€æœ¯å†…å®¹åå¥½"
- **è‡ªé€‚åº”å†³ç­–**: RAG æ£€ç´¢æ—¶ï¼ŒæŠ€æœ¯ç±»ç¬”è®°æƒé‡ +30%

**åœºæ™¯ 4: äº¤äº’é£æ ¼é€‚é…**
- **ç”¨æˆ·è¡Œä¸º**: ç»å¸¸ä¿®æ”¹ AI ç”Ÿæˆçš„å†…å®¹ï¼ˆé«˜ç¼–è¾‘ç‡ï¼‰
- **å­¦ä¹ æ¨¡å¼**: "è¯¦ç»†é¢„è§ˆåå¥½"
- **è‡ªé€‚åº”å†³ç­–**: AI å»ºè®®æ—¶ï¼Œé»˜è®¤æ˜¾ç¤ºè¯¦ç»†é¢„è§ˆè€Œéç›´æ¥æ‰§è¡Œ

**åœºæ™¯ 5: å›¾ç‰‡è´¨é‡åå¥½**
- **ç”¨æˆ·è¡Œä¸º**: å›¾ç‰‡å»é‡æ—¶ï¼Œæ€»æ˜¯ä¿ç•™é«˜åˆ†è¾¨ç‡ç‰ˆæœ¬
- **å­¦ä¹ æ¨¡å¼**: "é«˜åˆ†è¾¨ç‡åå¥½"
- **è‡ªé€‚åº”å†³ç­–**: å›¾ç‰‡è´¨é‡è¯„åˆ†æ—¶ï¼Œåˆ†è¾¨ç‡æƒé‡ +20%

---

## æ ¸å¿ƒæ¦‚å¿µ

### 2.1 æ ¸å¿ƒå·¥ä½œæµ

```
ç”¨æˆ·è¡Œä¸º (Signal)
    â†“ èšåˆåˆ†æ
UserMannerAgent (AI æ¨¡å¼æŒ–æ˜)
    â†“ å½’çº³æ¨¡å¼
UserManner (è¡Œä¸ºæ¨¡å¼æŠ½è±¡)
    â†“ åº”ç”¨æƒé‡
æ™ºèƒ½æœåŠ¡å†³ç­– (ChatFlow/NotesManager/TaskManager/MediaManager)
    â†“ ç”¨æˆ·åé¦ˆ
UserMannerEvaluator (è‡ªåŠ¨è¯„ä¼°)
    â†“ æƒé‡è°ƒæ•´
æ›´æ–° UserManner.decisionWeight
    â†“ å¾ªç¯è¿­ä»£
æŒç»­ä¼˜åŒ–å†³ç­–
```

### 2.2 å…³é”®æ¦‚å¿µå®šä¹‰

#### UserMannerï¼ˆç”¨æˆ·è¡Œä¸ºæ¨¡å¼ï¼‰

**å®šä¹‰**: ä»ç”¨æˆ· Signal ä¸­å½’çº³å‡ºçš„ç¨³å®šè¡Œä¸ºæ¨¡å¼ï¼ŒåŒ…å«è§¦å‘æ¡ä»¶ã€æ‰€éœ€æ•°æ®ã€ç›®æ ‡æœåŠ¡ã€å†³ç­–æƒé‡ã€‚

**ç¤ºä¾‹**:
```json
{
  "name": "ä¼šè®®çºªè¦è¡ŒåŠ¨é¡¹åå¥½",
  "description": "ç”¨æˆ·åœ¨ä¼šè®®çºªè¦ä¸­é«˜é¢‘æ ‡è®°è¡ŒåŠ¨é¡¹ï¼Œå€¾å‘äºç«‹å³æå– TODO",
  "category": "content_preference",
  "triggerPattern": {
    "signalTypes": ["highlight", "action_item"],
    "contextFilters": { "eventTypes": ["meeting_notes"] },
    "minOccurrence": 10
  },
  "targetServices": [
    { "service": "TaskManager", "actions": ["auto_extract_tasks"] }
  ],
  "decisionWeight": 0.85,
  "confidence": 0.92
}
```

#### UserMannerCategoryï¼ˆæ¨¡å¼åˆ†ç±»ï¼‰

| åˆ†ç±» | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `content_preference` | å†…å®¹åå¥½ | å–œæ¬¢æŠ€æœ¯æ–‡æ¡£ã€ä¼šè®®çºªè¦ |
| `time_preference` | æ—¶é—´åå¥½ | æ™šé—´è§„åˆ’ã€æ—©æ™¨å›é¡¾ |
| `interaction_style` | äº¤äº’é£æ ¼ | å–œæ¬¢é«˜äº®ã€å–œæ¬¢é—®ç­”ã€è¯¦ç»†é¢„è§ˆ |
| `organization_habit` | ç»„ç»‡ä¹ æƒ¯ | å–œæ¬¢æ ‡ç­¾ã€å–œæ¬¢åˆ†ç±» |
| `search_pattern` | æœç´¢æ¨¡å¼ | å…³é”®è¯ vs è¯­ä¹‰æœç´¢ |
| `decision_style` | å†³ç­–é£æ ¼ | å¿«é€Ÿç¡®è®¤ vs è¯¦ç»†é¢„è§ˆ |

#### Decision Weightï¼ˆå†³ç­–æƒé‡ï¼‰

**å®šä¹‰**: 0-1 çš„æ•°å€¼ï¼Œè¡¨ç¤ºè¯¥ UserManner å¯¹å†³ç­–çš„å½±å“å¼ºåº¦ã€‚

**æƒé‡è§£é‡Š**:
- `0.0 - 0.3`: ä½ç½®ä¿¡åº¦ï¼Œä»…ä½œä¸ºè¾…åŠ©å‚è€ƒ
- `0.3 - 0.7`: ä¸­ç­‰ç½®ä¿¡åº¦ï¼Œé€‚åº¦å½±å“å†³ç­–
- `0.7 - 1.0`: é«˜ç½®ä¿¡åº¦ï¼Œæ˜¾è‘—å½±å“å†³ç­–

**æ›´æ–°æœºåˆ¶**: æŒ‡æ•°ç§»åŠ¨å¹³å‡ï¼ˆEMAï¼‰
```typescript
newWeight = oldWeight * (1 - Î±) + score * Î±
// Î± = 0.2 (å­¦ä¹ ç‡)
```

### 2.3 åé¦ˆé—­ç¯æœºåˆ¶

#### éšå¼åé¦ˆï¼ˆæ¨èï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰

| ç”¨æˆ·è¡Œä¸º | åé¦ˆç±»å‹ | è¯„åˆ† | è¯´æ˜ |
|---------|---------|------|------|
| æ¥å— AI å»ºè®® | `accept` | 1.0 | ç”¨æˆ·ç‚¹å‡»"åº”ç”¨"æˆ–"ç¡®è®¤" |
| ä¿®æ”¹åæ¥å— | `modify` | 0.7 | ç”¨æˆ·ä¿®æ”¹ AI ç”Ÿæˆå†…å®¹åä¿å­˜ |
| å¿½ç•¥å»ºè®® | `ignore` | 0.3 | ç”¨æˆ·æœªæ“ä½œï¼Œå»ºè®®è¶…æ—¶å…³é—­ |
| åˆ é™¤ AI å†…å®¹ | `reject` | 0.0 | ç”¨æˆ·åˆ é™¤ AI åˆ›å»ºçš„ Event/Task |

#### æ˜¾å¼åé¦ˆï¼ˆå¯é€‰ï¼Œç”¨æˆ·ä¸»åŠ¨è¯„ä»·ï¼‰

```typescript
// UI ç¤ºä¾‹
<AISuggestion>
  <Content>{suggestion.text}</Content>
  <FeedbackButtons>
    <ThumbsUp onClick={() => feedback('positive')} />  // è¯„åˆ†: 1.0
    <ThumbsDown onClick={() => feedback('negative')} />  // è¯„åˆ†: 0.0
  </FeedbackButtons>
</AISuggestion>
```

---

## æ¶æ„è®¾è®¡

### 3.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Data Collection Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Signal     â”‚  â”‚   Event      â”‚  â”‚  Interaction â”‚  â”‚
â”‚  â”‚   Capture    â”‚  â”‚   Tracking   â”‚  â”‚   Logging    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Raw Data
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Pattern Mining Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            UserMannerAgent (AI)                   â”‚  â”‚
â”‚  â”‚  â€¢ Signal èšåˆåˆ†æ                                â”‚  â”‚
â”‚  â”‚  â€¢ LLM æ¨¡å¼è¯†åˆ«                                   â”‚  â”‚
â”‚  â”‚  â€¢ ç›¸ä¼¼æ¨¡å¼åˆå¹¶                                   â”‚  â”‚
â”‚  â”‚  â€¢ UserManner åˆ›å»º                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ UserManner
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ChatFlow  â”‚  â”‚NotesManagerâ”‚ â”‚TaskManagerâ”‚ â”‚Media    â”‚â”‚
â”‚  â”‚Agent     â”‚  â”‚Agent       â”‚ â”‚Agent      â”‚ â”‚Manager  â”‚â”‚
â”‚  â”‚          â”‚  â”‚            â”‚ â”‚           â”‚ â”‚Agent    â”‚â”‚
â”‚  â”‚åº”ç”¨æƒé‡  â”‚  â”‚åº”ç”¨æƒé‡    â”‚ â”‚åº”ç”¨æƒé‡   â”‚ â”‚åº”ç”¨æƒé‡ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ User Feedback
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Evaluation Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          UserMannerEvaluator                      â”‚  â”‚
â”‚  â”‚  â€¢ éšå¼åé¦ˆé‡‡é›†                                   â”‚  â”‚
â”‚  â”‚  â€¢ æ˜¾å¼åé¦ˆè®°å½•                                   â”‚  â”‚
â”‚  â”‚  â€¢ æƒé‡è‡ªé€‚åº”è°ƒæ•´                                 â”‚  â”‚
â”‚  â”‚  â€¢ ä½æ•ˆæ¨¡å¼åºŸå¼ƒ                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Weight Update
                         â–¼
                  Update UserManner
                         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”
                                â”‚ Feedback Loop
                                â””â”€â”€â–º (å¾ªç¯)
```

### 3.2 æ¨¡å—èŒè´£

#### UserMannerServiceï¼ˆæ ¸å¿ƒæœåŠ¡ï¼‰

**èŒè´£**: UserManner çš„ CRUD å’ŒæŸ¥è¯¢

**æ¥å£**:
```typescript
class UserMannerService {
  // CRUD
  static async create(data: Partial<UserManner>): Promise<UserManner>;
  static async get(id: string): Promise<UserManner | null>;
  static async update(id: string, data: Partial<UserManner>): Promise<void>;
  static async delete(id: string): Promise<void>;
  
  // æŸ¥è¯¢
  static async getActiveManners(userId: string, filters?: {
    targetService?: string;
    category?: UserMannerCategory;
    minWeight?: number;
  }): Promise<UserManner[]>;
  
  static async getAll(userId: string): Promise<UserManner[]>;
  
  // åº”ç”¨æ—¥å¿—
  static async logApplication(
    mannerId: string,
    context: { appliedTo: string; service: string; action: string }
  ): Promise<void>;
}
```

**Single Writer**: åªæœ‰ `UserMannerService` èƒ½å†™å…¥ `user_manners` è¡¨ï¼ˆç¬¦åˆ SSOTï¼‰

#### UserMannerAgentï¼ˆAI æ¨¡å¼æŒ–æ˜ï¼‰

**èŒè´£**: ä» Signal ä¸­è‡ªåŠ¨å½’çº³ UserManner

**å·¥ä½œæµ**:
```typescript
class UserMannerAgent {
  /**
   * å®šæœŸåˆ†æ Signal æ•°æ®ï¼Œå½’çº³æ–°çš„ UserManner
   * 
   * è§¦å‘æ—¶æœº: 
   * - æ¯å‘¨è‡ªåŠ¨è¿è¡Œ
   * - ç§¯ç´¯ 100 æ¡æ–° Signal å
   * - ç”¨æˆ·ä¸»åŠ¨è¯·æ±‚
   */
  async mineUserManners(userId: string): Promise<UserManner[]> {
    // 1. è·å–è¿‘æœŸ Signal æ•°æ® (30å¤©)
    const signals = await SignalService.getRecentSignals(userId, { days: 30 });
    
    // 2. èšåˆåˆ†æ
    const aggregated = this.aggregateSignals(signals);
    // ç¤ºä¾‹è¾“å‡º: { 
    //   highlightInMeetings: 45æ¬¡, 
    //   questionInTechDocs: 32æ¬¡,
    //   actionItemAt21h: 28æ¬¡ 
    // }
    
    // 3. LLM æ¨¡å¼è¯†åˆ«
    const patterns = await this.llm.chat({
      model: 'gpt-4',
      prompt: `
åˆ†æä»¥ä¸‹ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œè¯†åˆ«æ˜æ˜¾çš„è¡Œä¸ºæ¨¡å¼...
${JSON.stringify(aggregated, null, 2)}
`,
      responseFormat: 'json'
    });
    
    // 4. éªŒè¯å¹¶åˆ›å»º UserManner
    const newManners: UserManner[] = [];
    for (const pattern of patterns) {
      if (pattern.confidence < 0.7) continue;  // ä½ç½®ä¿¡åº¦è·³è¿‡
      
      const existing = await this.findSimilarManner(pattern);
      if (existing) {
        await this.mergeManner(existing, pattern);
      } else {
        const manner = await UserMannerService.create({
          ...pattern,
          userId,
          decisionWeight: 0.5,  // åˆå§‹æƒé‡
          status: 'learning'    // å­¦ä¹ é˜¶æ®µ
        });
        newManners.push(manner);
      }
    }
    
    return newManners;
  }
}
```

#### UserMannerEvaluatorï¼ˆè‡ªåŠ¨è¯„ä¼°ï¼‰

**èŒè´£**: è¯„ä¼° UserManner æ•ˆæœï¼Œè‡ªé€‚åº”è°ƒæ•´æƒé‡

**æ ¸å¿ƒç®—æ³•**:
```typescript
class UserMannerEvaluator {
  /**
   * è¯„ä¼°å•æ¬¡ UserManner åº”ç”¨æ•ˆæœ
   */
  async evaluateApplication(
    mannerId: string,
    applicationContext: {
      appliedTo: string;
      userAction: 'accept' | 'reject' | 'modify' | 'ignore';
      timestamp: string;
    }
  ): Promise<void> {
    const manner = await UserMannerService.get(mannerId);
    
    // 1. è®¡ç®—æœ¬æ¬¡è¯„åˆ†
    const score = this.calculateScore(applicationContext.userAction);
    
    // 2. æŒ‡æ•°ç§»åŠ¨å¹³å‡æ›´æ–°æƒé‡
    const alpha = 0.2;  // å­¦ä¹ ç‡
    const newWeight = manner.decisionWeight * (1 - alpha) + score * alpha;
    
    // 3. è®°å½•è¯„ä¼°å†å²
    await UserMannerService.update(mannerId, {
      decisionWeight: newWeight,
      evaluationHistory: [
        ...manner.evaluationHistory,
        {
          timestamp: applicationContext.timestamp,
          appliedTo: applicationContext.appliedTo,
          userFeedback: this.mapActionToFeedback(applicationContext.userAction),
          score,
          adjustedWeight: newWeight
        }
      ]
    });
    
    // 4. æ£€æŸ¥æ˜¯å¦éœ€è¦é™çº§/åºŸå¼ƒ
    if (newWeight < 0.2 && manner.stats.totalApplications > 20) {
      await UserMannerService.update(mannerId, { status: 'deprecated' });
    } else if (newWeight > 0.8 && manner.stats.totalApplications > 10) {
      await UserMannerService.update(mannerId, { status: 'active' });
    }
  }
  
  private calculateScore(action: string): number {
    switch (action) {
      case 'accept': return 1.0;
      case 'modify': return 0.7;
      case 'ignore': return 0.3;
      case 'reject': return 0.0;
      default: return 0.5;
    }
  }
}
```

---

## åŠŸèƒ½è¯¦ç»†è®¾è®¡

### 4.1 Feature 1: AI æ¨¡å¼æŒ–æ˜

**åŠŸèƒ½æè¿°**: è‡ªåŠ¨ä» Signal æ•°æ®ä¸­è¯†åˆ«ç”¨æˆ·è¡Œä¸ºæ¨¡å¼

**è§¦å‘æ¡ä»¶**:
- æ¯å‘¨æ—¥ å‡Œæ™¨ 2:00 è‡ªåŠ¨è¿è¡Œ
- æ–°å¢ Signal æ•°é‡ >= 100 æ¡
- ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ï¼š"åˆ†ææˆ‘çš„ä½¿ç”¨ä¹ æƒ¯"

**ç®—æ³•æµç¨‹**:

```typescript
// 1. Signal èšåˆ
const aggregated = signals.reduce((acc, signal) => {
  const key = `${signal.type}_${getEventType(signal.eventId)}_${getTimeSlot(signal.timestamp)}`;
  acc[key] = (acc[key] || 0) + 1;
  return acc;
}, {});

// 2. è¿‡æ»¤é«˜é¢‘æ¨¡å¼ï¼ˆè‡³å°‘ 10 æ¬¡ï¼‰
const highFreq = Object.entries(aggregated).filter(([_, count]) => count >= 10);

// 3. LLM æ¨¡å¼è¯†åˆ«
const prompt = `
åˆ†æä»¥ä¸‹ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œè¯†åˆ« 3-5 ä¸ªæœ€æ˜æ˜¾çš„è¡Œä¸ºæ¨¡å¼ï¼š

${highFreq.map(([pattern, count]) => `- ${pattern}: ${count}æ¬¡`).join('\n')}

è¦æ±‚ï¼š
1. æ¨¡å¼åç§°ç®€æ´æ¸…æ™°ï¼ˆå¦‚"ä¼šè®®è¡ŒåŠ¨é¡¹åå¥½"ï¼‰
2. è¯´æ˜è§¦å‘æ¡ä»¶ï¼ˆSignal ç±»å‹ + ä¸Šä¸‹æ–‡è¿‡æ»¤ï¼‰
3. æ¨æ–­ç”¨æˆ·æ„å›¾ï¼ˆä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿï¼‰
4. æ¨èå…³è”çš„æ™ºèƒ½æœåŠ¡ï¼ˆChatFlow/TaskManager/NotesManager/MediaManagerï¼‰
5. ç½®ä¿¡åº¦è¯„ä¼°ï¼ˆ0-1ï¼‰

è¾“å‡º JSON æ ¼å¼ã€‚
`;

const patterns = await llm.chat({ prompt, responseFormat: 'json' });
```

**è¾“å‡ºç¤ºä¾‹**:
```json
[
  {
    "name": "ä¼šè®®çºªè¦è¡ŒåŠ¨é¡¹åå¥½",
    "description": "ç”¨æˆ·åœ¨ä¼šè®®çºªè¦ä¸­é«˜é¢‘æ ‡è®°è¡ŒåŠ¨é¡¹ï¼Œå€¾å‘äºç«‹å³æå– TODO",
    "category": "content_preference",
    "triggerPattern": {
      "signalTypes": ["highlight", "action_item"],
      "contextFilters": { "eventTypes": ["meeting_notes"] },
      "minOccurrence": 10
    },
    "targetServices": [
      { "service": "TaskManager", "actions": ["auto_extract_tasks", "priority_boost"] }
    ],
    "confidence": 0.92
  }
]
```

**é˜²æ­¢è¯¯åˆ¤**:
- æœ€å°æ ·æœ¬é‡: 10 æ¬¡
- ç½®ä¿¡åº¦é˜ˆå€¼: 0.7
- ç›¸ä¼¼æ¨¡å¼åˆå¹¶ï¼ˆé¿å…é‡å¤ï¼‰

### 4.2 Feature 2: ChatFlow é›†æˆ

**åŠŸèƒ½æè¿°**: åœ¨å¤šè½®å¯¹è¯ä¸­åº”ç”¨ UserManner æƒé‡

**åº”ç”¨åœºæ™¯**:

**åœºæ™¯ A: RAG æ£€ç´¢æƒé‡è°ƒæ•´**
```typescript
class ChatFlowAgent {
  async answer(query: string, userId: string) {
    // 1. è·å–ç”¨æˆ·çš„ UserManner
    const manners = await UserMannerService.getActiveManners(userId, {
      targetService: 'ChatFlow',
      category: 'content_preference',
      minWeight: 0.5
    });
    
    // 2. RAG æ£€ç´¢
    let ragResults = await RAGIndexService.search(query, { topK: 20 });
    
    // 3. åº”ç”¨ UserManner æƒé‡
    if (manners.length > 0) {
      ragResults = ragResults.map(chunk => {
        let adjustedScore = chunk.score;
        
        for (const manner of manners) {
          // æ£€æŸ¥æ˜¯å¦åŒ¹é…è§¦å‘æ¡ä»¶
          if (this.matchesTriggerPattern(chunk, manner)) {
            // æƒé‡åŠ æˆ: adjustedScore *= (1 + weight * 0.5)
            adjustedScore *= (1 + manner.decisionWeight * 0.5);
          }
        }
        
        return { ...chunk, score: adjustedScore };
      }).sort((a, b) => b.score - a.score);
    }
    
    // 4. ç”Ÿæˆå›ç­”
    const answer = await this.llm.chat({
      prompt: this.buildPrompt(query, ragResults)
    });
    
    // 5. è®°å½•åº”ç”¨ï¼ˆç”¨äºåç»­è¯„ä¼°ï¼‰
    for (const manner of manners) {
      await UserMannerService.logApplication(manner.id, {
        appliedTo: conversationId,
        service: 'ChatFlow',
        action: 'rag_rerank'
      });
    }
    
    return answer;
  }
}
```

**ç¤ºä¾‹æ•ˆæœ**:
- ç”¨æˆ· A ç»å¸¸æœç´¢æŠ€æœ¯æ–‡æ¡£ â†’ æŠ€æœ¯ç±»ç¬”è®°æƒé‡ +30%
- ç”¨æˆ· B ç»å¸¸æœç´¢ä¼šè®®çºªè¦ â†’ ä¼šè®®ç±»ç¬”è®°æƒé‡ +30%
- åŒæ ·çš„é—®é¢˜ï¼Œä¸åŒç”¨æˆ·å¾—åˆ°ä¸åŒçš„æ£€ç´¢ç»“æœ

**åœºæ™¯ B: LLM å‚æ•°è‡ªé€‚åº”**
```typescript
// æ ¹æ® UserManner åŠ¨æ€è°ƒæ•´ temperature
private getAdaptiveTemperature(manners: UserManner[]): number {
  const creativityManner = manners.find(m => 
    m.category === 'interaction_style' && m.name.includes('åˆ›æ„')
  );
  
  return creativityManner && creativityManner.decisionWeight > 0.7
    ? 0.9  // é«˜åˆ›æ„ç”¨æˆ·ï¼šæé«˜ temperature
    : 0.3; // ç²¾ç¡®ç”¨æˆ·ï¼šé™ä½ temperature
}
```

### 4.3 Feature 3: TaskManager é›†æˆ

**åŠŸèƒ½æè¿°**: æ ¹æ®ç”¨æˆ·ä¹ æƒ¯è‡ªåŠ¨æå–/ä¼˜å…ˆçº§è°ƒæ•´ä»»åŠ¡

**åœºæ™¯ A: è‡ªåŠ¨æå– vs é¢„è§ˆç¡®è®¤**
```typescript
class TaskExtractionAgent {
  async extractTasks(event: Event, userId: string) {
    // 1. è·å–ç›¸å…³ UserManner
    const manners = await UserMannerService.getActiveManners(userId, {
      targetService: 'TaskManager',
      category: 'decision_style'
    });
    
    // 2. æ£€æŸ¥æ˜¯å¦æœ‰"è‡ªåŠ¨æå–ä»»åŠ¡"çš„åå¥½
    const autoExtractManner = manners.find(m => 
      m.targetServices.some(s => s.actions.includes('auto_extract_tasks'))
    );
    
    if (autoExtractManner && autoExtractManner.decisionWeight > 0.7) {
      // ç”¨æˆ·ä¹ æƒ¯è‡ªåŠ¨æå–ï¼Œç›´æ¥æ‰§è¡Œ
      const tasks = await this.llm.extractTasks(event.content);
      await TaskService.batchCreate(tasks);
      
      // è®°å½•åº”ç”¨
      await this.evaluateMannerApplication(autoExtractManner, tasks);
    } else {
      // ç”¨æˆ·ä¹ æƒ¯æ‰‹åŠ¨ç¡®è®¤ï¼Œæ˜¾ç¤ºé¢„è§ˆ
      const tasks = await this.llm.extractTasks(event.content);
      await this.showConfirmationDialog(tasks);
    }
  }
}
```

**åœºæ™¯ B: ä¼˜å…ˆçº§æ™ºèƒ½è°ƒæ•´**
```typescript
// ç”¨æˆ·æ€»æ˜¯åœ¨ä¼šè®®ä¸­æ ‡è®°çš„ä»»åŠ¡è®¾ç½®ä¸ºé«˜ä¼˜å…ˆçº§
if (manner.name === 'ä¼šè®®è¡ŒåŠ¨é¡¹åå¥½' && event.type === 'meeting_notes') {
  task.priority = 'high';  // è‡ªåŠ¨æå‡ä¼˜å…ˆçº§
}
```

### 4.4 Feature 4: NotesManager é›†æˆ

**åŠŸèƒ½æè¿°**: æ™ºèƒ½å†…å®¹æ’å…¥æ—¶ï¼Œæ ¹æ®ç”¨æˆ·åå¥½é€‰æ‹©ç›®æ ‡æ–‡æ¡£

**åœºæ™¯: æ™ºèƒ½æ’å…¥ç›®æ ‡é€‰æ‹©**
```typescript
class SmartContentInsertionAgent {
  async findBestInsertionTarget(content: string, userId: string) {
    // 1. RAG å…¨å±€æ£€ç´¢ Top 10
    const candidates = await RAGIndexService.search(content, { topK: 10 });
    
    // 2. è·å–ç”¨æˆ·çš„æ–‡æ¡£ç±»å‹åå¥½
    const manners = await UserMannerService.getActiveManners(userId, {
      category: 'content_preference'
    });
    
    // 3. åº”ç”¨åå¥½æƒé‡
    const scored = candidates.map(doc => {
      let score = doc.relevance;
      
      // å¦‚æœç”¨æˆ·åå¥½æŠ€æœ¯æ–‡æ¡£ï¼ŒæŠ€æœ¯ç±»æ–‡æ¡£å¾—åˆ† +30%
      if (doc.tags.includes('æŠ€æœ¯') && this.hasTechPreference(manners)) {
        score *= 1.3;
      }
      
      return { ...doc, score };
    }).sort((a, b) => b.score - a.score);
    
    return scored.slice(0, 3);  // Top 3 å€™é€‰
  }
}
```

### 4.5 Feature 5: MediaManager é›†æˆ

**åŠŸèƒ½æè¿°**: å›¾ç‰‡å»é‡æ—¶ï¼Œæ ¹æ®ç”¨æˆ·åå¥½é€‰æ‹©ä¿ç•™ç‰ˆæœ¬

**åœºæ™¯: å›¾ç‰‡è´¨é‡è¯„åˆ†ä¸ªæ€§åŒ–**
```typescript
class SmartMediaDeduplicationAgent {
  async evaluateImageQuality(image: MediaArtifact, userId: string) {
    // åŸºç¡€è¯„åˆ†
    let score = 0.5;
    
    // åˆ†è¾¨ç‡è¯„åˆ†
    const resolutionScore = this.calculateResolutionScore(image.width, image.height);
    
    // è·å–ç”¨æˆ·çš„å›¾ç‰‡åå¥½
    const manners = await UserMannerService.getActiveManners(userId, {
      category: 'content_preference',
      targetService: 'MediaManager'
    });
    
    // æ ¹æ®ç”¨æˆ·åå¥½è°ƒæ•´æƒé‡
    const resolutionPreference = manners.find(m => 
      m.name.includes('é«˜åˆ†è¾¨ç‡')
    );
    
    if (resolutionPreference) {
      // ç”¨æˆ·åå¥½é«˜åˆ†è¾¨ç‡ï¼Œåˆ†è¾¨ç‡æƒé‡ +20%
      const resolutionWeight = 0.4 + resolutionPreference.decisionWeight * 0.2;
      score = resolutionScore * resolutionWeight + otherScores * (1 - resolutionWeight);
    }
    
    return score;
  }
}
```

### 4.6 Feature 6: ç”¨æˆ·ç®¡ç†ç•Œé¢

**ç•Œé¢åŸå‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ§  æˆ‘çš„ä½¿ç”¨ä¹ æƒ¯                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  ğŸ“Š å·²å­¦ä¹ åˆ° 5 ä¸ªè¡Œä¸ºæ¨¡å¼                                â”‚
â”‚  ğŸ“… ä¸Šæ¬¡åˆ†æ: 2026-01-08                                 â”‚
â”‚  [ğŸ”„ é‡æ–°åˆ†æ]  [â• æ‰‹åŠ¨æ·»åŠ ]  [âš™ï¸ è®¾ç½®]                 â”‚
â”‚                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€ ä¼šè®®çºªè¦è¡ŒåŠ¨é¡¹åå¥½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” ğŸŸ¢ æ´»è·ƒ      â”‚
â”‚  â”‚  ğŸ“ å†…å®¹åå¥½  |  ğŸ“Š ç½®ä¿¡åº¦: 92%  |  âš–ï¸ æƒé‡: 0.85   â”‚
â”‚  â”‚                                                      â”‚
â”‚  â”‚  ğŸ“ è§¦å‘æ¡ä»¶: åœ¨ä¼šè®®çºªè¦ä¸­æ ‡è®°è¡ŒåŠ¨é¡¹                 â”‚
â”‚  â”‚  ğŸ¯ åº”ç”¨åˆ°: TaskManager (è‡ªåŠ¨æå–ä»»åŠ¡)               â”‚
â”‚  â”‚  ğŸ“ˆ æˆåŠŸç‡: 87% (åº”ç”¨ 45 æ¬¡)                         â”‚
â”‚  â”‚                                                      â”‚
â”‚  â”‚  ğŸ’¡ è¯´æ˜: æ‚¨ç»å¸¸åœ¨ä¼šè®®è®°å½•ä¸­æ ‡è®°å¾…åŠäº‹é¡¹ï¼Œç³»ç»Ÿä¼š     â”‚
â”‚  â”‚           è‡ªåŠ¨å¸®æ‚¨æå–ä¸ºä»»åŠ¡ï¼Œå¹¶æå‡ä¼˜å…ˆçº§           â”‚
â”‚  â”‚                                                      â”‚
â”‚  â”‚  [ğŸ“Š æŸ¥çœ‹å†å²]  [âœï¸ ç¼–è¾‘]  [ğŸ—‘ï¸ åˆ é™¤]                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                          â”‚
â”‚  â”Œâ”€ æŠ€æœ¯å†…å®¹åå¥½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” ğŸŸ¢ æ´»è·ƒ      â”‚
â”‚  â”‚  ğŸ“š æœç´¢æ¨¡å¼  |  ğŸ“Š ç½®ä¿¡åº¦: 88%  |  âš–ï¸ æƒé‡: 0.78   â”‚
â”‚  â”‚                                                      â”‚
â”‚  â”‚  ğŸ“ è§¦å‘æ¡ä»¶: 80% çš„æœç´¢æ¶‰åŠæŠ€æœ¯æ–‡æ¡£                 â”‚
â”‚  â”‚  ğŸ¯ åº”ç”¨åˆ°: ChatFlow (RAG æ£€ç´¢æƒé‡è°ƒæ•´)              â”‚
â”‚  â”‚  ğŸ“ˆ æˆåŠŸç‡: 82% (åº”ç”¨ 67 æ¬¡)                         â”‚
â”‚  â”‚                                                      â”‚
â”‚  â”‚  ğŸ’¡ è¯´æ˜: æ‚¨åå¥½æŠ€æœ¯ç±»å†…å®¹ï¼Œæœç´¢æ—¶æŠ€æœ¯ç¬”è®°ä¼š         â”‚
â”‚  â”‚           ä¼˜å…ˆå±•ç¤º                                   â”‚
â”‚  â”‚                                                      â”‚
â”‚  â”‚  [ğŸ“Š æŸ¥çœ‹å†å²]  [âœï¸ ç¼–è¾‘]  [ğŸ—‘ï¸ åˆ é™¤]                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                          â”‚
â”‚  â”Œâ”€ æ™šé—´è§„åˆ’ä¹ æƒ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” ğŸŸ¡ å­¦ä¹ ä¸­    â”‚
â”‚  â”‚  â° æ—¶é—´åå¥½  |  ğŸ“Š ç½®ä¿¡åº¦: 65%  |  âš–ï¸ æƒé‡: 0.52   â”‚
â”‚  â”‚                                                      â”‚
â”‚  â”‚  ğŸ“ è§¦å‘æ¡ä»¶: 21:00 åæ ‡è®°æ˜å¤©ä»»åŠ¡                   â”‚
â”‚  â”‚  ğŸ¯ åº”ç”¨åˆ°: TaskManager (dueDate è‡ªåŠ¨è®¾ç½®æ˜å¤©)       â”‚
â”‚  â”‚  ğŸ“ˆ æˆåŠŸç‡: 68% (åº”ç”¨ 12 æ¬¡)                         â”‚
â”‚  â”‚                                                      â”‚
â”‚  â”‚  ğŸ’¡ è¯´æ˜: ç³»ç»Ÿä»åœ¨å­¦ä¹ æ‚¨çš„æ™šé—´è§„åˆ’ä¹ æƒ¯ï¼Œéœ€è¦æ›´       â”‚
â”‚  â”‚           å¤šæ•°æ®æ‰èƒ½ç¨³å®šç”Ÿæ•ˆ                         â”‚
â”‚  â”‚                                                      â”‚
â”‚  â”‚  [ğŸ“Š æŸ¥çœ‹å†å²]  [âœï¸ ç¼–è¾‘]  [ğŸ—‘ï¸ åˆ é™¤]                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½**:
- âœ… æŸ¥çœ‹æ‰€æœ‰ UserManner
- âœ… æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡ï¼ˆæˆåŠŸç‡ã€åº”ç”¨æ¬¡æ•°ã€æƒé‡å˜åŒ–æ›²çº¿ï¼‰
- âœ… æ‰‹åŠ¨ç¼–è¾‘/åˆ é™¤ Manner
- âœ… æ‰‹åŠ¨è§¦å‘é‡æ–°åˆ†æ
- âœ… å¯¼å…¥/å¯¼å‡º Mannerï¼ˆè¿ç§»è®¾å¤‡æ—¶ï¼‰

---

## æ•°æ®æ¨¡å‹

### 5.1 user_manners è¡¨

```sql
CREATE TABLE user_manners (
  id TEXT PRIMARY KEY,              -- manner_${nanoid()}
  user_id TEXT NOT NULL,            -- FK â†’ users.id
  name TEXT NOT NULL,               -- "ä¼šè®®çºªè¦è¡ŒåŠ¨é¡¹åå¥½"
  description TEXT,                 -- AI ç”Ÿæˆçš„è§£é‡Š
  category TEXT NOT NULL,           -- content_preference / time_preference / ...
  trigger_pattern JSON NOT NULL,    -- è§¦å‘æ¡ä»¶
  required_data_schema JSON,        -- æ‰€éœ€æ•°æ®ç±»å‹
  target_services JSON NOT NULL,    -- å…³è”æœåŠ¡
  decision_weight REAL DEFAULT 0.5, -- å†³ç­–æƒé‡ (0-1)
  confidence REAL DEFAULT 0.5,      -- æ¨¡å¼ç½®ä¿¡åº¦ (0-1)
  evaluation_history JSON,          -- è¯„ä¼°å†å²
  status TEXT DEFAULT 'learning',   -- active / learning / deprecated
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  created_by TEXT NOT NULL,         -- ai / user
  last_applied_at TEXT,             -- ä¸Šæ¬¡åº”ç”¨æ—¶é—´
  stats JSON                        -- ç»Ÿè®¡æ•°æ®
);

CREATE INDEX idx_user_manners_user_status ON user_manners(user_id, status);
CREATE INDEX idx_user_manners_category ON user_manners(category);
CREATE INDEX idx_user_manners_weight ON user_manners(decision_weight DESC);
```

### 5.2 manner_applications è¡¨ï¼ˆåº”ç”¨æ—¥å¿—ï¼‰

```sql
CREATE TABLE manner_applications (
  id TEXT PRIMARY KEY,              -- app_${nanoid()}
  manner_id TEXT NOT NULL,          -- FK â†’ user_manners.id
  applied_to TEXT NOT NULL,         -- åº”ç”¨åˆ°çš„å¯¹è±¡ ID
  service TEXT NOT NULL,            -- ChatFlow / TaskManager / ...
  action TEXT NOT NULL,             -- rag_rerank / auto_extract_tasks / ...
  user_feedback TEXT,               -- positive / negative / neutral
  score REAL,                       -- 0-1
  timestamp TEXT NOT NULL,
  context JSON                      -- é¢å¤–ä¸Šä¸‹æ–‡æ•°æ®
);

CREATE INDEX idx_manner_apps_manner ON manner_applications(manner_id);
CREATE INDEX idx_manner_apps_timestamp ON manner_applications(timestamp DESC);
CREATE INDEX idx_manner_apps_service ON manner_applications(service);
```

### 5.3 TypeScript Interface

```typescript
interface UserManner {
  id: string;
  userId: string;
  name: string;
  description: string;
  category: UserMannerCategory;
  
  triggerPattern: {
    signalTypes: SignalType[];
    contextFilters: {
      eventTypes?: string[];
      timeRange?: { start: string; end: string };
      tags?: string[];
    };
    minOccurrence: number;
  };
  
  requiredDataSchema: {
    signalData: string[];
    eventData: string[];
    contextData: string[];
  };
  
  targetServices: {
    service: 'ChatFlow' | 'NotesManager' | 'TaskManager' | 'MediaManager';
    actions: string[];
  }[];
  
  decisionWeight: number;
  confidence: number;
  
  evaluationHistory: {
    timestamp: string;
    appliedTo: string;
    userFeedback: 'positive' | 'negative' | 'neutral';
    score: number;
    adjustedWeight: number;
  }[];
  
  status: 'active' | 'learning' | 'deprecated';
  createdAt: string;
  updatedAt: string;
  createdBy: 'ai' | 'user';
  lastAppliedAt: string;
  
  stats: {
    totalApplications: number;
    successRate: number;
    averageScore: number;
  };
}

type UserMannerCategory = 
  | 'content_preference'
  | 'time_preference'
  | 'interaction_style'
  | 'organization_habit'
  | 'search_pattern'
  | 'decision_style';
```

---

## ä¸ç°æœ‰æ¨¡å—é›†æˆ

### 6.1 ä¸ SignalService é›†æˆ

**æ•°æ®æµ**: Signal â†’ UserMannerAgent â†’ UserManner

```typescript
// 1. UserMannerAgent å®šæœŸè¯»å– Signal
class UserMannerAgent {
  async mineUserManners(userId: string) {
    // è¯»å–è¿‘ 30 å¤©çš„ Signal
    const signals = await SignalService.getRecentSignals(userId, {
      days: 30,
      minCount: 100
    });
    
    // åˆ†ææ¨¡å¼...
  }
}

// 2. Signal ä¸ç›´æ¥å†™å…¥ UserMannerï¼ˆä¿æŒèŒè´£åˆ†ç¦»ï¼‰
// âŒ é”™è¯¯åšæ³•:
// SignalService.create() â†’ è§¦å‘ UserManner åˆ›å»º

// âœ… æ­£ç¡®åšæ³•:
// SignalService.create() â†’ ä»…å†™å…¥ signals è¡¨
// UserMannerAgent (å®šæœŸä»»åŠ¡) â†’ è¯»å– signals â†’ åˆ›å»º UserManner
```

**SSOT åˆè§„**:
- Signal æ˜¯ SSOTï¼ˆçœŸç›¸æºï¼‰
- UserManner æ˜¯ Derivedï¼ˆæ´¾ç”Ÿæ•°æ®ï¼Œå¯é‡å»ºï¼‰
- UserMannerAgent æ˜¯å”¯ä¸€çš„ Derived Builder

### 6.2 ä¸ RAGIndexService é›†æˆ

**åº”ç”¨ç‚¹**: ChatFlow æ£€ç´¢æƒé‡è°ƒæ•´

```typescript
class ChatFlowAgent {
  async search(query: string, userId: string) {
    // 1. åŸºç¡€ RAG æ£€ç´¢
    const results = await RAGIndexService.search(query, { topK: 20 });
    
    // 2. è·å– UserManner
    const manners = await UserMannerService.getActiveManners(userId, {
      targetService: 'ChatFlow',
      minWeight: 0.5
    });
    
    // 3. åº”ç”¨æƒé‡è°ƒæ•´
    const reranked = this.applyMannerWeights(results, manners);
    
    return reranked.slice(0, 10);
  }
}
```

**ä¸ä¿®æ”¹ RAGIndexService**:
- RAGIndexService ä¿æŒé€šç”¨æ€§ï¼Œä¸æ„ŸçŸ¥ UserManner
- æƒé‡è°ƒæ•´åœ¨ ChatFlowAgent å±‚å®Œæˆ

### 6.3 ä¸ EventService é›†æˆ

**åº”ç”¨ç‚¹**: åé¦ˆé‡‡é›†ï¼ˆéšå¼ï¼‰

```typescript
// ç›‘å¬ Event åˆ é™¤äº‹ä»¶
eventBus.on('event:deleted', async (eventId) => {
  const event = await EventService.get(eventId);
  
  // å¦‚æœæ˜¯ AI åˆ›å»ºçš„ Event
  if (event.createdBy === 'ai') {
    // æŸ¥æ‰¾åº”ç”¨çš„ UserManner
    const manner = await this.findAppliedManner(eventId);
    
    if (manner) {
      // è®°å½•è´Ÿé¢åé¦ˆï¼ˆç”¨æˆ·åˆ é™¤ = æ‹’ç»ï¼‰
      await UserMannerEvaluator.evaluateApplication(manner.id, {
        appliedTo: eventId,
        userAction: 'reject',
        timestamp: new Date().toISOString()
      });
    }
  }
});
```

**SSOT åˆè§„**:
- EventService ä¸æ„ŸçŸ¥ UserManner
- UserManner é€šè¿‡äº‹ä»¶ç›‘å¬è¢«åŠ¨æ¥æ”¶åé¦ˆ
- ä¸è¿å Single Writer åŸåˆ™

### 6.4 ä¸ TaskService é›†æˆ

**åº”ç”¨ç‚¹**: è‡ªåŠ¨æå– vs é¢„è§ˆç¡®è®¤

```typescript
class TaskExtractionAgent {
  async extractTasks(event: Event, userId: string) {
    // 1. æŸ¥è¯¢ç”¨æˆ·åå¥½
    const manner = await UserMannerService.getActiveManners(userId, {
      targetService: 'TaskManager',
      category: 'decision_style'
    }).then(manners => 
      manners.find(m => m.name.includes('è‡ªåŠ¨æå–'))
    );
    
    // 2. æ ¹æ®æƒé‡å†³ç­–
    if (manner && manner.decisionWeight > 0.7) {
      // è‡ªåŠ¨æå–
      const tasks = await this.llm.extractTasks(event.content);
      await TaskService.batchCreate(tasks);
    } else {
      // æ˜¾ç¤ºé¢„è§ˆ
      const tasks = await this.llm.extractTasks(event.content);
      await this.showConfirmationDialog(tasks);
    }
  }
}
```

### 6.5 ä¸ MediaService é›†æˆ

**åº”ç”¨ç‚¹**: å›¾ç‰‡è´¨é‡è¯„åˆ†ä¸ªæ€§åŒ–

```typescript
class SmartMediaDeduplicationAgent {
  async evaluateImageQuality(image: MediaArtifact, userId: string) {
    // åŸºç¡€è¯„åˆ†
    let score = this.baseQualityScore(image);
    
    // è·å–ç”¨æˆ·åå¥½
    const manners = await UserMannerService.getActiveManners(userId, {
      targetService: 'MediaManager'
    });
    
    // æ ¹æ®åå¥½è°ƒæ•´æƒé‡
    for (const manner of manners) {
      if (manner.name.includes('é«˜åˆ†è¾¨ç‡')) {
        score.resolutionWeight += manner.decisionWeight * 0.2;
      }
      if (manner.name.includes('ç¾è§‚')) {
        score.aestheticWeight += manner.decisionWeight * 0.2;
      }
    }
    
    return this.calculateFinalScore(score);
  }
}
```

---

## å®æ–½è·¯çº¿

### 7.1 Phase 1: åŸºç¡€æ¡†æ¶ (2å‘¨)

**ç›®æ ‡**: å»ºç«‹ UserManner æ•°æ®æ¨¡å‹å’ŒåŸºç¡€æœåŠ¡

**ä»»åŠ¡**:
- [x] åˆ›å»º `user_manners` è¡¨å’Œ `manner_applications` è¡¨
- [x] å®ç° `UserMannerService` CRUD
- [x] å®ç°éšå¼åé¦ˆé‡‡é›†æœºåˆ¶ï¼ˆäº‹ä»¶ç›‘å¬ï¼‰
  - `event:deleted` â†’ reject
  - `event:updated` â†’ modify
  - `ai:suggestion:accepted` â†’ accept

**äº¤ä»˜ç‰©**:
- æ•°æ®è¡¨ Schema
- UserMannerService å®Œæ•´å®ç°
- åé¦ˆé‡‡é›†ä¸­é—´ä»¶

**æ•°æ®æ ·æœ¬éœ€æ±‚**: æ— ï¼ˆåŸºç¡€è®¾æ–½ï¼‰

---

### 7.2 Phase 2: ChatFlow é›†æˆ (3å‘¨)

**ç›®æ ‡**: åœ¨ ChatFlow ä¸­åº”ç”¨ UserManner æƒé‡

**ä»»åŠ¡**:
- [ ] åœ¨ ChatFlowAgent ä¸­é›†æˆ UserManner æŸ¥è¯¢
- [ ] å®ç° RAG ç»“æœæƒé‡è°ƒæ•´ç®—æ³•
- [ ] è®°å½•åº”ç”¨æ—¥å¿—ï¼ˆmanner_applicationsï¼‰
- [ ] æ‰‹åŠ¨åˆ›å»º 3-5 ä¸ªå…¸å‹ UserManner æµ‹è¯•

**äº¤ä»˜ç‰©**:
- ChatFlowAgent é›†æˆä»£ç 
- æƒé‡è°ƒæ•´ç®—æ³•
- æµ‹è¯•ç”¨ä¾‹ï¼ˆ5ä¸ª UserMannerï¼‰

**æ•°æ®æ ·æœ¬éœ€æ±‚**:
- 30 ç¯‡ä¸åŒç±»å‹çš„ç¬”è®°ï¼ˆæŠ€æœ¯/ä¼šè®®/æ—¥è®°ï¼‰
- 20 æ¡æµ‹è¯• query
- 5 ä¸ªæ‰‹åŠ¨åˆ›å»ºçš„ UserManner

---

### 7.3 Phase 3: è‡ªåŠ¨è¯„ä¼° (2å‘¨)

**ç›®æ ‡**: å®ç°æƒé‡è‡ªé€‚åº”è°ƒæ•´

**ä»»åŠ¡**:
- [ ] å®ç° `UserMannerEvaluator.evaluateApplication()`
- [ ] æŒ‡æ•°ç§»åŠ¨å¹³å‡æƒé‡æ›´æ–°ç®—æ³•
- [ ] ä½æ•ˆæ¨¡å¼è‡ªåŠ¨åºŸå¼ƒé€»è¾‘
- [ ] å®šæœŸæ‰¹é‡è¯„ä¼°ä»»åŠ¡ï¼ˆCron Jobï¼‰

**äº¤ä»˜ç‰©**:
- UserMannerEvaluator å®Œæ•´å®ç°
- æƒé‡æ›´æ–°ç®—æ³•ï¼ˆEMAï¼‰
- å®šæœŸä»»åŠ¡é…ç½®

**æ•°æ®æ ·æœ¬éœ€æ±‚**:
- 50 æ¬¡ UserManner åº”ç”¨è®°å½•
- è§‚å¯Ÿ 2 å‘¨çš„æƒé‡å˜åŒ–

---

### 7.4 Phase 4: AI æ¨¡å¼æŒ–æ˜ (4å‘¨)

**ç›®æ ‡**: LLM è‡ªåŠ¨å½’çº³ UserManner

**ä»»åŠ¡**:
- [ ] å®ç° `UserMannerAgent.mineUserManners()`
- [ ] Signal èšåˆåˆ†æç®—æ³•
- [ ] LLM Prompt è°ƒä¼˜ï¼ˆæ¨¡å¼è¯†åˆ«å‡†ç¡®ç‡ï¼‰
- [ ] ç›¸ä¼¼æ¨¡å¼æ£€æµ‹ä¸åˆå¹¶é€»è¾‘
- [ ] å®šæœŸä»»åŠ¡ï¼ˆæ¯å‘¨è‡ªåŠ¨åˆ†æï¼‰

**äº¤ä»˜ç‰©**:
- UserMannerAgent å®Œæ•´å®ç°
- LLM Prompt æ¨¡æ¿
- æ¨¡å¼åˆå¹¶ç®—æ³•

**æ•°æ®æ ·æœ¬éœ€æ±‚**:
- 500 æ¡ Signal æ•°æ®ï¼ˆçœŸå®ç”¨æˆ·è¡Œä¸ºï¼‰
- 10 ä¸ªäººå·¥æ ‡æ³¨çš„"æ­£ç¡®æ¨¡å¼"ï¼ˆç”¨äºéªŒè¯ï¼‰

---

### 7.5 Phase 5: æ‰©å±•åˆ°å…¶ä»–æœåŠ¡ (4å‘¨)

**ç›®æ ‡**: TaskManagerã€NotesManagerã€MediaManager é›†æˆ

**ä»»åŠ¡**:
- [ ] TaskManager é›†æˆï¼ˆè‡ªåŠ¨æå– vs é¢„è§ˆï¼‰
- [ ] NotesManager é›†æˆï¼ˆæ™ºèƒ½æ’å…¥ç›®æ ‡é€‰æ‹©ï¼‰
- [ ] MediaManager é›†æˆï¼ˆå›¾ç‰‡è´¨é‡è¯„åˆ†ï¼‰
- [ ] è·¨æœåŠ¡ UserManner ååŒï¼ˆä¸€ä¸ª Manner å½±å“å¤šä¸ªæœåŠ¡ï¼‰

**äº¤ä»˜ç‰©**:
- 3 ä¸ªæœåŠ¡çš„é›†æˆä»£ç 
- è·¨æœåŠ¡ååŒæœºåˆ¶

**æ•°æ®æ ·æœ¬éœ€æ±‚**:
- 30 æ¡ä¼šè®®çºªè¦ï¼ˆä»»åŠ¡æå–æµ‹è¯•ï¼‰
- 20 æ¬¡æ™ºèƒ½æ’å…¥æ“ä½œï¼ˆç›®æ ‡é€‰æ‹©æµ‹è¯•ï¼‰
- 100 å¼ å›¾ç‰‡ï¼ˆè´¨é‡è¯„åˆ†æµ‹è¯•ï¼‰

---

### 7.6 Phase 6: ç”¨æˆ·ç®¡ç†ç•Œé¢ (2å‘¨)

**ç›®æ ‡**: æä¾› UserManner ç®¡ç†åŠŸèƒ½

**ä»»åŠ¡**:
- [ ] UserManner åˆ—è¡¨é¡µé¢
- [ ] è¯¦ç»†ç»Ÿè®¡é¡µé¢ï¼ˆæƒé‡å˜åŒ–æ›²çº¿ï¼‰
- [ ] æ‰‹åŠ¨ç¼–è¾‘/åˆ é™¤åŠŸèƒ½
- [ ] æ‰‹åŠ¨è§¦å‘é‡æ–°åˆ†æ
- [ ] å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½

**äº¤ä»˜ç‰©**:
- å®Œæ•´çš„ç®¡ç†ç•Œé¢
- æ•°æ®å¯è§†åŒ–ç»„ä»¶

**æ•°æ®æ ·æœ¬éœ€æ±‚**: æ— ï¼ˆUI å¼€å‘ï¼‰

---

### 7.7 æ€»æ—¶é—´çº¿ï¼ˆ17å‘¨ = 4.2ä¸ªæœˆï¼‰

```
Week 1-2:   Phase 1 - åŸºç¡€æ¡†æ¶
Week 3-5:   Phase 2 - ChatFlow é›†æˆ
Week 6-7:   Phase 3 - è‡ªåŠ¨è¯„ä¼°
Week 8-11:  Phase 4 - AI æ¨¡å¼æŒ–æ˜
Week 12-15: Phase 5 - æ‰©å±•åˆ°å…¶ä»–æœåŠ¡
Week 16-17: Phase 6 - ç”¨æˆ·ç®¡ç†ç•Œé¢
```

**é‡Œç¨‹ç¢‘**:
- âœ… Week 2: UserManner åŸºç¡€æ¡†æ¶å¯ç”¨
- âœ… Week 5: ChatFlow æƒé‡è°ƒæ•´ç”Ÿæ•ˆ
- âœ… Week 7: è‡ªåŠ¨è¯„ä¼°é—­ç¯å»ºç«‹
- âœ… Week 11: AI è‡ªåŠ¨æŒ–æ˜ä¸Šçº¿
- âœ… Week 15: æ‰€æœ‰æœåŠ¡é›†æˆå®Œæˆ
- âœ… Week 17: ç”¨æˆ·ç®¡ç†ç•Œé¢ä¸Šçº¿

---

## é£é™©ä¸æŒ‘æˆ˜

### 8.1 å†·å¯åŠ¨é—®é¢˜

**é—®é¢˜**: æ–°ç”¨æˆ·æ²¡æœ‰è¶³å¤Ÿ Signal æ•°æ®ï¼Œæ— æ³•å½’çº³ UserManner

**è§£å†³æ–¹æ¡ˆ**:
1. **é»˜è®¤ UserManner**: åŸºäºäººç¾¤ç»Ÿè®¡æä¾›é€šç”¨æ¨¡å¼
   ```typescript
   const defaultManners = [
     { name: "æŠ€æœ¯å†…å®¹åå¥½", weight: 0.3 },  // ä½æƒé‡
     { name: "ä¼šè®®è¡ŒåŠ¨é¡¹åå¥½", weight: 0.3 }
   ];
   ```
2. **å¿«é€Ÿæ”¶é›† Signal**: å¼•å¯¼ç”¨æˆ·æ ‡è®°/æœç´¢ï¼ˆæ–°æ‰‹ä»»åŠ¡ï¼‰
3. **Few-shot Learning**: å°‘é‡æ•°æ®ä¹Ÿèƒ½å­¦ä¹ ï¼ˆ10 æ¬¡å³å¯ï¼‰

**é¢„æœŸæ•ˆæœ**: 7 å¤©å†…ç”Ÿæˆé¦–ä¸ª UserManner

---

### 8.2 è¿‡æ‹Ÿåˆé£é™©

**é—®é¢˜**: AI å­¦ä¹ åˆ°é”™è¯¯çš„æ¨¡å¼ï¼ˆå¶ç„¶è¡Œä¸ºè¢«è¯¯è®¤ä¸ºä¹ æƒ¯ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
1. **æœ€å°æ ·æœ¬é‡**: è‡³å°‘ 10 æ¬¡æ‰ç®—æ¨¡å¼
2. **ç½®ä¿¡åº¦é˜ˆå€¼**: ä½äº 0.7 ä¸å¯ç”¨
3. **å®šæœŸé‡æ–°è¯„ä¼°**: æ¯æœˆé‡æ–°åˆ†æï¼ŒåºŸå¼ƒå¤±æ•ˆæ¨¡å¼
4. **ç”¨æˆ·ç¡®è®¤**: æ–°æ¨¡å¼ç”Ÿæˆåï¼Œæç¤ºç”¨æˆ·ç¡®è®¤

**é¢„æœŸæ•ˆæœ**: è¯¯åˆ¤ç‡ < 10%

---

### 8.3 éšç§æ‹…å¿§

**é—®é¢˜**: UserManner å­˜å‚¨æ•æ„Ÿè¡Œä¸ºæ•°æ®

**è§£å†³æ–¹æ¡ˆ**:
1. **æœ¬åœ°å­˜å‚¨**: æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æœ¬åœ° IndexedDBï¼Œä¸ä¸Šä¼ äº‘ç«¯
2. **ç”¨æˆ·å¯æ§**: 
   - å…è®¸ç”¨æˆ·å…³é—­åŠŸèƒ½
   - å…è®¸ç”¨æˆ·æŸ¥çœ‹/åˆ é™¤ä»»ä½• Manner
   - å…è®¸ç”¨æˆ·é‡ç½®å­¦ä¹ æ•°æ®
3. **å®šæœŸæ¸…ç†**: 90 å¤©åè‡ªåŠ¨æ¸…ç†æ—§çš„ evaluation_history
4. **é€æ˜è¯´æ˜**: éšç§æ”¿ç­–æ˜ç¡®è¯´æ˜æ•°æ®ç”¨é€”

**é¢„æœŸæ•ˆæœ**: ç”¨æˆ·ä¿¡ä»»åº¦ > 80%

---

### 8.4 è®¡ç®—æˆæœ¬

**é—®é¢˜**: æ¯æ¬¡å†³ç­–éƒ½è¦æŸ¥è¯¢ UserManner + è°ƒæ•´æƒé‡

**è§£å†³æ–¹æ¡ˆ**:
1. **ç¼“å­˜æ´»è·ƒ Manner**: 
   ```typescript
   const cache = new Map<string, UserManner[]>();
   cache.set(userId, activeManners);  // ç¼“å­˜ 30 åˆ†é’Ÿ
   ```
2. **åªåœ¨å¿…è¦æ—¶è§¦å‘**: ä¸æ˜¯æ¯æ¬¡æŸ¥è¯¢éƒ½åº”ç”¨æƒé‡
3. **å¼‚æ­¥è¯„ä¼°**: åé¦ˆè¯„ä¼°ä¸é˜»å¡ä¸»æµç¨‹
   ```typescript
   // âœ… å¼‚æ­¥è¯„ä¼°
   evaluateApplication(...).catch(console.error);  // fire-and-forget
   ```

**é¢„æœŸæ•ˆæœ**: é¢å¤–å»¶è¿Ÿ < 50ms

---

### 8.5 ç”¨æˆ·ç†è§£æˆæœ¬

**é—®é¢˜**: ç”¨æˆ·ä¸ç†è§£ä¸ºä»€ä¹ˆ AI åšå‡ºæŸä¸ªå†³ç­–

**è§£å†³æ–¹æ¡ˆ**:
1. **å¯è§£é‡Šæ€§ UI**: 
   ```
   ğŸ’¡ å› ä¸ºæ‚¨é€šå¸¸åœ¨ä¼šè®®çºªè¦ä¸­æ ‡è®°è¡ŒåŠ¨é¡¹ï¼Œ
       ç³»ç»Ÿè‡ªåŠ¨ä¸ºæ‚¨æå–äº† 3 ä¸ªå¾…åŠä»»åŠ¡ã€‚
   ```
2. **é€æ˜å±•ç¤º**: ç”¨æˆ·èƒ½æŸ¥çœ‹æ‰€æœ‰ UserManner
3. **å…è®¸ç¼–è¾‘**: ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è°ƒæ•´æƒé‡
4. **é‡ç½®é€‰é¡¹**: æä¾›"é‡ç½®å­¦ä¹ "æŒ‰é’®

**é¢„æœŸæ•ˆæœ**: ç”¨æˆ·ç†è§£åº¦ > 75%

---

## æˆåŠŸæŒ‡æ ‡

### 9.1 æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹å¼ |
|------|--------|----------|
| **ä¸ªæ€§åŒ–å‡†ç¡®ç‡** | > 70% | AI å»ºè®®è¢«ç”¨æˆ·é‡‡çº³çš„æ¯”ä¾‹ |
| **å­¦ä¹ é€Ÿåº¦** | < 14 å¤© | ä»æ³¨å†Œåˆ°ç”Ÿæˆé¦–ä¸ªæœ‰æ•ˆ Manner |
| **æƒé‡æ”¶æ•›é€Ÿåº¦** | < 20 æ¬¡åº”ç”¨ | æƒé‡ç¨³å®šåˆ° Â±0.1 åŒºé—´ |
| **æ¨¡å¼è¯†åˆ«å‡†ç¡®ç‡** | > 85% | LLM è¯†åˆ«çš„æ¨¡å¼ä¸äººå·¥æ ‡æ³¨ä¸€è‡´æ€§ |
| **ç”¨æˆ·æ»¡æ„åº¦** | > 4.2/5 | AI æœåŠ¡ä½“éªŒè¯„åˆ† |

### 9.2 ä¸šåŠ¡æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| **åŠŸèƒ½ä½¿ç”¨ç‡** | > 60% | æ´»è·ƒç”¨æˆ·ä¸­å¯ç”¨ UserManner çš„æ¯”ä¾‹ |
| **ç•™å­˜æå‡** | + 15% | ç›¸æ¯”æœªå¯ç”¨ UserManner çš„ç”¨æˆ· |
| **AI æœåŠ¡ä½¿ç”¨é¢‘ç‡** | + 30% | ChatFlow/TaskManager ä½¿ç”¨æ¬¡æ•°æå‡ |
| **ç”¨æˆ·æ¨èæ„æ„¿** | > 8/10 | NPS è¯„åˆ† |

### 9.3 æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| **æ¨¡å¼æŒ–æ˜æ€§èƒ½** | < 5s | åˆ†æ 500 æ¡ Signal çš„è€—æ—¶ |
| **æƒé‡è°ƒæ•´å»¶è¿Ÿ** | < 100ms | å•æ¬¡è¯„ä¼° + æ›´æ–°çš„è€—æ—¶ |
| **å­˜å‚¨å ç”¨** | < 1MB/ç”¨æˆ· | UserManner + åº”ç”¨æ—¥å¿—æ€»å¤§å° |
| **è¯¯åˆ¤ç‡** | < 10% | é”™è¯¯æ¨¡å¼çš„æ¯”ä¾‹ |

---

## é™„å½•

### A.1 LLM Prompt æ¨¡æ¿ï¼ˆæ¨¡å¼è¯†åˆ«ï¼‰

```
æ‚¨æ˜¯ä¸€ä¸ªç”¨æˆ·è¡Œä¸ºåˆ†æä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹ç”¨æˆ·åœ¨ç¬”è®°è½¯ä»¶ä¸­çš„è¡Œä¸ºæ•°æ®ï¼Œè¯†åˆ«æ˜æ˜¾çš„è¡Œä¸ºæ¨¡å¼ã€‚

===== ç”¨æˆ·è¡Œä¸ºæ•°æ® =====
${aggregatedSignals}

===== ä»»åŠ¡è¦æ±‚ =====
1. è¯†åˆ« 3-5 ä¸ªæœ€æ˜æ˜¾çš„è¡Œä¸ºæ¨¡å¼
2. æ¯ä¸ªæ¨¡å¼è‡³å°‘å‡ºç° 10 æ¬¡
3. æ¨¡å¼åº”è¯¥æœ‰å®é™…æ„ä¹‰ï¼ˆèƒ½æŒ‡å¯¼ AI å†³ç­–ï¼‰
4. è¾“å‡º JSON æ ¼å¼

===== è¾“å‡ºæ ¼å¼ =====
[
  {
    "name": "ç®€æ´çš„æ¨¡å¼åç§°",
    "description": "è¯¦ç»†è¯´æ˜ç”¨æˆ·ä¸ºä»€ä¹ˆè¿™æ ·åš",
    "category": "content_preference | time_preference | interaction_style | organization_habit | search_pattern | decision_style",
    "triggerPattern": {
      "signalTypes": ["highlight", "action_item"],
      "contextFilters": {
        "eventTypes": ["meeting_notes"],
        "timeRange": { "start": "21:00", "end": "23:00" }
      },
      "minOccurrence": 10
    },
    "targetServices": [
      {
        "service": "ChatFlow | NotesManager | TaskManager | MediaManager",
        "actions": ["å…·ä½“çš„æ™ºèƒ½æœåŠ¡åŠ¨ä½œ"]
      }
    ],
    "confidence": 0.92
  }
]

===== ç¤ºä¾‹è¾“å‡º =====
[
  {
    "name": "ä¼šè®®çºªè¦è¡ŒåŠ¨é¡¹åå¥½",
    "description": "ç”¨æˆ·åœ¨ä¼šè®®çºªè¦ä¸­é«˜é¢‘æ ‡è®°è¡ŒåŠ¨é¡¹ï¼Œå€¾å‘äºç«‹å³æå– TODO",
    "category": "content_preference",
    "triggerPattern": {
      "signalTypes": ["highlight", "action_item"],
      "contextFilters": { "eventTypes": ["meeting_notes"] },
      "minOccurrence": 10
    },
    "targetServices": [
      { "service": "TaskManager", "actions": ["auto_extract_tasks", "priority_boost"] }
    ],
    "confidence": 0.92
  }
]
```

### A.2 æƒé‡æ›´æ–°ç®—æ³•ï¼ˆæ•°å­¦å…¬å¼ï¼‰

**æŒ‡æ•°ç§»åŠ¨å¹³å‡ï¼ˆEMAï¼‰**:

$$
W_{t+1} = W_t \cdot (1 - \alpha) + S_t \cdot \alpha
$$

å…¶ä¸­ï¼š
- $W_t$: å½“å‰æƒé‡
- $W_{t+1}$: æ›´æ–°åæƒé‡
- $S_t$: æœ¬æ¬¡è¯„åˆ†ï¼ˆ0-1ï¼‰
- $\alpha$: å­¦ä¹ ç‡ï¼ˆæ¨è 0.2ï¼‰

**å­¦ä¹ ç‡é€‰æ‹©**:
- $\alpha = 0.1$: ä¿å®ˆå­¦ä¹ ï¼Œæƒé‡å˜åŒ–æ…¢
- $\alpha = 0.2$: å¹³è¡¡ï¼ˆæ¨èï¼‰
- $\alpha = 0.5$: æ¿€è¿›å­¦ä¹ ï¼Œæƒé‡å˜åŒ–å¿«

**æƒé‡è¾¹ç•Œ**:
```typescript
newWeight = Math.max(0, Math.min(1, newWeight));  // é™åˆ¶åœ¨ [0, 1]
```

### A.3 ç›¸ä¼¼æ¨¡å¼æ£€æµ‹ç®—æ³•

```typescript
function findSimilarManner(newPattern: any): UserManner | null {
  const existing = await UserMannerService.getAll(userId);
  
  for (const manner of existing) {
    // 1. åç§°ç›¸ä¼¼åº¦ï¼ˆLevenshtein è·ç¦»ï¼‰
    const nameSim = levenshtein(newPattern.name, manner.name);
    
    // 2. è§¦å‘æ¡ä»¶ç›¸ä¼¼åº¦ï¼ˆSignal ç±»å‹äº¤é›†ï¼‰
    const signalSim = jaccard(
      newPattern.triggerPattern.signalTypes,
      manner.triggerPattern.signalTypes
    );
    
    // 3. ç›®æ ‡æœåŠ¡ç›¸ä¼¼åº¦
    const serviceSim = jaccard(
      newPattern.targetServices.map(s => s.service),
      manner.targetServices.map(s => s.service)
    );
    
    // ç»¼åˆç›¸ä¼¼åº¦
    const similarity = (nameSim + signalSim + serviceSim) / 3;
    
    if (similarity > 0.7) {
      return manner;  // æ‰¾åˆ°ç›¸ä¼¼æ¨¡å¼
    }
  }
  
  return null;  // æ— ç›¸ä¼¼æ¨¡å¼
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-10  
**ä½œè€…**: 4DNote Product Team
