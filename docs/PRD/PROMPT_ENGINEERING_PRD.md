# Prompt Engineering & Evaluation Platform PRD

**项目名称**: 4DNote AI Prompt Lab  
**版本**: v1.0  
**创建日期**: 2026-01-03  
**目标**: 为 4DNote AI 功能（事件提取、AI Answer、TakeawayCandidate 等）提供系统化的 Prompt 调试、评估和优化平台

---

## 一、背景与问题陈述

### 1.1 核心问题

在开发 4DNote 的 AI 功能（任务提取、AI Answer、笔记管理等）过程中，遇到以下困境：

1. **黑盒调试困境**
   - Prompt 调整缺乏科学方法，依赖"改了试试看"
   - 无法量化改进效果（不知道是 70% → 75% 还是 70% → 68%）
   - 不清楚失败案例的共同模式

2. **LLM 输出的两难选择**
   - **过度约束** → 幻觉（hallucination）：如要求提取"参会人"，AI 会编造
   - **约束不足** → 遗漏（omission）：不要求提取，AI 就忽略
   - 在两个极端之间摇摆，找不到平衡点

3. **输入多样性难题**
   - 正式邀请函（信息完整）vs 活动海报（信息缺失）vs 口头通知（口语化）
   - 用同一个 Prompt 处理所有类型，成功率不稳定

4. **Copilot 的局限性**
   - Copilot 能生成代码，但不知道你的真实数据分布
   - 不会系统分析失败模式
   - 给出的 Prompt 改进建议往往是"通用建议"，缺乏针对性

### 1.2 根本原因

**不是"更好的 Prompt 写法"问题，而是缺少：**
1. 结构化的错误分类方法
2. 可测量的评估体系（Golden Dataset + 自动化 Eval）
3. 针对性的 Prompt 模式（分类后分别处理）
4. Human-AI 协同的调试工作流

---

## 二、解决方案：Eval-Driven Development

### 2.1 核心方法论

> **"如果你不能度量它，你就不能改进它"**

采用 **评估驱动开发**（Eval-Driven Development）流程：

```
1. 定义成功标准（可测量）
   ↓
2. 建立测试集（Golden Dataset，30-50 条）
   ↓
3. 写第一版 Prompt（先求能跑）
   ↓
4. 自动化评估（跑测试集，算分数）
   ↓
5. 分析失败案例（找共同模式）
   ↓
6. 改进 Prompt（回到步骤 4）
```

### 2.2 关键设计原则

#### 原则 1：输出 Schema 设计 —— 让 AI 说"不确定"

**❌ 错误设计（强制字段）**
```typescript
interface EventInfo {
  title: string;
  time: string;
  location: string;
  attendees: string;  // ← 强制填写，AI 会编造
}
```

**✅ 正确设计（可选字段 + 置信度 + 证据链）**
```typescript
interface EventInfo {
  title: {
    value: string;
    confidence: 'high' | 'medium' | 'low';
    source: string;  // 证据位置，如"第 2 行"
  };
  time: {
    value: string | null;  // null 表示"未找到"
    confidence: 'high' | 'medium' | 'low';
    time_precision: 'datetime' | 'date' | 'relative';
    source: string;
  };
  location: {
    value: string | null;
    confidence: 'high' | 'medium' | 'low';
    source: string;
  };
  attendees: {
    value: string | null;  // ✅ 允许 null
    confidence: 'high' | 'medium' | 'low';
    source: string;
  };
  
  // AI 的"不确定声明"
  uncertain_fields: string[];  // 如 ["location", "attendees"]
  need_human_review: boolean;  // 如果超过 2 个字段 confidence=low
}
```

#### 原则 2：输入分类 + 专用 Prompt（Routing）

```typescript
async function extractEventInfo(text: string) {
  // Step 1: 自动分类输入类型
  const inputType = await classifyInput(text);
  // 返回: 'formal_invitation' | 'poster' | 'casual_note' | 'other'
  
  // Step 2: 选择对应的 Prompt
  const prompt = selectPromptByType(inputType, text);
  
  // Step 3: 提取
  const rawInfo = await llm.generate(prompt);
  
  // Step 4: 后处理验证
  return validateExtractedInfo(rawInfo, text);
}
```

**不同类型的 Prompt 策略**：
- **正式邀请函**：严格提取，所有字段都应该存在
- **活动海报**：容忍缺失，重点提取标题/时间/地点
- **口头通知**：允许推断，但标记 confidence=medium

#### 原则 3：Chain-of-Thought 提取（可解释性）

```typescript
const cotPrompt = `
## 步骤 1: 理解上下文
当前日期：${new Date().toISOString().split('T')[0]}

## 步骤 2: 逐字段分析（写出推理过程）

### 标题
- 原文："技术分享会"
- 分析：这是明确的标题
- 提取：value="技术分享会", confidence=high

### 时间
- 原文："下周五下午"
- 分析：
  * 今天是 2026-01-03（周五）
  * "下周五" = 2026-01-10
  * "下午"缺少具体时间
- 提取：value="2026-01-10", confidence=medium, time_precision="date"

（继续分析其他字段...）

## 步骤 3: 输出最终 JSON
{...}
`;
```

**价值**：
- 你能看到 AI 的推理过程（调试时有用）
- AI 被迫"显式思考"，减少幻觉
- 如果推理过程荒谬，你能快速发现

#### 原则 4：后处理验证（程序化检查）

```typescript
function validateExtractedInfo(info: EventInfo, originalText: string) {
  const issues = [];
  
  // 检查 1: 幻觉检测（值不在原文中）
  if (info.location.value && !originalText.includes(info.location.value)) {
    issues.push({ field: 'location', type: 'HALLUCINATION' });
    info.location.value = null;  // 自动修复
  }
  
  // 检查 2: 时间格式验证
  if (info.time.value && !isValidDateTime(info.time.value)) {
    issues.push({ field: 'time', type: 'FORMAT_ERROR' });
    info.time.confidence = 'low';
  }
  
  // 检查 3: 逻辑一致性（如时间在过去）
  if (info.time.value && isPastDate(info.time.value)) {
    issues.push({ field: 'time', type: 'LOGIC_ERROR' });
    info.need_human_review = true;
  }
  
  return { validated: info, issues };
}
```

---

## 三、系统架构：4DNote AI Prompt Lab

### 3.1 系统目标

1. **可视化评估**：并排查看不同 Prompt 版本的输出
2. **快速标注**：点击打分和标注失败原因
3. **AI 辅助分析**：自动聚类失败案例，生成改进建议
4. **版本管理**：Prompt 自动存档，随时回滚
5. **本地数据生成**：基于 4DNote 的真实数据结构造测试数据

### 3.2 技术栈

- **Frontend**: React + TypeScript + Tailwind CSS
- **Backend**: Node.js + Express
- **Database**: SQLite（本地存储）
- **AI Integration**: 
  - LLM API（DashScope / 腾讯混元 / Ollama）
  - Copilot API（失败案例分析）
- **Code Editor**: Monaco Editor（在线编辑 Prompt）

### 3.3 系统架构图

```
┌────────────────────────────────────────────────────────┐
│  Web UI (React)                                        │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐  │
│  │ 测试用例列表  │ │ 输入/输出对比 │ │ 打分和标注    │  │
│  │ - 通过/失败   │ │ - 高亮差异    │ │ - 失败原因    │  │
│  │ - 按类型过滤  │ │ - 证据链跳转  │ │ - Copilot分析 │  │
│  └──────────────┘ └──────────────┘ └──────────────┘  │
│  ┌────────────────────────────────────────────────┐  │
│  │ Prompt 编辑器 (Monaco Editor)                   │  │
│  │ - 语法高亮 | 版本对比 | 一键回滚                 │  │
│  └────────────────────────────────────────────────┘  │
└───────────────────────┬────────────────────────────────┘
                        │ HTTP/WebSocket
┌───────────────────────▼────────────────────────────────┐
│  Backend (Node.js + Express)                           │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────┐ │
│  │ Eval Engine    │ │ Data Generator │ │ AI Service │ │
│  │ - 运行测试集   │ │ - 造测试数据   │ │ - LLM 调用 │ │
│  │ - 计算评分     │ │ - 基于 4DNote  │ │ - Copilot  │ │
│  │ - 聚类失败案例 │ │   Schema       │ │   分析     │ │
│  └────────────────┘ └────────────────┘ └────────────┘ │
│  ┌──────────────────────────────────────────────────┐ │
│  │ SQLite Database                                   │ │
│  │ - test_cases (测试集)                             │ │
│  │ - eval_results (评估结果)                         │ │
│  │ - annotations (人工标注)                          │ │
│  │ - prompts (Prompt 版本)                           │ │
│  └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
```

---

## 四、核心功能设计

### 4.1 数据生成器（Data Generator）

#### 功能目标
基于 4DNote 的真实数据结构（Event、EventLog、TakeawayCandidate 等）生成测试数据。

#### 输入
```typescript
interface DataGeneratorConfig {
  scenario: 'event_extraction' | 'ai_answer' | 'takeaway_generation';
  count: number;  // 生成多少条
  distribution: {
    formal_invitation: number;  // 30%
    poster: number;             // 40%
    casual_note: number;        // 20%
    edge_case: number;          // 10%
  };
  templates: Template[];  // 基于真实案例的模板
}
```

#### 输出
```typescript
interface GeneratedTestCase {
  id: string;
  input: string;  // 模拟的邀请函/海报文本
  expected: {
    // 基于 4DNote 的 Event 结构
    title: { value: string, confidence: string };
    time: { value: string | null, confidence: string };
    location: { value: string | null, confidence: string };
    // ...
  };
  metadata: {
    type: 'formal_invitation' | 'poster' | 'casual_note';
    difficulty: 'easy' | 'medium' | 'hard';
    tags: string[];  // 如 ["时间模糊", "缺少地点"]
  };
}
```

#### 实现策略

**策略 1：模板变换**
```typescript
const templates = {
  formal_invitation: `
【{{event_type}}通知】
主题：{{title}}
时间：{{time}}
地点：{{location}}
参会：{{attendees}}
  `,
  
  poster: `
{{title}}
{{time}}
{{location}}
  `,  // 故意缺少参会人
  
  casual_note: `
{{relative_time}}有个关于{{topic}}的{{event_type}}
  `,  // 信息碎片化
};

// 变量池
const variables = {
  event_type: ['讲座', '会议', '分享会', '研讨会'],
  title: ['AI技术分享', 'React最佳实践', '团队建设活动'],
  time: ['2026-01-05 14:00', '下周五下午', '明天'],
  location: ['A101会议室', '线上', null],
  attendees: ['技术部全体', '仅限会员', null],
  // ...
};
```

**策略 2：真实数据变形**
```typescript
// 从 4DNote 的历史 Event 中提取
async function generateFromRealData() {
  const realEvents = await db.getEvents({ limit: 100 });
  
  return realEvents.map(event => {
    // 转换成测试案例
    const input = serializeEventToText(event, {
      removeFields: Math.random() > 0.7 ? ['attendees'] : [],  // 70% 保留所有字段
      addNoise: Math.random() > 0.8,  // 20% 添加噪声（错别字、格式混乱）
    });
    
    const expected = extractExpectedFromEvent(event);
    
    return { input, expected, metadata: { type: 'real_data_variant' } };
  });
}
```

**策略 3：边界案例生成**
```typescript
const edgeCases = [
  {
    name: '时间在过去',
    input: '讲座时间：2020-01-01 10:00',
    expected: { time: { value: null, note: '时间已过期' } },
  },
  {
    name: '信息完全缺失',
    input: '明天有个会',
    expected: { 
      title: { value: '会议', confidence: 'low' },
      time: { value: null },
      location: { value: null },
      need_human_review: true,
    },
  },
  {
    name: '多事件混合',
    input: '上午10点开会，下午2点讲座',
    expected: { note: '包含多个事件，需拆分' },
  },
  // ...
];
```

#### UI 界面

```
┌─────────────────────────────────────────────────────┐
│  数据生成器                                          │
│                                                      │
│  场景: [事件提取 ▼]                                  │
│  数量: [30] 条                                       │
│                                                      │
│  类型分布:                                           │
│    正式邀请函  ████████████ 30% (9条)                │
│    活动海报    ████████████████ 40% (12条)           │
│    口头通知    ████████ 20% (6条)                    │
│    边界案例    ████ 10% (3条)                        │
│                                                      │
│  [ ] 从真实数据变形（需要访问 4DNote 数据库）         │
│  [x] 使用模板生成                                     │
│  [x] 包含边界案例                                     │
│                                                      │
│  [生成测试集] [预览]                                  │
└─────────────────────────────────────────────────────┘

生成结果预览:
┌─────────────────────────────────────────────────────┐
│ 案例 1 (正式邀请函 - easy)                           │
│ 输入: 【讲座通知】主题：AI技术分享...                 │
│ 期望: { title: "AI技术分享", time: "2026-01-05..." } │
│                                                      │
│ 案例 2 (活动海报 - medium)                           │
│ 输入: AI技术分享\n2026-01-05 14:00\nA101...          │
│ 期望: { title: "AI技术分享", attendees: null }       │
│                                                      │
│ ...                                                  │
│                                                      │
│ [保存到测试集] [重新生成]                             │
└─────────────────────────────────────────────────────┘
```

---

### 4.2 评估引擎（Eval Engine）

#### 功能目标
自动运行测试集，计算多维度评分，聚类失败案例。

#### 评分维度

```typescript
interface EvalMetrics {
  // 1. 字段准确率
  field_accuracy: {
    overall: number;  // 0-1
    by_field: {
      title: number;
      time: number;
      location: number;
      attendees: number;
    };
  };
  
  // 2. 幻觉率（关键指标！）
  hallucination_rate: number;  // 0-1，越低越好
  hallucinated_cases: string[];  // 案例 ID
  
  // 3. 遗漏率
  omission_rate: number;  // 0-1，越低越好
  omitted_fields: { case_id: string, field: string }[];
  
  // 4. 置信度校准
  confidence_calibration: {
    high_confidence_accuracy: number;  // confidence=high 的准确率应该 > 90%
    medium_confidence_accuracy: number;
    low_confidence_accuracy: number;
    calibration_error: number;  // 预测置信度和实际准确率的差距
  };
  
  // 5. 按输入类型统计
  by_input_type: {
    formal_invitation: { pass_rate: number };
    poster: { pass_rate: number };
    casual_note: { pass_rate: number };
  };
  
  // 6. 性能指标
  avg_response_time_ms: number;
  avg_token_count: number;
  estimated_cost_per_call: number;
}
```

#### 失败案例聚类

```typescript
interface FailurePattern {
  pattern_id: string;
  type: 'hallucination' | 'omission' | 'format_error' | 'logic_error';
  count: number;
  affected_cases: string[];
  description: string;
  example: {
    input: string;
    expected: any;
    actual: any;
  };
  suggested_fix: string;  // 由 Copilot 生成
}

// 聚类算法
async function clusterFailures(failures: FailedCase[]): Promise<FailurePattern[]> {
  // 1. 按错误类型分组
  const byType = groupBy(failures, f => f.error_type);
  
  // 2. 在每个类型内，按字段分组
  const patterns = [];
  for (const [type, cases] of Object.entries(byType)) {
    const byField = groupBy(cases, c => c.failed_field);
    
    for (const [field, fieldCases] of Object.entries(byField)) {
      // 3. 检查是否有共同模式
      const commonPattern = detectCommonPattern(fieldCases);
      
      if (commonPattern) {
        patterns.push({
          type,
          field,
          count: fieldCases.length,
          description: commonPattern.description,
          // ...
        });
      }
    }
  }
  
  return patterns;
}
```

#### UI 界面

```
┌─────────────────────────────────────────────────────────┐
│  评估结果: event-extraction-v3                          │
│  时间: 2026-01-03 14:35:22                              │
│  对比: v2 → v3                                          │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  总体评分                                                │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  通过率:        86.7%  (26/30)  [↑ +13.4% from v2]     │
│  字段准确率:    89.2%           [↑ +8.1%]              │
│  幻觉率:        6.7%            [↓ -10.0%] ✅          │
│  遗漏率:        12.5%           [↑ +2.5%]  ⚠️         │
│  置信度校准:    0.82            [↑ +0.15]              │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  按输入类型                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  正式邀请函:    100%  (9/9)   ✅                        │
│  活动海报:      83.3% (10/12) [↑ from 66.7%]           │
│  口头通知:      66.7% (4/6)   [↓ from 83.3%] ⚠️       │
│  边界案例:      100%  (3/3)   ✅                        │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  失败模式 (4个)                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  1. [遗漏] location 字段 (3 cases, 口头通知类)          │
│     原因: Prompt 未强调提取隐式地点（如"线上"）          │
│     建议: 添加示例 "腾讯会议 → location='online'"        │
│     [查看案例] [应用修复]                                │
│                                                          │
│  2. [格式] time 解析错误 (1 case, 海报类)               │
│     原因: OCR 提取的时间有错别字 "2O26"（O 误识别）     │
│     建议: 添加后处理 "修正常见 OCR 错误"                 │
│     [查看案例] [应用修复]                                │
│                                                          │
│  [让 Copilot 分析所有失败案例] [导出报告]               │
└─────────────────────────────────────────────────────────┘
```

---

### 4.3 标注界面（Annotation UI）

#### 功能目标
快速标注失败案例，提供多维度反馈。

#### UI 设计

```
┌─────────────────────────────────────────────────────────┐
│  案例详情: case-012                                      │
│  类型: 活动海报 | 难度: medium                           │
│                                                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 输入文本                                         │   │
│  ├─────────────────────────────────────────────────┤   │
│  │ AI 技术分享会                                    │   │
│  │ 2026年1月5日 下午2点                             │   │
│  │ 腾讯会议                                         │   │
│  └─────────────────────────────────────────────────┘   │
│                                                          │
│  期望输出                      实际输出                  │
│  ┌───────────────────┐      ┌────────────────────┐    │
│  │ title: "AI技术分享" │      │ title: "AI技术分享" │ ✅ │
│  │ time: "2026-01-05  │      │ time: "2026-01-05  │ ✅ │
│  │       14:00"       │      │       14:00"       │    │
│  │ location: "online" │      │ location: null     │ ❌ │ ← 遗漏
│  │ attendees: null    │      │ attendees: "全体"  │ ❌ │ ← 幻觉
│  └───────────────────┘      └────────────────────┘    │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  人工评分                                                │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  整体质量: ●━━━━━○━━━━ 6/10                            │
│                                                          │
│  失败原因: (多选)                                        │
│  [x] 遗漏信息 (location)                                │
│  [x] 幻觉 (attendees)                                   │
│  [ ] 格式错误                                            │
│  [ ] 逻辑错误                                            │
│  [ ] 其他: ___________                                  │
│                                                          │
│  详细备注:                                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │ "腾讯会议"应该被识别为 location="online"，         │   │
│  │ 但 AI 没有提取。                                   │   │
│  │ 另外，AI 编造了 attendees="全体"，原文没有这个信息。│   │
│  └─────────────────────────────────────────────────┘   │
│                                                          │
│  [保存标注] [上一个] [下一个] [跳过]                     │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  AI 分析建议 (由 Copilot 生成)                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  根据你的标注，发现以下问题：                             │
│                                                          │
│  1. **隐式地点提取失败**                                 │
│     - 相似案例: case-007, case-015 (共3个)              │
│     - 模式: "腾讯会议"、"Zoom"等应识别为 online          │
│     - 建议: 在 Prompt 添加：                             │
│       "如果提到在线会议工具（腾讯会议/Zoom/...），       │
│        提取为 location='online (工具名)'"                │
│                                                          │
│  2. **attendees 幻觉**                                  │
│     - 这是第 5 次出现这类错误                            │
│     - 建议: 强化约束：                                   │
│       "如果原文未明确提及参会范围，必须设为 null，       │
│        不要根据活动类型推测"                             │
│                                                          │
│  [应用建议到 Prompt] [查看相似案例] [忽略]              │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  证据链追踪                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  AI 的推理过程:                                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Step 1: 提取标题                                 │   │
│  │   原文: "AI 技术分享会"                          │   │
│  │   结果: title="AI技术分享" ✅                    │   │
│  │                                                  │   │
│  │ Step 2: 提取时间                                 │   │
│  │   原文: "2026年1月5日 下午2点"                   │   │
│  │   解析: 2026-01-05 14:00 ✅                      │   │
│  │                                                  │   │
│  │ Step 3: 提取地点                                 │   │
│  │   原文: "腾讯会议"                               │   │
│  │   结果: location=null ❌                         │   │ ← 这里出错了
│  │   原因: 未识别为在线会议工具                     │   │
│  │                                                  │   │
│  │ Step 4: 提取参会人                               │   │
│  │   原文: (未提及)                                 │   │
│  │   推断: attendees="全体" ❌                      │   │ ← 幻觉
│  │   原因: 根据"技术分享会"推测了参会范围            │   │
│  └─────────────────────────────────────────────────┘   │
│                                                          │
│  [重新运行并查看推理] [导出此案例]                       │
└─────────────────────────────────────────────────────────┘
```

#### 批量标注模式

当你标注了 5+ 个案例后，系统自动提供批量操作：

```
┌─────────────────────────────────────────────────────────┐
│  检测到模式: 隐式地点提取失败                            │
│                                                          │
│  相似的 6 个案例都存在这个问题：                          │
│  • case-007: "Zoom 会议" → location=null                │
│  • case-012: "腾讯会议" → location=null                 │
│  • case-015: "线上参加" → location=null                 │
│  • case-023: "Microsoft Teams" → location=null          │
│  • case-028: "钉钉会议" → location=null                 │
│  • case-030: "Google Meet" → location=null              │
│                                                          │
│  是否批量标注这些案例为"遗漏 - 隐式地点"？               │
│  [是，批量标注] [否，逐个审查]                           │
└─────────────────────────────────────────────────────────┘
```

#### 快捷键支持

```
键盘快捷键:
  ←/→        上一个/下一个案例
  1-9        快速打分 (1-9分)
  0          打 10 分
  H          标记为"幻觉"
  O          标记为"遗漏"
  F          标记为"格式错误"
  Space      保存并下一个
  S          跳过
  A          让 AI 分析
  Ctrl+Enter 应用 AI 建议到 Prompt
```

---

### 4.4 Prompt 编辑器（Prompt Editor）

#### 功能目标
在线编辑 Prompt，支持版本管理、语法高亮、对比视图。

#### UI 设计

```
┌─────────────────────────────────────────────────────────┐
│  Prompt 编辑器                                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 版本: v3 (当前) | 基于: v2 | 创建: 2026-01-03    │   │
│  │ [保存] [另存为新版本] [回滚到 v2] [对比视图]     │   │
│  └─────────────────────────────────────────────────┘   │
│                                                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 1  你是 4DNote 的事件信息提取助手。               │   │
│  │ 2                                                 │   │
│  │ 3  **核心原则**                                   │   │
│  │ 4  1. **只提取明确存在的信息**，不要推测或编造   │   │
│  │ 5  2. **如果某个字段在文本中找不到，设为 null**  │   │
│  │ 6  3. **为每个字段标注置信度和来源位置**         │   │
│  │ 7                                                 │   │
│  │ 8  **新增规则 (v3)** ← Copilot 自动添加的标记     │   │
│  │ 9  4. **识别在线会议工具**                        │   │
│  │10     如果提到以下工具，提取为 location='online': │   │
│  │11     - 腾讯会议 / Zoom / Microsoft Teams        │   │
│  │12     - 钉钉会议 / Google Meet / Webex           │   │
│  │13     示例: "腾讯会议" → location="online        │   │
│  │14             (Tencent Meeting)"                 │   │
│  │15                                                 │   │
│  │16  5. **禁止推测参会人**                          │   │
│  │17     只有原文明确提及参会范围时才提取，否则设为  │   │
│  │18     null。不要根据活动类型推测。                │   │
│  │19     ❌ "技术分享会" → attendees="技术部"        │   │
│  │20     ✅ 未提及 → attendees=null                  │   │
│  │21                                                 │   │
│  │...                                                │   │
│  └─────────────────────────────────────────────────┘   │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  测试面板                                                │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  快速测试 (不保存结果):                                  │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 输入: AI 技术分享会                               │   │
│  │       2026年1月5日 14:00                          │   │
│  │       腾讯会议                                    │   │
│  └─────────────────────────────────────────────────┘   │
│  [测试当前 Prompt]                                       │
│                                                          │
│  输出:                                                   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ {                                                 │   │
│  │   "title": { "value": "AI技术分享", ... },       │   │
│  │   "location": {                                   │   │
│  │     "value": "online (Tencent Meeting)", ✅      │   │ ← 修复了！
│  │     "confidence": "high"                          │   │
│  │   },                                              │   │
│  │   "attendees": { "value": null, ... } ✅         │   │ ← 修复了！
│  │ }                                                 │   │
│  └─────────────────────────────────────────────────┘   │
│                                                          │
│  [运行完整 Eval] [保存 Prompt 并运行 Eval]               │
└─────────────────────────────────────────────────────────┘
```

#### 对比视图（Version Diff）

点击"对比视图"后：

```
┌─────────────────────────────────────────────────────────┐
│  Prompt 对比: v2 → v3                                    │
│                                                          │
│  v2 (Pass Rate: 73.3%)         v3 (Pass Rate: 86.7%)   │
│  ┌───────────────────────┐    ┌────────────────────┐   │
│  │ 你是事件提取助手。     │    │ 你是事件提取助手。  │   │
│  │                       │    │                    │   │
│  │ **核心原则**          │    │ **核心原则**       │   │
│  │ 1. 只提取明确信息     │    │ 1. 只提取明确信息  │   │
│  │ 2. 找不到设为 null    │    │ 2. 找不到设为 null │   │
│  │ 3. 标注置信度         │    │ 3. 标注置信度      │   │
│  │                       │    │                    │   │
│  │                       │    │ **新增规则 (v3)**  │   │ ← 新增
│  │                       │    │ 4. 识别在线会议工具 │   │ ← 新增
│  │                       │    │    腾讯会议/Zoom... │   │ ← 新增
│  │                       │    │                    │   │
│  │                       │    │ 5. 禁止推测参会人   │   │ ← 新增
│  │                       │    │    只提取明确提及的 │   │ ← 新增
│  └───────────────────────┘    └────────────────────┘   │
│                                                          │
│  关键改进:                                               │
│  • 新增在线会议工具识别规则 → 修复 3 个遗漏案例         │
│  • 强化 attendees 约束 → 修复 5 个幻觉案例              │
│                                                          │
│  评分对比:                                               │
│  • 幻觉率: 16.7% → 6.7% (-10.0%) ✅                     │
│  • 遗漏率: 10.0% → 12.5% (+2.5%) ⚠️ (可接受的trade-off)│
│  • 整体通过率: 73.3% → 86.7% (+13.4%) ✅                │
│                                                          │
│  [回滚到 v2] [保存 v3] [继续编辑]                        │
└─────────────────────────────────────────────────────────┘
```

#### Copilot 辅助编辑

在编辑器中，选中一段 Prompt，右键选择"让 Copilot 改进"：

```
┌─────────────────────────────────────────────────────────┐
│  Copilot 建议                                            │
│                                                          │
│  你选中的内容:                                           │
│  "如果某个字段在文本中找不到，设为 null"                 │
│                                                          │
│  Copilot 分析:                                           │
│  这条规则过于笼统，根据评估结果，建议细化：               │
│                                                          │
│  改进建议:                                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │ **字段提取规则**                                  │   │
│  │                                                  │   │
│  │ **title (必需)**                                 │   │
│  │ - 必须存在，如果找不到标记 confidence=low        │   │
│  │                                                  │   │
│  │ **time (可选)**                                  │   │
│  │ - 只提取绝对时间 (YYYY-MM-DD HH:mm)              │   │
│  │ - 相对时间（如"明天"）设为 null                  │   │
│  │                                                  │   │
│  │ **location (可选)**                              │   │
│  │ - 物理地点: 直接提取                             │   │
│  │ - 在线会议: 识别工具名，提取为 "online (工具名)" │   │
│  │ - 未提及: 设为 null                              │   │
│  │                                                  │   │
│  │ **attendees (可选)**                             │   │
│  │ - ⚠️ 高风险字段，容易产生幻觉                    │   │
│  │ - 只有明确提及时才提取（如"仅限会员"）           │   │
│  │ - 如果只是活动类型（如"技术分享会"），不要推测   │   │
│  │ - 未明确提及: 必须设为 null                      │   │
│  └─────────────────────────────────────────────────┘   │
│                                                          │
│  理由:                                                   │
│  1. 不同字段的重要性和风险不同，应该分别说明             │
│  2. attendees 是幻觉高发区，需要强调"禁止推测"           │
│  3. 提供具体示例（"在线会议"、"相对时间"）更清晰         │
│                                                          │
│  [应用建议] [修改后再应用] [忽略]                        │
└─────────────────────────────────────────────────────────┘
```

---

### 4.5 版本管理与回滚（Version Control）

#### 功能目标
自动保存每次 Prompt 修改，支持任意版本对比和回滚。

#### 版本历史界面

```
┌─────────────────────────────────────────────────────────┐
│  Prompt 版本历史                                         │
│                                                          │
│  场景: 事件提取 (event_extraction)                       │
│                                                          │
│  版本    时间              改动         通过率    幻觉率  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  v5 ⭐  01-03 16:20  优化示例格式    93.3%  ↓ 3.3%  ✅  │ ← 当前最佳
│  v4     01-03 15:10  添加边界案例    90.0%  ↓ 5.0%      │
│  v3     01-03 14:35  修复幻觉问题    86.7%  ↓ 6.7%      │
│  v2     01-03 10:22  添加置信度      73.3%    16.7%     │
│  v1     01-02 18:45  初始版本        60.0%    23.3%     │
│                                                          │
│  [查看详情] [对比任意两版本] [回滚到选定版本]            │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  改进趋势图                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  通过率                                                  │
│  100% ┤                                        ●v5       │
│   90% ┤                              ●v4      ╱          │
│   80% ┤                    ●v3      ╱                    │
│   70% ┤          ●v2      ╱                              │
│   60% ┤ ●v1     ╱                                        │
│   50% ┼─────────────────────────────────────────>        │
│       v1    v2    v3    v4    v5                         │
│                                                          │
│  幻觉率                                                  │
│   25% ┤ ●v1                                              │
│   20% ┤  ╲                                               │
│   15% ┤   ╲●v2                                           │
│   10% ┤    ╲    ●v3                                      │
│    5% ┤     ╲     ╲ ●v4                                  │
│    0% ┼──────╲─────╲──●v5───────────────────>           │
│       v1    v2    v3    v4    v5                         │
│                                                          │
│  关键里程碑:                                             │
│  • v2→v3: 修复 attendees 幻觉问题 (16.7% → 6.7%)        │
│  • v3→v4: 添加边界案例处理 (86.7% → 90.0%)              │
│  • v4→v5: 优化示例格式，达到生产可用 (90% → 93%) ✅     │
└─────────────────────────────────────────────────────────┘
```

#### 自动回归测试

每次保存新版本 Prompt 时，自动触发：

```
┌─────────────────────────────────────────────────────────┐
│  正在评估 v6...                                          │
│                                                          │
│  [████████████████████████░░░░░░░░] 70% (21/30)         │
│                                                          │
│  当前结果:                                               │
│  • 通过率: 90.5% (预计完成后 ~91%)                       │
│  • 幻觉率: 4.8% ✅ (比 v5 更好)                          │
│  • 遗漏率: 9.5% ⚠️ (比 v5 略差)                         │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  实时反馈                                                │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  ✅ case-001 通过 (正式邀请函)                           │
│  ✅ case-002 通过 (活动海报)                             │
│  ❌ case-003 失败 (口头通知) - 新增失败！                │
│     原因: time 提取失败，可能是规则过严                  │
│  ✅ case-004 通过 (边界案例)                             │
│  ...                                                     │
│                                                          │
│  ⚠️ 检测到回归: case-003 在 v5 中通过，v6 中失败         │
│                                                          │
│  [查看失败详情] [停止评估] [继续]                        │
└─────────────────────────────────────────────────────────┘
```

评估完成后：

```
┌─────────────────────────────────────────────────────────┐
│  评估完成: v6                                            │
│                                                          │
│  总体评分: 90.0% (27/30)                                 │
│                                                          │
│  对比 v5:                                                │
│  • 通过率: 93.3% → 90.0% (-3.3%) ⚠️                     │
│  • 幻觉率: 3.3% → 4.8% (+1.5%) ⚠️                       │
│  • 遗漏率: 6.7% → 5.2% (-1.5%) ✅                       │
│                                                          │
│  ⚠️ v6 在整体上表现不如 v5，建议回滚。                   │
│                                                          │
│  详细分析:                                               │
│  • 新失败: 1 个 (case-003, time 提取过严)                │
│  • 新通过: 0 个                                          │
│  • 净变化: -1                                            │
│                                                          │
│  可能原因:                                               │
│  你在 v6 中添加了更严格的时间验证规则（"相对时间必须设为  │
│  null"），导致一些原本能推断的时间被误判。               │
│                                                          │
│  建议:                                                   │
│  1. 回滚到 v5 ✅ (保持最佳性能)                          │
│  2. 修改 v6，放宽时间验证规则                            │
│  3. 保存 v6 但标记为"实验性" (不用于生产)                │
│                                                          │
│  [回滚到 v5] [修改 v6] [强制保存 v6]                     │
└─────────────────────────────────────────────────────────┘
```

---

### 4.6 Copilot 集成（AI-Assisted Analysis）

#### 功能目标
让 Copilot 基于你的标注数据，自动分析失败模式并生成改进建议。

#### 触发时机

1. **手动触发**: 点击"让 Copilot 分析"按钮
2. **自动触发**: 标注满 10 个案例后，自动弹出分析
3. **版本对比**: 切换版本时，显示"为什么这个版本更好/更差"

#### 分析报告格式

```typescript
interface CopilotAnalysis {
  summary: {
    total_cases: number;
    analyzed_cases: number;
    patterns_found: number;
  };
  
  patterns: FailurePattern[];  // 失败模式（按严重程度排序）
  
  root_causes: {
    type: 'prompt_issue' | 'model_limitation' | 'data_quality';
    description: string;
    affected_cases: string[];
    severity: 'critical' | 'high' | 'medium' | 'low';
  }[];
  
  suggestions: {
    priority: 'P0' | 'P1' | 'P2';
    action: 'add_constraint' | 'add_example' | 'restructure' | 'change_model';
    description: string;
    estimated_improvement: string;  // 如 "+10% pass rate, -5% hallucination"
    code_snippet?: string;  // 具体的 Prompt 改动
  }[];
  
  trade_offs: {
    if_apply_suggestion: string;
    pros: string[];
    cons: string[];
  }[];
}
```

#### 分析报告 UI

```
┌─────────────────────────────────────────────────────────┐
│  Copilot 分析报告                                        │
│  基于 30 个测试案例（包含 12 个人工标注）                 │
│  生成时间: 2026-01-03 16:45                              │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  关键发现 (3 个)                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                          │
│  🔴 P0: attendees 字段幻觉率高 (23.3%)                   │
│     影响: 7 个案例 (case-003, 005, 008, 012, 018, ...)  │
│     根本原因: Prompt 未明确禁止基于活动类型推测参会人     │
│     改进预期: -15% 幻觉率                                │
│     [查看详情] [应用修复]                                │
│                                                          │
│  🟡 P1: 隐式地点提取失败 (10.0%)                         │
│     影响: 3 个案例 (case-007, 012, 015)                  │
│     模式: "腾讯会议"、"Zoom"等未识别为 online            │
│     改进预期: +10% 通过率                                │
│     [查看详情] [应用修复]                                │
│                                                          │
│  🟢 P2: 相对时间处理不一致                               │
│     影响: 2 个案例 (case-021, 024)                       │
│     模式: 有时推断具体时间，有时返回 null                │
│     改进预期: +6.7% 一致性                               │
│     [查看详情] [应用修复]                                │
│                                                          │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  详细分析: P0 - attendees 幻觉问题                       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                          │
│  失败案例模式:                                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 输入类型          AI 输出            应该输出     │   │
│  ├─────────────────────────────────────────────────┤   │
│  │ "技术分享会"      "技术部"          null         │   │
│  │ "产品评审会"      "产品团队"        null         │   │
│  │ "年度总结会"      "全体员工"        null         │   │
│  │ "新人培训"        "新入职员工"      null         │   │
│  └─────────────────────────────────────────────────┘   │
│                                                          │
│  根本原因:                                               │
│  AI 根据活动名称推测了参会人，这是典型的"过度推断"。      │
│  当前 Prompt 只说"找不到就设为 null"，但没有明确禁止     │
│  "从活动类型推断参会人"。                                │
│                                                          │
│  推荐方案:                                               │
│  在 Prompt 的 attendees 部分添加：                       │
│  ┌─────────────────────────────────────────────────┐   │
│  │ **attendees (可选)**                             │   │
│  │ ⚠️ **高风险字段，严格遵守以下规则**:              │   │
│  │                                                  │   │
│  │ **可以提取的情况**:                              │   │
│  │ ✅ "仅限会员参加" → "会员"                       │   │
│  │ ✅ "技术部全体成员" → "技术部全体成员"            │   │
│  │ ✅ "已报名人员" → "已报名人员"                    │   │
│  │                                                  │   │
│  │ **禁止提取的情况**:                              │   │
│  │ ❌ "技术分享会" → 不要推测为"技术部"              │   │
│  │ ❌ "全员会议" → 不要推测为"全体员工"              │   │
│  │ ❌ 活动类型本身 → 不要当作参会人范围              │   │
│  │                                                  │   │
│  │ 判断标准: 原文是否**明确限定了参会范围**？        │   │
│  │ - 如果只是活动名称，必须设为 null                │   │
│  │ - 如果有"仅限"、"全体"、"所有"等限定词，才提取   │   │
│  └─────────────────────────────────────────────────┘   │
│                                                          │
│  预期效果:                                               │
│  • 修复 7 个幻觉案例                                     │
│  • 幻觉率: 23.3% → 8.3% (-15%)                          │
│  • 通过率: 73.3% → 86.7% (+13.4%)                       │
│                                                          │
│  潜在风险:                                               │
│  ⚠️ 如果约束过严，可能导致一些真实的参会人信息被忽略。   │
│     建议: 应用后重新评估，关注遗漏率是否上升。           │
│                                                          │
│  [应用此修复] [修改后应用] [查看相似案例] [忽略]         │
└─────────────────────────────────────────────────────────┘
```

#### 一键应用修复

点击"应用此修复"后：

```
┌─────────────────────────────────────────────────────────┐
│  正在应用修复...                                         │
│                                                          │
│  [████████████████░░░░] 80%                             │
│                                                          │
│  步骤:                                                   │
│  ✅ 1. 备份当前 Prompt (v3)                              │
│  ✅ 2. 应用 Copilot 建议                                 │
│  ✅ 3. 创建新版本 (v4)                                   │
│  ⏳ 4. 运行回归测试 (25/30 完成)                         │
│  ⏸  5. 生成对比报告                                     │
│                                                          │
│  初步结果 (25个案例):                                    │
│  • 修复的幻觉案例: 6/7 ✅                                │
│  • 新增失败: 0 ✅                                        │
│  • 遗漏率变化: +0% (无影响) ✅                           │
│                                                          │
│  预计还需 15 秒...                                       │
└─────────────────────────────────────────────────────────┘
```

完成后自动跳转到"版本对比"界面，展示 v3 vs v4 的详细对比。

---

### 4.7 导出与分享（Export & Share）

#### 功能目标
导出评估报告、测试集、Prompt 版本，便于文档记录和团队协作。

#### 导出格式

1. **Markdown 报告** (用于文档)
```markdown
# Event Extraction Prompt - Evaluation Report

**Version**: v5  
**Date**: 2026-01-03  
**Pass Rate**: 93.3% (28/30)

Key Metrics:
- Field Accuracy: 94.5%
- Hallucination Rate: 3.3% ✅
- Omission Rate: 6.7%
- Confidence Calibration: 0.89

Improvements from v4:
- Added explicit attendees constraint → Fixed 5 hallucination cases
- Refined online meeting detection → Fixed 3 omission cases

Remaining Issues:
1. Relative time handling (2 cases)
2. OCR error tolerance (1 case)

Next Steps:
- [ ] Add time inference rules
- [ ] Add OCR error correction

---
*Generated by 4DNote AI Prompt Lab*
```

2. **JSON 数据** (用于程序化处理)
```json
{
  "version": "v5",
  "timestamp": "2026-01-03T16:45:00Z",
  "test_cases": [...],
  "results": [...],
  "metrics": {...},
  "prompt": "..."
}
```

3. **CSV 测试集** (用于Excel分析)
```csv
case_id,type,difficulty,input,expected_title,expected_time,...,actual_title,actual_time,...,passed,score
case-001,formal,easy,"【讲座通知】...","AI技术分享","2026-01-05 14:00",...,"AI技术分享","2026-01-05 14:00",...,true,10
```

---

## 五、技术实现方案

### 5.1 项目结构

```
prompt-lab/
├── frontend/                 # React 前端
│   ├── src/
│   │   ├── components/
│   │   │   ├── TestCaseList.tsx
│   │   │   ├── ComparisonView.tsx
│   │   │   ├── AnnotationPanel.tsx
│   │   │   ├── PromptEditor.tsx
│   │   │   └── VersionHistory.tsx
│   │   ├── hooks/
│   │   │   ├── useEvaluation.ts
│   │   │   └── useCopilotAnalysis.ts
│   │   ├── services/
│   │   │   ├── api.ts
│   │   │   └── websocket.ts
│   │   └── App.tsx
│   ├── package.json
│   └── tsconfig.json
│
├── backend/                  # Node.js 后端
│   ├── src/
│   │   ├── routes/
│   │   │   ├── eval.ts          # 评估相关API
│   │   │   ├── annotation.ts    # 标注相关API
│   │   │   ├── prompt.ts        # Prompt管理API
│   │   │   └── copilot.ts       # Copilot集成API
│   │   ├── services/
│   │   │   ├── EvalEngine.ts    # 评估引擎
│   │   │   ├── DataGenerator.ts # 数据生成器
│   │   │   ├── LLMService.ts    # LLM调用封装
│   │   │   └── CopilotService.ts# Copilot分析
│   │   ├── db/
│   │   │   ├── schema.ts        # 数据库Schema
│   │   │   └── migrations/
│   │   └── index.ts
│   ├── package.json
│   └── tsconfig.json
│
├── shared/                   # 共享类型定义
│   ├── types/
│   │   ├── TestCase.ts
│   │   ├── EvalResult.ts
│   │   ├── Prompt.ts
│   │   └── 4dnote/           # 4DNote特定类型
│   │       ├── Event.ts
│   │       ├── EventLog.ts
│   │       └── TakeawayCandidate.ts
│   └── tsconfig.json
│
├── prompts/                  # Prompt版本库
│   ├── event_extraction/
│   │   ├── v1.txt
│   │   ├── v2.txt
│   │   └── ...
│   ├── ai_answer/
│   └── takeaway_generation/
│
├── test-data/                # 测试集
│   ├── event_extraction/
│   │   ├── golden_set.json  # 标准测试集
│   │   └── edge_cases.json  # 边界案例
│   └── ...
│
├── docs/                     # 文档
│   ├── PRD.md               # 本文档
│   ├── API.md               # API文档
│   └── GUIDE.md             # 使用指南
│
└── package.json
```

### 5.2 数据库 Schema

```typescript
// SQLite Schema

// 测试用例表
CREATE TABLE test_cases (
  id TEXT PRIMARY KEY,
  scenario TEXT NOT NULL,  -- 'event_extraction' | 'ai_answer' | ...
  input TEXT NOT NULL,
  expected JSON NOT NULL,
  metadata JSON NOT NULL,  -- { type, difficulty, tags }
  created_at INTEGER NOT NULL
);

// Prompt版本表
CREATE TABLE prompts (
  id TEXT PRIMARY KEY,
  scenario TEXT NOT NULL,
  version TEXT NOT NULL,
  content TEXT NOT NULL,
  parent_version TEXT,     -- 基于哪个版本
  created_at INTEGER NOT NULL,
  UNIQUE(scenario, version)
);

// 评估结果表
CREATE TABLE eval_results (
  id TEXT PRIMARY KEY,
  prompt_id TEXT NOT NULL,
  test_case_id TEXT NOT NULL,
  output JSON NOT NULL,
  metrics JSON NOT NULL,   -- { field_accuracy, confidence, ... }
  passed BOOLEAN NOT NULL,
  created_at INTEGER NOT NULL,
  FOREIGN KEY (prompt_id) REFERENCES prompts(id),
  FOREIGN KEY (test_case_id) REFERENCES test_cases(id)
);

// 人工标注表
CREATE TABLE annotations (
  id TEXT PRIMARY KEY,
  eval_result_id TEXT NOT NULL,
  score INTEGER NOT NULL,  -- 0-10
  failure_reasons JSON,    -- ['hallucination', 'omission', ...]
  comment TEXT,
  annotator TEXT,          -- 标注人
  created_at INTEGER NOT NULL,
  FOREIGN KEY (eval_result_id) REFERENCES eval_results(id)
);

// Copilot分析表
CREATE TABLE copilot_analyses (
  id TEXT PRIMARY KEY,
  prompt_id TEXT NOT NULL,
  analysis JSON NOT NULL,  -- CopilotAnalysis 结构
  created_at INTEGER NOT NULL,
  FOREIGN KEY (prompt_id) REFERENCES prompts(id)
);
```

### 5.3 核心API设计

```typescript
// API接口定义

// 1. 评估相关
POST /api/eval/run
  Body: { promptId: string, testCaseIds?: string[] }
  Response: { evalId: string, status: 'running' }

GET /api/eval/:evalId/status
  Response: { status: 'running' | 'completed', progress: number, results?: EvalResult[] }

GET /api/eval/:evalId/results
  Response: { metrics: EvalMetrics, results: EvalResult[], compareTo?: string }

// 2. 标注相关
POST /api/annotation
  Body: { evalResultId: string, score: number, reasons: string[], comment: string }
  Response: { annotationId: string }

GET /api/annotation/batch-suggestions
  Response: { patterns: FailurePattern[], suggestedAnnotations: { evalResultId: string, reason: string }[] }

// 3. Prompt管理
GET /api/prompt/:scenario
  Response: { prompts: Prompt[], current: string }

POST /api/prompt
  Body: { scenario: string, content: string, parentVersion?: string }
  Response: { promptId: string, version: string }

GET /api/prompt/:id/diff/:compareToId
  Response: { diff: string, metricsComparison: {...} }

POST /api/prompt/:id/rollback
  Response: { newPromptId: string }

// 4. Copilot集成
POST /api/copilot/analyze
  Body: { promptId: string, annotationIds: string[] }
  Response: { analysis: CopilotAnalysis }

POST /api/copilot/apply-suggestion
  Body: { promptId: string, suggestionId: string }
  Response: { newPromptId: string, evalId: string }

// 5. 数据生成
POST /api/data-generator/generate
  Body: { config: DataGeneratorConfig }
  Response: { testCaseIds: string[] }

GET /api/data-generator/templates
  Response: { templates: Template[] }

// 6. 4DNote集成
GET /api/4dnote/events
  Query: { limit: number, startDate: string }
  Response: { events: Event[] }

POST /api/4dnote/transform-to-test-case
  Body: { eventId: string, transformConfig: {...} }
  Response: { testCaseId: string }
```

### 5.4 关键技术选型

| 模块 | 技术选择 | 理由 |
|------|---------|------|
| **Frontend** | React + TypeScript + Tailwind | 快速开发，类型安全，Copilot友好 |
| **State Management** | Zustand | 轻量级，比Redux简单 |
| **Code Editor** | Monaco Editor | VS Code同款，支持语法高亮 |
| **Diff View** | react-diff-viewer | 美观的对比视图 |
| **Backend** | Node.js + Express | 与前端同语言，易于维护 |
| **Database** | SQLite | 轻量级，本地部署，无需配置 |
| **LLM SDK** | 统一封装 | 支持多个提供商（DashScope/混元/Ollama） |
| **WebSocket** | Socket.io | 实时推送评估进度 |
| **Charts** | Recharts | 声明式图表，易于集成 |

---

## 六、开发路线图

### Phase 1: MVP（1-2 周）

**目标**: 基础评估功能 + 手动标注

- [x] 项目脚手架搭建
- [x] 数据库Schema设计
- [ ] 评估引擎核心逻辑
  - [ ] 运行测试集
  - [ ] 计算基础指标（通过率、幻觉率）
  - [ ] 生成评估报告
- [ ] 前端基础界面
  - [ ] 测试用例列表
  - [ ] 输入/输出对比视图
  - [ ] 简单的手动打分UI
- [ ] Prompt编辑器（基于Monaco）
- [ ] 测试集管理（增删改查）

**验收标准**:
- 能运行一个包含30个案例的测试集
- 能手动标注失败案例
- 能在编辑器里改Prompt并重新评估

---

### Phase 2: 数据生成 + Copilot集成（1-2 周）

**目标**: 自动化数据生成 + AI辅助分析

- [ ] 数据生成器
  - [ ] 基于模板生成
  - [ ] 从4DNote真实数据变形
  - [ ] 边界案例库
- [ ] Copilot集成
  - [ ] 失败案例聚类
  - [ ] 根因分析
  - [ ] 改进建议生成
  - [ ] 一键应用修复
- [ ] 批量标注功能
- [ ] 证据链追踪（显示AI推理过程）

**验收标准**:
- 能一键生成30个测试案例
- Copilot能分析失败案例并给出建议
- 能应用建议并自动重新评估

---

### Phase 3: 版本管理 + 对比分析（1 周）

**目标**: Prompt版本化 + 迭代优化

- [ ] Prompt版本管理
  - [ ] 自动版本号
  - [ ] 版本历史查看
  - [ ] 任意版本对比
  - [ ] 一键回滚
- [ ] 对比分析
  - [ ] 并排对比视图
  - [ ] 改进趋势图
  - [ ] 回归测试
- [ ] 导出功能
  - [ ] Markdown报告
  - [ ] JSON数据
  - [ ] CSV测试集

**验收标准**:
- 每次修改Prompt自动创建新版本
- 能对比任意两个版本的性能
- 能导出完整的评估报告

---

### Phase 4: 优化与生产准备（1 周）

**目标**: 性能优化 + 用户体验打磨

- [ ] 性能优化
  - [ ] 并发评估（多案例同时跑）
  - [ ] 缓存LLM响应
  - [ ] 懒加载大列表
- [ ] UX改进
  - [ ] 快捷键支持
  - [ ] 撤销/重做
  - [ ] 自动保存标注
  - [ ] 暗色模式
- [ ] 文档完善
  - [ ] API文档
  - [ ] 使用指南
  - [ ] 视频教程
- [ ] 测试
  - [ ] 单元测试（核心逻辑）
  - [ ] E2E测试（关键流程）

**验收标准**:
- 30个案例评估时间 < 30秒
- 关键操作都有快捷键
- 文档完善，新人能30分钟上手

---

## 七、关键指标与成功标准

### 7.1 平台本身的指标

| 指标 | 目标值 | 测量方法 |
|------|--------|---------|
| **评估速度** | < 1秒/案例 | 时间戳差值 |
| **标注效率** | < 30秒/案例 | 用户操作时长统计 |
| **Copilot准确率** | > 80% | 人工验证建议是否有效 |
| **版本回滚率** | < 10% | 回滚次数 / 总版本数 |

### 7.2 Prompt质量指标（使用平台后）

| 指标 | 基线 | 目标 | 实际 |
|------|------|------|------|
| **通过率** | 60% | > 90% | \_\_% |
| **幻觉率** | 23% | < 5% | \_\_% |
| **遗漏率** | 15% | < 10% | \_\_% |
| **置信度校准** | 0.6 | > 0.85 | \_\_ |

### 7.3 开发效率指标

| 场景 | 传统方式 | 使用平台 | 提升 |
|------|---------|---------|------|
| **调试一个Prompt** | 2-3天 | 4-6小时 | **5x** |
| **发现失败模式** | 1天（手动翻日志） | 5分钟（自动聚类） | **100x** |
| **版本对比** | 30分钟（写脚本） | 1分钟（点击按钮） | **30x** |

---

## 八、风险与应对

### 8.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| **LLM API不稳定** | 评估中断 | 中 | 实现重试机制 + 本地缓存 |
| **Copilot分析质量差** | 建议无效 | 中 | 人工审核 + 反馈循环改进 |
| **数据库文件损坏** | 数据丢失 | 低 | 自动备份 + 导出功能 |

### 8.2 产品风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| **学习曲线过陡** | 用户放弃 | 中 | 提供向导模式 + 视频教程 |
| **过度依赖自动化** | 错误建议被盲目应用 | 中 | 强制人工审核 + 警告提示 |

---

## 九、FAQ

### Q1: 为什么要自建平台，而不用Braintrust？
**A**: 
1. **本地数据**: 需要基于4DNote的真实数据结构生成测试数据
2. **深度定制**: 需要特定的评分维度（幻觉率、遗漏率、置信度校准）
3. **Copilot集成**: 需要与本地Copilot深度集成，实现"标注→分析→修复"闭环
4. **离线可用**: 4DNote是本地应用，需要完全离线工作

### Q2: 为什么不担心AI功能的调试？
**A**:
1. **方法论成熟**: Eval-Driven Development已被验证有效
2. **工具支撑**: 有了这个平台，调试效率提升5x
3. **可度量**: 每次改动都能看到量化的改进/退步
4. **可回滚**: 版本管理确保不会"越改越差"
5. **AI辅助**: Copilot能分析失败模式，不是全靠人工

**关键洞察**: AI功能调试难，不是因为"改Prompt难"，而是因为"不知道怎么科学地度量和迭代"。有了评估平台，就有了科学方法。

### Q3: 数据生成器如何确保质量？
**A**:
1. **人工审核**: 生成后必须人工审核标注
2. **真实数据优先**: 优先从4DNote真实数据变形
3. **困难案例覆盖**: 专门设计边界案例库
4. **持续更新**: 真实使用中发现的问题案例持续加入测试集

### Q4: 如果Copilot给出的建议是错的怎么办？
**A**:
1. **不自动应用**: 所有建议都需要人工点击"应用"
2. **显示预期效果**: 应用前显示"预期改进+10%"
3. **自动回归测试**: 应用后立即评估，如果退步会警告
4. **一键回滚**: 可以随时回到上一个版本

### Q5: 这个平台的投资回报率（ROI）如何？
**A**:
- **开发成本**: 4-6周（包含学习曲线）
- **每个AI功能的调试时间**: 从2-3天 → 4-6小时
- **4DNote计划开发的AI功能**: 4个（事件提取、AI Answer、Takeaway生成、Daily Review）
- **节省时间**: 4 × (2天 - 0.5天) = **6天**
- **长期价值**: 后续新增AI功能都能复用这套体系

**结论**: 在第2个AI功能调试时就能回本，长期ROI > 10x

---

## 十、交付给Copilot的任务清单

### 第一阶段：脚手架搭建（30分钟）

**任务**: 生成基础项目结构

**Prompt给Copilot**:
```
请帮我创建一个 AI Prompt 调试平台的项目脚手架，要求：

技术栈:
- Frontend: React + TypeScript + Vite + Tailwind CSS
- Backend: Node.js + Express + TypeScript
- Database: better-sqlite3
- Monorepo: 使用 pnpm workspace

项目结构:
- frontend/ (React app)
- backend/ (Node.js API)
- shared/ (共享类型定义)

初始化配置:
- TypeScript 严格模式
- ESLint + Prettier
- 基础的 package.json 脚本

生成后我能立即运行 `pnpm install` 和 `pnpm dev`。
```

---

### 第二阶段：数据库设计（1小时）

**任务**: 实现数据库Schema和基础CRUD

**Prompt给Copilot**:
```
基于PRD的"5.2 数据库Schema"部分，帮我实现：

1. database/schema.sql - SQLite建表语句
2. backend/src/db/Database.ts - 数据库封装类
3. backend/src/db/repositories/ - 数据访问层
   - TestCaseRepository.ts
   - PromptRepository.ts
   - EvalResultRepository.ts
   - AnnotationRepository.ts

要求:
- 使用 better-sqlite3
- 所有方法都有类型定义
- 支持事务
- 自动初始化（首次运行自动建表）

示例:
const db = new Database('./data/prompt-lab.db');
const testCase = await db.testCases.create({ scenario: 'event_extraction', input: '...', expected: {...} });
```

---

### 第三阶段：评估引擎核心（2-3小时）

**任务**: 实现评估引擎的核心逻辑

**Prompt给Copilot**:
```
实现评估引擎，参考PRD "4.2 评估引擎"部分。

需要实现:
1. backend/src/services/EvalEngine.ts
   - runEvaluation(promptId, testCaseIds): Promise<EvalResult[]>
   - calculateMetrics(results): EvalMetrics
   - compareVersions(v1, v2): VersionComparison

2. 评分维度（PRD中的 EvalMetrics）:
   - field_accuracy: 字段准确率
   - hallucination_rate: 幻觉率（值不在原文中）
   - omission_rate: 遗漏率
   - confidence_calibration: 置信度校准

3. LLM调用封装:
   - 支持多个provider（DashScope/腾讯混元/Ollama）
   - 统一的接口
   - 错误重试

示例用法:
const engine = new EvalEngine();
const results = await engine.runEvaluation('prompt-v3', ['case-001', 'case-002']);
const metrics = engine.calculateMetrics(results);
console.log(`Pass rate: ${metrics.pass_rate}`);
```

---

### 第四阶段：前端基础界面（3-4小时）

**任务**: 实现核心UI组件

**Prompt给Copilot**:
```
实现前端界面，参考PRD "4.3 标注界面" 和 "4.4 Prompt编辑器"。

需要实现:
1. src/components/TestCaseList.tsx
   - 左侧列表，显示所有测试用例
   - 通过/失败状态
   - 按类型过滤
   - 点击显示详情

2. src/components/ComparisonView.tsx
   - 并排显示期望输出 vs 实际输出
   - 高亮差异
   - 显示证据链（AI的推理过程）

3. src/components/AnnotationPanel.tsx
   - 评分滑块（0-10）
   - 失败原因多选
   - 备注文本框
   - "让AI分析"按钮

4. src/components/PromptEditor.tsx
   - 使用 @monaco-editor/react
   - 语法高亮
   - 保存/另存为按钮
   - 快速测试面板

设计风格: 使用 Tailwind CSS，参考 VS Code 的暗色主题。
```

---

### 第五阶段：数据生成器（2-3小时）

**任务**: 实现测试数据生成

**Prompt给Copilot**:
```
实现数据生成器，参考PRD "4.1 数据生成器"。

需要实现:
1. backend/src/services/DataGenerator.ts
   - generateFromTemplates(config): TestCase[]
   - generateFromRealData(events): TestCase[]
   - generateEdgeCases(): TestCase[]

2. 模板系统:
   - prompts/templates/event_extraction/
     - formal_invitation.txt
     - poster.txt
     - casual_note.txt
   - 支持变量替换 {{title}}, {{time}}, {{location}}

3. 4DNote数据集成:
   - 读取4DNote的Event数据
   - 转换成测试用例格式
   - 添加噪声/变形

示例:
const generator = new DataGenerator();
const testCases = generator.generateFromTemplates({
  scenario: 'event_extraction',
  count: 30,
  distribution: { formal: 0.3, poster: 0.4, casual: 0.2, edge: 0.1 }
});
```

---

### 第六阶段：Copilot集成（2-3小时）

**任务**: 实现AI辅助分析

**Prompt给Copilot**:
```
实现Copilot分析功能，参考PRD "4.6 Copilot集成"。

**任务**: 实现AI辅助分析

**Prompt给Copilot**:
```
实现Copilot分析功能，参考PRD "4.6 Copilot集成"。

需要实现:
1. backend/src/services/CopilotService.ts
   - analyzeFailures(annotations): Promise<CopilotAnalysis>
   - clusterFailurePatterns(failures): FailurePattern[]
   - generateSuggestions(patterns): Suggestion[]
   - applySuggestion(promptId, suggestionId): Promise<string>

2. 分析流程:
   Step 1: 聚类失败案例（按错误类型+字段分组）
   Step 2: 调用 LLM 分析每个模式的根本原因
   Step 3: 生成具体的 Prompt 改进建议（包含代码片段）
   Step 4: 评估改进的预期效果

3. Prompt 模板:
   - prompts/copilot/analyze_failures.txt
   - prompts/copilot/generate_suggestions.txt
   - 包含 few-shot examples

4. 应用建议:
   - 解析建议中的 Prompt 改动
   - 自动插入到正确位置
   - 创建新版本
   - 触发回归测试

示例:
const copilot = new CopilotService();
const analysis = await copilot.analyzeFailures(annotationIds);
console.log(`Found ${analysis.patterns.length} patterns`);
console.log(`Top suggestion: ${analysis.suggestions[0].description}`);

const newPromptId = await copilot.applySuggestion(promptId, suggestionId);
// 自动触发评估
```

---

### 第七阶段：版本管理（1-2小时）

**任务**: 实现Prompt版本控制

**Prompt给Copilot**:
```
实现Prompt版本管理，参考PRD "4.5 版本管理与回滚"。

需要实现:
1. backend/src/services/VersionManager.ts
   - createVersion(scenario, content, parentVersion?): Promise<Prompt>
   - listVersions(scenario): Promise<Prompt[]>
   - compareVersions(v1, v2): VersionDiff
   - rollback(versionId): Promise<Prompt>

2. 版本号生成:
   - 自动递增（v1, v2, v3...）
   - 记录父版本（用于回滚）
   - 记录创建时间和改动说明

3. 对比功能:
   - 文本差异对比（使用 diff 库）
   - 评分指标对比
   - 失败案例变化

4. 回归测试:
   - 新版本保存时自动触发
   - 与上一版本对比
   - 检测性能退步并警告

示例:
const vm = new VersionManager();
const v4 = await vm.createVersion('event_extraction', newContent, 'v3');
const diff = await vm.compareVersions('v3', 'v4');
if (diff.metrics.pass_rate_delta < 0) {
  console.warn('Performance regression detected!');
}
```

---

### 第八阶段：前端高级功能（2-3小时）

**任务**: 实现高级交互功能

**Prompt给Copilot**:
```
实现前端高级功能，参考PRD "4.3-4.7"。

需要实现:
1. src/components/VersionHistory.tsx
   - 版本列表（时间轴样式）
   - 改进趋势图（使用 recharts）
   - 版本对比视图
   - 一键回滚

2. src/components/BatchAnnotation.tsx
   - 检测相似失败案例
   - 批量标注建议
   - 批量操作确认

3. src/components/CopilotAnalysisPanel.tsx
   - 显示分析报告
   - 失败模式卡片
   - 改进建议列表
   - "应用建议"按钮（带确认）

4. src/hooks/useKeyboardShortcuts.ts
   - 实现 PRD 中定义的快捷键
   - ←/→ 切换案例
   - 1-9/0 快速打分
   - H/O/F 标记失败原因
   - Space 保存并下一个

5. src/components/QuickTestPanel.tsx (在 PromptEditor 底部)
   - 输入测试文本
   - 实时调用 LLM
   - 显示输出结果
   - 不保存到数据库

技术要求:
- 使用 Zustand 管理状态
- 使用 TanStack Query 处理异步
- 响应式设计（支持大屏幕）
```

---

### 第九阶段：导出与报告（1-2小时）

**任务**: 实现导出功能

**Prompt给Copilot**:
```
实现导出功能，参考PRD "4.7 导出与分享"。

需要实现:
1. backend/src/services/ExportService.ts
   - exportMarkdownReport(evalId): string
   - exportJSONData(evalId): object
   - exportCSVTestSet(testCaseIds): string

2. Markdown 报告模板:
   - prompts/templates/report.md
   - 包含评分、对比、改进建议等
   - 支持变量替换

3. 前端导出按钮:
   - src/components/ExportMenu.tsx
   - 下拉菜单（Markdown/JSON/CSV）
   - 点击下载文件

4. 报告内容:
   - 基本信息（版本、时间、通过率）
   - 关键指标（字段准确率、幻觉率等）
   - 对比上一版本的改进
   - 剩余问题列表
   - 下一步行动建议

示例输出 (Markdown):
```markdown
# Event Extraction Prompt - Evaluation Report

**Version**: v5
**Date**: 2026-01-03
**Pass Rate**: 93.3% (28/30)

Key Metrics:
- Field Accuracy: 94.5%
- Hallucination Rate: 3.3% ✅
- Omission Rate: 6.7%

Improvements from v4:
- Added attendees constraint → Fixed 5 cases
- Refined online meeting detection → Fixed 3 cases
...
```

---

### 第十阶段：4DNote数据集成（2-3小时）

**任务**: 与4DNote真实数据打通

**Prompt给Copilot**:
```
实现4DNote数据集成，读取真实Event数据并转换为测试用例。

需要实现:
1. shared/types/4dnote/Event.ts
   - 定义4DNote的Event类型（基于timestamp node架构）
   - EventLog类型
   - TakeawayCandidate类型

2. backend/src/services/FourDNoteAdapter.ts
   - readEvents(dbPath): Promise<Event[]>
   - transformEventToTestCase(event, config): TestCase
   - addNoise(text, level): string  // 添加OCR错误、错别字等

3. 转换策略:
   - 从Event中提取关键字段（title, timestamp, location等）
   - 序列化为文本（模拟邀请函格式）
   - 可选：添加噪声（removeFields, addTypos, scrambleFormat）
   - 生成expected输出（基于原始Event）

4. 前端界面:
   - src/components/DataImportPanel.tsx
   - 选择4DNote数据库文件
   - 配置转换选项
   - 预览生成的测试用例
   - 导入到测试集

示例:
const adapter = new FourDNoteAdapter();
const events = await adapter.readEvents('/path/to/4dnote.db');
const testCases = events.map(e => 
  adapter.transformEventToTestCase(e, {
    removeFields: Math.random() > 0.7 ? ['location'] : [],
    addTypos: true,
    noiseLevel: 0.1
  })
);
```

---

### 第十一阶段：性能优化（1-2小时）

**任务**: 优化评估性能

**Prompt给Copilot**:
```
实现性能优化，参考PRD "Phase 4: 优化与生产准备"。

需要实现:
1. 并发评估:
   - backend/src/services/EvalEngine.ts 中添加并发逻辑
   - 使用 Promise.all() 同时运行多个案例
   - 限制并发数（如最多10个）
   - 进度报告（通过 WebSocket 推送）

2. 结果缓存:
   - backend/src/services/CacheService.ts
   - 缓存 LLM 响应（key = hash(prompt + input)）
   - 使用 SQLite 存储（表: llm_cache）
   - 设置过期时间（如7天）

3. 前端优化:
   - src/components/TestCaseList.tsx 使用虚拟滚动
   - 懒加载测试用例详情
   - 防抖搜索/过滤

4. WebSocket 实时推送:
   - backend/src/websocket.ts
   - 评估进度推送
   - 完成后推送结果
   - 前端实时更新进度条

示例:
const engine = new EvalEngine({ concurrency: 10 });
engine.on('progress', ({ current, total }) => {
  ws.emit('eval:progress', { current, total, percent: current/total });
});
const results = await engine.runEvaluation(promptId, testCaseIds);
```

---

### 第十二阶段：文档与测试（1-2小时）

**任务**: 完善文档和测试

**Prompt给Copilot**:
```
实现文档和测试，参考PRD "Phase 4"。

需要实现:
1. docs/API.md
   - 所有API端点的文档
   - 请求/响应示例
   - 错误码说明

2. docs/GUIDE.md
   - 快速开始（5分钟上手）
   - 核心概念（Eval-Driven Development）
   - 常见场景（调试事件提取、修复幻觉等）
   - 最佳实践

3. 单元测试:
   - backend/tests/EvalEngine.test.ts
   - backend/tests/DataGenerator.test.ts
   - backend/tests/CopilotService.test.ts
   - 使用 Vitest

4. E2E测试:
   - tests/e2e/eval-workflow.spec.ts
   - 测试完整的"生成测试集 → 运行评估 → 标注 → Copilot分析"流程
   - 使用 Playwright

示例测试:
import { describe, it, expect } from 'vitest';
import { EvalEngine } from '../src/services/EvalEngine';

describe('EvalEngine', () => {
  it('should calculate field accuracy correctly', () => {
    const results = [
      { expected: { title: 'A' }, actual: { title: 'A' } }, // correct
      { expected: { title: 'A' }, actual: { title: 'B' } }, // wrong
    ];
    const metrics = EvalEngine.calculateMetrics(results);
    expect(metrics.field_accuracy.overall).toBe(0.5);
  });
});
```

---

## 十一、给Copilot的完整初始化Prompt

当你准备好开始开发时，把以下内容发给Copilot：

```markdown
# 项目初始化：4DNote AI Prompt Lab

## 背景
我需要开发一个 Prompt 调试和评估平台，用于优化 4DNote 的 AI 功能（事件提取、AI Answer等）。完整的 PRD 文档已经准备好。

## 技术栈
- Frontend: React 18 + TypeScript + Vite + Tailwind CSS
- Backend: Node.js + Express + TypeScript
- Database: SQLite (better-sqlite3)
- Monorepo: pnpm workspace
- Code Editor: Monaco Editor
- Charts: Recharts
- State: Zustand
- Async: TanStack Query

## 项目结构
```
prompt-lab/
├── frontend/          # React app
├── backend/           # Node.js API
├── shared/            # 共享类型
├── prompts/           # Prompt 版本库
├── test-data/         # 测试集
└── docs/              # 文档
```

## 第一步：生成项目脚手架

请帮我：
1. 创建 monorepo 结构（使用 pnpm workspace）
2. 配置 TypeScript（严格模式）
3. 配置 ESLint + Prettier
4. 添加基础依赖：
   - Frontend: react, react-dom, vite, tailwindcss, zustand, @tanstack/react-query, @monaco-editor/react, recharts
   - Backend: express, better-sqlite3, cors, ws (WebSocket)
   - Shared: zod (类型验证)
5. 设置启动脚本：
   - `pnpm dev`: 同时启动前后端
   - `pnpm build`: 构建生产版本

生成后，我应该能运行 `pnpm install && pnpm dev` 立即看到一个空白页面。

## 关键要求
- 所有代码都要有 TypeScript 类型
- 使用 async/await（不用 .then()）
- 前端组件使用函数式 + Hooks
- 后端使用 Express Router 分模块
- 数据库操作都封装在 Repository 层

## 下一步
脚手架完成后，我会给你具体的功能需求（从数据库设计开始）。

准备好了吗？请开始生成项目脚手架。
```

---

## 十二、逐步开发的 Copilot 对话模板

以下是给Copilot的完整对话模板，可以按顺序使用：

### 对话1：数据库设计

**给Copilot的消息：**

```
@workspace 现在实现数据库层。

参考 PRD 的 "5.2 数据库 Schema" 部分。

需要：
1. 在 backend/src/db/schema.sql 定义表结构（4个表：test_cases, prompts, eval_results, annotations）
2. 在 backend/src/db/Database.ts 实现数据库封装类
3. 在 backend/src/db/repositories/ 实现4个 Repository

要求：
- 使用 better-sqlite3
- 自动初始化（首次运行创建表）
- 所有方法返回类型化的对象
- 支持事务

示例用法：
  const db = new Database('./data/prompt-lab.db');
  const testCase = await db.testCases.create({
    scenario: 'event_extraction',
    input: '【讲座通知】...',
    expected: { title: 'AI技术分享', ... },
    metadata: { type: 'formal_invitation', difficulty: 'easy' }
  });

请先显示 schema.sql 的内容，然后我确认后再生成其他文件。
```

---

### 对话2：评估引擎

**给Copilot的消息：**

```
@workspace 现在实现评估引擎核心逻辑。

参考 PRD 的 "4.2 评估引擎" 部分。

在 backend/src/services/EvalEngine.ts 实现：

核心方法：
  class EvalEngine {
    async runEvaluation(promptId: string, testCaseIds: string[]): Promise<EvalResult[]>
    calculateMetrics(results: EvalResult[]): EvalMetrics
  }

关键逻辑：
- 幻觉检测：检查 output.field.value 是否在 input 中
- 遗漏检测：检查 expected 中有值但 output 中为 null 的字段
- 置信度校准：比较 confidence=high 的案例的实际准确率

同时实现 LLMService.ts 封装 API 调用（先支持一个 provider，后续再扩展）。
```

---

### 对话3：前端基础界面

**给Copilot的消息：**

```
@workspace 现在实现前端核心组件。

需要3个主要组件：

1. TestCaseList.tsx (左侧列表)
   - 显示测试用例列表
   - 状态图标（✅/❌）
   - 点击选中，高亮当前
   - 过滤器（按类型、通过/失败）

2. ComparisonView.tsx (中间对比区)
   - 上方：输入文本（只读）
   - 下方：期望 vs 实际（两列）
   - 差异高亮（红色=错误，绿色=正确）

3. AnnotationPanel.tsx (右侧标注区)
   - 评分滑块（0-10）
   - 失败原因复选框（幻觉/遗漏/格式/其他）
   - 备注文本框
   - 保存按钮

布局：三列式（TestCaseList 20%，ComparisonView 50%，AnnotationPanel 30%）
使用 Tailwind CSS，暗色主题（bg-gray-900）。
```

---

### 对话4：Prompt编辑器

**给Copilot的消息：**

```
@workspace 现在实现 Prompt 编辑器。

在 frontend/src/components/PromptEditor.tsx：

要求：
1. 使用 @monaco-editor/react
2. 语法高亮（语言选 markdown）
3. 暗色主题（vs-dark）
4. 顶部工具栏：版本下拉、保存按钮、另存为新版本、对比视图
5. 底部测试面板：输入框（快速测试）、测试按钮、输出显示区

功能：能实时编辑Prompt，点击测试按钮快速验证输出。
```

---

### 对话5：数据生成器

**给Copilot的消息：**

```
@workspace 现在实现数据生成器。

在 backend/src/services/DataGenerator.ts：

需要三种生成方式：
1. generateFromTemplates - 基于模板和变量池生成
2. generateFromRealData - 从4DNote真实数据变形（添加噪声、删除字段等）
3. generateEdgeCases - 返回预定义的边界案例

模板文件在 prompts/templates/event_extraction/
使用 Mustache 语法：{{title}}, {{time}} 等

变量池定义在 templates/variables.json
```

---

### 对话6：Copilot 分析

**给Copilot的消息：**

```
@workspace 现在实现 Copilot 分析功能。

在 backend/src/services/CopilotService.ts：

核心方法：analyzeFailures(annotationIds: string[]): Promise<CopilotAnalysis>

流程：
1. 加载标注数据
2. 聚类失败案例（按 error_type + failed_field 分组）
3. 对每个模式调用 LLM 分析根因
4. 生成改进建议（包含具体的 Prompt 修改）
5. 返回结构化分析报告

创建 prompts/copilot/analyze_failures.txt 作为分析Prompt模板。
输出应包含：pattern（模式描述）、root_cause（根本原因）、suggestion（改进建议）
```

---

### 对话7：版本管理

**给Copilot的消息：**

```
@workspace 实现 Prompt 版本管理。

在 backend/src/services/VersionManager.ts：

功能：
1. 自动版本号（v1, v2, v3...）
2. 记录父版本（用于回滚）
3. 版本对比（文本diff + 指标对比）
4. 一键回滚

关键方法：
- createVersion(scenario, content, parentVersion?, changelog?)
- compareVersions(v1, v2) - 返回文本diff和指标对比
- rollback(versionId)

前端组件 VersionHistory.tsx：时间轴显示版本列表，趋势图使用 Recharts
```

---

### 对话8：性能优化

**给Copilot的消息：**

```
@workspace 优化评估性能。

需要实现：
1. 并发评估（EvalEngine.ts）- 每批10个案例并发处理
2. LLM 响应缓存（CacheService.ts）- 相同输入返回缓存结果
3. WebSocket 推送（backend/src/websocket.ts）- 实时推送评估进度
4. 虚拟滚动（TestCaseList.tsx）- 使用 @tanstack/react-virtual

目标：30个案例评估时间 < 30秒
```

---

## 十三、验收清单

在交付给你本地 Copilot 之前，确认以下清单：

### 文档完整性
- [ ] PRD 包含所有核心功能的详细设计
- [ ] 每个模块都有清晰的接口定义
- [ ] 有具体的示例代码
- [ ] 技术栈和依赖明确列出

### 可执行性
- [ ] 所有给 Copilot 的 Prompt 都是独立的、可直接使用的
- [ ] 包含预期的输入/输出示例
- [ ] 有清晰的验收标准

### 4DNote 特定需求
- [ ] Event/EventLog/TakeawayCandidate 类型定义
- [ ] timestamp node 架构说明
- [ ] 数据转换逻辑（4DNote → 测试用例）

---

## 十四、开发时的注意事项

### 给你自己的提醒

1. **逐步验证**
   - 不要一次性让 Copilot 生成所有代码
   - 每完成一个模块，运行测试确认可用
   - 先实现核心功能，再添加优化

2. **及时反馈**
   - Copilot 生成的代码有问题时，立即指出
   - 给出具体的错误信息和预期行为
   - 必要时提供修改后的代码片段作为示例

3. **保持文档同步**
   - 如果实现时发现设计不合理，更新 PRD
   - 记录重要的技术决策
   - 维护 CHANGELOG

4. **优先级管理**
   - Phase 1 (MVP) 是最高优先级
   - 高级功能（Copilot 分析、版本管理）可以后做
   - 性能优化放在最后

---

## 十五、预期时间线

| 阶段 | 工作量 | 累计时间 |
|------|--------|---------|
| **脚手架** | 30分钟 | 0.5小时 |
| **数据库** | 1小时 | 1.5小时 |
| **评估引擎** | 3小时 | 4.5小时 |
| **前端基础** | 4小时 | 8.5小时 |
| **Phase 1 完成** | - | **~2工作日** |
| **数据生成器** | 3小时 | 11.5小时 |
| **Copilot集成** | 3小时 | 14.5小时 |
| **Phase 2 完成** | - | **~3工作日** |
| **版本管理** | 2小时 | 16.5小时 |
| **前端高级** | 3小时 | 19.5小时 |
| **Phase 3 完成** | - | **~4工作日** |
| **性能优化** | 2小时 | 21.5小时 |
| **文档测试** | 2小时 | 23.5小时 |
| **Phase 4 完成** | - | **~5工作日** |

**总计**: 4-6周（假设每天投入4-5小时）

---

## 十六、成功标准

### MVP 阶段（Phase 1）
- [ ] 能创建测试集（30个案例）
- [ ] 能运行评估并看到通过率
- [ ] 能手动标注失败案例
- [ ] 能编辑 Prompt 并重新评估

### 完整版（Phase 4）
- [ ] 数据生成器能基于4DNote数据生成测试集
- [ ] Copilot 能分析失败案例并给出建议
- [ ] 应用建议后自动重跑评估
- [ ] 版本管理和回滚功能完整
- [ ] 评估速度 < 1秒/案例
- [ ] 文档完善，新人能30分钟上手

### 质量指标
- [ ] 使用平台后，Prompt 通过率从 60% → 90%+
- [ ] 幻觉率 < 5%
- [ ] 调试时间从 2-3天 → 4-6小时

---

## 十七、总结：为什么这个PRD对Copilot友好？

### 1. 结构化
- 每个功能都有明确的边界
- 接口定义清晰（输入/输出/类型）
- 依赖关系明确（先做数据库，再做评估引擎）

### 2. 可执行
- 包含具体的代码示例
- 每个模块都有独立的验收标准
- Prompt 模板直接可用

### 3. 迭代友好
- 分阶段开发（MVP → 完整版）
- 每个阶段都有独立的价值
- 可以随时停下来评估效果

### 4. 4DNote 特定
- 包含真实的数据结构
- 考虑了实际的使用场景
- 与现有系统集成的方案清晰

---

**现在，你可以把这个 PRD 交给本地 Copilot，开始构建你的 Prompt Lab 了！**

祝开发顺利！如果在实现过程中遇到问题，可以随时回来参考这个文档，或者向我提问。🚀