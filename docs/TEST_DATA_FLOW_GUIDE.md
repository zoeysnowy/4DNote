# 4DNote æ•°æ®æµæµ‹è¯•å·¥å…· - ä½¿ç”¨æŒ‡å—

## ğŸ“Œ æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª**å…¨é¢çš„æ•°æ®æµæµ‹è¯•è„šæœ¬**ï¼Œç”¨äºéªŒè¯ 4DNote æ‰€æœ‰æ¨¡å—ä¸ EventService Hub çš„æ•°æ®äº¤äº’æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿å­˜å‚¨æ¶æ„ï¼ˆIndexedDB + SQLite + LRU Cacheï¼‰æŒ‰é¢„æœŸå·¥ä½œã€‚

---

## ğŸ¯ æµ‹è¯•èŒƒå›´

### è¦†ç›–çš„æ¨¡å—ï¼ˆ10 ä¸ªæµ‹è¯•å¥—ä»¶ï¼‰

| æ¨¡å— | æµ‹è¯•å†…å®¹ | æµ‹è¯•ç”¨ä¾‹æ•° |
|------|----------|-----------|
| **1. å­˜å‚¨æ¶æ„** | IndexedDB + SQLite + LRU Cache | 6 |
| **2. EventService Hub** | CRUD + äº‹ä»¶å¹¿æ’­ | 4 |
| **3. EventHub** | å†…å®¹/æ ‡ç­¾/é™„ä»¶ç®¡ç† | 3 |
| **4. TimeHub** | æ—¶é—´/è®¡æ—¶å™¨ç®¡ç† | 2 |
| **5. ContactService** | è”ç³»äººç®¡ç† | 4 |
| **6. TagService** | æ ‡ç­¾ç®¡ç† | 3 |
| **7. EventTree** | çˆ¶å­äº‹ä»¶å±‚çº§ | 3 |
| **8. åŒå‘é“¾æ¥** | äº‹ä»¶å…³ç³»ç½‘ç»œ | 2 |
| **9. è·¨æ¨¡å—è”åŠ¨** | å®Œæ•´äº‹ä»¶ç”Ÿå‘½å‘¨æœŸ | 2 |
| **10. æ€§èƒ½æµ‹è¯•** | æ‰¹é‡æ“ä½œï¼ˆ50 ä¸ªäº‹ä»¶ï¼‰ | 2 |

**æ€»è®¡**: çº¦ **31 ä¸ªæµ‹è¯•ç”¨ä¾‹**

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1: æµè§ˆå™¨æ§åˆ¶å°ï¼ˆæ¨èï¼‰

1. **å¯åŠ¨ 4DNote åº”ç”¨**
   ```bash
   npm run dev
   # æˆ–
   npm start
   ```

2. **æ‰“å¼€æµ‹è¯•é¡µé¢**
   ```
   http://localhost:3000/test-data-flow.html
   # æˆ– Vite ç«¯å£
   http://localhost:5173/test-data-flow.html
   ```

3. **è¿è¡Œæµ‹è¯•**
   - ç‚¹å‡»é¡µé¢ä¸Šçš„ã€ŒğŸš€ å¼€å§‹æµ‹è¯•ã€æŒ‰é’®
   - æˆ–åœ¨æµè§ˆå™¨æ§åˆ¶å°è¾“å…¥ï¼š
     ```javascript
     await window.testDataFlow()
     ```

4. **æŸ¥çœ‹ç»“æœ**
   - é¡µé¢ä¼šå®æ—¶æ˜¾ç¤ºæµ‹è¯•è¾“å‡º
   - æ§åˆ¶å°ä¼šæ˜¾ç¤ºè¯¦ç»†çš„æµ‹è¯•æ—¥å¿—
   - æµ‹è¯•å®Œæˆåæ˜¾ç¤ºé€šè¿‡ç‡

---

### æ–¹æ³• 2: ç‹¬ç«‹è„šæœ¬è¿è¡Œ

1. **åœ¨åº”ç”¨ä¸­åŠ è½½è„šæœ¬**
   ```html
   <script src="/scripts/test-data-flow-complete.js"></script>
   ```

2. **åœ¨æ§åˆ¶å°è¿è¡Œ**
   ```javascript
   await window.testDataFlow()
   ```

---

### æ–¹æ³• 3: Electron ç¯å¢ƒ

1. **å¯åŠ¨ Electron åº”ç”¨**
   ```bash
   npm run electron-dev
   ```

2. **æ‰“å¼€ DevTools**
   - å¿«æ·é”®: `Ctrl+Shift+I` (Windows/Linux) æˆ– `Cmd+Option+I` (Mac)

3. **è¿è¡Œæµ‹è¯•**
   ```javascript
   await window.testDataFlow()
   ```

   **Electron é¢å¤–æµ‹è¯•**ï¼šä¼šéªŒè¯ SQLite åŒå†™åŠŸèƒ½

---

## ğŸ“Š æµ‹è¯•è¾“å‡ºç¤ºä¾‹

### æˆåŠŸè¾“å‡º
```
================================================================================
ğŸ¯ 1. å­˜å‚¨æ¶æ„æµ‹è¯• - Storage Architecture
================================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“‹ 1.1 StorageManager åŒå†™æµ‹è¯•
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… StorageManager.createEvent() æˆåŠŸ {}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“‹ 1.2 IndexedDB è¯»å–éªŒè¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… IndexedDB è¯»å–æˆåŠŸ { event: {...} }

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“‹ 1.3 SQLite è¯»å–éªŒè¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… SQLite è¯»å–æˆåŠŸ { event: {...} }

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“‹ 1.4 LRU Cache éªŒè¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… LRU Cache å‘½ä¸­ { cached: true }

...

================================================================================
æµ‹è¯•æŠ¥å‘Š - Test Report
================================================================================

ğŸ“Š æµ‹è¯•ç»Ÿè®¡ï¼š
   æ€»è®¡ï¼š31 ä¸ªæµ‹è¯•
   é€šè¿‡ï¼š31 ä¸ª âœ…
   å¤±è´¥ï¼š0 ä¸ª âŒ
   é€šè¿‡ç‡ï¼š100.00%

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

### å¤±è´¥è¾“å‡º
```
âŒ IndexedDB è¯»å–å¤±è´¥ { error: 'IDBRequest error' }

================================================================================
æµ‹è¯•æŠ¥å‘Š - Test Report
================================================================================

ğŸ“Š æµ‹è¯•ç»Ÿè®¡ï¼š
   æ€»è®¡ï¼š31 ä¸ªæµ‹è¯•
   é€šè¿‡ï¼š29 ä¸ª âœ…
   å¤±è´¥ï¼š2 ä¸ª âŒ
   é€šè¿‡ç‡ï¼š93.55%

âš ï¸ å¤±è´¥çš„æµ‹è¯•: [
  { test: 'IndexedDB è¯»å–å¤±è´¥', details: {...} },
  { test: 'SQLite è¯»å–å¤±è´¥', details: {...} }
]
```

---

## ğŸ” æµ‹è¯•è¯¦è§£

### 1. å­˜å‚¨æ¶æ„æµ‹è¯•

**éªŒè¯ç‚¹**ï¼š
- âœ… StorageManager åŒå†™ï¼ˆIndexedDB + SQLiteï¼‰
- âœ… IndexedDB è¯»å–æ­£ç¡®æ€§
- âœ… SQLite è¯»å–æ­£ç¡®æ€§ï¼ˆElectronï¼‰
- âœ… LRU Cache å‘½ä¸­
- âœ… æ›´æ–°æ“ä½œåŒå†™
- âœ… è½¯åˆ é™¤æ ‡è®°ï¼ˆdeletedAtï¼‰

**æµ‹è¯•æ•°æ®**ï¼šåˆ›å»º 1 ä¸ªæµ‹è¯•äº‹ä»¶

---

### 2. EventService Hub æµ‹è¯•

**éªŒè¯ç‚¹**ï¼š
- âœ… createEvent() å†™å…¥
- âœ… eventsUpdated äº‹ä»¶å¹¿æ’­
- âœ… getEventById() è¯»å–
- âœ… deleteEvent() è½¯åˆ é™¤

**æµ‹è¯•æ•°æ®**ï¼šåˆ›å»º 1 ä¸ªäº‹ä»¶

---

### 3. EventHub æµ‹è¯•

**éªŒè¯ç‚¹**ï¼š
- âœ… updateContent() å†…å®¹æ›´æ–°
- âœ… addTag() æ ‡ç­¾æ·»åŠ 
- âœ… removeTag() æ ‡ç­¾ç§»é™¤

**æµ‹è¯•æ•°æ®**ï¼šåˆ›å»º 1 ä¸ªäº‹ä»¶ï¼Œæ·»åŠ /ç§»é™¤æ ‡ç­¾

---

### 4. TimeHub æµ‹è¯•

**éªŒè¯ç‚¹**ï¼š
- âœ… updateTimeRange() æ—¶é—´èŒƒå›´æ›´æ–°
- âœ… updateTimeSpec() æ¨¡ç³Šæ—¶é—´æ›´æ–°

**æµ‹è¯•æ•°æ®**ï¼šåˆ›å»º 1 ä¸ªäº‹ä»¶ï¼Œæ›´æ–°æ—¶é—´

---

### 5. ContactService æµ‹è¯•

**éªŒè¯ç‚¹**ï¼š
- âœ… addContact() åˆ›å»ºè”ç³»äºº
- âœ… è”ç³»äººä¸äº‹ä»¶å…³è”
- âœ… updateContact() æ›´æ–°è”ç³»äºº
- âœ… deleteContact() è½¯åˆ é™¤

**æµ‹è¯•æ•°æ®**ï¼šåˆ›å»º 1 ä¸ªè”ç³»äººï¼Œå…³è”åˆ° 1 ä¸ªäº‹ä»¶

---

### 6. TagService æµ‹è¯•

**éªŒè¯ç‚¹**ï¼š
- âœ… addTag() åˆ›å»ºæ ‡ç­¾
- âœ… æ ‡ç­¾ä¸äº‹ä»¶å…³è”
- âœ… deleteTag() åˆ é™¤æ ‡ç­¾

**æµ‹è¯•æ•°æ®**ï¼šåˆ›å»º 1 ä¸ªæ ‡ç­¾ï¼Œå…³è”åˆ° 1 ä¸ªäº‹ä»¶

---

### 7. EventTree æµ‹è¯•

**éªŒè¯ç‚¹**ï¼š
- âœ… åˆ›å»ºçˆ¶äº‹ä»¶
- âœ… åˆ›å»ºå­äº‹ä»¶ï¼ˆTimerï¼‰
- âœ… çˆ¶å­å…³ç³»å¯æ¢å¤ï¼ˆä»¥ parentEventId ä¸ºç»“æ„çœŸç›¸ï¼‰

**æµ‹è¯•æ•°æ®**ï¼šåˆ›å»º 1 ä¸ªçˆ¶äº‹ä»¶ + 2 ä¸ªå­äº‹ä»¶

---

### 8. åŒå‘é“¾æ¥æµ‹è¯•

**éªŒè¯ç‚¹**ï¼š
- âœ… addLink() æ·»åŠ é“¾æ¥
- âœ… åŒå‘é“¾æ¥ç»´æŠ¤ï¼ˆlinkedEventIds + backlinksï¼‰
- âœ… removeLink() ç§»é™¤é“¾æ¥

**æµ‹è¯•æ•°æ®**ï¼šåˆ›å»º 2 ä¸ªäº‹ä»¶ï¼Œå»ºç«‹é“¾æ¥

---

### 9. è·¨æ¨¡å—è”åŠ¨æµ‹è¯•

**éªŒè¯ç‚¹**ï¼š
- âœ… åˆ›å»ºå®Œæ•´äº‹ä»¶ï¼ˆè”ç³»äºº + æ ‡ç­¾ + å­äº‹ä»¶ï¼‰
- âœ… è”åŠ¨æ›´æ–°ï¼ˆè”ç³»äººæ›´æ–° â†’ äº‹ä»¶åŒæ­¥ï¼‰

**æµ‹è¯•æ•°æ®**ï¼šåˆ›å»º 1 ä¸ªå®Œæ•´äº‹ä»¶ï¼ˆåŒ…å«è”ç³»äººã€æ ‡ç­¾ã€Timer å­äº‹ä»¶ï¼‰

---

### 10. æ€§èƒ½æµ‹è¯•

**éªŒè¯ç‚¹**ï¼š
- âœ… æ‰¹é‡åˆ›å»º 50 ä¸ªäº‹ä»¶ < 10 ç§’
- âœ… æ‰¹é‡æŸ¥è¯¢ 50 ä¸ªäº‹ä»¶ < 1 ç§’

**æµ‹è¯•æ•°æ®**ï¼šåˆ›å»º 50 ä¸ªäº‹ä»¶

---

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒè¦æ±‚

- âœ… 4DNote åº”ç”¨å·²å¯åŠ¨
- âœ… IndexedDB å¯ç”¨ï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰
- âœ… SQLite å¯ç”¨ï¼ˆElectron ç¯å¢ƒï¼Œå¯é€‰ï¼‰
- âœ… ä»¥ä¸‹å…¨å±€å¯¹è±¡å¯ç”¨ï¼š
  - `window.EventService`
  - `window.EventHub`
  - `window.TimeHub`
  - `window.ContactService`
  - `window.TagService`
  - `window.storageManager`

### æµ‹è¯•æ•°æ®æ¸…ç†

**è‡ªåŠ¨æ¸…ç†**ï¼šæ‰€æœ‰æµ‹è¯•æ•°æ®ä¼šåœ¨æµ‹è¯•å®Œæˆåè‡ªåŠ¨åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰

**æ‰‹åŠ¨æ¸…ç†**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
```javascript
// æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®
const events = await storageManager.queryEvents({ limit: 1000 });
const testEvents = events.items.filter(e => e.id.startsWith('test-'));
for (const event of testEvents) {
  await EventService.deleteEvent(event.id);
}
```

---

## ğŸ› æ•…éšœæ’é™¤

### 1. "æµ‹è¯•è„šæœ¬æœªåŠ è½½"

**åŸå› **ï¼šè„šæœ¬è·¯å¾„ä¸æ­£ç¡®  
**è§£å†³**ï¼šæ£€æŸ¥ `test-data-flow-complete.js` æ˜¯å¦åœ¨ `scripts/` ç›®å½•

---

### 2. "EventService is not defined"

**åŸå› **ï¼š4DNote åº”ç”¨æœªå¯åŠ¨æˆ–å…¨å±€å¯¹è±¡æœªæš´éœ²  
**è§£å†³**ï¼š
1. ç¡®ä¿åº”ç”¨å·²å¯åŠ¨
2. æ£€æŸ¥ `src/index.tsx` æ˜¯å¦æš´éœ²å…¨å±€å¯¹è±¡ï¼š
   ```typescript
   window.EventService = EventService;
   window.storageManager = storageManager;
   ```

---

### 3. "SQLite è¯»å–å¤±è´¥"

**åŸå› **ï¼šæµè§ˆå™¨ç¯å¢ƒä¸æ”¯æŒ SQLite  
**è§£å†³**ï¼šè¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼Œä»…åœ¨ Electron ç¯å¢ƒæµ‹è¯• SQLite

---

### 4. "IndexedDB QuotaExceededError"

**åŸå› **ï¼šIndexedDB å­˜å‚¨é…é¢ä¸è¶³  
**è§£å†³**ï¼š
1. æ¸…ç†æµè§ˆå™¨æ•°æ®
2. æˆ–åœ¨ Electron ç¯å¢ƒæµ‹è¯•ï¼ˆæ— é™åˆ¶ï¼‰

---

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°æµ‹è¯•

åœ¨ `test-data-flow-complete.js` ä¸­æ·»åŠ æ–°å‡½æ•°ï¼š

```javascript
async function testMyNewFeature() {
  testLogger.section('11. æ–°åŠŸèƒ½æµ‹è¯•');

  // æµ‹è¯•é€»è¾‘
  try {
    // ... ä½ çš„æµ‹è¯•ä»£ç 
    await assert(condition, 'æµ‹è¯•æè¿°', { details });
  } catch (error) {
    await assert(false, 'æµ‹è¯•å¤±è´¥', { error: error.message });
  }
}

// åœ¨ runAllTests() ä¸­æ·»åŠ 
async function runAllTests() {
  // ...
  await testMyNewFeature(); // æ·»åŠ è¿™ä¸€è¡Œ
}
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å­˜å‚¨æ¶æ„æ–‡æ¡£](../docs/architecture/STORAGE_ARCHITECTURE.md)
- [EventService API](../docs/PRD/EVENTSERVICE_MODULE_PRD.md)
- [ContactService è¿ç§»](../CONTACTSERVICE_MIGRATION_FINAL_REPORT.md)

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
- æäº¤ [GitHub Issue](https://github.com/zoeysnowy/4DNote/issues)
- å‚ä¸ [GitHub Discussions](https://github.com/zoeysnowy/4DNote/discussions)

---

**Created**: 2025-12-03  
**Version**: 1.0.0  
**Author**: GitHub Copilot + 4DNote Team
