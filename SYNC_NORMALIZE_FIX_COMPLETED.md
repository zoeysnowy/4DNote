# âœ… åŒæ­¥é“¾è·¯ normalizeEvent ä¿®å¤å®ŒæˆæŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-12-16  
**ç‰ˆæœ¬**: v2.18.1  
**é—®é¢˜**: Timestamp é€€åŒ– + ç­¾åæ˜¾ç¤ºé—®é¢˜

---

## ğŸ› é—®é¢˜æè¿°

### é—®é¢˜ 1: Timestamp é€€åŒ–æˆå­—ç¬¦ä¸²

**ç°è±¡**:
- åŒæ­¥æ—¶æ·»åŠ äº†åŒæ­¥æ—¶åˆ»çš„ timestamp
- è¿‡å»å·²æœ‰çš„ Block-Level Timestamp è¢«é€€åŒ–æˆçº¯æ–‡æœ¬å­—ç¬¦ä¸²
- EventLog ä¸­å‡ºç°ç±»ä¼¼ `2025-12-07 01:30:06` çš„çº¯æ–‡æœ¬è¡Œ

**æ ¹å› **:
```typescript
// âŒ é”™è¯¯çš„åšæ³•ï¼ˆActionBasedSyncManager L2508ï¼‰
const slateJson = JSON.stringify([{ 
  type: 'paragraph', 
  children: [{ text: remoteCoreContent }] 
}]);
updates.eventlog = slateJson;  // ç›´æ¥ä¼ é€’ slateJson å­—ç¬¦ä¸²
```

**å½±å“**:
- ç»•è¿‡äº† `normalizeEventLog` çš„è‡ªåŠ¨å¤„ç†
- æ²¡æœ‰æ·»åŠ  Block-Level Timestamp å…ƒæ•°æ®ï¼ˆ`id`ã€`createdAt`ã€`updatedAt`ï¼‰
- å¯¼è‡´æ—¶é—´æˆ³æ˜¾ç¤ºä¸ºçº¯æ–‡æœ¬è€Œéå…ƒæ•°æ®

---

### é—®é¢˜ 2: ç­¾ååœ¨å†…éƒ¨æ˜¾ç¤º

**ç°è±¡**:
- äº‹ä»¶ description ä¸­çš„ç­¾åï¼ˆå¦‚ `ç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-04 02:47:50`ï¼‰åœ¨ UI ä¸­å¯è§
- UpcomingEventsPanel ç›´æ¥æ˜¾ç¤º `event.description`ï¼Œæœªç§»é™¤ç­¾å

**æ ¹å› **:
```tsx
// âŒ é”™è¯¯çš„åšæ³•ï¼ˆUpcomingEventsPanel.tsx L370ï¼‰
<span className="event-log-text">{event.description}</span>
```

**å½±å“**:
- ç”¨æˆ·åœ¨å³å°†åˆ°æ¥çš„äº‹ä»¶é¢æ¿ä¸­çœ‹åˆ°ç­¾åæ–‡æœ¬
- ç ´åäº†ç­¾åä»…ç”¨äº Outlook åŒæ­¥çš„è®¾è®¡åŸåˆ™

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: ActionBasedSyncManager ä¼ é€’çº¯æ–‡æœ¬

**ä¿®æ”¹æ–‡ä»¶**: `src/services/ActionBasedSyncManager.ts`

**ä¿®æ”¹ä½ç½® 1**: å¢é‡æ›´æ–°è·¯å¾„ (L2508-2520)

```typescript
// âŒ ä¿®å¤å‰
const slateJson = JSON.stringify([{ type: 'paragraph', children: [{ text: remoteCoreContent }] }]);
updates.eventlog = slateJson;

// âœ… ä¿®å¤å
updates.eventlog = remoteCoreContent;  // ä¼ é€’çº¯æ–‡æœ¬ï¼Œè®© normalizeEventLog è‡ªåŠ¨å¤„ç†
```

**ä¿®æ”¹ä½ç½® 2**: æ—§æ ¼å¼æ›´æ–°è·¯å¾„ (L4150-4160)

```typescript
// âŒ ä¿®å¤å‰
const slateJson = JSON.stringify([{ type: 'paragraph', children: [{ text: remoteCoreContent }] }]);
updatedEventlog = slateJson;

// âœ… ä¿®å¤å
updatedEventlog = remoteCoreContent;  // ä¼ é€’çº¯æ–‡æœ¬ï¼Œè®© normalizeEventLog è‡ªåŠ¨å¤„ç†
```

**å·¥ä½œåŸç†**:

```
[ä¿®å¤å‰]
ActionBasedSyncManager 
  â†’ æ‰‹åŠ¨æ„é€  slateJson å­—ç¬¦ä¸²
  â†’ EventService.updateEvent
  â†’ normalizeEventLog (ä½†å·²ç»æ˜¯ slateJsonï¼Œè·³è¿‡è§£æ)
  â†’ ç¼ºå°‘ Block-Level å…ƒæ•°æ® âŒ

[ä¿®å¤å]
ActionBasedSyncManager
  â†’ ä¼ é€’çº¯æ–‡æœ¬ remoteCoreContent
  â†’ EventService.updateEvent
  â†’ normalizeEventLog (è¯†åˆ«ä¸ºçº¯æ–‡æœ¬)
  â†’ parseTextWithBlockTimestamps() 
  â†’ è‡ªåŠ¨æ·»åŠ  idã€createdAtã€updatedAt âœ…
```

---

### ä¿®å¤ 2: UpcomingEventsPanel ç§»é™¤ç­¾å

**ä¿®æ”¹æ–‡ä»¶**: `src/components/UpcomingEventsPanel.tsx`

**ä¿®æ”¹ä½ç½® 1**: æ·»åŠ å¯¼å…¥ (L15)

```typescript
import { SignatureUtils } from '../utils/signatureUtils';
```

**ä¿®æ”¹ä½ç½® 2**: æå–æ ¸å¿ƒå†…å®¹ (L367-373)

```tsx
{/* âŒ ä¿®å¤å‰ */}
<span className="event-log-text">{event.description}</span>

{/* âœ… ä¿®å¤å */}
<span className="event-log-text">
  {SignatureUtils.extractCoreContent(event.description)}
</span>
```

---

## ğŸ”§ ä¿®å¤çš„æ•°æ®æµ

### å®Œæ•´çš„ EventLog è§„èŒƒåŒ–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®è¾“å…¥ï¼ˆå¤šç§æ ¼å¼ï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. çº¯æ–‡æœ¬: "2025-12-07 01:30:06\nä¼šè®®å†…å®¹"                      â”‚
â”‚ 2. HTML: "<p>ä¼šè®®å†…å®¹</p>"                                       â”‚
â”‚ 3. EventLog å¯¹è±¡: { slateJson, html, plainText }                â”‚
â”‚ 4. Slate JSON å­—ç¬¦ä¸²: "[{type:'paragraph', ...}]"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              normalizeEventLog (EventService.ts)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ£€æµ‹æ ¼å¼ç±»å‹                                                  â”‚
â”‚ 2. æ£€æµ‹æ—§æ ¼å¼ (timestamp-divider) â†’ è¿ç§»åˆ° Block-Level        â”‚
â”‚ 3. æ£€æµ‹çº¯æ–‡æœ¬æ—¶é—´æˆ³ â†’ parseTextWithBlockTimestamps()           â”‚
â”‚ 4. ç¡®ä¿æ‰€æœ‰ paragraph æœ‰ Block-Level å…ƒæ•°æ®                    â”‚
â”‚ 5. ç”Ÿæˆå®Œæ•´çš„ EventLog å¯¹è±¡                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ ‡å‡†åŒ–çš„ EventLog å¯¹è±¡                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                                â”‚
â”‚   slateJson: [                                                   â”‚
â”‚     {                                                            â”‚
â”‚       type: 'paragraph',                                         â”‚
â”‚       id: 'block-1733213520123-a7f2k9',  âœ… Block ID            â”‚
â”‚       createdAt: 1733213520123,          âœ… Unix æ¯«ç§’æ—¶é—´æˆ³     â”‚
â”‚       updatedAt: 1733213520123,          âœ… Unix æ¯«ç§’æ—¶é—´æˆ³     â”‚
â”‚       children: [{ text: 'ä¼šè®®å†…å®¹' }]                           â”‚
â”‚     }                                                            â”‚
â”‚   ],                                                             â”‚
â”‚   html: '<p>ä¼šè®®å†…å®¹</p>',                                       â”‚
â”‚   plainText: 'ä¼šè®®å†…å®¹'                                          â”‚
â”‚ }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ vs ä¿®å¤å

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **Outlook åŒæ­¥** | âŒ æ—¶é—´æˆ³é€€åŒ–ä¸ºçº¯æ–‡æœ¬ | âœ… è‡ªåŠ¨è½¬æ¢ä¸º Block-Level å…ƒæ•°æ® |
| **EventLog ç»“æ„** | âŒ ç¼ºå°‘ `id`ã€`createdAt` | âœ… å®Œæ•´çš„ Block-Level å…ƒæ•°æ® |
| **UpcomingEventsPanel** | âŒ æ˜¾ç¤ºç­¾åæ–‡æœ¬ | âœ… è‡ªåŠ¨ç§»é™¤ç­¾å |
| **LogSlate/ModalSlate** | âœ… ç­¾åæ®µè½å·²éšè— | âœ… ä¿æŒä¸å˜ï¼ˆå·²æ­£ç¡®ï¼‰ |
| **EventHistory å¢é•¿** | âŒ æ¯æ¬¡åŒæ­¥è§¦å‘è®°å½• | âœ… å†…å®¹æ— å˜åŒ–æ—¶ä¸è®°å½• |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•é¡µé¢

æ‰“å¼€ [diagnose-sync-normalize.html](public/diagnose-sync-normalize.html) è¿›è¡Œè¯Šæ–­ï¼š

1. **è¿è¡Œè¯Šæ–­** - æ£€æŸ¥æ‰€æœ‰äº‹ä»¶çš„ EventLog æ ¼å¼
2. **æ£€æŸ¥æœ€è¿‘äº‹ä»¶** - æŸ¥çœ‹æœ€è¿‘åŒæ­¥çš„äº‹ä»¶
3. **æŸ¥çœ‹ä¿®å¤æ–¹æ¡ˆ** - è·å–è¯¦ç»†çš„ä¿®å¤å»ºè®®

### æ‰‹åŠ¨æµ‹è¯•æ¸…å•

- [ ] åˆ›å»ºæ–°äº‹ä»¶ â†’ æ£€æŸ¥ EventLog æœ‰ Block-Level å…ƒæ•°æ®
- [ ] Outlook åŒæ­¥äº‹ä»¶ â†’ æ£€æŸ¥æ—¶é—´æˆ³ä¸é€€åŒ–
- [ ] æŸ¥çœ‹ UpcomingEventsPanel â†’ ç­¾åä¸å¯è§
- [ ] ç¼–è¾‘äº‹ä»¶ï¼ˆLogSlate/ModalSlateï¼‰â†’ ç­¾åæ®µè½ä¸å¯è§
- [ ] é‡å¤åŒæ­¥ç›¸åŒäº‹ä»¶ â†’ EventHistory ä¸å¢é•¿

---

## ğŸ¯ æ¶æ„åˆè§„æ€§

### EventHub Architecture ç¬¦åˆæ€§æ£€æŸ¥

| æ¶æ„è¦æ±‚ | çŠ¶æ€ | è¯´æ˜ |
|----------|------|------|
| **æ‰€æœ‰ update è·¯å¾„è°ƒç”¨ normalizeEvent** | âœ… | EventService.updateEvent æ­£ç¡®è°ƒç”¨ |
| **æ‰€æœ‰ sync è·¯å¾„è°ƒç”¨ normalizeEvent** | âœ… | ActionBasedSyncManager ä¼ é€’çº¯æ–‡æœ¬ |
| **Block-Level Timestamp è‡ªåŠ¨å¤„ç†** | âœ… | normalizeEventLog è‡ªåŠ¨æ·»åŠ å…ƒæ•°æ® |
| **ç­¾ååœ¨å‰ç«¯éšè—** | âœ… | LogSlate/ModalSlate/UpcomingEventsPanel |
| **description åŒ…å«ç­¾åï¼ˆOutlookåŒæ­¥ï¼‰** | âœ… | normalizeEvent è‡ªåŠ¨æ·»åŠ ç­¾å |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [EventHub & TimeHub ç»Ÿä¸€æ¶æ„](docs/architecture/EVENTHUB_TIMEHUB_ARCHITECTURE.md)
- [ç­¾åç³»ç»Ÿé‡æ„å®Œæˆ](SIGNATURE_REFACTOR_COMPLETED.md)
- [Block-Level Timestamp v2.18.0](docs/architecture/EVENTHUB_TIMEHUB_ARCHITECTURE.md#v2180)

---

## ğŸ”„ åç»­å»ºè®®

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰

1. âœ… ~~ä¿®å¤ ActionBasedSyncManager ä¼ é€’çº¯æ–‡æœ¬~~
2. âœ… ~~ä¿®å¤ UpcomingEventsPanel ç­¾åæ˜¾ç¤º~~
3. â³ è¿è¡Œè¯Šæ–­é¡µé¢ï¼Œæ£€æŸ¥æ‰€æœ‰äº‹ä»¶
4. â³ æ¸…ç†æ—§æ ¼å¼çš„äº‹ä»¶ï¼ˆè¿è¡Œè¿ç§»è„šæœ¬ï¼‰

### ä¸­æœŸï¼ˆv2.19.0ï¼‰

1. æ·»åŠ  EventLog å®Œæ•´æ€§æ£€æŸ¥ï¼ˆå®šæœŸæ‰«æï¼‰
2. åˆ›å»ºæ‰¹é‡ä¿®å¤å·¥å…·ï¼ˆä¿®å¤ç¼ºå¤±å…ƒæ•°æ®çš„äº‹ä»¶ï¼‰
3. æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯åŒæ­¥è·¯å¾„

### é•¿æœŸï¼ˆv3.0.0ï¼‰

1. ç»Ÿä¸€æ‰€æœ‰åŒæ­¥è·¯å¾„ä½¿ç”¨ EventService CRUD
2. ç§»é™¤ ActionBasedSyncManager çš„ç›´æ¥æ•°æ®åº“æ“ä½œ
3. å®Œå…¨åŸºäºäº‹ä»¶é©±åŠ¨çš„åŒæ­¥æ¶æ„

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-12-16 22:15  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…éªŒè¯  
**å‘å¸ƒç‰ˆæœ¬**: v2.18.1
