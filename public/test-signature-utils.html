<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SignatureUtils æµ‹è¯•é¡µé¢</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .test-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section h3 {
      margin-top: 0;
      color: #667eea;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    .test-case {
      background: #f9f9f9;
      padding: 15px;
      border-left: 4px solid #667eea;
      margin: 10px 0;
    }
    .result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }
    .result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .result.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #5568d3;
    }
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }
    .stat-label {
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>âœ… SignatureUtils æµ‹è¯•é¡µé¢</h1>
    <p>æµ‹è¯•ç­¾åå·¥å…·ç±»çš„æ‰€æœ‰åŠŸèƒ½</p>
  </div>

  <div class="test-section">
    <h3>ğŸ” 1. isSignatureParagraph() - ç­¾åæ£€æµ‹</h3>
    <button onclick="testSignatureDetection()">è¿è¡Œæµ‹è¯•</button>
    <div id="detection-results"></div>
  </div>

  <div class="test-section">
    <h3>âœ‚ï¸ 2. extractCoreContent() - æå–æ ¸å¿ƒå†…å®¹</h3>
    <button onclick="testExtractCoreContent()">è¿è¡Œæµ‹è¯•</button>
    <div id="extract-results"></div>
  </div>

  <div class="test-section">
    <h3>â• 3. addSignature() - æ·»åŠ ç­¾å</h3>
    <button onclick="testAddSignature()">è¿è¡Œæµ‹è¯•</button>
    <div id="add-results"></div>
  </div>

  <div class="test-section">
    <h3>ğŸ“Š 4. extractSignatureInfo() - æå–ç­¾åä¿¡æ¯</h3>
    <button onclick="testExtractSignatureInfo()">è¿è¡Œæµ‹è¯•</button>
    <div id="info-results"></div>
  </div>

  <div class="test-section">
    <h3>ğŸ”§ 5. ç»¼åˆæµ‹è¯• - å®é™…åœºæ™¯</h3>
    <button onclick="testRealWorldScenarios()">è¿è¡Œæµ‹è¯•</button>
    <div id="scenario-results"></div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-value" id="total-tests">0</div>
      <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="passed-tests" style="color: #28a745;">0</div>
      <div class="stat-label">é€šè¿‡</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="failed-tests" style="color: #dc3545;">0</div>
      <div class="stat-label">å¤±è´¥</div>
    </div>
  </div>

  <script type="module">
    import { SignatureUtils } from '../src/utils/signatureUtils.ts';
    
    window.SignatureUtils = SignatureUtils;
    window.testStats = { total: 0, passed: 0, failed: 0 };

    // æ›´æ–°ç»Ÿè®¡
    window.updateStats = function() {
      document.getElementById('total-tests').textContent = window.testStats.total;
      document.getElementById('passed-tests').textContent = window.testStats.passed;
      document.getElementById('failed-tests').textContent = window.testStats.failed;
    };

    // æµ‹è¯•åŠ©æ‰‹
    window.runTest = function(name, testFn, container) {
      window.testStats.total++;
      try {
        const result = testFn();
        if (result) {
          window.testStats.passed++;
          container.innerHTML += `<div class="result success">âœ… ${name}: é€šè¿‡</div>`;
        } else {
          window.testStats.failed++;
          container.innerHTML += `<div class="result error">âŒ ${name}: å¤±è´¥</div>`;
        }
      } catch (error) {
        window.testStats.failed++;
        container.innerHTML += `<div class="result error">âŒ ${name}: å¼‚å¸¸ - ${error.message}</div>`;
      }
      window.updateStats();
    };

    // 1. ç­¾åæ£€æµ‹æµ‹è¯•
    window.testSignatureDetection = function() {
      const container = document.getElementById('detection-results');
      container.innerHTML = '';

      const testCases = [
        ['4DNote åˆ›å»ºç­¾å', 'ç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-16 10:00:00', true],
        ['Outlook åˆ›å»ºç­¾å', 'ç”± ğŸ“§ Outlook åˆ›å»ºäº 2025-12-16 10:00:00', true],
        ['4DNote ç¼–è¾‘ç­¾å', 'ç”± ğŸ”® 4DNote æœ€åä¿®æ”¹äº 2025-12-16 10:00:00', true],
        ['Outlook ç¼–è¾‘ç­¾å', 'ç”± ğŸ“§ Outlook ç¼–è¾‘äº 2025-12-16 10:00:00', true],
        ['åˆ†éš”çº¿', '---', false],  // å•ç‹¬çš„åˆ†éš”çº¿ä¸æ˜¯ç­¾å
        ['æ™®é€šæ–‡æœ¬', 'è¿™æ˜¯æ™®é€šå†…å®¹', false],
        ['ç©ºæ–‡æœ¬', '', false],
        ['åŒ…å«"åˆ›å»ºäº"ä½†æ ¼å¼ä¸å¯¹', 'æˆ‘åœ¨åˆ›å»ºäº 2025-12-16', false]
      ];

      testCases.forEach(([name, text, expected]) => {
        window.runTest(
          name,
          () => SignatureUtils.isSignatureParagraph(text) === expected,
          container
        );
      });
    };

    // 2. æå–æ ¸å¿ƒå†…å®¹æµ‹è¯•
    window.testExtractCoreContent = function() {
      const container = document.getElementById('extract-results');
      container.innerHTML = '';

      const testCases = [
        [
          'ç§»é™¤ 4DNote ç­¾å',
          'æ ¸å¿ƒå†…å®¹\n\n---\nç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-16 10:00:00',
          'æ ¸å¿ƒå†…å®¹'
        ],
        [
          'ç§»é™¤ Outlook ç­¾å',
          'é‡è¦äº‹ä»¶\n\n---\nç”± ğŸ“§ Outlook åˆ›å»ºäº 2025-12-16 10:00:00',
          'é‡è¦äº‹ä»¶'
        ],
        [
          'ç§»é™¤åŒé‡ç­¾å',
          'å†…å®¹\n\n---\nç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-16 10:00:00\nç”± ğŸ“§ Outlook æœ€åä¿®æ”¹äº 2025-12-16 11:00:00',
          'å†…å®¹'
        ],
        [
          'æ— ç­¾åå†…å®¹',
          'çº¯æ–‡æœ¬å†…å®¹',
          'çº¯æ–‡æœ¬å†…å®¹'
        ],
        [
          'ç©ºå†…å®¹',
          '',
          ''
        ]
      ];

      testCases.forEach(([name, input, expected]) => {
        window.runTest(
          name,
          () => SignatureUtils.extractCoreContent(input).trim() === expected.trim(),
          container
        );
      });
    };

    // 3. æ·»åŠ ç­¾åæµ‹è¯•
    window.testAddSignature = function() {
      const container = document.getElementById('add-results');
      container.innerHTML = '';

      // æµ‹è¯• 1: æ·»åŠ  4DNote åˆ›å»ºç­¾å
      window.runTest(
        'æ·»åŠ  4DNote åˆ›å»ºç­¾å',
        () => {
          const result = SignatureUtils.addSignature('æ ¸å¿ƒå†…å®¹', {
            createdAt: '2025-12-16 10:00:00',
            fourDNoteSource: true
          });
          return result.includes('ç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-16 10:00:00');
        },
        container
      );

      // æµ‹è¯• 2: æ·»åŠ  Outlook åˆ›å»ºç­¾å
      window.runTest(
        'æ·»åŠ  Outlook åˆ›å»ºç­¾å',
        () => {
          const result = SignatureUtils.addSignature('æ ¸å¿ƒå†…å®¹', {
            createdAt: '2025-12-16 10:00:00',
            source: 'outlook'
          });
          return result.includes('ç”± ğŸ“§ Outlook åˆ›å»ºäº 2025-12-16 10:00:00');
        },
        container
      );

      // æµ‹è¯• 3: ä¸é‡å¤æ·»åŠ ç­¾å
      window.runTest(
        'ä¸é‡å¤æ·»åŠ ç­¾å',
        () => {
          const withSignature = 'æ ¸å¿ƒå†…å®¹\n\n---\nç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-16 10:00:00';
          const result = SignatureUtils.addSignature(withSignature, {
            createdAt: '2025-12-16 10:00:00'
          });
          // ç»Ÿè®¡ç­¾åå‡ºç°æ¬¡æ•°
          const matches = result.match(/ç”±\s+ğŸ”®\s*4DNote\s*åˆ›å»ºäº/g);
          return matches && matches.length === 1; // åªæœ‰ä¸€ä¸ªç­¾å
        },
        container
      );
    };

    // 4. æå–ç­¾åä¿¡æ¯æµ‹è¯•
    window.testExtractSignatureInfo = function() {
      const container = document.getElementById('info-results');
      container.innerHTML = '';

      // æµ‹è¯• 1: æå– 4DNote ç­¾åä¿¡æ¯
      window.runTest(
        'æå– 4DNote ç­¾åä¿¡æ¯',
        () => {
          const content = 'å†…å®¹\n\n---\nç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-16 10:00:00';
          const info = SignatureUtils.extractSignatureInfo(content);
          return info.createdAt === '2025-12-16 10:00:00' && info.fourDNoteSource === true;
        },
        container
      );

      // æµ‹è¯• 2: æå– Outlook ç­¾åä¿¡æ¯
      window.runTest(
        'æå– Outlook ç­¾åä¿¡æ¯',
        () => {
          const content = 'å†…å®¹\n\n---\nç”± ğŸ“§ Outlook åˆ›å»ºäº 2025-12-16 10:00:00\nç”± ğŸ“§ Outlook æœ€åä¿®æ”¹äº 2025-12-16 11:00:00';
          const info = SignatureUtils.extractSignatureInfo(content);
          return info.createdAt === '2025-12-16 10:00:00' && 
                 info.updatedAt === '2025-12-16 11:00:00' && 
                 info.fourDNoteSource === false && 
                 info.source === 'outlook';
        },
        container
      );
    };

    // 5. å®é™…åœºæ™¯æµ‹è¯•
    window.testRealWorldScenarios = function() {
      const container = document.getElementById('scenario-results');
      container.innerHTML = '';

      // åœºæ™¯ 1: åˆ›å»ºäº‹ä»¶ â†’ æ·»åŠ ç­¾å â†’ æå–æ ¸å¿ƒå†…å®¹
      window.runTest(
        'åœºæ™¯ 1: åˆ›å»ºâ†’ç­¾åâ†’æå–',
        () => {
          const original = 'è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„ä¼šè®®è®°å½•';
          const withSignature = SignatureUtils.addSignature(original, {
            createdAt: '2025-12-16 10:00:00',
            fourDNoteSource: true
          });
          const extracted = SignatureUtils.extractCoreContent(withSignature);
          return extracted.trim() === original.trim();
        },
        container
      );

      // åœºæ™¯ 2: IndexMap è½®è¯¢ä¸é‡å¤æ·»åŠ ç­¾å
      window.runTest(
        'åœºæ™¯ 2: IndexMap è½®è¯¢ä¸é‡å¤',
        () => {
          let content = 'ä¼šè®®å†…å®¹';
          // æ¨¡æ‹Ÿè½®è¯¢ 10 æ¬¡
          for (let i = 0; i < 10; i++) {
            content = SignatureUtils.addSignature(content, {
              createdAt: '2025-12-16 10:00:00',
              fourDNoteSource: true
            });
          }
          // ç»Ÿè®¡ç­¾åå‡ºç°æ¬¡æ•°
          const matches = content.match(/ç”±\s+ğŸ”®\s*4DNote\s*åˆ›å»ºäº/g);
          return matches && matches.length === 1;
        },
        container
      );

      // åœºæ™¯ 3: Outlook åŒæ­¥æ›´æ–°ç­¾å
      window.runTest(
        'åœºæ™¯ 3: Outlook åŒæ­¥æ›´æ–°',
        () => {
          const original = 'æ ¸å¿ƒå†…å®¹';
          const withSignature = SignatureUtils.addSignature(original, {
            createdAt: '2025-12-16 10:00:00',
            updatedAt: '2025-12-16 11:00:00',
            source: 'outlook',
            lastModifiedSource: 'outlook'
          });
          // æ£€æŸ¥æ˜¯å¦åŒ…å« Outlook ç­¾å
          return withSignature.includes('ç”± ğŸ“§ Outlook åˆ›å»ºäº 2025-12-16 10:00:00') &&
                 withSignature.includes('æœ€åä¿®æ”¹äº 2025-12-16 11:00:00');
        },
        container
      );

      // åœºæ™¯ 4: å‰ç«¯ç­¾åæ£€æµ‹
      window.runTest(
        'åœºæ™¯ 4: å‰ç«¯ç­¾åéšè—',
        () => {
          const paragraphs = [
            'è¿™æ˜¯æ­£å¸¸æ®µè½',
            '---',  // åˆ†éš”çº¿ä¸æ˜¯ç­¾å
            'ç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-16 10:00:00',  // è¿™æ˜¯ç­¾å
            'è¿™æ˜¯å¦ä¸€ä¸ªæ­£å¸¸æ®µè½'
          ];
          const visibleParagraphs = paragraphs.filter(p => !SignatureUtils.isSignatureParagraph(p));
          // åº”è¯¥æ˜¯ 3 ä¸ªï¼šä¸¤ä¸ªæ­£å¸¸æ®µè½ + åˆ†éš”çº¿
          return visibleParagraphs.length === 3 && 
                 visibleParagraphs.includes('---') &&
                 !visibleParagraphs.includes('ç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-16 10:00:00');
        },
        container
      );
    };

    console.log('âœ… SignatureUtils æµ‹è¯•é¡µé¢å·²åŠ è½½');
  </script>
</body>
</html>
