<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EventHistory è¯Šæ–­æµ‹è¯•</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    .section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 20px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      font-weight: 500;
    }
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    button.danger {
      background: #e74c3c;
    }
    button.danger:hover {
      background: #c0392b;
    }
    button.success {
      background: #27ae60;
    }
    button.success:hover {
      background: #229954;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .stat-card h3 {
      color: #999;
      font-size: 12px;
      text-transform: uppercase;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .stat-card .value {
      color: #333;
      font-size: 24px;
      font-weight: bold;
    }
    .stat-card.warning .value {
      color: #f39c12;
    }
    .stat-card.danger .value {
      color: #e74c3c;
    }
    .stat-card.success .value {
      color: #27ae60;
    }
    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      max-height: 500px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 3px;
    }
    .log-entry.info { color: #4fc3f7; }
    .log-entry.success { color: #66bb6a; }
    .log-entry.warning { color: #ffa726; }
    .log-entry.error { 
      color: #ef5350;
      background: rgba(239, 83, 80, 0.1);
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
    }
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead {
      position: sticky;
      top: 0;
      background: #667eea;
      color: white;
      z-index: 1;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    tbody tr:hover {
      background: #f5f5f5;
    }
    .code-block {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      overflow-x: auto;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š EventHistory è¯Šæ–­æµ‹è¯•</h1>
    <p class="subtitle">æµ‹è¯•å†å²è®°å½•æœåŠ¡ã€æ¸…ç†åŠŸèƒ½å’Œæ€§èƒ½ä¼˜åŒ–</p>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="section">
      <h2>ğŸ“ˆ å½“å‰ç»Ÿè®¡</h2>
      <div class="stats" id="stats">
        <div class="stat-card">
          <h3>æ€»è®°å½•æ•°</h3>
          <div class="value" id="totalCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Create æ“ä½œ</h3>
          <div class="value" id="createCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Update æ“ä½œ</h3>
          <div class="value" id="updateCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Delete æ“ä½œ</h3>
          <div class="value" id="deleteCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Backfill è®°å½•</h3>
          <div class="value" id="backfillCount">-</div>
        </div>
        <div class="stat-card">
          <h3>æœ€æ—§è®°å½•</h3>
          <div class="value" id="oldestRecord" style="font-size: 14px;">-</div>
        </div>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="section">
      <h2>ğŸ”§ æµ‹è¯•æ“ä½œ</h2>
      <div class="button-group">
        <button onclick="loadStats()">ğŸ”„ åˆ·æ–°ç»Ÿè®¡</button>
        <button onclick="testExtractChanges()">ğŸ§ª æµ‹è¯• extractChanges</button>
        <button onclick="testEventLogComparison()">ğŸ“ æµ‹è¯• EventLog æ¯”è¾ƒ</button>
        <button onclick="showRecentLogs()">ğŸ“œ æ˜¾ç¤ºæœ€è¿‘è®°å½•</button>
        <button onclick="checkDuplicates()">ğŸ” æ£€æŸ¥é‡å¤è®°å½•</button>
        <button onclick="analyzeChangeFields()">ğŸ“Š åˆ†æå˜æ›´å­—æ®µ</button>
        <button onclick="debugExternalSync()">ğŸ› è°ƒè¯• external-sync</button>
        <button onclick="analyzeCreateRecords()">ğŸ”¬ åˆ†æ CREATE è®°å½•</button>
      </div>
      <div class="button-group">
        <button class="success" onclick="runAutoCleanup()">ğŸ§¹ è¿è¡Œè‡ªåŠ¨æ¸…ç†</button>
        <button class="success" onclick="cleanOldRecords()">ğŸ—‘ï¸ æ¸…ç†æ—§è®°å½•ï¼ˆ30å¤©å‰ï¼‰</button>
        <button class="danger" onclick="clearAllHistory()">âš ï¸ æ¸…ç©ºæ‰€æœ‰å†å²</button>
      </div>
    </div>

    <!-- æ§åˆ¶å°æ—¥å¿— -->
    <div class="section">
      <h2>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
      <div class="log-container" id="logContainer">
        <div class="log-entry info">ç­‰å¾…æµ‹è¯•...</div>
      </div>
    </div>

    <!-- ğŸ†• Description å˜æ›´è°ƒè¯• -->
    <div class="section">
      <h2>ğŸ” Description å˜æ›´è°ƒè¯•ï¼ˆå®æ—¶ç›‘å¬ UPDATE æ“ä½œï¼‰</h2>
      <div class="button-group">
        <button onclick="testDescriptionChange()">ğŸ§ª æ‰‹åŠ¨æµ‹è¯• Description å˜æ›´</button>
        <button onclick="clearDescriptionLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div class="log-container" id="descriptionDebugContainer" style="max-height: 300px;">
        <div class="log-entry info">â³ ç­‰å¾… UPDATE æ“ä½œè§¦å‘...ï¼ˆCREATE æ“ä½œä¸ä¼šè§¦å‘æ­¤è°ƒè¯•ï¼‰</div>
      </div>
    </div>

    <!-- ğŸ†• CREATE å»é‡è°ƒè¯• -->
    <div class="section">
      <h2>ğŸ›¡ï¸ CREATE å»é‡ç›‘æ§ï¼ˆå®æ—¶æ•æ‰é‡å¤è°ƒç”¨ï¼‰</h2>
      <div class="button-group">
        <button onclick="testCreateEvent()">ğŸ§ª æ‰‹åŠ¨æµ‹è¯• CREATE</button>
        <button onclick="testCreateDuplicate()">âš ï¸ æµ‹è¯•é‡å¤è°ƒç”¨ï¼ˆ1ç§’å†…ï¼‰</button>
        <button onclick="clearCreateLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        <button class="info" onclick="showCreateStats()">ğŸ“Š æ˜¾ç¤ºç»Ÿè®¡</button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
          <strong>âœ… æˆåŠŸè®°å½•:</strong> <span id="createSuccessCount" style="font-size: 20px; color: #2196F3;">0</span>
        </div>
        <div style="background: #fff3e0; padding: 10px; border-radius: 5px;">
          <strong>âš ï¸ å»é‡æ‹¦æˆª:</strong> <span id="createDedupeCount" style="font-size: 20px; color: #ff9800;">0</span>
        </div>
      </div>
      <div class="log-container" id="createDebugContainer" style="max-height: 400px;">
        <div class="log-entry info">â³ ç­‰å¾… CREATE æ“ä½œ...ï¼ˆåŒ…å«è°ƒç”¨å †æ ˆä¿¡æ¯ï¼‰</div>
      </div>
    </div>

    <!-- æµ‹è¯•ç»“æœ -->
    <div class="section" id="resultsSection" style="display: none;">
      <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
      <div id="resultsContent"></div>
    </div>
  </div>

  <script type="module">
    // åŠ¨æ€å¯¼å…¥ EventHistoryService
    let EventHistoryService;
    let StorageManager;

    async function init() {
      try {
        const historyModule = await import('/src/services/EventHistoryService.ts');
        EventHistoryService = historyModule.EventHistoryService;
        
        const storageModule = await import('/src/services/storage/StorageManager.ts');
        StorageManager = storageModule.storageManager;
        
        log('âœ… æ¨¡å—åŠ è½½æˆåŠŸ', 'success');
        window.EventHistoryService = EventHistoryService;
        window.StorageManager = StorageManager;
        
        // ğŸ†• ç›‘å¬ description è°ƒè¯•äº‹ä»¶
        window.addEventListener('description-debug', (event) => {
          const { detail } = event;
          logDescription(detail);
        });
        
        // ğŸ†• ç›‘å¬ CREATE æˆåŠŸè®°å½•
        window.addEventListener('create-logged', (event) => {
          const { detail } = event;
          logCreateSuccess(detail);
        });
        
        // ğŸ†• ç›‘å¬ CREATE å»é‡æ‹¦æˆª
        window.addEventListener('create-dedupe', (event) => {
          const { detail } = event;
          logCreateDedupe(detail);
        });
        
        // è‡ªåŠ¨åŠ è½½ç»Ÿè®¡
        await loadStats();
      } catch (error) {
        log(`âŒ æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // æ—¥å¿—è¾“å‡º
    window.log = function(message, type = 'info') {
      const container = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
      console.log(message);
    };

    // ğŸ†• CREATE æˆåŠŸæ—¥å¿—è®¡æ•°å™¨
    let createSuccessCount = 0;
    let createDedupeCount = 0;
    
    // ğŸ†• CREATE æˆåŠŸæ—¥å¿—è¾“å‡º
    window.logCreateSuccess = function(data) {
      createSuccessCount++;
      document.getElementById('createSuccessCount').textContent = createSuccessCount;
      
      const container = document.getElementById('createDebugContainer');
      const entry = document.createElement('div');
      entry.className = 'log-entry success';
      entry.innerHTML = `
        <div><strong>[${new Date(data.timestamp).toLocaleTimeString()}] âœ… CREATE å·²è®°å½•</strong></div>
        <div style="margin-top: 5px;">äº‹ä»¶ID: <code>${data.eventId}</code> | æ¥æº: <code>${data.source}</code></div>
        <details style="margin-top: 5px;">
          <summary style="cursor: pointer; color: #666;">ğŸ“ è°ƒç”¨å †æ ˆï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
          <pre style="margin-top: 5px; padding: 10px; background: #f5f5f5; border-radius: 3px; font-size: 11px; overflow-x: auto;">${data.stackTrace}</pre>
        </details>
      `;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    };
    
    // ğŸ†• CREATE å»é‡æ—¥å¿—è¾“å‡º
    window.logCreateDedupe = function(data) {
      createDedupeCount++;
      document.getElementById('createDedupeCount').textContent = createDedupeCount;
      
      const container = document.getElementById('createDebugContainer');
      const entry = document.createElement('div');
      entry.className = 'log-entry warning';
      entry.innerHTML = `
        <div><strong>[${new Date(data.timestamp).toLocaleTimeString()}] âš ï¸ CREATE å»é‡æ‹¦æˆª</strong></div>
        <div style="margin-top: 5px;">äº‹ä»¶ID: <code>${data.eventId}</code> | æ¥æº: <code>${data.source}</code></div>
        <div style="margin-top: 5px; color: #ff9800;">â±ï¸ è·ç¦»ä¸Šæ¬¡è°ƒç”¨: <strong>${data.timeSinceLastCall}ms</strong> (å»é‡çª—å£: 1000ms)</div>
        <details style="margin-top: 5px;">
          <summary style="cursor: pointer; color: #666;">ğŸ“ è°ƒç”¨å †æ ˆï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
          <pre style="margin-top: 5px; padding: 10px; background: #fff3e0; border-radius: 3px; font-size: 11px; overflow-x: auto;">${data.stackTrace}</pre>
        </details>
      `;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    };
    
    // ğŸ†• æ¸…ç©º CREATE æ—¥å¿—
    window.clearCreateLog = function() {
      createSuccessCount = 0;
      createDedupeCount = 0;
      document.getElementById('createSuccessCount').textContent = '0';
      document.getElementById('createDedupeCount').textContent = '0';
      document.getElementById('createDebugContainer').innerHTML = '<div class="log-entry info">â³ ç­‰å¾… CREATE æ“ä½œ...</div>';
    };
    
    // ğŸ†• æ˜¾ç¤º CREATE ç»Ÿè®¡
    window.showCreateStats = function() {
      const total = createSuccessCount + createDedupeCount;
      const dedupeRate = total > 0 ? ((createDedupeCount / total) * 100).toFixed(1) : 0;
      alert(`CREATE æ“ä½œç»Ÿè®¡:\n\nâœ… æˆåŠŸè®°å½•: ${createSuccessCount}\nâš ï¸ å»é‡æ‹¦æˆª: ${createDedupeCount}\nğŸ“Š æ€»è®¡: ${total}\nğŸ›¡ï¸ æ‹¦æˆªç‡: ${dedupeRate}%`);
    };
    
    // ğŸ†• Description è°ƒè¯•æ—¥å¿—è¾“å‡º
    window.logDescription = function(data) {
      const container = document.getElementById('descriptionDebugContainer');
      const entry = document.createElement('div');
      entry.className = 'log-entry warning';
      entry.innerHTML = `
        <div style="border-left: 3px solid #ffa726; padding-left: 10px; margin: 10px 0;">
          <strong>[${new Date().toLocaleTimeString()}] EventID: ${data.eventId}</strong><br>
          <span style="color: #aaa;">Before (${data.before_length} chars):</span> ${data.before_first_150}<br>
          <span style="color: #aaa;">After (${data.after_length} chars):</span> ${data.after_first_150}<br>
          <span style="color: ${data.equal ? '#66bb6a' : '#ef5350'};">ç›¸ç­‰: ${data.equal}</span>
        </div>
      `;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
      
      // é™åˆ¶æœ€å¤šæ˜¾ç¤º 20 æ¡
      while (container.children.length > 20) {
        container.removeChild(container.children[1]); // ä¿ç•™ç¬¬ä¸€ä¸ªæç¤º
      }
    };

    // åŠ è½½ç»Ÿè®¡
    window.loadStats = async function() {
      try {
        log('ğŸ“Š åŠ è½½ç»Ÿè®¡æ•°æ®...', 'info');
        const stats = await EventHistoryService.getBasicStatistics();
        
        document.getElementById('totalCount').textContent = stats.total || 0;
        document.getElementById('createCount').textContent = stats.byOperation?.create || 0;
        document.getElementById('updateCount').textContent = stats.byOperation?.update || 0;
        document.getElementById('deleteCount').textContent = stats.byOperation?.delete || 0;
        document.getElementById('backfillCount').textContent = stats.bySource?.['backfill-from-timestamp'] || 0;
        document.getElementById('oldestRecord').textContent = stats.oldestRecord || '-';
        
        // æ ¹æ®æ•°é‡è®¾ç½®è­¦å‘Šæ ·å¼
        const totalCard = document.querySelector('.stat-card');
        const total = stats.total || 0;
        if (total > 10000) {
          totalCard.classList.add('danger');
          log(`âš ï¸ å†å²è®°å½•è¶…é™: ${total} / 10000`, 'warning');
        } else if (total > 8000) {
          totalCard.classList.add('warning');
          log(`âš ï¸ å†å²è®°å½•å³å°†è¶…é™: ${total} / 10000`, 'warning');
        } else {
          totalCard.classList.add('success');
          log(`âœ… å†å²è®°å½•æ­£å¸¸: ${total} / 10000`, 'success');
        }
        
        log('âœ… ç»Ÿè®¡åŠ è½½å®Œæˆ', 'success');
      } catch (error) {
        log(`âŒ åŠ è½½ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // æµ‹è¯• extractChanges
    window.testExtractChanges = async function() {
      log('ğŸ§ª æµ‹è¯• extractChanges...', 'info');
      log('â„¹ï¸ æ³¨æ„: æ­¤æµ‹è¯•éœ€è¦å®é™…åˆ›å»ºäº‹ä»¶ï¼Œæš‚æ—¶è·³è¿‡', 'warning');
      log('âœ… æ”¹ç”¨æ§åˆ¶å°å‘½ä»¤æµ‹è¯•:', 'info');
      log('  await testEventUpdate()', 'info');
    };

    async function testExtractChangesHelper(before, after) {
      // ç®€åŒ–ç‰ˆæœ¬ - ç›´æ¥ä½¿ç”¨å…¨å±€ EventService
      try {
        if (!window.EventService) {
          throw new Error('EventService æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
        }
        
        // å…ˆåˆ›å»º before äº‹ä»¶
        const beforeEvent = await window.EventService.createEvent(before, { source: 'test' });
        
        // æ›´æ–°ä¸º after
        await window.EventService.updateEvent(beforeEvent.id, after, { source: 'test' });
        
        // æŸ¥è¯¢å†å²è®°å½•
        const history = await EventHistoryService.queryHistory({
          eventId: beforeEvent.id,
          limit: 10
        });
        
        const updateLog = history.find(h => h.operation === 'update');
        
        // æ¸…ç†æµ‹è¯•äº‹ä»¶
        await window.EventService.deleteEvent(beforeEvent.id);
        
        return updateLog?.changes || [];
      } catch (error) {
        log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        console.error('è¯¦ç»†é”™è¯¯:', error);
        return [];
      }
    }

    // æµ‹è¯• EventLog æ¯”è¾ƒ
    window.testEventLogComparison = function() {
      log('ğŸ“ æµ‹è¯• EventLog æ–‡æœ¬æå–...', 'info');
      
      const testCases = [
        {
          name: 'Slate JSON with Block Timestamp',
          eventlog: {
            slateJson: JSON.stringify([
              { type: 'paragraph', createdAt: 1734220800000, children: [{ text: 'æµ‹è¯•å†…å®¹' }] }
            ])
          },
          expected: 'æµ‹è¯•å†…å®¹'
        },
        {
          name: 'Slate JSON without timestamp',
          eventlog: {
            slateJson: JSON.stringify([
              { type: 'paragraph', children: [{ text: 'æµ‹è¯•å†…å®¹' }] }
            ])
          },
          expected: 'æµ‹è¯•å†…å®¹'
        },
        {
          name: 'Multiple paragraphs',
          eventlog: {
            slateJson: JSON.stringify([
              { type: 'paragraph', children: [{ text: 'ç¬¬ä¸€æ®µ' }] },
              { type: 'paragraph', children: [{ text: 'ç¬¬äºŒæ®µ' }] }
            ])
          },
          expected: 'ç¬¬ä¸€æ®µ\nç¬¬äºŒæ®µ'
        }
      ];
      
      testCases.forEach((test, index) => {
        log(`æµ‹è¯• ${index + 1}: ${test.name}`, 'info');
        // Note: extractTextFromEventLog æ˜¯ç§æœ‰æ–¹æ³•ï¼Œè¿™é‡Œä»…ä½œæ¼”ç¤º
        log(`  é¢„æœŸ: "${test.expected}"`, 'info');
      });
      
      log('âœ… EventLog æ¯”è¾ƒæµ‹è¯•å®Œæˆ', 'success');
    };

    // æ˜¾ç¤ºæœ€è¿‘çš„è®°å½•
    window.showRecentLogs = async function() {
      try {
        log('ğŸ“œ æŸ¥è¯¢æœ€è¿‘ 20 æ¡è®°å½•...', 'info');
        const logs = await EventHistoryService.queryHistory({ limit: 20 });
        
        const resultsSection = document.getElementById('resultsSection');
        const resultsContent = document.getElementById('resultsContent');
        
        let html = `<div class="table-container"><table>
          <thead>
            <tr>
              <th>æ—¶é—´</th>
              <th>æ“ä½œ</th>
              <th>äº‹ä»¶ID</th>
              <th>æ¥æº</th>
              <th>å˜æ›´å­—æ®µ</th>
            </tr>
          </thead>
          <tbody>`;
        
        logs.forEach(log => {
          const changes = log.changes?.map(c => c.field).join(', ') || '-';
          html += `<tr>
            <td>${log.timestamp}</td>
            <td>${log.operation}</td>
            <td>${log.eventId?.slice(-8) || '-'}</td>
            <td>${log.source}</td>
            <td>${changes}</td>
          </tr>`;
        });
        
        html += '</tbody></table></div>';
        resultsContent.innerHTML = html;
        resultsSection.style.display = 'block';
        
        log(`âœ… æ˜¾ç¤º ${logs.length} æ¡è®°å½•`, 'success');
      } catch (error) {
        log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
      }
    };

    // æ£€æŸ¥é‡å¤è®°å½•
    window.checkDuplicates = async function() {
      try {
        log('ğŸ” æ£€æŸ¥é‡å¤è®°å½•...', 'info');
        const logs = await EventHistoryService.queryHistory({ limit: 10000 });
        
        const seen = new Map();
        const duplicates = [];
        
        logs.forEach(log => {
          const key = `${log.eventId}|${log.operation}|${log.timestamp}`;
          if (seen.has(key)) {
            duplicates.push({ original: seen.get(key), duplicate: log });
          } else {
            seen.set(key, log);
          }
        });
        
        log(`âœ… æ£€æŸ¥å®Œæˆ: æ‰¾åˆ° ${duplicates.length} ç»„é‡å¤è®°å½•`, 
            duplicates.length > 0 ? 'warning' : 'success');
        
        if (duplicates.length > 0) {
          log(`  ç¤ºä¾‹: ${duplicates.slice(0, 3).map(d => d.original.eventId?.slice(-8)).join(', ')}`, 'info');
        }
      } catch (error) {
        log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
      }
    };

    // åˆ†æå˜æ›´å­—æ®µåˆ†å¸ƒ
    window.analyzeChangeFields = async function() {
      try {
        log('ğŸ“Š åˆ†æå˜æ›´å­—æ®µåˆ†å¸ƒ...', 'info');
        const logs = await EventHistoryService.queryHistory({ limit: 10000 });
        
        const fieldCount = {};
        const operationCount = {};
        const sourceCount = {};
        
        logs.forEach(log => {
          // ç»Ÿè®¡æ“ä½œç±»å‹
          operationCount[log.operation] = (operationCount[log.operation] || 0) + 1;
          
          // ç»Ÿè®¡æ¥æº
          sourceCount[log.source] = (sourceCount[log.source] || 0) + 1;
          
          // ç»Ÿè®¡å˜æ›´å­—æ®µ
          if (log.changes) {
            log.changes.forEach(change => {
              fieldCount[change.field] = (fieldCount[change.field] || 0) + 1;
            });
          }
        });
        
        log(`âœ… åˆ†æå®Œæˆï¼ˆæ ·æœ¬: ${logs.length} æ¡ï¼‰`, 'success');
        log('', 'info');
        log('ğŸ“ˆ æ“ä½œç±»å‹åˆ†å¸ƒ:', 'info');
        Object.entries(operationCount)
          .sort((a,b) => b[1] - a[1])
          .forEach(([op, count]) => {
            log(`  ${op}: ${count} (${(count/logs.length*100).toFixed(1)}%)`, 'info');
          });
        
        log('', 'info');
        log('ğŸ·ï¸ æ¥æºåˆ†å¸ƒ:', 'info');
        Object.entries(sourceCount)
          .sort((a,b) => b[1] - a[1])
          .slice(0, 10)
          .forEach(([source, count]) => {
            log(`  ${source}: ${count} (${(count/logs.length*100).toFixed(1)}%)`, 'info');
          });
        
        log('', 'info');
        log('ğŸ”§ å˜æ›´å­—æ®µ TOP 20:', 'info');
        Object.entries(fieldCount)
          .sort((a,b) => b[1] - a[1])
          .slice(0, 20)
          .forEach(([field, count]) => {
            log(`  ${field}: ${count} (${(count/logs.length*100).toFixed(1)}%)`, 'info');
          });
        
        // ä¿å­˜åˆ°å…¨å±€ä¾›è¿›ä¸€æ­¥åˆ†æ
        window.analysisResult = { fieldCount, operationCount, sourceCount, logs };
        log('', 'info');
        log('ğŸ’¾ è¯¦ç»†æ•°æ®å·²ä¿å­˜åˆ° window.analysisResult', 'success');
      } catch (error) {
        log(`âŒ åˆ†æå¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // ğŸ†• è°ƒè¯•æœ€è¿‘çš„ external-sync æ›´æ–°
    window.debugExternalSync = async function() {
      try {
        log('ğŸ” æŸ¥æ‰¾æœ€è¿‘çš„ external-sync æ›´æ–°...', 'info');
        const logs = await EventHistoryService.queryHistory({ limit: 100 });
        
        const syncLogs = logs.filter(log => 
          log.operation === 'update' && log.source === 'external-sync'
        );
        
        if (syncLogs.length === 0) {
          log('âœ… æ²¡æœ‰æ‰¾åˆ° external-sync æ›´æ–°', 'success');
          return;
        }
        
        log(`æ‰¾åˆ° ${syncLogs.length} æ¡ external-sync æ›´æ–°`, 'info');
        
        // åˆ†æç¬¬ä¸€æ¡
        const firstLog = syncLogs[0];
        log('', 'info');
        log('ğŸ“ æœ€è¿‘ä¸€æ¡ external-sync æ›´æ–°è¯¦æƒ…:', 'info');
        log(`  äº‹ä»¶ID: ${firstLog.eventId}`, 'info');
        log(`  æ—¶é—´: ${firstLog.timestamp}`, 'info');
        log(`  å˜æ›´å­—æ®µæ•°: ${firstLog.changes?.length || 0}`, 'info');
        
        if (firstLog.changes && firstLog.changes.length > 0) {
          log('', 'info');
          log('  å˜æ›´è¯¦æƒ…:', 'info');
          firstLog.changes.slice(0, 5).forEach(change => {
            log(`    - ${change.field}:`, 'info');
            const oldStr = change.oldValue === undefined ? 'undefined' : JSON.stringify(change.oldValue);
            const newStr = change.newValue === undefined ? 'undefined' : JSON.stringify(change.newValue);
            log(`        æ—§: ${oldStr.slice(0, 100)}`, 'info');
            log(`        æ–°: ${newStr.slice(0, 100)}`, 'info');
          });
        }
        
        // ä¿å­˜åˆ°å…¨å±€
        window.debugLog = firstLog;
        log('', 'info');
        log('ğŸ’¾ å®Œæ•´æ•°æ®å·²ä¿å­˜åˆ° window.debugLog', 'success');
        log('ğŸ’¡ åœ¨æ§åˆ¶å°è¿è¡Œ console.log(window.debugLog) æŸ¥çœ‹å®Œæ•´å†…å®¹', 'info');
        
      } catch (error) {
        log(`âŒ è°ƒè¯•å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // è¿è¡Œè‡ªåŠ¨æ¸…ç†
    window.runAutoCleanup = async function() {
      if (!confirm('ç¡®å®šè¦è¿è¡Œè‡ªåŠ¨æ¸…ç†å—ï¼Ÿè¿™ä¼šåˆ é™¤è¿‡æœŸå’Œé‡å¤çš„å†å²è®°å½•ã€‚')) return;
      
      try {
        log('ğŸ§¹ å¼€å§‹è‡ªåŠ¨æ¸…ç†...', 'info');
        const deleted = await EventHistoryService.autoCleanup();
        log(`âœ… æ¸…ç†å®Œæˆ: åˆ é™¤ ${deleted} æ¡è®°å½•`, 'success');
        await loadStats();
      } catch (error) {
        log(`âŒ æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // æ¸…ç†æ—§è®°å½•ï¼ˆ30å¤©å‰ï¼‰
    window.cleanOldRecords = async function() {
      if (!confirm('ç¡®å®šè¦æ¸…ç† 30 å¤©å‰çš„è®°å½•å—ï¼Ÿ')) return;
      
      try {
        log('ğŸ—‘ï¸ å¼€å§‹æ¸…ç† 30 å¤©å‰çš„è®°å½•...', 'info');
        
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - 30);
        
        const { formatTimeForStorage } = await import('/src/utils/timeUtils.ts');
        const cutoffStr = formatTimeForStorage(cutoffDate);
        
        log(`  æˆªæ­¢æ—¶é—´: ${cutoffStr}`, 'info');
        
        const deleted = await StorageManager.cleanupEventHistory(cutoffStr);
        
        log(`âœ… æ¸…ç†å®Œæˆ: åˆ é™¤ ${deleted} æ¡è®°å½•`, 'success');
        await loadStats();
      } catch (error) {
        log(`âŒ æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // æ¸…ç©ºæ‰€æœ‰å†å²
    window.clearAllHistory = async function() {
      if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
      if (!confirm('âš ï¸âš ï¸ å†æ¬¡ç¡®è®¤ï¼šè¿™ä¼šåˆ é™¤æ‰€æœ‰å†å²è®°å½•ï¼')) return;
      
      try {
        log('âš ï¸ æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•...', 'warning');
        
        // åˆ†æ‰¹åˆ é™¤ï¼Œé¿å…ä¸€æ¬¡æ€§æŸ¥è¯¢å¤ªå¤š
        let totalDeleted = 0;
        let batchSize = 5000;
        
        while (true) {
          const logs = await EventHistoryService.queryHistory({ limit: batchSize });
          
          if (logs.length === 0) break;
          
          log(`  æ­£åœ¨åˆ é™¤ ${logs.length} æ¡è®°å½•...`, 'info');
          
          for (const log of logs) {
            await StorageManager.deleteEventHistory(log.id);
          }
          
          totalDeleted += logs.length;
          log(`  å·²åˆ é™¤ ${totalDeleted} æ¡`, 'info');
          
          if (logs.length < batchSize) break;
        }
        
        log(`âœ… æ¸…ç©ºå®Œæˆ: åˆ é™¤ ${totalDeleted} æ¡è®°å½•`, 'success');
        await loadStats();
      } catch (error) {
        log(`âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error');
      }
    };

    // ğŸ†• æ‰‹åŠ¨æµ‹è¯• description å˜æ›´
    window.testDescriptionChange = async function() {
      try {
        log('ğŸ§ª æµ‹è¯• description å˜æ›´æ£€æµ‹...', 'info');
        
        // è·å–æœ€è¿‘çš„ä¸€æ¡ update è®°å½•
        const logs = await EventHistoryService.queryHistory({ 
          limit: 100,
          operationType: 'update'
        });
        
        if (logs.length === 0) {
          log('âš ï¸ æ²¡æœ‰æ‰¾åˆ° update è®°å½•', 'warning');
          return;
        }
        
        // æ‰¾ç¬¬ä¸€ä¸ªåŒ…å« description å˜æ›´çš„è®°å½•
        const descLog = logs.find(l => 
          l.changes?.some(c => c.field === 'description')
        );
        
        if (!descLog) {
          log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°åŒ…å« description å˜æ›´çš„è®°å½•', 'warning');
          return;
        }
        
        const descChange = descLog.changes.find(c => c.field === 'description');
        
        // æ‰‹åŠ¨è§¦å‘è°ƒè¯•äº‹ä»¶
        const debugData = {
          eventId: descLog.eventId.slice(-8),
          before_length: typeof descChange.oldValue === 'string' ? descChange.oldValue.length : 'N/A',
          after_length: typeof descChange.newValue === 'string' ? descChange.newValue.length : 'N/A',
          before_first_150: typeof descChange.oldValue === 'string' ? descChange.oldValue.substring(0, 150) : descChange.oldValue,
          after_first_150: typeof descChange.newValue === 'string' ? descChange.newValue.substring(0, 150) : descChange.newValue,
          equal: descChange.oldValue === descChange.newValue
        };
        
        logDescription(debugData);
        log('âœ… å·²æ˜¾ç¤ºæœ€è¿‘ä¸€æ¡ description å˜æ›´', 'success');
        
      } catch (error) {
        log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // ğŸ†• æ¸…ç©º description æ—¥å¿—
    window.clearDescriptionLog = function() {
      const container = document.getElementById('descriptionDebugContainer');
      container.innerHTML = '<div class="log-entry info">â³ ç­‰å¾… UPDATE æ“ä½œè§¦å‘...ï¼ˆCREATE æ“ä½œä¸ä¼šè§¦å‘æ­¤è°ƒè¯•ï¼‰</div>';
      log('âœ… å·²æ¸…ç©º description æ—¥å¿—', 'success');
    };

    // ğŸ†• æ‰‹åŠ¨æµ‹è¯• CREATE è®°å½•
    window.testCreateEvent = async function() {
      try {
        log('ğŸ§ª æµ‹è¯• CREATE è®°å½•...', 'info');
        
        // åˆ›å»ºæµ‹è¯•äº‹ä»¶
        const testEvent = {
          id: `test-${Date.now()}`,
          title: { text: 'æµ‹è¯• CREATE äº‹ä»¶', displayText: 'æµ‹è¯• CREATE äº‹ä»¶', slateJson: '[]' },
          description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•äº‹ä»¶ï¼Œç”¨äºè§¦å‘ CREATE è®°å½•',
          startTime: new Date().toISOString().slice(0, 19).replace('T', ' '),
          endTime: new Date(Date.now() + 3600000).toISOString().slice(0, 19).replace('T', ' '),
          isAllDay: false
        };
        
        // ç›´æ¥è°ƒç”¨ logCreate
        const result = EventHistoryService.logCreate(testEvent, 'manual-test');
        
        if (result) {
          log('âœ… CREATE è®°å½•æˆåŠŸï¼ŒæŸ¥çœ‹ä¸‹æ–¹æ—¥å¿—', 'success');
        } else {
          log('âš ï¸ CREATE è®°å½•è¢«è·³è¿‡ï¼ˆå¯èƒ½è¢«å»é‡ï¼‰', 'warning');
        }
        
      } catch (error) {
        log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // ğŸ†• æµ‹è¯•é‡å¤ CREATEï¼ˆ1ç§’å†…ï¼‰
    window.testCreateDuplicate = async function() {
      try {
        log('ğŸ§ª æµ‹è¯•é‡å¤ CREATEï¼ˆ1ç§’å†…ä¸¤æ¬¡è°ƒç”¨ï¼‰...', 'info');
        
        const eventId = `test-duplicate-${Date.now()}`;
        const testEvent = {
          id: eventId,
          title: { text: 'æµ‹è¯•é‡å¤ CREATE', displayText: 'æµ‹è¯•é‡å¤ CREATE', slateJson: '[]' },
          description: 'æµ‹è¯•å»é‡æœºåˆ¶',
          startTime: new Date().toISOString().slice(0, 19).replace('T', ' '),
          endTime: new Date(Date.now() + 3600000).toISOString().slice(0, 19).replace('T', ' '),
          isAllDay: false
        };
        
        // ç¬¬ä¸€æ¬¡è°ƒç”¨
        const result1 = EventHistoryService.logCreate(testEvent, 'duplicate-test-1');
        log(result1 ? 'âœ… ç¬¬ä¸€æ¬¡ CREATE æˆåŠŸ' : 'âš ï¸ ç¬¬ä¸€æ¬¡ CREATE è¢«è·³è¿‡', result1 ? 'success' : 'warning');
        
        // ç«‹å³ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ˆåº”è¯¥è¢«å»é‡ï¼‰
        setTimeout(() => {
          const result2 = EventHistoryService.logCreate(testEvent, 'duplicate-test-2');
          log(result2 ? 'âŒ ç¬¬äºŒæ¬¡ CREATE æˆåŠŸï¼ˆå»é‡å¤±è´¥ï¼ï¼‰' : 'âœ… ç¬¬äºŒæ¬¡ CREATE è¢«å»é‡æ‹¦æˆª', result2 ? 'error' : 'success');
        }, 100); // 100ms åè°ƒç”¨ï¼Œè¿œå°äº 1000ms å»é‡çª—å£
        
      } catch (error) {
        log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // ğŸ†• åˆ†æ CREATE è®°å½•ï¼ˆè¯Šæ–­ä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šåˆ›å»ºæ“ä½œï¼‰
    window.analyzeCreateRecords = async function() {
      try {
        log('ğŸ”¬ åˆ†ææœ€è¿‘çš„ CREATE è®°å½•...', 'info');
        
        const logs = await EventHistoryService.queryHistory({ 
          limit: 200,
          operationType: 'create'
        });
        
        if (logs.length === 0) {
          log('âš ï¸ æ²¡æœ‰æ‰¾åˆ° CREATE è®°å½•', 'warning');
          return;
        }
        
        log(`æ‰¾åˆ° ${logs.length} æ¡ CREATE è®°å½•`, 'info');
        log('', 'info');
        
        // ç»Ÿè®¡æ¥æº
        const sources = {};
        const recentCreates = [];
        const now = Date.now();
        
        logs.forEach(l => {
          const source = l.source || 'unknown';
          sources[source] = (sources[source] || 0) + 1;
          
          // æœ€è¿‘24å°æ—¶çš„è®°å½•
          const logTime = new Date(l.timestamp).getTime();
          if (now - logTime < 24 * 60 * 60 * 1000) {
            recentCreates.push(l);
          }
        });
        
        log('ğŸ“Š æ¥æºåˆ†å¸ƒ:', 'info');
        Object.entries(sources).forEach(([source, count]) => {
          log(`  ${source}: ${count} (${(count / logs.length * 100).toFixed(1)}%)`, 'info');
        });
        
        log('', 'info');
        log(`â° æœ€è¿‘24å°æ—¶å†…çš„ CREATE: ${recentCreates.length} æ¡`, recentCreates.length > 50 ? 'warning' : 'success');
        
        if (recentCreates.length > 0) {
          log('', 'info');
          log('ğŸ” æœ€è¿‘10æ¡ CREATE è¯¦æƒ…:', 'info');
          
          recentCreates.slice(0, 10).forEach((l, i) => {
            const eventId = l.eventId.slice(-8);
            const timeDiff = Math.floor((now - new Date(l.timestamp).getTime()) / 1000 / 60);
            log(`  ${i + 1}. [${eventId}] ${timeDiff}åˆ†é’Ÿå‰ - æ¥æº: ${l.source}`, 'info');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ externalIdï¼ˆè¯´æ˜æ˜¯ Outlook åŒæ­¥ï¼‰
            const hasExternalId = l.changes?.some(c => c.field === 'externalId' && c.newValue);
            const title = l.changes?.find(c => c.field === 'title')?.newValue?.simpleTitle || 'N/A';
            
            log(`      æ ‡é¢˜: ${title}`, 'info');
            log(`      æ˜¯å¦æœ‰ externalId: ${hasExternalId ? 'Yes (Outlook)' : 'No (Local)'}`, 'info');
          });
        }
        
        // ä¿å­˜åˆ°å…¨å±€
        window.createAnalysis = { logs, recentCreates, sources };
        log('', 'info');
        log('ğŸ’¾ å®Œæ•´æ•°æ®å·²ä¿å­˜åˆ° window.createAnalysis', 'success');
        log('ğŸ’¡ è¿è¡Œ console.log(window.createAnalysis) æŸ¥çœ‹è¯¦æƒ…', 'info');
        
      } catch (error) {
        log(`âŒ åˆ†æå¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
