<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>åŒæ­¥ä¿®å¤éªŒè¯ - å¿«é€Ÿæµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 30px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    button {
      background: #28a745;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px;
      font-size: 16px;
      font-weight: bold;
    }
    button:hover {
      background: #218838;
    }
    .result {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .success {
      border-left: 4px solid #28a745;
      background: #d4edda;
    }
    .fail {
      border-left: 4px solid #dc3545;
      background: #f8d7da;
    }
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: #28a745;
    }
    .stat-label {
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>âœ… åŒæ­¥ä¿®å¤éªŒè¯</h1>
    <p>å¿«é€Ÿæµ‹è¯• normalizeEvent å’Œç­¾åå¤„ç†æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
  </div>

  <div>
    <button onclick="testNormalizeEventLog()">æµ‹è¯• normalizeEventLog</button>
    <button onclick="testSignatureRemoval()">æµ‹è¯•ç­¾åç§»é™¤</button>
    <button onclick="testFullWorkflow()">å®Œæ•´å·¥ä½œæµæµ‹è¯•</button>
    <button onclick="checkRecentSyncedEvents()">æ£€æŸ¥æœ€è¿‘åŒæ­¥äº‹ä»¶</button>
  </div>

  <div id="results"></div>

  <script type="module">
    import { EventService } from '../src/services/EventService.ts';
    import { SignatureUtils } from '../src/utils/signatureUtils.ts';
    import { storageManager } from '../src/services/storage/StorageManager.ts';

    window.EventService = EventService;
    window.SignatureUtils = SignatureUtils;
    window.storageManager = storageManager;

    function addResult(html) {
      document.getElementById('results').innerHTML += html;
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }

    // æµ‹è¯• 1: normalizeEventLog æ˜¯å¦æ­£ç¡®å¤„ç†çº¯æ–‡æœ¬
    window.testNormalizeEventLog = async function() {
      clearResults();
      addResult('<h3>æµ‹è¯• normalizeEventLog</h3>');

      try {
        // æµ‹è¯•ç”¨ä¾‹ 1: çº¯æ–‡æœ¬ï¼ˆæ— æ—¶é—´æˆ³ï¼‰
        const plainText = 'è¿™æ˜¯ä¸€æ®µä¼šè®®è®°å½•';
        const result1 = EventService['normalizeEventLog'](plainText);
        
        const slateJson1 = JSON.parse(result1.slateJson);
        const hasBlockMeta1 = slateJson1.every(node => 
          node.type !== 'paragraph' || (node.id && node.createdAt && node.updatedAt)
        );

        addResult(`
          <div class="result ${hasBlockMeta1 ? 'success' : 'fail'}">
            <strong>${hasBlockMeta1 ? 'âœ…' : 'âŒ'} æµ‹è¯• 1: çº¯æ–‡æœ¬ â†’ EventLog</strong>
            <p>è¾“å…¥: "${plainText}"</p>
            <p>Block-Level å…ƒæ•°æ®: ${hasBlockMeta1 ? 'å·²æ·»åŠ ' : 'ç¼ºå¤±'}</p>
            <details>
              <summary>æŸ¥çœ‹ slateJson</summary>
              <pre>${JSON.stringify(slateJson1, null, 2)}</pre>
            </details>
          </div>
        `);

        // æµ‹è¯•ç”¨ä¾‹ 2: å¸¦æ—¶é—´æˆ³çš„çº¯æ–‡æœ¬
        const textWithTimestamp = '2025-12-07 01:30:06\nä¼šè®®å†…å®¹ç¬¬ä¸€æ®µ\n\n2025-12-07 02:00:00\nä¼šè®®å†…å®¹ç¬¬äºŒæ®µ';
        const result2 = EventService['normalizeEventLog'](textWithTimestamp);
        
        const slateJson2 = JSON.parse(result2.slateJson);
        const hasTimestampParsed = slateJson2.every(node => 
          node.type !== 'paragraph' || (node.createdAt && node.id)
        );
        const noTextTimestamp = !slateJson2.some(node => 
          node.type === 'paragraph' && 
          node.children?.[0]?.text?.match(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/)
        );

        addResult(`
          <div class="result ${hasTimestampParsed && noTextTimestamp ? 'success' : 'fail'}">
            <strong>${hasTimestampParsed && noTextTimestamp ? 'âœ…' : 'âŒ'} æµ‹è¯• 2: å¸¦æ—¶é—´æˆ³æ–‡æœ¬ â†’ Block-Level</strong>
            <p>æ—¶é—´æˆ³è§£æ: ${hasTimestampParsed ? 'æˆåŠŸ' : 'å¤±è´¥'}</p>
            <p>çº¯æ–‡æœ¬æ—¶é—´æˆ³æ®‹ç•™: ${noTextTimestamp ? 'æ— ' : 'æœ‰ï¼ˆé—®é¢˜ï¼ï¼‰'}</p>
            <details>
              <summary>æŸ¥çœ‹ slateJson</summary>
              <pre>${JSON.stringify(slateJson2, null, 2)}</pre>
            </details>
          </div>
        `);

      } catch (error) {
        addResult(`
          <div class="result fail">
            <strong>âŒ æµ‹è¯•å¤±è´¥</strong>
            <p>${error.message}</p>
            <pre>${error.stack}</pre>
          </div>
        `);
      }
    };

    // æµ‹è¯• 2: ç­¾åç§»é™¤
    window.testSignatureRemoval = function() {
      clearResults();
      addResult('<h3>æµ‹è¯•ç­¾åç§»é™¤</h3>');

      const testCases = [
        {
          input: 'ä¼šè®®å†…å®¹\n\n---\nç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-04 02:47:50',
          expected: 'ä¼šè®®å†…å®¹'
        },
        {
          input: 'é‡è¦äº‹é¡¹\n\n---\nç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-04 02:47:50\nç”± ğŸ“§ Outlook æœ€åç¼–è¾‘äº 2025-12-15 00:21:54',
          expected: 'é‡è¦äº‹é¡¹'
        },
        {
          input: 'æ— ç­¾åçš„å†…å®¹',
          expected: 'æ— ç­¾åçš„å†…å®¹'
        }
      ];

      testCases.forEach((test, idx) => {
        const result = SignatureUtils.extractCoreContent(test.input);
        const success = result.trim() === test.expected.trim();

        addResult(`
          <div class="result ${success ? 'success' : 'fail'}">
            <strong>${success ? 'âœ…' : 'âŒ'} æµ‹è¯•ç”¨ä¾‹ ${idx + 1}</strong>
            <p>è¾“å…¥é•¿åº¦: ${test.input.length} å­—ç¬¦</p>
            <p>è¾“å‡ºé•¿åº¦: ${result.length} å­—ç¬¦</p>
            <p>é¢„æœŸ: "${test.expected}"</p>
            <p>å®é™…: "${result}"</p>
            <p>ç»“æœ: ${success ? 'é€šè¿‡' : 'å¤±è´¥'}</p>
          </div>
        `);
      });
    };

    // æµ‹è¯• 3: å®Œæ•´å·¥ä½œæµ
    window.testFullWorkflow = async function() {
      clearResults();
      addResult('<h3>å®Œæ•´å·¥ä½œæµæµ‹è¯•</h3>');
      addResult('<p>æ¨¡æ‹Ÿ Outlook åŒæ­¥ â†’ EventService.updateEvent â†’ éªŒè¯ç»“æœ</p>');

      try {
        // 1. åˆ›å»ºæµ‹è¯•äº‹ä»¶
        const testEvent = await EventService.createEvent({
          title: 'æµ‹è¯•äº‹ä»¶ - åŒæ­¥ä¿®å¤éªŒè¯',
          startTime: '2025-12-16 10:00:00',
          endTime: '2025-12-16 11:00:00',
          description: 'åˆå§‹å†…å®¹'
        });

        addResult(`
          <div class="result success">
            <strong>âœ… æ­¥éª¤ 1: åˆ›å»ºæµ‹è¯•äº‹ä»¶</strong>
            <p>äº‹ä»¶ ID: ${testEvent.id}</p>
          </div>
        `);

        // 2. æ¨¡æ‹Ÿ Outlook åŒæ­¥ï¼ˆä¼ é€’çº¯æ–‡æœ¬ï¼‰
        const remoteCoreContent = '2025-12-07 01:30:06\nOutlook åŒæ­¥çš„å†…å®¹\n\n2025-12-07 02:00:00\nç¬¬äºŒæ®µå†…å®¹';
        
        const updateResult = await EventService.updateEvent(
          testEvent.id,
          {
            eventlog: remoteCoreContent  // âœ… ä¼ é€’çº¯æ–‡æœ¬ï¼Œä¸æ‰‹åŠ¨æ„é€  slateJson
          },
          false,
          { source: 'external-sync' }
        );

        if (!updateResult.success) {
          throw new Error('æ›´æ–°å¤±è´¥: ' + updateResult.error);
        }

        const updatedEvent = updateResult.event;
        
        // 3. éªŒè¯ EventLog ç»“æ„
        const eventlog = updatedEvent.eventlog;
        const slateJson = typeof eventlog.slateJson === 'string' 
          ? JSON.parse(eventlog.slateJson) 
          : eventlog.slateJson;
        
        const hasBlockMeta = slateJson.every(node => 
          node.type !== 'paragraph' || (node.id && node.createdAt && node.updatedAt)
        );
        
        const noTextTimestamp = !slateJson.some(node => 
          node.type === 'paragraph' && 
          node.children?.[0]?.text?.match(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/)
        );

        addResult(`
          <div class="result ${hasBlockMeta && noTextTimestamp ? 'success' : 'fail'}">
            <strong>${hasBlockMeta && noTextTimestamp ? 'âœ…' : 'âŒ'} æ­¥éª¤ 2: éªŒè¯ EventLog ç»“æ„</strong>
            <p>Block-Level å…ƒæ•°æ®: ${hasBlockMeta ? 'âœ… å®Œæ•´' : 'âŒ ç¼ºå¤±'}</p>
            <p>çº¯æ–‡æœ¬æ—¶é—´æˆ³: ${noTextTimestamp ? 'âœ… å·²æ¸…é™¤' : 'âŒ ä»å­˜åœ¨'}</p>
            <details>
              <summary>æŸ¥çœ‹ slateJson</summary>
              <pre>${JSON.stringify(slateJson, null, 2)}</pre>
            </details>
          </div>
        `);

        // 4. éªŒè¯ç­¾åå¤„ç†
        const description = updatedEvent.description || '';
        const hasSignature = /ç”±\s+(?:ğŸ”®|ğŸ“§)\s*(?:4DNote|Outlook)\s*åˆ›å»ºäº/.test(description);
        const coreContent = SignatureUtils.extractCoreContent(description);
        const signatureRemoved = !coreContent.includes('ç”±') && !coreContent.includes('åˆ›å»ºäº');

        addResult(`
          <div class="result ${hasSignature && signatureRemoved ? 'success' : 'fail'}">
            <strong>${hasSignature && signatureRemoved ? 'âœ…' : 'âŒ'} æ­¥éª¤ 3: éªŒè¯ç­¾åå¤„ç†</strong>
            <p>description åŒ…å«ç­¾å: ${hasSignature ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
            <p>extractCoreContent ç§»é™¤ç­¾å: ${signatureRemoved ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}</p>
            <details>
              <summary>æŸ¥çœ‹ description</summary>
              <pre>${description}</pre>
            </details>
            <details>
              <summary>æŸ¥çœ‹æ ¸å¿ƒå†…å®¹</summary>
              <pre>${coreContent}</pre>
            </details>
          </div>
        `);

        // 5. æ¸…ç†æµ‹è¯•äº‹ä»¶
        await EventService.deleteEvent(testEvent.id, true);
        addResult(`
          <div class="result success">
            <strong>âœ… æ­¥éª¤ 4: æ¸…ç†æµ‹è¯•äº‹ä»¶</strong>
            <p>æµ‹è¯•å®Œæˆï¼Œå·²åˆ é™¤æµ‹è¯•äº‹ä»¶</p>
          </div>
        `);

      } catch (error) {
        addResult(`
          <div class="result fail">
            <strong>âŒ å·¥ä½œæµæµ‹è¯•å¤±è´¥</strong>
            <p>${error.message}</p>
            <pre>${error.stack}</pre>
          </div>
        `);
      }
    };

    // æµ‹è¯• 4: æ£€æŸ¥æœ€è¿‘åŒæ­¥çš„äº‹ä»¶
    window.checkRecentSyncedEvents = async function() {
      clearResults();
      addResult('<h3>æ£€æŸ¥æœ€è¿‘åŒæ­¥çš„äº‹ä»¶</h3>');

      try {
        const events = await storageManager.getAllEvents();
        const syncedEvents = events
          .filter(e => e.lastSyncTime)
          .sort((a, b) => new Date(b.lastSyncTime) - new Date(a.lastSyncTime))
          .slice(0, 5);

        let totalChecked = 0;
        let passedCount = 0;
        let failedCount = 0;

        syncedEvents.forEach((event, idx) => {
          totalChecked++;
          
          try {
            const slateJson = typeof event.eventlog?.slateJson === 'string'
              ? JSON.parse(event.eventlog.slateJson)
              : event.eventlog?.slateJson || [];
            
            const hasBlockMeta = slateJson.every(node => 
              node.type !== 'paragraph' || (node.id && node.createdAt)
            );
            
            const noTextTimestamp = !slateJson.some(node => 
              node.type === 'paragraph' && 
              node.children?.[0]?.text?.match(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/)
            );

            const passed = hasBlockMeta && noTextTimestamp;
            if (passed) passedCount++;
            else failedCount++;

            addResult(`
              <div class="result ${passed ? 'success' : 'fail'}">
                <strong>${passed ? 'âœ…' : 'âŒ'} ${idx + 1}. ${event.title?.simpleTitle || event.title || 'Untitled'}</strong>
                <p>æœ€ååŒæ­¥: ${event.lastSyncTime}</p>
                <p>Block-Level å…ƒæ•°æ®: ${hasBlockMeta ? 'âœ…' : 'âŒ'}</p>
                <p>çº¯æ–‡æœ¬æ—¶é—´æˆ³: ${noTextTimestamp ? 'âœ… æ— ' : 'âŒ æœ‰'}</p>
              </div>
            `);
          } catch (error) {
            failedCount++;
            addResult(`
              <div class="result fail">
                <strong>âŒ ${idx + 1}. æ£€æŸ¥å¤±è´¥</strong>
                <p>${error.message}</p>
              </div>
            `);
          }
        });

        // æ˜¾ç¤ºç»Ÿè®¡
        addResult(`
          <div class="stats">
            <div class="stat-card">
              <div class="stat-value">${totalChecked}</div>
              <div class="stat-label">æ£€æŸ¥äº‹ä»¶æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" style="color: #28a745;">${passedCount}</div>
              <div class="stat-label">é€šè¿‡</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" style="color: #dc3545;">${failedCount}</div>
              <div class="stat-label">å¤±è´¥</div>
            </div>
          </div>
        `);

      } catch (error) {
        addResult(`
          <div class="result fail">
            <strong>âŒ æ£€æŸ¥å¤±è´¥</strong>
            <p>${error.message}</p>
          </div>
        `);
      }
    };

    console.log('âœ… æµ‹è¯•é¡µé¢å·²åŠ è½½');
    console.log('å¯ç”¨æµ‹è¯•ï¼š');
    console.log('1. testNormalizeEventLog() - æµ‹è¯• normalizeEventLog');
    console.log('2. testSignatureRemoval() - æµ‹è¯•ç­¾åç§»é™¤');
    console.log('3. testFullWorkflow() - å®Œæ•´å·¥ä½œæµæµ‹è¯•');
    console.log('4. checkRecentSyncedEvents() - æ£€æŸ¥æœ€è¿‘åŒæ­¥çš„äº‹ä»¶');
  </script>
</body>
</html>
