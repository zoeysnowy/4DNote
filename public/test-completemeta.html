<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CompleteMeta åŒæ­¥æ¶æ„æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #1976d2;
      border-bottom: 3px solid #1976d2;
      padding-bottom: 10px;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      color: #424242;
      margin-top: 0;
    }
    .two-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .column {
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #616161;
    }
    textarea {
      width: 100%;
      min-height: 300px;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      resize: vertical;
    }
    .html-preview {
      border: 1px solid #e0e0e0;
      padding: 15px;
      background: #fafafa;
      min-height: 300px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      word-break: break-all;
    }
    .meta-display {
      background: #fff3e0;
      border: 1px solid #ff9800;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
    }
    .diff-result {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
    }
    .diff-item {
      padding: 5px;
      margin: 3px 0;
      border-radius: 3px;
    }
    .diff-match {
      background: #c8e6c9;
    }
    .diff-insert {
      background: #fff9c4;
    }
    .diff-delete {
      background: #ffcdd2;
    }
    button {
      padding: 10px 20px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #1565c0;
    }
    button:active {
      background: #0d47a1;
    }
    .scenario-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    .scenario-buttons button {
      background: #673ab7;
    }
    .scenario-buttons button:hover {
      background: #5e35b1;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    .info-box h3 {
      margin-top: 0;
      color: #1976d2;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }
    .stat-item {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-label {
      font-size: 12px;
      color: #757575;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #1976d2;
    }
  </style>
</head>
<body>
  <h1>ğŸ”¬ CompleteMeta åŒæ­¥æ¶æ„æµ‹è¯•</h1>
  
  <div class="info-box">
    <h3>æµ‹è¯•è¯´æ˜</h3>
    <p><strong>CompleteMetaæ¶æ„</strong>ä½¿ç”¨Base64ç¼–ç çš„éšè—divæ¥å­˜å‚¨å…ƒæ•°æ®ï¼Œå¹¶é€šè¿‡Diffç®—æ³•å®ç°HTMLä¸Metaçš„æ™ºèƒ½å¯¹é½ã€‚</p>
    <ul>
      <li><strong>åºåˆ—åŒ–</strong>ï¼šEvent â†’ HTML + Base64 Metaï¼ˆæ¨¡æ‹Ÿ4DNoteâ†’OutlookåŒæ­¥ï¼‰</li>
      <li><strong>ååºåˆ—åŒ–</strong>ï¼šHTML + Meta â†’ Eventï¼ˆæ¨¡æ‹ŸOutlookâ†’4DNoteåŒæ­¥ï¼Œæ”¯æŒæ£€æµ‹ç”¨æˆ·çš„æ·»åŠ /åˆ é™¤/ä¿®æ”¹ï¼‰</li>
      <li><strong>Diffå¯¹é½</strong>ï¼šä½¿ç”¨hintï¼ˆæ–‡æœ¬å‰ç¼€ï¼‰è¿›è¡Œæ™ºèƒ½åŒ¹é…ï¼Œå¤„ç†æ®µè½çš„æ–°å¢/åˆ é™¤/ç¼–è¾‘</li>
    </ul>
  </div>

  <div class="info-box" style="background: #fff3e0; border-left-color: #ff9800;">
    <h3>ğŸ“Š ä¸ºä»€ä¹ˆä½¿ç”¨Base64ç¼–ç ï¼Ÿ</h3>
    <ul>
      <li><strong>é˜²æ­¢è½¬ä¹‰ç¾éš¾</strong>ï¼šMeta JSONä¸­åŒ…å«å¤§é‡å¼•å·ã€å°–æ‹¬å·ç­‰ç‰¹æ®Šå­—ç¬¦ï¼Œç›´æ¥åµŒå…¥HTMLä¼šå¯¼è‡´è½¬ä¹‰åœ°ç‹±</li>
      <li><strong>é‚®ä»¶ç³»ç»Ÿå®‰å…¨</strong>ï¼šOutlookç­‰é‚®ä»¶å®¢æˆ·ç«¯ä¼šæ¸…ç†HTMLï¼ŒBase64ç¼–ç åçš„çº¯å­—ç¬¦ä¸²æ›´å®‰å…¨</li>
      <li><strong>ä½“ç§¯å¼€é”€å¯æ§</strong>ï¼šBase64ç¼–ç çº¦å¢åŠ 33%ä½“ç§¯ï¼Œä½†Metaæœ¬èº«åªä¿å­˜å…ƒæ•°æ®ï¼ˆä¸å«æ–‡æœ¬ï¼‰ï¼Œå®é™…å¢åŠ æœ‰é™</li>
      <li><strong>å®é™…ä½“ç§¯</strong>ï¼š5ä¸ªæ®µè½çš„EventLogï¼ŒMetaçº¦400Bï¼ŒBase64åçº¦530Bï¼Œæ€»HTMLçº¦1.5KB</li>
      <li><strong>Outlooké™åˆ¶</strong>ï¼šå•ä¸ªEventçš„descriptioné™åˆ¶32KBï¼Œå³ä½¿20æ®µå¤æ‚EventLogä¹Ÿè¿œä½äºæ­¤é™åˆ¶</li>
    </ul>
    <p style="color: #e65100; font-weight: bold; margin-top: 10px;">âš ï¸ æ³¨æ„ï¼šBase64ä¸æ˜¯åŠ å¯†ï¼ä»»ä½•äººéƒ½å¯ä»¥ç”¨atob()è§£ç ï¼Œå®ƒåªæ˜¯ç¼–ç æ ¼å¼ã€‚</p>
  </div>

  <div class="info-box" style="background: #f3e5f5; border-left-color: #9c27b0;">
    <h3>ğŸ¤” ä¸ºä»€ä¹ˆä¸èƒ½åªç”¨eventIDè§£å†³é—®é¢˜ï¼Ÿ</h3>
    <p><strong>æ ¸å¿ƒé—®é¢˜</strong>ï¼ševentIDåªèƒ½æŸ¥åˆ°"æ—§ç‰ˆæœ¬"Eventï¼Œæ— æ³•çŸ¥é“ç”¨æˆ·åœ¨Outlookä¸­çš„å…·ä½“ç¼–è¾‘ã€‚</p>
    
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
      <thead>
        <tr style="background: #ede7f6;">
          <th style="padding: 8px; border: 1px solid #9c27b0; text-align: left;">åœºæ™¯</th>
          <th style="padding: 8px; border: 1px solid #9c27b0; text-align: left;">åªæœ‰eventID</th>
          <th style="padding: 8px; border: 1px solid #9c27b0; text-align: left;">æœ‰CompleteMeta</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 8px; border: 1px solid #e0e0e0;"><strong>ç”¨æˆ·åˆ é™¤æ®µè½</strong></td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âŒ ä¸çŸ¥é“åˆ äº†å“ªæ®µï¼Œåªèƒ½å…¨éƒ¨è¦†ç›–</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… Diffç®—æ³•æ£€æµ‹åˆ°å…·ä½“åˆ é™¤çš„æ®µè½</td>
        </tr>
        <tr>
          <td style="padding: 8px; border: 1px solid #e0e0e0;"><strong>ç”¨æˆ·æ–°å¢æ®µè½</strong></td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âŒ ä¸çŸ¥é“æ–°å¢ä½ç½®ï¼Œå¯èƒ½ä¸¢å¤±</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… æ£€æµ‹åˆ°æ–°å¢ï¼Œç”Ÿæˆæ–°èŠ‚ç‚¹ID</td>
        </tr>
        <tr>
          <td style="padding: 8px; border: 1px solid #e0e0e0;"><strong>èŠ‚ç‚¹IDä¿ç•™</strong></td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âŒ é‡æ–°è§£æHTMLç”Ÿæˆæ–°IDï¼Œæ‰€æœ‰å¼•ç”¨æ–­è£‚</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… èŠ‚ç‚¹IDåœ¨Metaä¸­ä¿å­˜ï¼Œå¾€è¿”ä¸å˜</td>
        </tr>
        <tr>
          <td style="padding: 8px; border: 1px solid #e0e0e0;"><strong>mentionå…ƒæ•°æ®</strong></td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âŒ Outlookæ¸…é™¤data-*åæ— æ³•æ¢å¤</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… Metaä¸­ä¿å­˜å®Œæ•´mentionä¿¡æ¯</td>
        </tr>
        <tr>
          <td style="padding: 8px; border: 1px solid #e0e0e0;"><strong>bulletLevel/level</strong></td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âŒ Outlookå¯èƒ½æ”¹å˜HTMLç»“æ„ï¼Œä¸¢å¤±å±‚çº§</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… ä»Metaæ¢å¤åŸå§‹å±‚çº§ä¿¡æ¯</td>
        </tr>
        <tr>
          <td style="padding: 8px; border: 1px solid #e0e0e0;"><strong>æ—¶é—´æˆ³èŠ‚ç‚¹</strong></td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âŒ createdAt/updatedAtåœ¨HTMLä¸­ä¼šä¸¢å¤±</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… Metaä¿å­˜æ¯ä¸ªèŠ‚ç‚¹çš„æ—¶é—´æˆ³</td>
        </tr>
      </tbody>
    </table>
    
    <p style="margin-top: 15px;"><strong>æ€»ç»“</strong>ï¼ševentIDçš„ä½œç”¨æ˜¯<em>èº«ä»½æ ‡è¯†</em>ï¼Œç”¨äºæŸ¥è¯¢æœ¬åœ°æ•°æ®åº“ã€‚CompleteMetaçš„ä½œç”¨æ˜¯<em>å˜æ›´æ£€æµ‹å’Œå…ƒæ•°æ®æ¢å¤</em>ï¼Œä¸¤è€…é…åˆæ‰èƒ½å®ç°å¯é çš„åŒå‘åŒæ­¥ã€‚</p>
  </div>

  <div class="info-box" style="background: #ffebee; border-left-color: #f44336;">
    <h3>âš–ï¸ Trade-offï¼šhinté•¿åº¦ vs å¯¹é½å‡†ç¡®ç‡</h3>
    
    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
      <thead>
        <tr style="background: #ffcdd2;">
          <th style="padding: 8px; border: 1px solid #f44336;">hinté•¿åº¦</th>
          <th style="padding: 8px; border: 1px solid #f44336;">Metaä½“ç§¯</th>
          <th style="padding: 8px; border: 1px solid #f44336;">å¯¹é½å‡†ç¡®ç‡</th>
          <th style="padding: 8px; border: 1px solid #f44336;">æŠ—ä¿®æ”¹èƒ½åŠ›</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">5å­—ç¬¦</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">æœ€å°ï¼ˆ~200Bï¼‰</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âŒ ä½ï¼ˆæ˜“è¯¯åˆ¤ï¼‰</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âŒ ä¿®æ”¹1-2å­—å°±å¤±æ•ˆ</td>
        </tr>
        <tr style="background: #e8f5e9;">
          <td style="padding: 8px; border: 1px solid #e0e0e0;"><strong>10å­—ç¬¦ï¼ˆå½“å‰ï¼‰</strong></td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">é€‚ä¸­ï¼ˆ~400Bï¼‰</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… ä¸­ç­‰ï¼ˆ60%é˜ˆå€¼ï¼‰</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âš ï¸ ä¿®æ”¹5-6å­—ä¼šå¤±æ•ˆ</td>
        </tr>
        <tr>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">15-20å­—ç¬¦</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">è¾ƒå¤§ï¼ˆ~600Bï¼‰</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… é«˜ï¼ˆæ›´ç¨³å®šï¼‰</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… å¯å®¹å¿æ›´å¤šä¿®æ”¹</td>
        </tr>
        <tr>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">å®Œæ•´æ–‡æœ¬</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âŒ çˆ†ç‚¸ï¼ˆ2-3KBï¼‰</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… å®Œç¾</td>
          <td style="padding: 8px; border: 1px solid #e0e0e0;">âœ… å®Œç¾ï¼ˆä½†è¿èƒŒè®¾è®¡ï¼‰</td>
        </tr>
      </tbody>
    </table>
    
    <p style="margin-top: 10px;"><strong>å®é™…è¡¨ç°</strong>ï¼š</p>
    <ul style="margin: 5px 0;">
      <li><strong>å°å¹…ç¼–è¾‘ï¼ˆæœ«å°¾æ·»åŠ ï¼‰</strong>ï¼š"ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦" â†’ "ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦å’Œç»†èŠ‚" âœ… å¯æ­£ç¡®å¯¹é½</li>
      <li><strong>ä¸­ç­‰ç¼–è¾‘ï¼ˆä¸­é—´ä¿®æ”¹ï¼‰</strong>ï¼š"ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦" â†’ "ä¼šè®®å¼€å§‹åè®¨è®ºæ–°é¡¹ç›®è¿›åº¦" âœ… ç›¸ä¼¼åº¦70%ï¼Œå¯å¯¹é½</li>
      <li><strong>å¤§å¹…ä¿®æ”¹ï¼ˆå‰10å­—ç¬¦å˜åŒ–>40%ï¼‰</strong>ï¼š"ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦" â†’ "ä¼šè®®å¼€å§‹åé¢†å¯¼è‡´è¾" âŒ ç›¸ä¼¼åº¦40%ï¼Œåˆ¤å®šä¸ºåˆ é™¤+æ–°å¢</li>
    </ul>
    
    <p style="margin-top: 10px; color: #d32f2f;"><strong>å»ºè®®</strong>ï¼šå¦‚æœç”¨æˆ·ç»å¸¸å¤§å¹…ä¿®æ”¹æ®µè½å¼€å¤´ï¼Œå¯å°†hinté•¿åº¦è°ƒæ•´ä¸º15-20å­—ç¬¦ï¼ŒMetaä½“ç§¯å¢åŠ çº¦50%ï¼ˆ400Bâ†’600Bï¼‰ï¼Œä½†ä»è¿œä½äº32KBé™åˆ¶ã€‚</p>
  </div>

  <!-- æ­¥éª¤1ï¼šåºåˆ—åŒ–Eventåˆ°HTML -->
  <div class="test-section">
    <h2>æ­¥éª¤1ï¸âƒ£ï¼šåºåˆ—åŒ–Eventåˆ°HTMLï¼ˆ4DNote â†’ Outlookï¼‰</h2>
    
    <div class="scenario-buttons">
      <button onclick="loadScenario('simple')">ç®€å•äº‹ä»¶</button>
      <button onclick="loadScenario('complex')">å¤æ‚äº‹ä»¶ï¼ˆå«mentionï¼‰</button>
      <button onclick="loadScenario('multiLevel')">å¤šå±‚çº§æ ‡é¢˜</button>
      <button onclick="loadScenario('bullets')">åˆ—è¡¨ç¼©è¿›</button>
    </div>

    <div class="two-columns">
      <div class="column">
        <label>è¾“å…¥Event JSONï¼š</label>
        <textarea id="eventInput" placeholder='{"id":"evt_001","eventlog":{"slateJson":"..."}}'></textarea>
        <button onclick="serializeEvent()" style="margin-top: 10px;">ğŸ”„ åºåˆ—åŒ–ä¸ºHTML + Meta</button>
      </div>
      
      <div class="column">
        <label>ç”Ÿæˆçš„HTMLï¼ˆå¸¦Base64 Metaï¼‰ï¼š</label>
        <div class="html-preview" id="htmlOutput"></div>
        <button onclick="copyHtml()" style="margin-top: 10px;">ğŸ“‹ å¤åˆ¶HTML</button>
      </div>
    </div>

    <div>
      <label>è§£ç çš„Meta JSONï¼š</label>
      <div class="meta-display" id="metaDisplay"></div>
      <div style="background: #e8f5e9; border: 1px solid #4caf50; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 12px;">
        <strong>ğŸ’¡ æç¤ºï¼š</strong>hintå­—æ®µï¼ˆhï¼‰åªä¿å­˜æ–‡æœ¬å‰10ä¸ªå­—ç¬¦ä½œä¸ºDiffå¯¹é½çš„"æŒ‡çº¹"ã€‚<br>
        å®Œæ•´æ–‡æœ¬ä»HTMLä¸­æå–ï¼Œä¸åœ¨Metaä¸­é‡å¤å­˜å‚¨ã€‚è¿™æ˜¯ä¸ºäº†å‡å°ä½“ç§¯å’Œé¿å…æ–‡æœ¬é‡å¤ã€‚
      </div>
    </div>

    <div class="stats">
      <div class="stat-item">
        <div class="stat-label">èŠ‚ç‚¹æ•°</div>
        <div class="stat-value" id="nodeCount">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">æ€»HTMLå¤§å°</div>
        <div class="stat-value" id="htmlSize">0B</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">å¯è§å†…å®¹å¤§å°</div>
        <div class="stat-value" id="visibleSize">0B</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">MetaåŸå§‹JSON</div>
        <div class="stat-value" id="metaSize">0B</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Meta Base64å</div>
        <div class="stat-value" id="metaBase64Size">0B</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Base64è†¨èƒ€ç‡</div>
        <div class="stat-value" id="base64Overhead">0%</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Metaå æ€»HTML</div>
        <div class="stat-value" id="metaPercentage">0%</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">å·²ç”¨ç©ºé—´</div>
        <div class="stat-value" id="usedSpace">0B</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">å‰©ä½™ç©ºé—´</div>
        <div class="stat-value" id="remainingSpace" style="color: #4caf50;">32KB</div>
      </div>
    </div>
    <div style="margin-top: 10px;">
      <div style="font-size: 12px; color: #757575; margin-bottom: 5px;">
        ç©ºé—´ä½¿ç”¨ç‡ï¼ˆOutlook 32KBé™åˆ¶ï¼‰ï¼š<span id="usagePercent" style="font-weight: bold;">0%</span>
      </div>
      <div style="width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
        <div id="usageBar" style="height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); width: 0%; transition: width 0.3s;"></div>
      </div>
    </div>
  </div>

  <!-- æ­¥éª¤2ï¼šæ¨¡æ‹ŸOutlookç¼–è¾‘ -->
  <div class="test-section">
    <h2>æ­¥éª¤2ï¸âƒ£ï¼šæ¨¡æ‹ŸOutlookç¼–è¾‘</h2>
    
    <div class="scenario-buttons">
      <button onclick="simulateEdit('addParagraph')">â• æ·»åŠ æ®µè½</button>
      <button onclick="simulateEdit('deleteParagraph')">â– åˆ é™¤æ®µè½</button>
      <button onclick="simulateEdit('modifyText')">âœï¸ ä¿®æ”¹æ–‡æœ¬ï¼ˆå°æ”¹ï¼‰</button>
      <button onclick="simulateEdit('majorModify')">âš ï¸ å¤§å¹…ä¿®æ”¹hint</button>
      <button onclick="simulateEdit('reorder')">ğŸ”€ é‡æ’é¡ºåº</button>
      <button onclick="simulateEdit('stripMeta')">ğŸ§¹ æ¸…é™¤data-*å±æ€§</button>
    </div>
    
    <div style="background: #fff3e0; border: 1px solid #ff9800; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 12px;">
      <strong>âš ï¸ å…³äº"å¤§å¹…ä¿®æ”¹hint"æµ‹è¯•ï¼š</strong><br>
      å¦‚æœç”¨æˆ·åœ¨Outlookä¸­å¤§å¹…ä¿®æ”¹æ®µè½çš„å‰10ä¸ªå­—ç¬¦ï¼ˆç›¸ä¼¼åº¦<60%ï¼‰ï¼ŒDiffç®—æ³•ä¼šåˆ¤æ–­ä¸º"åˆ é™¤æ—§æ®µè½+æ–°å¢æ®µè½"ï¼Œå¯¼è‡´èŠ‚ç‚¹IDå˜åŒ–ã€‚<br>
      è¿™æ˜¯trade-offï¼šhintè¶Šé•¿è¶Šå‡†ç¡®ï¼ˆå»ºè®®15-20å­—ç¬¦ï¼‰ï¼Œä½†Metaä½“ç§¯ä¼šå¢åŠ ã€‚
    </div>

    <div class="two-columns">
      <div class="column">
        <label>åŸå§‹HTMLï¼ˆä»æ­¥éª¤1å¤åˆ¶ï¼‰ï¼š</label>
        <textarea id="originalHtml" placeholder="ç²˜è´´æ­¥éª¤1ç”Ÿæˆçš„HTML"></textarea>
      </div>
      
      <div class="column">
        <label>ç¼–è¾‘åçš„HTMLï¼ˆæ¨¡æ‹ŸOutlookä¿®æ”¹ï¼‰ï¼š</label>
        <textarea id="editedHtml" placeholder="æ‰‹åŠ¨ç¼–è¾‘æˆ–ä½¿ç”¨å·¦ä¾§æŒ‰é’®æ¨¡æ‹Ÿ"></textarea>
      </div>
    </div>
  </div>

  <!-- æ­¥éª¤3ï¼šååºåˆ—åŒ–å¹¶Diffå¯¹é½ -->
  <div class="test-section">
    <h2>æ­¥éª¤3ï¸âƒ£ï¼šååºåˆ—åŒ– + Diffå¯¹é½ï¼ˆOutlook â†’ 4DNoteï¼‰</h2>
    
    <button onclick="deserializeHtml()">ğŸ” è¿è¡ŒDiffå¯¹é½ç®—æ³•</button>
    <button onclick="compareResults()">ğŸ“Š å¯¹æ¯”åŸå§‹Event</button>

    <div class="two-columns">
      <div class="column">
        <label>Diffå¯¹é½ç»“æœï¼š</label>
        <div class="diff-result" id="diffResult"></div>
      </div>
      
      <div class="column">
        <label>æ¢å¤çš„Event JSONï¼š</label>
        <textarea id="restoredEvent" readonly></textarea>
      </div>
    </div>

    <div class="stats">
      <div class="stat-item">
        <div class="stat-label">åŒ¹é…æ®µè½</div>
        <div class="stat-value" id="matchCount">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">æ–°å¢æ®µè½</div>
        <div class="stat-value" id="insertCount" style="color: #ff9800;">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">åˆ é™¤æ®µè½</div>
        <div class="stat-value" id="deleteCount" style="color: #f44336;">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">å‡†ç¡®ç‡</div>
        <div class="stat-value" id="accuracy">0%</div>
      </div>
    </div>
  </div>

  <script>
    // ==================== æ•°æ®ç»“æ„ ====================
    
    const scenarios = {
      simple: {
        id: 'evt_simple_001',
        eventlog: {
          slateJson: JSON.stringify([
            { id: 'p-001', type: 'paragraph', children: [{ text: 'ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦' }] },
            { id: 'p-002', type: 'paragraph', children: [{ text: 'ç¡®è®¤ä¸‹å‘¨çš„äº¤ä»˜æ—¶é—´' }] },
            { id: 'p-003', type: 'paragraph', children: [{ text: 'åˆ†é…å…·ä½“ä»»åŠ¡ç»™å›¢é˜Ÿæˆå‘˜' }] }
          ])
        },
        createdAt: '2025-12-19 10:00:00',
        updatedAt: '2025-12-19 10:30:00'
      },
      
      complex: {
        id: 'evt_complex_001',
        eventlog: {
          slateJson: JSON.stringify([
            { id: 'p-001', type: 'paragraph', children: [{ text: 'å‡†å¤‡å­£åº¦æŠ¥å‘Šï¼ŒåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š' }] },
            { id: 'h-001', type: 'heading', level: 2, children: [{ text: 'ç¬¬ä¸€éƒ¨åˆ†ï¼šå¸‚åœºåˆ†æ' }] },
            { id: 'p-002', type: 'paragraph', children: [
              { text: 'å‚è€ƒ' },
              { type: 'mention', mention: { type: 'event', targetId: 'evt_ref_001', displayText: '@ä¸Šå­£åº¦æŠ¥å‘Š' }, children: [{ text: '@ä¸Šå­£åº¦æŠ¥å‘Š' }] },
              { text: 'çš„æ•°æ®' }
            ]},
            { id: 'h-002', type: 'heading', level: 2, children: [{ text: 'ç¬¬äºŒéƒ¨åˆ†ï¼šè´¢åŠ¡æ¦‚å†µ' }] },
            { id: 'p-003', type: 'paragraph', children: [
              { text: 'æ ‡è®°ä¸º' },
              { type: 'mention', mention: { type: 'tag', targetName: 'å·¥ä½œ/è´¢åŠ¡', displayText: '#è´¢åŠ¡' }, children: [{ text: '#è´¢åŠ¡' }] }
            ]}
          ])
        },
        createdAt: '2025-12-19 09:00:00',
        updatedAt: '2025-12-19 09:45:00'
      },
      
      multiLevel: {
        id: 'evt_multilevel_001',
        eventlog: {
          slateJson: JSON.stringify([
            { id: 'h1-001', type: 'heading', level: 1, children: [{ text: 'é¡¹ç›®è®¡åˆ’' }] },
            { id: 'h2-001', type: 'heading', level: 2, children: [{ text: 'é˜¶æ®µä¸€ï¼šéœ€æ±‚åˆ†æ' }] },
            { id: 'p-001', type: 'paragraph', children: [{ text: 'æ”¶é›†ç”¨æˆ·éœ€æ±‚' }] },
            { id: 'h2-002', type: 'heading', level: 2, children: [{ text: 'é˜¶æ®µäºŒï¼šè®¾è®¡å¼€å‘' }] },
            { id: 'p-002', type: 'paragraph', children: [{ text: 'å®ŒæˆUIè®¾è®¡' }] },
            { id: 'p-003', type: 'paragraph', children: [{ text: 'ç¼–å†™ä»£ç å®ç°' }] }
          ])
        },
        createdAt: '2025-12-19 08:00:00',
        updatedAt: '2025-12-19 08:20:00'
      },
      
      bullets: {
        id: 'evt_bullets_001',
        eventlog: {
          slateJson: JSON.stringify([
            { id: 'p-001', type: 'paragraph', children: [{ text: 'å¾…åŠäº‹é¡¹ï¼š' }] },
            { id: 'p-002', type: 'paragraph', bulletLevel: 1, children: [{ text: 'å®Œæˆä»£ç å®¡æŸ¥' }] },
            { id: 'p-003', type: 'paragraph', bulletLevel: 2, children: [{ text: 'æ£€æŸ¥é”™è¯¯å¤„ç†' }] },
            { id: 'p-004', type: 'paragraph', bulletLevel: 2, children: [{ text: 'éªŒè¯è¾¹ç•Œæ¡ä»¶' }] },
            { id: 'p-005', type: 'paragraph', bulletLevel: 1, children: [{ text: 'æ›´æ–°æ–‡æ¡£' }] }
          ])
        },
        createdAt: '2025-12-19 07:00:00',
        updatedAt: '2025-12-19 07:15:00'
      }
    };

    // ==================== å·¥å…·å‡½æ•° ====================
    
    function extractText(node) {
      if (!node.children) return '';
      return node.children.map(child => {
        if (child.text) return child.text;
        if (child.children) return extractText(child);
        return '';
      }).join('');
    }

    function generateNodeId() {
      return 'node_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // ==================== åºåˆ—åŒ–ï¼šEvent â†’ HTML + Meta ====================
    
    function serializeEvent() {
      const input = document.getElementById('eventInput').value;
      if (!input.trim()) {
        alert('è¯·è¾“å…¥Event JSON');
        return;
      }

      try {
        const event = JSON.parse(input);
        const nodes = JSON.parse(event.eventlog.slateJson);

        // 1. ç”ŸæˆMetaï¼ˆåŒ…å«hintï¼‰
        const meta = {
          v: 1,
          id: event.id,
          slate: {
            nodes: nodes.map(node => {
              const textContent = extractText(node);
              const hint = textContent.substring(0, 10);
              
              const metaNode = {};
              if (node.id) metaNode.id = node.id;
              if (hint) metaNode.h = hint;
              if (node.createdAt) metaNode.ts = node.createdAt;
              if (node.updatedAt) metaNode.ut = node.updatedAt;
              if (node.level !== undefined) metaNode.lvl = node.level;
              if (node.bulletLevel !== undefined) metaNode.bullet = node.bulletLevel;
              if (node.mention) metaNode.mention = node.mention;
              
              return metaNode;
            })
          },
          signature: {
            createdAt: event.createdAt,
            updatedAt: event.updatedAt,
            fourDNoteSource: event.fourDNoteSource ?? true,
            source: event.source || 'local',
            lastModifiedSource: event.lastModifiedSource || '4dnote'
          }
        };

        // 2. Base64ç¼–ç Meta
        const metaJson = JSON.stringify(meta, null, 2);
        const metaBase64 = btoa(unescape(encodeURIComponent(metaJson)));

        // 3. ç”ŸæˆHTML
        const visibleHtml = slateNodesToHtml(nodes);
        
        const fullHtml = `<div class="4dnote-content-wrapper" data-4dnote-version="1" style="border-left: 2px solid #e0e0e0; padding-left: 10px;">
  ${visibleHtml}
  
  <!-- Meta Data Zone -->
  <div id="4dnote-meta" style="display:none; font-size:0; line-height:0; opacity:0; mso-hide:all;">
    ${metaBase64}
  </div>
</div>`;

        // æ˜¾ç¤ºç»“æœ
        document.getElementById('htmlOutput').textContent = fullHtml;
        document.getElementById('metaDisplay').textContent = metaJson;

        // ç»Ÿè®¡ä¿¡æ¯
        const visibleHtmlSize = visibleHtml.length;
        const metaJsonSize = metaJson.length;
        const metaBase64Size = metaBase64.length;
        const fullHtmlSize = fullHtml.length;
        const base64Overhead = ((metaBase64Size - metaJsonSize) / metaJsonSize * 100).toFixed(1);
        const metaPercentage = ((metaBase64Size / fullHtmlSize) * 100).toFixed(1);
        const remainingBytes = 32 * 1024 - fullHtmlSize;
        
        document.getElementById('nodeCount').textContent = nodes.length;
        document.getElementById('htmlSize').textContent = formatBytes(fullHtmlSize);
        document.getElementById('visibleSize').textContent = formatBytes(visibleHtmlSize);
        document.getElementById('metaSize').textContent = formatBytes(metaJsonSize);
        document.getElementById('metaBase64Size').textContent = formatBytes(metaBase64Size);
        document.getElementById('base64Overhead').textContent = base64Overhead + '%';
        document.getElementById('metaPercentage').textContent = metaPercentage + '%';
        document.getElementById('usedSpace').textContent = formatBytes(fullHtmlSize);
        document.getElementById('remainingSpace').textContent = formatBytes(remainingBytes);
        
        const usagePercent = ((fullHtmlSize / (32 * 1024)) * 100).toFixed(2);
        document.getElementById('usagePercent').textContent = usagePercent + '%';
        document.getElementById('usageBar').style.width = usagePercent + '%';
        
        // æ ¹æ®ä½¿ç”¨ç‡æ”¹å˜è¿›åº¦æ¡é¢œè‰²
        const usageBar = document.getElementById('usageBar');
        if (usagePercent > 80) {
          usageBar.style.background = 'linear-gradient(90deg, #f44336, #e91e63)';
        } else if (usagePercent > 50) {
          usageBar.style.background = 'linear-gradient(90deg, #ff9800, #ffc107)';
        } else {
          usageBar.style.background = 'linear-gradient(90deg, #4caf50, #8bc34a)';
        }

        // è‡ªåŠ¨å¡«å……åˆ°æ­¥éª¤2
        document.getElementById('originalHtml').value = fullHtml;

      } catch (err) {
        alert('JSONè§£æé”™è¯¯ï¼š' + err.message);
        console.error(err);
      }
    }

    function slateNodesToHtml(nodes) {
      return nodes.map(node => {
        const text = extractText(node);
        let indent = '';
        
        if (node.bulletLevel) {
          indent = '  '.repeat(node.bulletLevel - 1);
          return `${indent}â€¢ ${text}`;
        } else if (node.level) {
          const prefix = '#'.repeat(node.level);
          return `<strong>${prefix} ${text}</strong>`;
        } else {
          return `<p>${text}</p>`;
        }
      }).join('\n  ');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + 'B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
      return (bytes / 1024 / 1024).toFixed(1) + 'MB';
    }

    function copyHtml() {
      const html = document.getElementById('htmlOutput').textContent;
      navigator.clipboard.writeText(html).then(() => {
        alert('HTMLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      });
    }

    // ==================== åŠ è½½æµ‹è¯•åœºæ™¯ ====================
    
    function loadScenario(name) {
      const event = scenarios[name];
      document.getElementById('eventInput').value = JSON.stringify(event, null, 2);
    }

    // ==================== æ¨¡æ‹ŸOutlookç¼–è¾‘ ====================
    
    function simulateEdit(action) {
      const html = document.getElementById('originalHtml').value;
      if (!html.trim()) {
        alert('è¯·å…ˆåœ¨æ­¥éª¤1ç”ŸæˆHTML');
        return;
      }

      let edited = html;

      switch (action) {
        case 'addParagraph':
          // åœ¨ç¬¬äºŒä¸ª<p>åæ’å…¥æ–°æ®µè½
          edited = html.replace(/<p>(.*?)<\/p>\s*<p>/, '<p>$1</p>\n  <p>ã€Outlookæ–°å¢ã€‘è¿™æ˜¯ç”¨æˆ·åœ¨Outlookä¸­æ·»åŠ çš„æ®µè½</p>\n  <p>');
          break;

        case 'deleteParagraph':
          // åˆ é™¤ç¬¬ä¸€ä¸ª<p>
          edited = html.replace(/<p>.*?<\/p>\n\s*/, '');
          break;

        case 'modifyText':
          // å°å¹…ä¿®æ”¹ç¬¬ä¸€ä¸ªæ®µè½ï¼ˆä¸å½±å“hintå‰10å­—ç¬¦ï¼‰
          edited = html.replace(/<p>(ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦)<\/p>/, '<p>ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦å’Œç»†èŠ‚</p>');
          break;

        case 'majorModify':
          // å¤§å¹…ä¿®æ”¹hint - å‰10ä¸ªå­—ç¬¦å˜åŒ–è¶…è¿‡60%
          edited = html.replace(/<p>ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦<\/p>/, '<p>ä¼šè®®å¼€å§‹åé¢†å¯¼è‡´è¾å¹¶å®£å¸ƒå¯åŠ¨</p>');
          alert('âš ï¸ æ³¨æ„ï¼šè¿™ä¸ªä¿®æ”¹ä¼šå¯¼è‡´ç›¸ä¼¼åº¦åªæœ‰40%ï¼ˆ4/10å­—ç¬¦åŒ¹é…ï¼‰ï¼Œä½äº60%é˜ˆå€¼\n' +
                'Diffç®—æ³•ä¼šåˆ¤æ–­ä¸ºï¼šåˆ é™¤æ—§æ®µè½(p-001) + æ–°å¢æ®µè½(node_xxx)\n' +
                'èŠ‚ç‚¹IDä¼šä¸¢å¤±ï¼è¿™æ˜¯trade-offçš„ç»“æœã€‚');
          break;

        case 'reorder':
          // äº¤æ¢å‰ä¸¤ä¸ªæ®µè½
          const matches = html.match(/<p>(.*?)<\/p>/g);
          if (matches && matches.length >= 2) {
            edited = html.replace(matches[0], '___TEMP___')
                         .replace(matches[1], matches[0])
                         .replace('___TEMP___', matches[1]);
          }
          break;

        case 'stripMeta':
          // ç§»é™¤data-*å±æ€§ï¼ˆæ¨¡æ‹ŸOutlookæ¸…ç†ï¼‰
          edited = html.replace(/data-[a-z-]+="[^"]*"/g, '');
          break;
      }

      document.getElementById('editedHtml').value = edited;
    }

    // ==================== ååºåˆ—åŒ– + Diffå¯¹é½ ====================
    
    function deserializeHtml() {
      const html = document.getElementById('editedHtml').value || document.getElementById('originalHtml').value;
      if (!html.trim()) {
        alert('è¯·è¾“å…¥HTML');
        return;
      }

      try {
        // Step 1: æå–è¾¹ç•Œå†…å®¹
        const wrapperMatch = html.match(/<div class="4dnote-content-wrapper"[^>]*>([\s\S]*?)<\/div>/);
        if (!wrapperMatch) {
          alert('æœªæ‰¾åˆ°4DNote content wrapper');
          return;
        }
        const wrapper = wrapperMatch[1];

        // Step 2: è§£æMeta
        const metaMatch = wrapper.match(/<div id="4dnote-meta"[^>]*>([\s\S]*?)<\/div>/);
        let meta = null;
        
        if (metaMatch) {
          const metaBase64 = metaMatch[1].trim();
          const metaJson = decodeURIComponent(escape(atob(metaBase64)));
          meta = JSON.parse(metaJson);
        } else {
          alert('æœªæ‰¾åˆ°Metaæ•°æ®');
          return;
        }

        // Step 3: ä»HTMLç”ŸæˆèŠ‚ç‚¹åˆ—è¡¨
        const visibleHtml = wrapper.replace(/<div id="4dnote-meta"[\s\S]*?<\/div>/, '');
        let htmlNodes = parseHtmlToNodes(visibleHtml);

        // Step 4: Diffå¯¹é½
        const diffResults = [];
        let alignedNodes = [];

        if (meta.slate && meta.slate.nodes) {
          const metaHints = meta.slate.nodes.map(n => n.h || '');
          const htmlTexts = htmlNodes.map(n => extractText(n).substring(0, 10));

          console.log('Meta hints:', metaHints);
          console.log('HTML texts:', htmlTexts);

          const alignment = diffAlign(metaHints, htmlTexts);
          
          alignedNodes = alignment.map(match => {
            if (match.type === 'match') {
              const htmlNode = htmlNodes[match.htmlIndex];
              const metaNode = meta.slate.nodes[match.metaIndex];
              
              diffResults.push({
                type: 'match',
                text: extractText(htmlNode),
                metaId: metaNode.id,
                hint: metaNode.h
              });

              return {
                ...htmlNode,
                id: metaNode.id,
                createdAt: metaNode.ts,
                updatedAt: metaNode.ut,
                level: metaNode.lvl,
                bulletLevel: metaNode.bullet,
                mention: metaNode.mention
              };
            } else if (match.type === 'insert') {
              const htmlNode = htmlNodes[match.htmlIndex];
              
              diffResults.push({
                type: 'insert',
                text: extractText(htmlNode)
              });

              return {
                ...htmlNode,
                id: generateNodeId(),
                createdAt: Date.now()
              };
            } else if (match.type === 'delete') {
              const metaNode = meta.slate.nodes[match.metaIndex];
              
              diffResults.push({
                type: 'delete',
                hint: metaNode.h,
                metaId: metaNode.id
              });

              return null;
            }
          }).filter(Boolean);
        }

        // æ˜¾ç¤ºDiffç»“æœ
        displayDiffResults(diffResults);

        // æ„é€ æ¢å¤çš„Event
        const restoredEvent = {
          id: meta.id,
          eventlog: {
            slateJson: JSON.stringify(alignedNodes, null, 2)
          },
          createdAt: meta.signature?.createdAt,
          updatedAt: meta.signature?.updatedAt,
          fourDNoteSource: meta.signature?.fourDNoteSource,
          source: meta.signature?.source,
          lastModifiedSource: meta.signature?.lastModifiedSource
        };

        document.getElementById('restoredEvent').value = JSON.stringify(restoredEvent, null, 2);

        // ç»Ÿè®¡
        const matchCount = diffResults.filter(r => r.type === 'match').length;
        const insertCount = diffResults.filter(r => r.type === 'insert').length;
        const deleteCount = diffResults.filter(r => r.type === 'delete').length;
        const total = matchCount + insertCount + deleteCount;

        document.getElementById('matchCount').textContent = matchCount;
        document.getElementById('insertCount').textContent = insertCount;
        document.getElementById('deleteCount').textContent = deleteCount;
        document.getElementById('accuracy').textContent = total > 0 ? ((matchCount / total) * 100).toFixed(1) + '%' : '0%';

      } catch (err) {
        alert('ååºåˆ—åŒ–é”™è¯¯ï¼š' + err.message);
        console.error(err);
      }
    }

    function parseHtmlToNodes(html) {
      const lines = html.split('\n').map(line => line.trim()).filter(line => line);
      
      return lines.map(line => {
        // æ£€æµ‹åˆ—è¡¨é¡¹
        const bulletMatch = line.match(/^(â€¢|\*|-)\s+(.*)/);
        if (bulletMatch) {
          return {
            type: 'paragraph',
            bulletLevel: 1,
            children: [{ text: bulletMatch[2] }]
          };
        }

        // æ£€æµ‹æ ‡é¢˜
        const headingMatch = line.match(/<strong>(#+)\s+(.*?)<\/strong>/);
        if (headingMatch) {
          return {
            type: 'heading',
            level: headingMatch[1].length,
            children: [{ text: headingMatch[2] }]
          };
        }

        // æ™®é€šæ®µè½
        const textMatch = line.match(/<p>(.*?)<\/p>/);
        if (textMatch) {
          return {
            type: 'paragraph',
            children: [{ text: textMatch[1] }]
          };
        }

        // çº¯æ–‡æœ¬
        return {
          type: 'paragraph',
          children: [{ text: line }]
        };
      });
    }

    function diffAlign(metaHints, htmlTexts) {
      const results = [];
      let metaIndex = 0;
      let htmlIndex = 0;

      while (metaIndex < metaHints.length || htmlIndex < htmlTexts.length) {
        if (metaIndex >= metaHints.length) {
          results.push({ type: 'insert', htmlIndex: htmlIndex++ });
        } else if (htmlIndex >= htmlTexts.length) {
          results.push({ type: 'delete', metaIndex: metaIndex++ });
        } else if (isSimilar(metaHints[metaIndex], htmlTexts[htmlIndex])) {
          results.push({ type: 'match', metaIndex: metaIndex++, htmlIndex: htmlIndex++ });
        } else {
          // å‘å‰æŸ¥æ‰¾åŒ¹é…
          const lookAhead = 3;
          let foundMatch = false;

          // å°è¯•ï¼šè·³è¿‡Metaä¸­çš„èŠ‚ç‚¹ï¼ˆå¯èƒ½è¢«åˆ é™¤ï¼‰
          for (let i = 1; i <= lookAhead && metaIndex + i < metaHints.length; i++) {
            if (isSimilar(metaHints[metaIndex + i], htmlTexts[htmlIndex])) {
              // Metaä¸­æœ‰åˆ é™¤
              for (let j = 0; j < i; j++) {
                results.push({ type: 'delete', metaIndex: metaIndex++ });
              }
              foundMatch = true;
              break;
            }
          }

          if (!foundMatch) {
            // å°è¯•ï¼šè·³è¿‡HTMLä¸­çš„èŠ‚ç‚¹ï¼ˆå¯èƒ½æ˜¯æ–°å¢ï¼‰
            for (let i = 1; i <= lookAhead && htmlIndex + i < htmlTexts.length; i++) {
              if (isSimilar(metaHints[metaIndex], htmlTexts[htmlIndex + i])) {
                // HTMLä¸­æœ‰æ–°å¢
                for (let j = 0; j < i; j++) {
                  results.push({ type: 'insert', htmlIndex: htmlIndex++ });
                }
                foundMatch = true;
                break;
              }
            }
          }

          if (!foundMatch) {
            // æ— æ³•åŒ¹é…ï¼Œå‡è®¾æ˜¯æ›¿æ¢ï¼ˆåˆ é™¤+æ’å…¥ï¼‰
            results.push({ type: 'delete', metaIndex: metaIndex++ });
            results.push({ type: 'insert', htmlIndex: htmlIndex++ });
          }
        }
      }

      return results;
    }

    function isSimilar(hint, text, threshold = 0.6) {
      if (!hint || !text) return false;
      
      const minLen = Math.min(hint.length, text.length);
      let matchCount = 0;
      
      for (let i = 0; i < minLen; i++) {
        if (hint[i] === text[i]) matchCount++;
      }
      
      return (matchCount / minLen) >= threshold;
    }

    function displayDiffResults(results) {
      const container = document.getElementById('diffResult');
      container.innerHTML = results.map(r => {
        if (r.type === 'match') {
          return `<div class="diff-item diff-match">âœ… åŒ¹é…ï¼š${r.text} (ID: ${r.metaId})</div>`;
        } else if (r.type === 'insert') {
          return `<div class="diff-item diff-insert">â• æ–°å¢ï¼š${r.text}</div>`;
        } else {
          return `<div class="diff-item diff-delete">â– åˆ é™¤ï¼š${r.hint} (ID: ${r.metaId})</div>`;
        }
      }).join('');
    }

    function compareResults() {
      const original = document.getElementById('eventInput').value;
      const restored = document.getElementById('restoredEvent').value;
      
      if (!original || !restored) {
        alert('è¯·å…ˆå®Œæˆåºåˆ—åŒ–å’Œååºåˆ—åŒ–');
        return;
      }

      try {
        const originalEvent = JSON.parse(original);
        const restoredEvent = JSON.parse(restored);
        
        const originalNodes = JSON.parse(originalEvent.eventlog.slateJson);
        const restoredNodes = JSON.parse(restoredEvent.eventlog.slateJson);
        
        console.log('åŸå§‹èŠ‚ç‚¹æ•°:', originalNodes.length);
        console.log('æ¢å¤èŠ‚ç‚¹æ•°:', restoredNodes.length);
        console.log('åŸå§‹Event:', originalEvent);
        console.log('æ¢å¤Event:', restoredEvent);
        
        alert(`å¯¹æ¯”ç»“æœï¼š\nåŸå§‹èŠ‚ç‚¹æ•°: ${originalNodes.length}\næ¢å¤èŠ‚ç‚¹æ•°: ${restoredNodes.length}\n\nè¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°`);
      } catch (err) {
        alert('å¯¹æ¯”é”™è¯¯ï¼š' + err.message);
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½simpleåœºæ™¯
    window.addEventListener('DOMContentLoaded', () => {
      loadScenario('simple');
    });
  </script>
</body>
</html>
