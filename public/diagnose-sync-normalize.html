<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>åŒæ­¥é“¾è·¯ normalizeEvent è¯Šæ–­</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .issue-card {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
    }
    .issue-card h3 {
      margin-top: 0;
      color: #856404;
    }
    .test-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-result {
      margin: 10px 0;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .test-result.pass {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .test-result.fail {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .test-result.warn {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #5568d3;
    }
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 500px;
    }
    .timeline {
      margin: 20px 0;
      padding-left: 20px;
      border-left: 3px solid #667eea;
    }
    .timeline-item {
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .code-block {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border-left: 4px solid #667eea;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ” åŒæ­¥é“¾è·¯ normalizeEvent è¯Šæ–­</h1>
    <p>æ£€æŸ¥æ‰€æœ‰ update å’Œ sync æ–¹æ³•æ˜¯å¦æ­£ç¡®è°ƒç”¨ normalizeEvent/normalizeEventLog</p>
  </div>

  <div class="issue-card">
    <h3>ğŸ› å½“å‰é—®é¢˜</h3>
    <p><strong>é—®é¢˜1ï¼š</strong>Timestamp é€€åŒ– - åŒæ­¥æ—¶åŠ ä¸Šäº†åŒæ­¥æ—¶åˆ»çš„ timestampï¼Œè¿‡å»å·²æœ‰çš„ timestamp è¢«é€€åŒ–æˆå­—ç¬¦ä¸²</p>
    <p><strong>é—®é¢˜2ï¼š</strong>ç­¾åæœªæ¸…é™¤ - ç­¾åä¾æ—§æ˜¾ç¤ºåœ¨å†…éƒ¨ï¼Œæœªè¢« normalizeEventLog æ­£ç¡®å¤„ç†</p>
    <p><strong>æ ¹å› ï¼š</strong>ActionBasedSyncManager çš„åŒæ­¥è·¯å¾„æœªæ­£ç¡®è°ƒç”¨ normalizeEventï¼Œç›´æ¥ä¼ é€’äº†åŸå§‹æ•°æ®</p>
  </div>

  <div class="test-section">
    <h3>ğŸ“‹ è¯Šæ–­ç»“æœ</h3>
    <button onclick="runDiagnosis()">è¿è¡Œè¯Šæ–­</button>
    <button onclick="checkRecentEvents()">æ£€æŸ¥æœ€è¿‘äº‹ä»¶</button>
    <button onclick="showFixSuggestions()">æŸ¥çœ‹ä¿®å¤æ–¹æ¡ˆ</button>
    <div id="diagnosis-results"></div>
  </div>

  <div class="test-section">
    <h3>ğŸ”§ ä¿®å¤å»ºè®®</h3>
    <div id="fix-suggestions"></div>
  </div>

  <script type="module">
    import { storageManager } from '../src/services/storage/StorageManager.ts';
    import { EventService } from '../src/services/EventService.ts';
    import { SignatureUtils } from '../src/utils/signatureUtils.ts';

    window.storageManager = storageManager;
    window.EventService = EventService;
    window.SignatureUtils = SignatureUtils;

    window.runDiagnosis = async function() {
      const container = document.getElementById('diagnosis-results');
      container.innerHTML = '<p>ğŸ” æ­£åœ¨è¯Šæ–­...</p>';
      
      try {
        const events = await storageManager.getAllEvents();
        container.innerHTML = '<h4>è¯Šæ–­æŠ¥å‘Š</h4>';
        
        // é—®é¢˜1: æ£€æŸ¥ eventlog æ˜¯å¦æœ‰ timestamp-dividerï¼ˆæ—§æ ¼å¼ï¼‰
        const eventsWithOldTimestamp = events.filter(e => {
          try {
            const slateJson = typeof e.eventlog === 'object' && e.eventlog?.slateJson
              ? (typeof e.eventlog.slateJson === 'string' ? JSON.parse(e.eventlog.slateJson) : e.eventlog.slateJson)
              : [];
            return Array.isArray(slateJson) && slateJson.some(node => node.type === 'timestamp-divider');
          } catch {
            return false;
          }
        });
        
        if (eventsWithOldTimestamp.length > 0) {
          container.innerHTML += `
            <div class="test-result fail">
              âŒ å‘ç° ${eventsWithOldTimestamp.length} ä¸ªäº‹ä»¶ä½¿ç”¨æ—§æ ¼å¼ timestamp-divider
              <details>
                <summary>æŸ¥çœ‹ç¤ºä¾‹</summary>
                <pre>${JSON.stringify(eventsWithOldTimestamp.slice(0, 3), null, 2)}</pre>
              </details>
            </div>
          `;
        } else {
          container.innerHTML += `
            <div class="test-result pass">
              âœ… æ‰€æœ‰äº‹ä»¶å·²è¿ç§»åˆ° Block-Level Timestamp
            </div>
          `;
        }
        
        // é—®é¢˜2: æ£€æŸ¥ eventlog ä¸­æ˜¯å¦æœ‰çº¯æ–‡æœ¬æ—¶é—´æˆ³ï¼ˆæœªè¢«è§£æï¼‰
        const eventsWithTextTimestamp = events.filter(e => {
          try {
            const slateJson = typeof e.eventlog === 'object' && e.eventlog?.slateJson
              ? (typeof e.eventlog.slateJson === 'string' ? JSON.parse(e.eventlog.slateJson) : e.eventlog.slateJson)
              : [];
            return Array.isArray(slateJson) && slateJson.some(node => {
              if (node.type === 'paragraph' && node.children?.[0]?.text) {
                const text = node.children[0].text.trim();
                return /^(\d{4}[-\/]\d{1,2}[-\/]\d{1,2}\s+\d{2}:\d{2}:\d{2})/.test(text);
              }
              return false;
            });
          } catch {
            return false;
          }
        });
        
        if (eventsWithTextTimestamp.length > 0) {
          container.innerHTML += `
            <div class="test-result fail">
              âŒ å‘ç° ${eventsWithTextTimestamp.length} ä¸ªäº‹ä»¶åŒ…å«æœªè§£æçš„çº¯æ–‡æœ¬æ—¶é—´æˆ³
              <details>
                <summary>æŸ¥çœ‹ç¤ºä¾‹</summary>
                <pre>${JSON.stringify(eventsWithTextTimestamp.slice(0, 3).map(e => ({
                  id: e.id,
                  title: e.title?.simpleTitle || e.title,
                  eventlog: e.eventlog
                })), null, 2)}</pre>
              </details>
            </div>
          `;
        } else {
          container.innerHTML += `
            <div class="test-result pass">
              âœ… æ‰€æœ‰æ—¶é—´æˆ³å·²æ­£ç¡®è§£æä¸º Block-Level å…ƒæ•°æ®
            </div>
          `;
        }
        
        // é—®é¢˜3: æ£€æŸ¥ description æ˜¯å¦åŒ…å«ç­¾åï¼ˆå†…éƒ¨æ˜¾ç¤ºæ—¶åº”è¯¥ç§»é™¤ï¼‰
        const eventsWithSignature = events.filter(e => {
          const desc = e.description || '';
          return SignatureUtils.isSignatureParagraph(desc) || 
                 /ç”±\s+(?:ğŸ”®|ğŸ“§)\s*(?:4DNote|Outlook)\s*åˆ›å»ºäº/.test(desc);
        });
        
        if (eventsWithSignature.length > 0) {
          container.innerHTML += `
            <div class="test-result warn">
              âš ï¸ å‘ç° ${eventsWithSignature.length} ä¸ªäº‹ä»¶çš„ description åŒ…å«ç­¾å
              <p>æ³¨æ„ï¼šdescription åº”è¯¥åŒ…å«ç­¾åï¼ˆç”¨äº Outlook åŒæ­¥ï¼‰ï¼Œä½†å‰ç«¯åº”è¯¥ä½¿ç”¨ SignatureUtils.extractCoreContent() ç§»é™¤ç­¾åæ˜¾ç¤º</p>
              <details>
                <summary>æŸ¥çœ‹ç¤ºä¾‹</summary>
                <pre>${eventsWithSignature.slice(0, 3).map(e => ({
                  id: e.id,
                  title: e.title?.simpleTitle || e.title,
                  description: e.description?.substring(0, 200)
                })).map(e => JSON.stringify(e, null, 2)).join('\n\n')}</pre>
              </details>
            </div>
          `;
        } else {
          container.innerHTML += `
            <div class="test-result pass">
              âœ… description ç­¾åçŠ¶æ€æ­£å¸¸
            </div>
          `;
        }
        
        // é—®é¢˜4: æ£€æŸ¥ eventlog ä¸­æ˜¯å¦ç¼ºå°‘ Block-Level å…ƒæ•°æ®
        const eventsWithoutBlockMeta = events.filter(e => {
          try {
            const slateJson = typeof e.eventlog === 'object' && e.eventlog?.slateJson
              ? (typeof e.eventlog.slateJson === 'string' ? JSON.parse(e.eventlog.slateJson) : e.eventlog.slateJson)
              : [];
            if (!Array.isArray(slateJson) || slateJson.length === 0) return false;
            const paragraphs = slateJson.filter(n => n.type === 'paragraph');
            return paragraphs.length > 0 && !paragraphs.some(p => p.createdAt || p.id);
          } catch {
            return false;
          }
        });
        
        if (eventsWithoutBlockMeta.length > 0) {
          container.innerHTML += `
            <div class="test-result fail">
              âŒ å‘ç° ${eventsWithoutBlockMeta.length} ä¸ªäº‹ä»¶ç¼ºå°‘ Block-Level å…ƒæ•°æ®ï¼ˆid/createdAtï¼‰
              <details>
                <summary>æŸ¥çœ‹ç¤ºä¾‹</summary>
                <pre>${JSON.stringify(eventsWithoutBlockMeta.slice(0, 3).map(e => ({
                  id: e.id,
                  title: e.title?.simpleTitle || e.title,
                  eventlog: e.eventlog
                })), null, 2)}</pre>
              </details>
            </div>
          `;
        } else {
          container.innerHTML += `
            <div class="test-result pass">
              âœ… æ‰€æœ‰äº‹ä»¶çš„ paragraph èŠ‚ç‚¹éƒ½æœ‰ Block-Level å…ƒæ•°æ®
            </div>
          `;
        }
        
      } catch (error) {
        container.innerHTML += `
          <div class="test-result fail">
            âŒ è¯Šæ–­å¤±è´¥: ${error.message}
            <pre>${error.stack}</pre>
          </div>
        `;
      }
    };

    window.checkRecentEvents = async function() {
      const container = document.getElementById('diagnosis-results');
      container.innerHTML = '<p>ğŸ” æ£€æŸ¥æœ€è¿‘åŒæ­¥çš„äº‹ä»¶...</p>';
      
      try {
        const events = await storageManager.getAllEvents();
        const recentSynced = events
          .filter(e => e.lastSyncTime)
          .sort((a, b) => new Date(b.lastSyncTime) - new Date(a.lastSyncTime))
          .slice(0, 10);
        
        container.innerHTML = '<h4>æœ€è¿‘åŒæ­¥çš„ 10 ä¸ªäº‹ä»¶</h4>';
        
        recentSynced.forEach((event, idx) => {
          const slateJson = typeof event.eventlog === 'object' && event.eventlog?.slateJson
            ? (typeof event.eventlog.slateJson === 'string' ? JSON.parse(event.eventlog.slateJson) : event.eventlog.slateJson)
            : [];
          
          const hasOldTimestamp = slateJson.some(n => n.type === 'timestamp-divider');
          const hasTextTimestamp = slateJson.some(n => {
            if (n.type === 'paragraph' && n.children?.[0]?.text) {
              const text = n.children[0].text.trim();
              return /^(\d{4}[-\/]\d{1,2}[-\/]\d{1,2}\s+\d{2}:\d{2}:\d{2})/.test(text);
            }
            return false;
          });
          const hasBlockMeta = slateJson.some(n => n.type === 'paragraph' && (n.createdAt || n.id));
          const hasSignature = /ç”±\s+(?:ğŸ”®|ğŸ“§)\s*(?:4DNote|Outlook)\s*åˆ›å»ºäº/.test(event.description || '');
          
          const statusClass = (hasOldTimestamp || hasTextTimestamp) ? 'fail' : 'pass';
          
          container.innerHTML += `
            <div class="test-result ${statusClass}">
              <strong>${idx + 1}. ${event.title?.simpleTitle || event.title || 'Untitled'}</strong><br>
              ID: ${event.id}<br>
              æœ€ååŒæ­¥: ${event.lastSyncTime}<br>
              æ—§æ ¼å¼ timestamp-divider: ${hasOldTimestamp ? 'âŒ æ˜¯' : 'âœ… å¦'}<br>
              çº¯æ–‡æœ¬æ—¶é—´æˆ³: ${hasTextTimestamp ? 'âŒ æ˜¯' : 'âœ… å¦'}<br>
              Block-Level å…ƒæ•°æ®: ${hasBlockMeta ? 'âœ… æœ‰' : 'âŒ æ— '}<br>
              description ç­¾å: ${hasSignature ? 'âœ… æœ‰' : 'âŒ æ— '}<br>
              <details>
                <summary>æŸ¥çœ‹ eventlog ç»“æ„</summary>
                <pre>${JSON.stringify(slateJson, null, 2)}</pre>
              </details>
            </div>
          `;
        });
        
      } catch (error) {
        container.innerHTML += `
          <div class="test-result fail">
            âŒ æ£€æŸ¥å¤±è´¥: ${error.message}
          </div>
        `;
      }
    };

    window.showFixSuggestions = function() {
      const container = document.getElementById('fix-suggestions');
      container.innerHTML = `
        <div class="timeline">
          <div class="timeline-item">
            <h4>ä¿®å¤ 1: ActionBasedSyncManager å¢é‡æ›´æ–°è·¯å¾„</h4>
            <p><strong>ä½ç½®ï¼š</strong>ActionBasedSyncManager.ts L2500-2550</p>
            <p><strong>é—®é¢˜ï¼š</strong>ç›´æ¥ä¼ é€’ <code>slateJson</code> å­—ç¬¦ä¸²ï¼Œæœªç»è¿‡ normalizeEventLog å¤„ç†</p>
            <div class="code-block">
              <strong>âŒ å½“å‰ä»£ç ï¼š</strong>
              <pre>const slateJson = JSON.stringify([{ type: 'paragraph', children: [{ text: remoteCoreContent }] }]);
updates.eventlog = slateJson;  // ç›´æ¥ä¼ é€’å­—ç¬¦ä¸²</pre>
            </div>
            <div class="code-block">
              <strong>âœ… ä¿®å¤åï¼š</strong>
              <pre>// ä¸è¦ç›´æ¥ä¼ é€’ slateJson å­—ç¬¦ä¸²ï¼Œè®© EventService.updateEvent è‡ªåŠ¨è°ƒç”¨ normalizeEvent
// normalizeEvent ä¼šè°ƒç”¨ normalizeEventLog å¤„ç†ç­¾åå’Œ Block-Level Timestamp
updates.eventlog = remoteCoreContent;  // ä¼ é€’çº¯æ–‡æœ¬ï¼Œè®© normalizeEventLog å¤„ç†</pre>
            </div>
          </div>

          <div class="timeline-item">
            <h4>ä¿®å¤ 2: ActionBasedSyncManager æ—§æ ¼å¼æ›´æ–°è·¯å¾„</h4>
            <p><strong>ä½ç½®ï¼š</strong>ActionBasedSyncManager.ts L4150-4200</p>
            <p><strong>é—®é¢˜ï¼š</strong>åŒæ ·çš„é—®é¢˜ï¼Œç›´æ¥æ„é€  slateJson å­—ç¬¦ä¸²</p>
            <div class="code-block">
              <strong>âŒ å½“å‰ä»£ç ï¼š</strong>
              <pre>const slateJson = JSON.stringify([{ type: 'paragraph', children: [{ text: remoteCoreContent }] }]);
updates.eventlog = slateJson;</pre>
            </div>
            <div class="code-block">
              <strong>âœ… ä¿®å¤åï¼š</strong>
              <pre>updates.eventlog = remoteCoreContent;  // ä¼ é€’çº¯æ–‡æœ¬</pre>
            </div>
          </div>

          <div class="timeline-item">
            <h4>ä¿®å¤ 3: EventService.updateEvent ç¡®ä¿è°ƒç”¨ normalizeEvent</h4>
            <p><strong>ä½ç½®ï¼š</strong>EventService.ts L818-1100</p>
            <p><strong>æ£€æŸ¥ï¼š</strong>ç¡®è®¤ updateEvent åœ¨ä¿å­˜å‰è°ƒç”¨ normalizeEvent</p>
            <div class="code-block">
              <strong>âœ… å½“å‰å·²æ­£ç¡®å®ç°ï¼š</strong>
              <pre>// åœºæ™¯1: eventlog æœ‰å˜åŒ– â†’ è§„èŒƒåŒ–å¹¶åŒæ­¥åˆ° descriptionï¼ˆå¸¦ç­¾åï¼‰
if ((updates as any).eventlog !== undefined) {
  const normalizedEventLog = this.normalizeEventLog((updates as any).eventlog);
  (updatesWithSync as any).eventlog = normalizedEventLog;
  // ...
}</pre>
            </div>
            <p><strong>âœ… å·²æ­£ç¡®ï¼š</strong>updateEvent å·²ç»è°ƒç”¨ normalizeEventLog</p>
          </div>

          <div class="timeline-item">
            <h4>ä¿®å¤ 4: å‰ç«¯æ˜¾ç¤ºæ—¶ç§»é™¤ç­¾å</h4>
            <p><strong>ä½ç½®ï¼š</strong>æ‰€æœ‰æ˜¾ç¤º description çš„ç»„ä»¶</p>
            <p><strong>é—®é¢˜ï¼š</strong>ç›´æ¥æ˜¾ç¤º <code>event.description</code>ï¼Œæœªç§»é™¤ç­¾å</p>
            <div class="code-block">
              <strong>âŒ å½“å‰ä»£ç ï¼š</strong>
              <pre>const description = event.description;</pre>
            </div>
            <div class="code-block">
              <strong>âœ… ä¿®å¤åï¼š</strong>
              <pre>import { SignatureUtils } from '@/utils/signatureUtils';
const description = SignatureUtils.extractCoreContent(event.description);</pre>
            </div>
          </div>

          <div class="timeline-item">
            <h4>ä¿®å¤ 5: LogSlate/ModalSlate å·²æ­£ç¡®éšè—ç­¾å</h4>
            <p><strong>çŠ¶æ€ï¼š</strong>âœ… å·²å®Œæˆ</p>
            <p><strong>å®ç°ï¼š</strong>ä½¿ç”¨ <code>SignatureUtils.isSignatureParagraph()</code> æ£€æµ‹å¹¶éšè—ç­¾åæ®µè½</p>
            <div class="code-block">
              <pre>// LogSlate.tsx & ModalSlate.tsx
const isSignature = paragraphText && SignatureUtils.isSignatureParagraph(paragraphText);
if (isSignature) {
  return &lt;span {...props.attributes} style={{ display: 'none' }}&gt;{props.children}&lt;/span&gt;;
}</pre>
            </div>
          </div>
        </div>

        <h4>æ€»ç»“</h4>
        <p><strong>å…³é”®åŸåˆ™ï¼š</strong></p>
        <ul>
          <li>âŒ <strong>ä¸è¦</strong>åœ¨åŒæ­¥ä»£ç ä¸­ç›´æ¥æ„é€  <code>slateJson</code> å­—ç¬¦ä¸²</li>
          <li>âœ… <strong>åº”è¯¥</strong>ä¼ é€’çº¯æ–‡æœ¬/HTMLï¼Œè®© <code>normalizeEventLog</code> è‡ªåŠ¨å¤„ç†</li>
          <li>âœ… <strong>åº”è¯¥</strong>åœ¨å‰ç«¯æ˜¾ç¤ºæ—¶ä½¿ç”¨ <code>SignatureUtils.extractCoreContent()</code> ç§»é™¤ç­¾å</li>
          <li>âœ… <strong>åº”è¯¥</strong>åœ¨ç¼–è¾‘å™¨ä¸­ä½¿ç”¨ <code>SignatureUtils.isSignatureParagraph()</code> éšè—ç­¾åæ®µè½</li>
        </ul>
      `;
    };

    console.log('âœ… è¯Šæ–­é¡µé¢å·²åŠ è½½');
    console.log('ä½¿ç”¨æ–¹æ³•ï¼š');
    console.log('1. ç‚¹å‡»"è¿è¡Œè¯Šæ–­"æ£€æŸ¥æ‰€æœ‰äº‹ä»¶');
    console.log('2. ç‚¹å‡»"æ£€æŸ¥æœ€è¿‘äº‹ä»¶"æŸ¥çœ‹æœ€è¿‘åŒæ­¥çš„äº‹ä»¶');
    console.log('3. ç‚¹å‡»"æŸ¥çœ‹ä¿®å¤æ–¹æ¡ˆ"è·å–è¯¦ç»†çš„ä¿®å¤å»ºè®®');
  </script>
</body>
</html>
