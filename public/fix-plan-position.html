<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ä¿®å¤ Plan é¡µé¢ Position æ’åº</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
      white-space: pre-wrap;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      line-height: 1.6;
      max-height: 600px;
      overflow-y: auto;
    }
    .success { color: #28a745; font-weight: bold; }
    .warning { color: #ffc107; font-weight: bold; }
    .error { color: #dc3545; font-weight: bold; }
    .info { color: #17a2b8; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ Plan é¡µé¢ Position ä¿®å¤å·¥å…·</h1>
    <p class="subtitle">åªè¯Šæ–­å’Œä¿®å¤ä¼šæ˜¾ç¤ºåœ¨ Plan é¡µé¢çš„äº‹ä»¶</p>
    
    <div>
      <button onclick="diagnose()">ğŸ” 1. è¯Šæ–­</button>
      <button onclick="fix()">âœ… 2. ä¿®å¤Position</button>
      <button onclick="autoFixParentChild()">ğŸ”§ 3. ä¿®å¤çˆ¶å­å…³ç³»</button>
      <button onclick="verify()">ğŸ§ª 4. éªŒè¯</button>
    </div>
    
    <div id="output"></div>
  </div>

  <script>
    const POSITION_GAP = 1000;
    const output = document.getElementById('output');
    
    function updateStatus(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      output.innerHTML += `<span class="${type}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }
    
    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('4DNoteDB', 2);
        request.onsuccess = () => {
          const db = request.result;
          updateStatus(`âœ… æ•°æ®åº“æ‰“å¼€æˆåŠŸï¼Œç‰ˆæœ¬ï¼š${db.version}`, 'info');
          updateStatus(`ğŸ“‹ Object stores: ${Array.from(db.objectStoreNames).join(', ')}`, 'info');
          resolve(db);
        };
        request.onerror = () => reject(request.error);
      });
    }
    
    function getAllEvents(store) {
      return new Promise((resolve, reject) => {
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    
    // åˆ¤æ–­äº‹ä»¶æ˜¯å¦ä¼šæ˜¾ç¤ºåœ¨ Plan é¡µé¢
    function isPlanEvent(event) {
      return event.isPlan === true || 
             (event.checkType && event.checkType !== 'none') || 
             event.isTimeCalendar === true;
    }
    
    // ğŸ†• æ¨¡æ‹Ÿ PlanSlate Tab é”®è‡ªåŠ¨ä¿®å¤ parentId/childIds
    async function autoFixParentChild() {
      output.innerHTML = '';
      updateStatus('ğŸ”§ å¼€å§‹è‡ªåŠ¨ä¿®å¤ parentId/childIds å…³ç³»...', 'info');
      
      const db = await openDatabase();
      
      if (!db.objectStoreNames.contains('events')) {
        updateStatus('âŒ æ•°æ®åº“ä¸­æ²¡æœ‰ events storeï¼', 'error');
        return;
      }
      
      const tx = db.transaction('events', 'readwrite');
      const store = tx.objectStore('events');
      const allEvents = await getAllEvents(store);
      
      const planEvents = allEvents.filter(isPlanEvent);
      
      updateStatus(`ğŸ“‹ æ‰¾åˆ° ${planEvents.length} ä¸ª Plan é¡µé¢äº‹ä»¶`, 'info');
      
      // æŒ‰ position æ’åºï¼ˆæ¨¡æ‹Ÿ Plan é¡µé¢çš„æ˜¾ç¤ºé¡ºåºï¼‰
      planEvents.sort((a, b) => {
        const posA = a.position ?? Infinity;
        const posB = b.position ?? Infinity;
        if (posA !== posB) return posA - posB;
        
        const timeA = new Date(a.createdAt || 0).getTime();
        const timeB = new Date(b.createdAt || 0).getTime();
        return timeA - timeB;
      });
      
      updateStatus('\nğŸ” æŒ‰æ˜¾ç¤ºé¡ºåºåˆ†æå±‚çº§å…³ç³»:', 'info');
      
      // æ ¹æ® bulletLevel æ¨å¯¼ parentId/childIds
      const levelStack = []; // å­˜å‚¨æ¯ä¸ªå±‚çº§çš„æœ€åä¸€ä¸ªäº‹ä»¶
      let fixedCount = 0;
      
      for (let i = 0; i < planEvents.length; i++) {
        const event = planEvents[i];
        const level = event.bulletLevel ?? 0;
        const title = typeof event.title === 'string' ? event.title : event.title?.simpleTitle || '(æ— æ ‡é¢˜)';
        
        // æˆªæ–­åˆ°å½“å‰å±‚çº§
        levelStack.length = level;
        
        // æ‰¾åˆ°çˆ¶äº‹ä»¶ï¼ˆlevel - 1 çš„æœ€åä¸€ä¸ªäº‹ä»¶ï¼‰
        const expectedParentId = level > 0 ? levelStack[level - 1]?.id : null;
        const actualParentId = event.parentEventId || null;
        
        if (expectedParentId !== actualParentId) {
          updateStatus(`  ğŸ”§ ä¿®å¤ "${title.substring(0, 30)}"`, 'warning');
          updateStatus(`     bulletLevel=${level}, é¢„æœŸçˆ¶äº‹ä»¶=${expectedParentId ? expectedParentId.slice(-8) : 'null'}, å®é™…=${actualParentId ? actualParentId.slice(-8) : 'null'}`, 'warning');
          
          event.parentEventId = expectedParentId;
          
          // åŒæ—¶ä¿®å¤çˆ¶äº‹ä»¶çš„ childIds
          if (expectedParentId) {
            const parentEvent = planEvents.find(e => e.id === expectedParentId);
            if (parentEvent) {
              parentEvent.childEventIds = parentEvent.childEventIds || [];
              if (!parentEvent.childEventIds.includes(event.id)) {
                parentEvent.childEventIds.push(event.id);
              }
            }
          }
          
          fixedCount++;
        }
        
        // è®°å½•å½“å‰å±‚çº§çš„æœ€åä¸€ä¸ªäº‹ä»¶
        levelStack[level] = event;
      }
      
      // æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“
      if (fixedCount > 0) {
        updateStatus(`\nğŸ’¾ ä¿å­˜ ${fixedCount} ä¸ªäº‹ä»¶çš„ä¿®å¤ç»“æœ...`, 'info');
        
        for (const event of planEvents) {
          await store.put(event);
        }
        
        await tx.complete;
        
        updateStatus(`\nâœ… ä¿®å¤å®Œæˆï¼å…±ä¿®å¤ ${fixedCount} ä¸ªäº‹ä»¶çš„çˆ¶å­å…³ç³»`, 'success');
        updateStatus(`   æç¤ºï¼šè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæœ`, 'info');
      } else {
        updateStatus('\nâœ… æ‰€æœ‰äº‹ä»¶çš„çˆ¶å­å…³ç³»éƒ½æ­£ç¡®', 'success');
      }
    }
    
    async function diagnose() {
      output.innerHTML = '';
      updateStatus('å¼€å§‹è¯Šæ–­ Position å­—æ®µ...', 'info');
      
      const db = await openDatabase();
      
      // æ£€æŸ¥ events store æ˜¯å¦å­˜åœ¨
      if (!db.objectStoreNames.contains('events')) {
        updateStatus('âŒ æ•°æ®åº“ä¸­æ²¡æœ‰ events storeï¼', 'error');
        updateStatus('å¯èƒ½åŸå› ï¼šæ•°æ®åº“åˆšæ¸…ç©ºï¼Œè¿˜æœªåˆå§‹åŒ–', 'warning');
        updateStatus('è§£å†³æ–¹æ¡ˆï¼šåˆ·æ–°é¡µé¢ï¼Œç­‰å¾…åº”ç”¨åˆå§‹åŒ–å®Œæˆ', 'info');
        return;
      }
      
      const tx = db.transaction('events', 'readonly');
      const store = tx.objectStore('events');
      const allEvents = await getAllEvents(store);
      
      updateStatus(`âœ… æ‰¾åˆ° ${allEvents.length} ä¸ªäº‹ä»¶`, 'success');
      
      // ï¿½ æœç´¢"2.2"ç›¸å…³äº‹ä»¶
      const event22 = allEvents.filter(e => {
        const title = typeof e.title === 'string' ? e.title : e.title?.simpleTitle || '';
        return title.includes('2.2');
      });
      
      if (event22.length > 0) {
        updateStatus(`\nğŸ” æ‰¾åˆ° ${event22.length} ä¸ªåŒ…å« "2.2" çš„äº‹ä»¶:`, 'info');
        event22.forEach(e => {
          const title = typeof e.title === 'string' ? e.title : e.title?.simpleTitle || '(æ— æ ‡é¢˜)';
          const isPlan = isPlanEvent(e);
          updateStatus(`  - "${title}"`, isPlan ? 'info' : 'warning');
          updateStatus(`    isPlan=${e.isPlan} | checkType=${e.checkType} | isTimeCalendar=${e.isTimeCalendar}`, 'info');
          updateStatus(`    position=${e.position} | ${isPlan ? 'âœ… ä¼šæ˜¾ç¤ºåœ¨ Plan é¡µé¢' : 'âŒ ä¸ä¼šæ˜¾ç¤ºåœ¨ Plan é¡µé¢'}`, isPlan ? 'success' : 'error');
        });
      }
      
      // ï¿½ğŸ”§ åªè¯Šæ–­ä¼šæ˜¾ç¤ºåœ¨ Plan é¡µé¢çš„äº‹ä»¶
      const planEvents = allEvents.filter(isPlanEvent);
      
      updateStatus(`ğŸ“‹ å…¶ä¸­ ${planEvents.length} ä¸ªäº‹ä»¶ä¼šæ˜¾ç¤ºåœ¨ Plan é¡µé¢`, 'info');
      updateStatus(`   (${allEvents.length - planEvents.length} ä¸ªäº‹ä»¶ä¸åœ¨ Plan é¡µé¢ï¼Œè·³è¿‡è¯Šæ–­)`, 'info');
      
      const withPosition = planEvents.filter(e => e.position !== undefined && e.position !== null);
      const withoutPosition = planEvents.filter(e => e.position === undefined || e.position === null);
      
      updateStatus('\nğŸ“Š Plan é¡µé¢äº‹ä»¶ç»Ÿè®¡:', 'info');
      updateStatus(`  - æœ‰ position: ${withPosition.length} ä¸ª`, 'info');
      updateStatus(`  - æ—  position: ${withoutPosition.length} ä¸ª`, withoutPosition.length === 0 ? 'success' : 'warning');
      
      // è¯¦ç»†åˆ†æ
      if (withPosition.length > 0) {
        updateStatus('\nâœ… æœ‰ position çš„äº‹ä»¶:', 'info');
        withPosition.slice(0, 5).forEach(e => {
          const title = typeof e.title === 'string' ? e.title : e.title?.simpleTitle || '(æ— æ ‡é¢˜)';
          const childIds = e.childIds ? `[${e.childIds.join(', ')}]` : '[]';
          updateStatus(`  - ${title.substring(0, 40)}`, 'info');
          updateStatus(`    position=${e.position} | isPlan=${e.isPlan} | checkType=${e.checkType}`, 'info');
          updateStatus(`    parentId=${e.parentId || 'null'} | childIds=${childIds}`, 'info');
          updateStatus(`    created=${new Date(e.createdAt).toLocaleString()}`, 'info');
        });
      }
      
      if (withoutPosition.length > 0) {
        updateStatus('\nâš ï¸ æ—  position çš„äº‹ä»¶:', 'warning');
        withoutPosition.forEach(e => {
          const title = typeof e.title === 'string' ? e.title : e.title?.simpleTitle || '(æ— æ ‡é¢˜)';
          const childIds = e.childIds ? `[${e.childIds.join(', ')}]` : '[]';
          updateStatus(`  - ${title.substring(0, 40)}`, 'warning');
          updateStatus(`    isPlan=${e.isPlan} | checkType=${e.checkType} | isTimeCalendar=${e.isTimeCalendar}`, 'warning');
          updateStatus(`    parentId=${e.parentId || 'null'} | childIds=${childIds}`, 'warning');
          updateStatus(`    created=${new Date(e.createdAt).toLocaleString()}`, 'warning');
        });
        updateStatus('\n   ç‚¹å‡» "ä¿®å¤" æŒ‰é’®è‡ªåŠ¨åˆ†é… position', 'info');
      } else {
        updateStatus('\nâœ… æ‰€æœ‰ Plan é¡µé¢äº‹ä»¶éƒ½æœ‰ position å­—æ®µ', 'success');
      }
    }
    
    async function fix() {
      output.innerHTML = '';
      updateStatus('å¼€å§‹ä¿®å¤ Position å­—æ®µ...', 'info');
      
      const db = await openDatabase();
      const tx = db.transaction('events', 'readwrite');
      const store = tx.objectStore('events');
      const allEvents = await getAllEvents(store);
      
      // ğŸ”§ åªä¿®å¤ä¼šæ˜¾ç¤ºåœ¨ Plan é¡µé¢çš„äº‹ä»¶
      const planEvents = allEvents.filter(isPlanEvent);
      
      updateStatus(`ğŸ“‹ æ‰¾åˆ° ${planEvents.length} ä¸ª Plan é¡µé¢äº‹ä»¶ï¼ˆå…± ${allEvents.length} ä¸ªï¼‰`, 'info');
      
      // æŒ‰ createdAt æ’åºï¼ˆæœ€æ—©çš„æ’åœ¨å‰é¢ï¼‰
      planEvents.sort((a, b) => {
        const timeA = new Date(a.createdAt || 0).getTime();
        const timeB = new Date(b.createdAt || 0).getTime();
        return timeA - timeB;
      });
      
      updateStatus(`âœ… æŒ‰åˆ›å»ºæ—¶é—´æ’åºå®Œæˆ`, 'info');
      
      // ä¸ºæ¯ä¸ªäº‹ä»¶åˆ†é… positionï¼ˆ1000, 2000, 3000...ï¼‰
      let fixedCount = 0;
      for (let i = 0; i < planEvents.length; i++) {
        const event = planEvents[i];
        const newPosition = (i + 1) * POSITION_GAP;
        
        // åªä¿®å¤æ²¡æœ‰ position çš„äº‹ä»¶
        if (event.position === undefined || event.position === null) {
          event.position = newPosition;
          await store.put(event);
          fixedCount++;
          
          if (fixedCount <= 10) {
            const title = typeof event.title === 'string' ? event.title : event.title?.simpleTitle || '(æ— æ ‡é¢˜)';
            updateStatus(`  âœ… ${title.substring(0, 30)} â†’ position = ${newPosition}`, 'success');
          } else if (fixedCount === 11) {
            updateStatus(`  ... (åªæ˜¾ç¤ºå‰ 10 ä¸ª)`, 'info');
          }
        }
      }
      
      await tx.complete;
      
      updateStatus(`\nâœ… ä¿®å¤å®Œæˆï¼å…±ä¿®å¤ ${fixedCount} ä¸ª Plan é¡µé¢äº‹ä»¶`, 'success');
      updateStatus(`   è·³è¿‡äº† ${allEvents.length - planEvents.length} ä¸ªé Plan é¡µé¢äº‹ä»¶`, 'info');
      updateStatus(`   æç¤ºï¼šè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæœ`, 'info');
    }
    
    async function verify() {
      output.innerHTML = '';
      updateStatus('å¼€å§‹éªŒè¯æ’åºç»“æœ...', 'info');
      
      const db = await openDatabase();
      
      if (!db.objectStoreNames.contains('events')) {
        updateStatus('âŒ æ•°æ®åº“ä¸­æ²¡æœ‰ events storeï¼', 'error');
        return;
      }
      
      const tx = db.transaction('events', 'readonly');
      const store = tx.objectStore('events');
      const allEvents = await getAllEvents(store);
      
      // ğŸ”§ åªéªŒè¯ Plan é¡µé¢çš„äº‹ä»¶
      const planEvents = allEvents.filter(isPlanEvent);
      
      updateStatus(`ğŸ“‹ éªŒè¯ ${planEvents.length} ä¸ª Plan é¡µé¢äº‹ä»¶`, 'info');
      
      // Position æ’åº
      const byPosition = [...planEvents].sort((a, b) => {
        const posA = a.position ?? Infinity;
        const posB = b.position ?? Infinity;
        return posA - posB;
      });
      
      // æ—¶é—´æ’åº
      const byTime = [...planEvents].sort((a, b) => {
        const timeA = new Date(a.createdAt || 0).getTime();
        const timeB = new Date(b.createdAt || 0).getTime();
        return timeA - timeB;
      });
      
      // å¯¹æ¯”ä¸¤ç§æ’åº
      let mismatchCount = 0;
      for (let i = 0; i < planEvents.length; i++) {
        if (byPosition[i].id !== byTime[i].id) {
          mismatchCount++;
          if (mismatchCount <= 5) {
            const posTitle = typeof byPosition[i].title === 'string' ? byPosition[i].title : byPosition[i].title?.simpleTitle || '(æ— æ ‡é¢˜)';
            const timeTitle = typeof byTime[i].title === 'string' ? byTime[i].title : byTime[i].title?.simpleTitle || '(æ— æ ‡é¢˜)';
            updateStatus(`  âš ï¸ ç¬¬${i+1}ä½ä¸åŒ¹é…:`, 'warning');
            updateStatus(`     Positionæ’åº: ${posTitle.substring(0, 30)}`, 'warning');
            updateStatus(`     æ—¶é—´æ’åº: ${timeTitle.substring(0, 30)}`, 'warning');
          }
        }
      }
      
      if (mismatchCount === 0) {
        updateStatus('\nâœ… éªŒè¯é€šè¿‡ï¼Plan é¡µé¢çš„ Position æ’åºä¸æ—¶é—´æ’åºå®Œå…¨ä¸€è‡´', 'success');
      } else {
        updateStatus(`\nâš ï¸ å‘ç° ${mismatchCount} å¤„ä¸åŒ¹é…`, 'warning');
        updateStatus('   å»ºè®®é‡æ–°æ‰§è¡Œä¿®å¤', 'info');
      }
    }
  </script>
</body>
</html>
