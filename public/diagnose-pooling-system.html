<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ± åŒ–IDç³»ç»Ÿè¯Šæ–­å·¥å…·</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #2196F3;
      padding-bottom: 10px;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #1976D2;
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #d32f2f;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      border-left: 4px solid #2196F3;
    }
    .stat-card.warning {
      border-left-color: #ff9800;
    }
    .stat-card.error {
      border-left-color: #f44336;
    }
    .stat-card .label {
      font-size: 14px;
      color: #666;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 14px;
    }
    .issue {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid #ff9800;
      background: #fff3cd;
    }
    .success {
      color: #4caf50;
      font-weight: bold;
    }
    .warning {
      color: #ff9800;
      font-weight: bold;
    }
    .error {
      color: #f44336;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ğŸ” EventIdPool æ± åŒ–ç³»ç»Ÿè¯Šæ–­å·¥å…·</h1>
  
  <div class="section">
    <h2>ğŸ¯ å¿«é€Ÿè¯Šæ–­</h2>
    <button onclick="runDiagnosis()">ğŸ” è¿è¡Œå®Œæ•´è¯Šæ–­</button>
    <button onclick="checkPoolStatus()">ğŸ“Š æ£€æŸ¥IDæ± çŠ¶æ€</button>
    <button onclick="findTempIds()">âš ï¸ æŸ¥æ‰¾ä¸´æ—¶ID</button>
    <button onclick="checkPlaceholders()">ğŸ” æ£€æŸ¥å ä½äº‹ä»¶</button>
    <button class="danger" onclick="cleanupPool()">ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„æ± åŒ–ID</button>
  </div>

  <div id="results"></div>

  <script>
    const log = (html) => {
      document.getElementById('results').innerHTML += html + '\n';
    };

    const clear = () => {
      document.getElementById('results').innerHTML = '';
    };

    async function getStorageManager() {
      if (window.storageManagerInstance) {
        return window.storageManagerInstance;
      }
      throw new Error('StorageManageræœªåˆå§‹åŒ–ï¼Œè¯·åœ¨åº”ç”¨ä¸­æ‰“å¼€æ­¤é¡µé¢');
    }

    async function getEventIdPool() {
      // é€šè¿‡å…¨å±€å¯¹è±¡è®¿é—®ï¼ˆå¦‚æœæš´éœ²äº†ï¼‰
      if (window.EventIdPool) {
        return window.EventIdPool;
      }
      throw new Error('EventIdPoolæœªæš´éœ²åˆ°å…¨å±€å¯¹è±¡');
    }

    async function runDiagnosis() {
      clear();
      log('<div class="section"><h2>ğŸ“‹ è¯Šæ–­æŠ¥å‘Š</h2>');
      
      try {
        const storageManager = await getStorageManager();
        const result = await storageManager.queryEvents({ filters: {}, limit: 10000 });
        const events = result.items;
        
        // ç»Ÿè®¡æ•°æ®
        const stats = {
          total: events.length,
          tempIds: events.filter(e => e.id.startsWith('line-')).length,
          placeholders: events.filter(e => e._isPlaceholder === true).length,
          pooledIds: events.filter(e => e._isPooledId === true).length,
          withParentEventId: events.filter(e => e.parentEventId).length,
          withChildEventIds: events.filter(e => e.childEventIds && e.childEventIds.length > 0).length,
          tempParentIds: events.filter(e => e.parentEventId && e.parentEventId.startsWith('line-')).length
        };
        
        log('<div class="stats">');
        log(`<div class="stat-card"><div class="label">æ€»äº‹ä»¶æ•°</div><div class="value">${stats.total}</div></div>`);
        log(`<div class="stat-card ${stats.tempIds > 0 ? 'error' : ''}"><div class="label">ä¸´æ—¶ID (line-)</div><div class="value">${stats.tempIds}</div></div>`);
        log(`<div class="stat-card"><div class="label">å ä½äº‹ä»¶</div><div class="value">${stats.placeholders}</div></div>`);
        log(`<div class="stat-card"><div class="label">æ± åŒ–ID</div><div class="value">${stats.pooledIds}</div></div>`);
        log(`<div class="stat-card"><div class="label">æœ‰çˆ¶äº‹ä»¶</div><div class="value">${stats.withParentEventId}</div></div>`);
        log(`<div class="stat-card"><div class="label">æœ‰å­äº‹ä»¶</div><div class="value">${stats.withChildEventIds}</div></div>`);
        log(`<div class="stat-card ${stats.tempParentIds > 0 ? 'warning' : ''}"><div class="label">ä¸´æ—¶çˆ¶IDå¼•ç”¨</div><div class="value">${stats.tempParentIds}</div></div>`);
        log('</div>');
        
        // é—®é¢˜æ£€æµ‹
        if (stats.tempIds > 0) {
          log(`<div class="issue">âš ï¸ å‘ç° ${stats.tempIds} ä¸ªä¸´æ—¶IDäº‹ä»¶ï¼ˆåº”è¯¥ä½¿ç”¨æ± åŒ–IDï¼‰</div>`);
        }
        
        if (stats.tempParentIds > 0) {
          log(`<div class="issue">âš ï¸ å‘ç° ${stats.tempParentIds} ä¸ªäº‹ä»¶å¼•ç”¨äº†ä¸´æ—¶IDä½œä¸ºçˆ¶äº‹ä»¶</div>`);
        }
        
        if (stats.tempIds === 0 && stats.tempParentIds === 0) {
          log('<div class="success">âœ… æœªå‘ç°ä¸´æ—¶IDé—®é¢˜ï¼ç³»ç»Ÿæ­£å¸¸ä½¿ç”¨æ± åŒ–IDã€‚</div>');
        }
        
      } catch (error) {
        log(`<div class="error">âŒ è¯Šæ–­å¤±è´¥: ${error.message}</div>`);
      }
      
      log('</div>');
    }

    async function checkPoolStatus() {
      clear();
      log('<div class="section"><h2>ğŸ“Š IDæ± çŠ¶æ€</h2>');
      
      try {
        const storageManager = await getStorageManager();
        const result = await storageManager.queryEvents({ 
          filters: { _isPooledId: true }, 
          limit: 100 
        });
        const poolEvents = result.items;
        
        const allocated = poolEvents.filter(e => !e._isPlaceholder).length;
        const unallocated = poolEvents.filter(e => e._isPlaceholder === true).length;
        
        log(`<p>æ± åŒ–äº‹ä»¶æ€»æ•°: <strong>${poolEvents.length}</strong></p>`);
        log(`<p>å·²åˆ†é…: <strong class="success">${allocated}</strong></p>`);
        log(`<p>æœªåˆ†é…ï¼ˆå ä½ï¼‰: <strong class="warning">${unallocated}</strong></p>`);
        
        if (poolEvents.length > 0) {
          log('<h3>æ± åŒ–äº‹ä»¶åˆ—è¡¨ï¼ˆå‰20ä¸ªï¼‰ï¼š</h3>');
          log('<pre>' + JSON.stringify(poolEvents.slice(0, 20).map(e => ({
            id: e.id,
            title: e.title || '(empty)',
            _isPlaceholder: e._isPlaceholder,
            _pooledAt: e._pooledAt,
            bulletLevel: e.bulletLevel,
            parentEventId: e.parentEventId
          })), null, 2) + '</pre>');
        }
        
      } catch (error) {
        log(`<div class="error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`);
      }
      
      log('</div>');
    }

    async function findTempIds() {
      clear();
      log('<div class="section"><h2>âš ï¸ ä¸´æ—¶IDæ£€æµ‹</h2>');
      
      try {
        const storageManager = await getStorageManager();
        const result = await storageManager.queryEvents({ filters: {}, limit: 10000 });
        const events = result.items;
        
        const tempIdEvents = events.filter(e => e.id.startsWith('line-'));
        const tempParentRefs = events.filter(e => e.parentEventId && e.parentEventId.startsWith('line-'));
        
        log(`<p>ä¸´æ—¶IDäº‹ä»¶: <strong class="${tempIdEvents.length > 0 ? 'error' : 'success'}">${tempIdEvents.length}</strong></p>`);
        log(`<p>ä¸´æ—¶çˆ¶IDå¼•ç”¨: <strong class="${tempParentRefs.length > 0 ? 'warning' : 'success'}">${tempParentRefs.length}</strong></p>`);
        
        if (tempIdEvents.length > 0) {
          log('<h3>ä¸´æ—¶IDäº‹ä»¶åˆ—è¡¨ï¼š</h3>');
          log('<pre>' + JSON.stringify(tempIdEvents.map(e => ({
            id: e.id,
            title: e.title,
            isPlan: e.isPlan,
            createdAt: e.createdAt
          })), null, 2) + '</pre>');
        }
        
        if (tempParentRefs.length > 0) {
          log('<h3>ä¸´æ—¶çˆ¶IDå¼•ç”¨ï¼š</h3>');
          log('<pre>' + JSON.stringify(tempParentRefs.map(e => ({
            id: e.id,
            title: e.title,
            parentEventId: e.parentEventId
          })), null, 2) + '</pre>');
        }
        
        if (tempIdEvents.length === 0 && tempParentRefs.length === 0) {
          log('<div class="success">âœ… æ²¡æœ‰å‘ç°ä¸´æ—¶IDï¼</div>');
        }
        
      } catch (error) {
        log(`<div class="error">âŒ æ£€æµ‹å¤±è´¥: ${error.message}</div>`);
      }
      
      log('</div>');
    }

    async function checkPlaceholders() {
      clear();
      log('<div class="section"><h2>ğŸ” å ä½äº‹ä»¶æ£€æŸ¥</h2>');
      
      try {
        const storageManager = await getStorageManager();
        const result = await storageManager.queryEvents({ 
          filters: { _isPlaceholder: true }, 
          limit: 100 
        });
        const placeholders = result.items;
        
        log(`<p>å ä½äº‹ä»¶æ€»æ•°: <strong>${placeholders.length}</strong></p>`);
        
        if (placeholders.length > 0) {
          const ages = placeholders.map(e => {
            const pooledAt = new Date(e._pooledAt || e.createdAt);
            const now = new Date();
            return Math.floor((now - pooledAt) / 1000);
          });
          
          const avgAge = Math.floor(ages.reduce((a, b) => a + b, 0) / ages.length);
          const oldestAge = Math.max(...ages);
          
          log(`<p>å¹³å‡å¹´é¾„: <strong>${avgAge}ç§’</strong></p>`);
          log(`<p>æœ€è€çš„: <strong>${oldestAge}ç§’</strong></p>`);
          
          log('<h3>å ä½äº‹ä»¶è¯¦æƒ…ï¼š</h3>');
          log('<pre>' + JSON.stringify(placeholders.map(e => ({
            id: e.id,
            _pooledAt: e._pooledAt,
            bulletLevel: e.bulletLevel,
            parentEventId: e.parentEventId,
            title: e.title || '(empty)'
          })), null, 2) + '</pre>');
        } else {
          log('<div class="success">âœ… æ²¡æœ‰æœªä½¿ç”¨çš„å ä½äº‹ä»¶</div>');
        }
        
      } catch (error) {
        log(`<div class="error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`);
      }
      
      log('</div>');
    }

    async function cleanupPool() {
      if (!confirm('ç¡®å®šè¦æ¸…ç†æœªä½¿ç”¨çš„æ± åŒ–IDå—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ _isPlaceholder=true çš„äº‹ä»¶ã€‚')) {
        return;
      }
      
      clear();
      log('<div class="section"><h2>ğŸ§¹ æ¸…ç†IDæ± </h2>');
      
      try {
        const storageManager = await getStorageManager();
        const result = await storageManager.queryEvents({ 
          filters: { _isPlaceholder: true }, 
          limit: 100 
        });
        const placeholders = result.items;
        
        log(`<p>æ‰¾åˆ° ${placeholders.length} ä¸ªå ä½äº‹ä»¶...</p>`);
        
        let deleted = 0;
        for (const event of placeholders) {
          await storageManager.deleteEvent(event.id);
          deleted++;
          log(`<p>å·²åˆ é™¤: ${event.id}</p>`);
        }
        
        log(`<div class="success">âœ… æ¸…ç†å®Œæˆï¼åˆ é™¤äº† ${deleted} ä¸ªå ä½äº‹ä»¶ã€‚</div>`);
        
      } catch (error) {
        log(`<div class="error">âŒ æ¸…ç†å¤±è´¥: ${error.message}</div>`);
      }
      
      log('</div>');
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
    window.addEventListener('load', () => {
      setTimeout(runDiagnosis, 500);
    });
  </script>
</body>
</html>
