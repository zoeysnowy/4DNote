<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” çˆ¶å­å…³ç³»è¯Šæ–­å·¥å…·</title>
  <style>
    body {
      font-family: 'Consolas', 'Monaco', monospace;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
      border-radius: 6px;
      border: 1px solid #555;
      background: linear-gradient(to bottom, #3a3a3a, #2a2a2a);
      color: #fff;
    }
    button:hover { background: linear-gradient(to bottom, #4a4a4a, #3a3a3a); }
    #output {
      background: #252526;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 13px;
      max-height: 800px;
      overflow-y: auto;
    }
    .info { color: #4fc3f7; }
    .success { color: #81c784; }
    .warning { color: #ffb74d; }
    .error { color: #e57373; }
  </style>
</head>
<body>
  <h1>ğŸ” çˆ¶å­å…³ç³»è¯Šæ–­å·¥å…·</h1>
  <p>æ£€æŸ¥ UUID æµ‹è¯•äº‹ä»¶çš„å±‚çº§ç»“æ„å’Œçˆ¶å­å…³ç³»</p>
  
  <button onclick="diagnose()">å¼€å§‹è¯Šæ–­</button>
  <button onclick="fixBrokenRefs()" id="fixBtn" disabled>ä¿®å¤æ–­è£‚å…³ç³»</button>
  
  <div id="output"></div>

  <script type="module">
    import { EventService } from '../src/services/EventService.js';
    window.EventService = EventService;

    let brokenRefs = [];
    let allEvents = [];

    function buildParentToChildrenMap(events) {
      const map = new Map();
      events.forEach(e => {
        if (!e.parentEventId) return;
        const arr = map.get(e.parentEventId) || [];
        arr.push(e);
        map.set(e.parentEventId, arr);
      });
      return map;
    }

    function log(msg, type = 'info') {
      const output = document.getElementById('output');
      const colors = {
        info: '#4fc3f7',
        success: '#81c784',
        warning: '#ffb74d',
        error: '#e57373'
      };
      const time = new Date().toLocaleTimeString();
      output.innerHTML += `<span style="color: ${colors[type]}">[${time}] ${msg}</span>\n`;
      output.scrollTop = output.scrollHeight;
      console.log(msg);
    }

    window.diagnose = async function() {
      document.getElementById('output').innerHTML = '';
      log('ğŸ” å¼€å§‹è¯Šæ–­...', 'info');

      try {
        allEvents = await EventService.getAllEvents();
        log(`âœ… è¯»å–äº‹ä»¶ï¼š${allEvents.length} ä¸ª`, 'success');

        // æ‰¾å‡ºæ‰€æœ‰ UUID æµ‹è¯•äº‹ä»¶
        const uuidEvents = allEvents.filter(e => {
          const t = e.title?.simpleTitle || '';
          return t.includes('UUIDæ ¹äº‹ä»¶') || t.includes('L1-') || t.includes('L2-') || 
                 t.includes('L3-') || t.includes('L4-');
        });

        log(`\nğŸ“Š UUID æµ‹è¯•äº‹ä»¶ç»Ÿè®¡`, 'info');
        log(`æ€»æ•°: ${uuidEvents.length}`, 'info');

        // æŒ‰ bulletLevel åˆ†ç»„
        const byLevel = {};
        uuidEvents.forEach(e => {
          const level = e.bulletLevel || 0;
          if (!byLevel[level]) byLevel[level] = [];
          byLevel[level].push(e);
        });

        Object.keys(byLevel).sort((a, b) => Number(a) - Number(b)).forEach(level => {
          log(`  L${level}: ${byLevel[level].length} ä¸ªäº‹ä»¶`, 'info');
        });

        // æ£€æŸ¥æ ¹äº‹ä»¶ï¼ˆADR-001ï¼šä»¥ parentEventId ä¸ºç»“æ„çœŸç›¸ï¼‰
        log(`\nğŸ”— æ ¹äº‹ä»¶æ£€æŸ¥`, 'info');
        const roots = uuidEvents.filter(e => !e.parentEventId);
        log(`æ ¹äº‹ä»¶: ${roots.length} ä¸ª`, 'info');

        const parentToChildren = buildParentToChildrenMap(uuidEvents);

        roots.forEach((root, idx) => {
          const derivedDirectChildren = parentToChildren.get(root.id) || [];
          log(`\nğŸ“Œ æ ¹äº‹ä»¶ ${idx + 1}: ${root.title?.simpleTitle}`, 'info');
          log(`  ID: ${root.id}`, 'info');
          log(`  bulletLevel: ${root.bulletLevel}`, 'info');
          log(`  ç›´æ¥å­èŠ‚ç‚¹ï¼ˆç”± parentEventId æ´¾ç”Ÿï¼‰: ${derivedDirectChildren.length} ä¸ª`,
              derivedDirectChildren.length > 0 ? 'success' : 'warning');
          log(`  childEventIds(legacy): ${root.childEventIds?.length || 0} ä¸ªï¼ˆä¸ç»´æŠ¤/ä¸ä¾èµ–ï¼‰`, 'info');
        });

        // æ£€æŸ¥çˆ¶å­å…³ç³»å®Œæ•´æ€§
        log(`\nğŸ”„ çˆ¶å­å…³ç³»å®Œæ•´æ€§æ£€æŸ¥`, 'info');
        brokenRefs = [];
        
        const children = uuidEvents.filter(e => e.parentEventId);
        log(`å­äº‹ä»¶: ${children.length} ä¸ª (åŒ…å«æ‰€æœ‰å±‚çº§çš„åä»£)`, 'info');
        log(`æ³¨æ„: ADR-001 ä»¥ parentEventId ä¸ºç»“æ„çœŸç›¸ï¼›childEventIds ä¸º legacy å­—æ®µï¼Œä¸ä½œä¸ºæ­£ç¡®æ€§æ ¡éªŒä¾æ®`, 'info');

        children.forEach(child => {
          const parent = allEvents.find(e => e.id === child.parentEventId);
          
          if (!parent) {
            brokenRefs.push({
              type: 'missing-parent',
              childId: child.id,
              childTitle: child.title?.simpleTitle,
              missingParentId: child.parentEventId
            });
          }
        });

        if (brokenRefs.length > 0) {
          log(`\nâš ï¸ å‘ç° ${brokenRefs.length} ä¸ªæ–­è£‚çš„çˆ¶å­å…³ç³»ï¼š`, 'error');
          brokenRefs.forEach((ref, idx) => {
            log(`  ${idx + 1}. å­äº‹ä»¶ ${ref.childTitle}`, 'error');
            log(`     â†’ çˆ¶äº‹ä»¶ä¸å­˜åœ¨: ${ref.missingParentId.slice(-8)}`, 'error');
          });
          document.getElementById('fixBtn').disabled = true;
        } else {
          log(`\nâœ… æ‰€æœ‰ parentEventId å¼•ç”¨å‡æœ‰å¯¹åº”çˆ¶äº‹ä»¶`, 'success');
          
          // æ˜¾ç¤ºå±‚çº§æ ‘ç¤ºä¾‹
          if (roots.length > 0) {
            log(`\nğŸŒ² å±‚çº§æ ‘ç¤ºä¾‹ (ç¬¬1ä¸ªæ ¹äº‹ä»¶):`, 'info');
            const root = roots[0];
            const directL1 = uuidEvents.filter(e => e.parentEventId === root.id);
            log(`  L0: ${root.title?.simpleTitle} (${directL1.length} ä¸ªç›´æ¥å­èŠ‚ç‚¹)`, 'info');
            
            directL1.slice(0, 2).forEach(l1 => {
              const directL2 = uuidEvents.filter(e => e.parentEventId === l1.id);
              log(`    â”œâ”€ L1: ${l1.title?.simpleTitle} (${directL2.length} ä¸ªç›´æ¥å­èŠ‚ç‚¹)`, 'info');
              
              directL2.slice(0, 2).forEach(l2 => {
                const directL3 = uuidEvents.filter(e => e.parentEventId === l2.id);
                log(`    â”‚  â”œâ”€ L2: ${l2.title?.simpleTitle} (${directL3.length} ä¸ªç›´æ¥å­èŠ‚ç‚¹)`, 'info');
                
                if (directL3.length > 0) {
                  log(`    â”‚  â”‚  â””â”€ L3: ${directL3[0].title?.simpleTitle} ...`, 'info');
                }
              });
            });
          }
        }

        // æ£€æŸ¥å±‚çº§è®¡ç®—
        log(`\nğŸ“ å±‚çº§è®¡ç®—éªŒè¯`, 'info');
        const filtered = uuidEvents.filter(e => e.isPlan || e.checkType);
        const calculated = EventService.calculateAllBulletLevels(filtered);

        const mismatches = [];
        filtered.forEach(e => {
          const dbLevel = e.bulletLevel || 0;
          const calcLevel = calculated.get(e.id) || 0;
          if (dbLevel !== calcLevel) {
            mismatches.push({
              id: e.id.slice(-8),
              title: e.title?.simpleTitle?.slice(0, 40),
              dbLevel,
              calcLevel,
              parentId: e.parentEventId?.slice(-8)
            });
          }
        });

        if (mismatches.length > 0) {
          log(`\nâš ï¸ å‘ç° ${mismatches.length} ä¸ªå±‚çº§ä¸ä¸€è‡´ï¼š`, 'warning');
          mismatches.slice(0, 10).forEach((m, idx) => {
            log(`  ${idx + 1}. ${m.title}`, 'warning');
            log(`     ID: ${m.id}, çˆ¶: ${m.parentId || 'æ— '}`, 'info');
            log(`     æ•°æ®åº“ L${m.dbLevel} â†’ è®¡ç®— L${m.calcLevel}`, 'warning');
          });
        } else {
          log(`\nâœ… æ‰€æœ‰äº‹ä»¶çš„å±‚çº§è®¡ç®—æ­£ç¡®`, 'success');
        }

        log(`\n=== è¯Šæ–­å®Œæˆ ===`, 'info');

      } catch (err) {
        log(`\nâŒ è¯Šæ–­å¤±è´¥: ${err.message}`, 'error');
        console.error(err);
      }
    };

    window.fixBrokenRefs = async function() {
      log('âš ï¸ ADR-001: ä¸å†æä¾›åŸºäº childEventIds çš„è‡ªåŠ¨ä¿®å¤ã€‚è¯·æ ¹æ® parentEventId ä¿®å¤ç¼ºå¤±çˆ¶èŠ‚ç‚¹æˆ–æ•°æ®å¯¼å…¥é—®é¢˜ã€‚', 'warning');
    };
  </script>
</body>
</html>
