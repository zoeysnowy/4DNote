<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>4DNote ç»Ÿè®¡åŠŸèƒ½æµ‹è¯• - æ ‡ç­¾ä¸æ—¥å†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      color: #333;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 16px;
      padding: 24px 32px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 28px;
      color: #667eea;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .date-range {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .date-range input {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .stats-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .stats-card h2 {
      font-size: 20px;
      color: #333;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .summary-item {
      text-align: center;
      padding: 16px;
      background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
      border-radius: 12px;
    }

    .summary-value {
      font-size: 28px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 4px;
    }

    .summary-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .chart-container {
      margin-top: 20px;
    }

    .tag-item, .calendar-item {
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      background: #f8f9fa;
      transition: all 0.3s;
      cursor: pointer;
    }

    .tag-item:hover, .calendar-item:hover {
      background: #e9ecef;
      transform: translateX(4px);
    }

    .tag-icon {
      font-size: 24px;
      margin-right: 12px;
      min-width: 32px;
      text-align: center;
    }

    .calendar-icon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 12px;
    }

    .item-info {
      flex: 1;
      min-width: 0;
    }

    .item-name {
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .item-level {
      font-size: 11px;
      color: #999;
      padding: 2px 6px;
      background: white;
      border-radius: 4px;
    }

    .item-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #666;
    }

    .item-duration {
      font-weight: 600;
      color: #667eea;
      margin-left: 12px;
      white-space: nowrap;
    }

    .item-count {
      font-size: 11px;
      color: #999;
      margin-left: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
      transition: width 0.6s ease;
    }

    .trend-chart {
      margin-top: 20px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .correlation-matrix {
      display: grid;
      gap: 8px;
      margin-top: 16px;
    }

    .correlation-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .correlation-cell {
      flex: 1;
      padding: 8px;
      text-align: center;
      background: #f0f0f0;
      border-radius: 4px;
      font-size: 12px;
      transition: all 0.3s;
    }

    .correlation-cell.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: bold;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f0f0f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .tab-container {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      transition: all 0.3s;
      margin-bottom: -2px;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab:hover {
      color: #667eea;
    }

    .hierarchy-item {
      margin-left: 20px;
      margin-top: 8px;
    }

    .source-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #e3f2fd;
      color: #1976d2;
      margin-left: 8px;
    }

    .source-badge.outlook {
      background: #e3f2fd;
      color: #1976d2;
    }

    .source-badge.google {
      background: #fce4ec;
      color: #c2185b;
    }

    .source-badge.local {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    /* 15åˆ†é’Ÿåƒç´ å—æ ·å¼ */
    .pixel-container {
      padding: 20px;
      background: white;
      border-radius: 12px;
      overflow-x: auto;
    }

    .pixel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .pixel-legend {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 200px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #666;
      padding: 4px 8px;
      background: #f8f9fa;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .legend-item:hover {
      background: #e9ecef;
      transform: translateX(2px);
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .pixel-grid {
      display: flex;
      gap: 0;
      position: relative;
      padding: 40px 0;
    }

    .pixel-week-group {
      display: flex;
      gap: 2px;
      padding-right: 12px;
      border-right: 2px solid #dee2e6;
      margin-right: 12px;
    }

    .pixel-week-group:last-child {
      border-right: none;
      margin-right: 0;
    }

    .pixel-day-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 32px;
      position: relative;
      transition: all 0.2s;
    }

    .pixel-day-column:hover {
      transform: translateY(-4px);
      z-index: 100;
    }

    .pixel-day-column:hover .pixel-date-popup {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .pixel-date-popup {
      position: absolute;
      top: -50px;
      left: 50%;
      transform: translateX(-50%) translateY(5px);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: bold;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }

    .pixel-date-popup::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid rgba(0, 0, 0, 0.9);
    }

    .pixel-date-label {
      font-size: 9px;
      font-weight: bold;
      color: transparent;
      margin-bottom: 4px;
      writing-mode: horizontal-tb;
      text-align: center;
      user-select: none;
    }

    .pixel-day-label {
      font-size: 8px;
      color: #999;
      margin-bottom: 8px;
    }

    .pixel-timeline {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      flex: 1;
    }

    /* AM éƒ¨åˆ†ï¼ˆå‘ä¸Šï¼‰ */
    .pixel-am {
      display: flex;
      flex-direction: column-reverse;
      gap: 1px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e9ecef;
    }

    /* PM éƒ¨åˆ†ï¼ˆå‘ä¸‹ï¼‰ */
    .pixel-pm {
      display: flex;
      flex-direction: column;
      gap: 1px;
      padding-top: 8px;
      border-top: 2px solid #e9ecef;
    }

    .pixel-hour-group {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .pixel-block {
      width: 28px;
      height: 6px;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .pixel-block:hover {
      transform: scale(1.15);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }

    .pixel-block.empty {
      background: #f5f5f5;
      opacity: 0.3;
    }

    /* å°æ—¶æ ‡ç­¾ï¼ˆå·¦ä¾§ï¼‰ */
    .hour-labels {
      position: absolute;
      left: -75px;
      top: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 40px 0;
    }

    .hour-labels-am {
      display: flex;
      flex-direction: column-reverse;
      gap: 24px;
      padding-bottom: 8px;
    }

    .hour-labels-pm {
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding-top: 8px;
    }

    .hour-label {
      font-size: 10px;
      color: #999;
      font-family: monospace;
      text-align: right;
      width: 65px;
      overflow: visible;
      white-space: nowrap;
    }

    .am-pm-badge {
      position: absolute;
      left: -75px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .am-badge {
      top: 20%;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
    }

    .pm-badge {
      bottom: 20%;
      background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
      color: white;
    }

    /* æŠ˜çº¿å›¾æ ·å¼ */
    .line-chart {
      padding: 20px;
      background: white;
      border-radius: 12px;
    }

    .chart-svg {
      width: 100%;
      height: 300px;
    }

    .chart-line {
      fill: none;
      stroke: #667eea;
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .chart-area {
      fill: url(#gradient);
      opacity: 0.3;
    }

    .chart-point {
      fill: #667eea;
      stroke: white;
      stroke-width: 2;
      fill: #764ba2;
    }

    .chart-grid {
      stroke: #e9ecef;
      stroke-width: 1;
    }

    .chart-label {
      font-size: 11px;
      fill: #666;
    }

    .chart-tooltip {
      position: absolute;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        <span>ğŸ“Š</span>
        4DNote ç»Ÿè®¡åŠŸèƒ½æµ‹è¯•
      </h1>
      <p>æ ‡ç­¾ç»´åº¦ç»Ÿè®¡ + æ—¥å†åˆ†ç»„ç»Ÿè®¡ï¼ˆæ”¯æŒå¯¼å…¥æ•°æ®ï¼‰</p>
      
      <div class="controls">
        <button class="btn btn-primary" onclick="loadStats()">
          <span>ğŸ”„</span> åˆ·æ–°ç»Ÿè®¡
        </button>
        <div class="date-range">
          <label>å¼€å§‹æ—¥æœŸ:</label>
          <input type="date" id="startDate" />
          <label>ç»“æŸæ—¥æœŸ:</label>
          <input type="date" id="endDate" />
        </div>
        <button class="btn btn-secondary" onclick="setDateRange('today')">ä»Šå¤©</button>
        <button class="btn btn-secondary" onclick="setDateRange('week')">æœ¬å‘¨</button>
        <button class="btn btn-secondary" onclick="setDateRange('month')">æœ¬æœˆ</button>
        <button class="btn btn-secondary" onclick="setDateRange('all')">å…¨éƒ¨</button>
      </div>
    </div>

    <!-- æ€»è§ˆç»Ÿè®¡ -->
    <div class="stats-card" style="margin-bottom: 24px;">
      <h2><span>ğŸ“ˆ</span> æ€»è§ˆ</h2>
      <div class="stats-summary" id="overview">
        <div class="loading">
          <div class="spinner"></div>
          <p>åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- Tab åˆ‡æ¢ -->
    <div class="stats-card">
      <div class="tab-container">
        <button class="tab active" onclick="switchTab('tags')">
          <span>ğŸ·ï¸</span> æ ‡ç­¾ç»Ÿè®¡
        </button>
        <button class="tab" onclick="switchTab('calendars')">
          <span>ğŸ“…</span> æ—¥å†ç»Ÿè®¡
        </button>
        <button class="tab" onclick="switchTab('correlation')">
          <span>ğŸ”—</span> æ ‡ç­¾å…³è”
        </button>
        <button class="tab" onclick="switchTab('trends')">
          <span>ğŸ“‰</span> è¶‹åŠ¿åˆ†æ
        </button>
      </div>

      <!-- æ ‡ç­¾ç»Ÿè®¡ -->
      <div id="tab-tags" class="tab-content">
        <div id="tagStats" class="chart-container">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½æ ‡ç­¾ç»Ÿè®¡ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- æ—¥å†ç»Ÿè®¡ -->
      <div id="tab-calendars" class="tab-content" style="display: none;">
        <div id="calendarStats" class="chart-container">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½æ—¥å†ç»Ÿè®¡ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- æ ‡ç­¾å…³è” -->
      <div id="tab-correlation" class="tab-content" style="display: none;">
        <div id="correlationMatrix" class="chart-container">
          <div class="loading">
            <div class="spinner"></div>
            <p>è®¡ç®—æ ‡ç­¾å…³è”ä¸­...</p>
          </div>
        </div>
      </div>

      <!-- è¶‹åŠ¿åˆ†æ -->
      <div id="tab-trends" class="tab-content" style="display: none;">
        <!-- è¶‹åŠ¿è§†å›¾åˆ‡æ¢ -->
        <div style="display: flex; gap: 8px; margin-bottom: 20px; padding: 8px; background: #f8f9fa; border-radius: 8px;">
          <button class="btn btn-secondary" onclick="switchTrendView('pixels')" id="btn-trend-pixels">
            <span>ğŸ“Š</span> åƒç´ æ—¶é—´å—
          </button>
          <button class="btn btn-secondary" onclick="switchTrendView('line')" id="btn-trend-line">
            <span>ğŸ“ˆ</span> æŠ˜çº¿å›¾
          </button>
        </div>
        
        <div id="trendChart" class="chart-container">
          <div class="loading">
            <div class="spinner"></div>
            <p>åˆ†æè¶‹åŠ¿ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { EventService } from '../src/services/EventService.js';
    import { TagService } from '../src/services/TagService.js';

    let currentTab = 'tags';
    let currentTrendView = 'pixels'; // è¶‹åŠ¿è§†å›¾ï¼š'pixels' æˆ– 'line'
    let allEvents = [];
    let allTags = [];
    let calendarCache = new Map(); // æ—¥å† ID -> æ—¥å†ä¿¡æ¯çš„ç¼“å­˜
    let startDate = null;
    let endDate = null;
    let dailyStatsCache = []; // ç¼“å­˜æ¯æ—¥ç»Ÿè®¡æ•°æ®

    // åŠ è½½æ—¥å†ç¼“å­˜
    async function loadCalendarCache() {
      try {
        // å°è¯•ä» localStorage åŠ è½½æ—¥å†ç¼“å­˜
        const cacheStr = localStorage.getItem('4dnote-calendars-cache');
        if (cacheStr) {
          const calendars = JSON.parse(cacheStr);
          console.log('ğŸ“… åŠ è½½æ—¥å†ç¼“å­˜:', calendars.length, 'ä¸ª');
          calendars.forEach(cal => {
            calendarCache.set(cal.id, {
              id: cal.id,
              name: cal.name || cal.id.substring(0, 20),
              color: cal.hexColor || cal.color || cal.backgroundColor || getCalendarColor(cal.id, 'calendar')
            });
          });
        }

        // ä¹Ÿå°è¯•ä» MicrosoftCalendarService è·å–
        if (window.microsoftCalendarService) {
          const service = window.microsoftCalendarService;
          if (service.calendars && service.calendars.length > 0) {
            console.log('ğŸ“… ä» MicrosoftCalendarService åŠ è½½æ—¥å†:', service.calendars.length, 'ä¸ª');
            service.calendars.forEach(cal => {
              calendarCache.set(cal.id, {
                id: cal.id,
                name: cal.name || cal.id.substring(0, 20),
                color: cal.hexColor || cal.color || getCalendarColor(cal.id, 'outlook')
              });
            });
          }
        }

        console.log('âœ… æ—¥å†ç¼“å­˜åŠ è½½å®Œæˆ:', calendarCache.size, 'ä¸ªæ—¥å†');
      } catch (error) {
        console.warn('âš ï¸ åŠ è½½æ—¥å†ç¼“å­˜å¤±è´¥:', error);
      }
    }

    // è·å–æ—¥å†åç§°
    function getCalendarName(calendarId) {
      // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾
      if (calendarCache.has(calendarId)) {
        return calendarCache.get(calendarId).name;
      }

      // å¦‚æœæ˜¯ç‰¹æ®Šå‰ç¼€ï¼Œè¿”å›æ›´å‹å¥½çš„åç§°
      if (calendarId.startsWith('outlook-')) {
        return 'Outlook æ—¥å†';
      }
      if (calendarId.startsWith('google-')) {
        return 'Google æ—¥å†';
      }
      if (calendarId.startsWith('icloud-')) {
        return 'iCloud æ—¥å†';
      }

      // å¦‚æœ ID å¤ªé•¿ï¼Œæˆªæ–­æ˜¾ç¤º
      if (calendarId.length > 40) {
        return calendarId.substring(0, 30) + '...';
      }

      return calendarId;
    }

    // åˆå§‹åŒ–
    async function init() {
      // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ¬å‘¨ï¼‰
      setDateRange('week');
      
      // ç­‰å¾…æœåŠ¡åˆå§‹åŒ–
      await Promise.all([
        EventService.waitForInitialization?.() || Promise.resolve(),
        TagService.waitForInitialization?.() || Promise.resolve()
      ]);

      // åŠ è½½æ—¥å†ç¼“å­˜
      await loadCalendarCache();

      // åŠ è½½æ•°æ®
      await loadStats();
    }

    // æ‰å¹³åŒ–æ ‡ç­¾ï¼ˆå¤„ç†å±‚çº§ç»“æ„ï¼‰
    function flattenTags(tags) {
      const result = [];
      const flatten = (tagList, level = 0) => {
        tagList.forEach(tag => {
          result.push({
            ...tag,
            level
          });
          if (tag.children && tag.children.length > 0) {
            flatten(tag.children, level + 1);
          }
        });
      };
      flatten(tags);
      return result;
    }

    // è®¾ç½®æ—¥æœŸèŒƒå›´
    window.setDateRange = function(range) {
      const now = new Date();
      const startInput = document.getElementById('startDate');
      const endInput = document.getElementById('endDate');

      switch (range) {
        case 'today':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
          break;
        case 'week':
          const dayOfWeek = now.getDay();
          const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + mondayOffset);
          endDate = new Date(startDate.getTime() + 7 * 24 * 60 * 60 * 1000 - 1);
          break;
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
          break;
        case 'all':
          startDate = null;
          endDate = null;
          startInput.value = '';
          endInput.value = '';
          loadStats();
          return;
      }

      startInput.value = startDate.toISOString().split('T')[0];
      endInput.value = endDate.toISOString().split('T')[0];
      loadStats();
    };

    // æ—¥æœŸè¾“å…¥å˜åŒ–
    document.getElementById('startDate').addEventListener('change', (e) => {
      startDate = e.target.value ? new Date(e.target.value) : null;
      loadStats();
    });

    document.getElementById('endDate').addEventListener('change', (e) => {
      endDate = e.target.value ? new Date(e.target.value + 'T23:59:59') : null;
      loadStats();
    });

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    window.loadStats = async function() {
      try {
        // è·å–æ‰€æœ‰äº‹ä»¶
        allEvents = await EventService.getAllEvents();
        
        // è¿‡æ»¤æ—¥æœŸèŒƒå›´
        const filteredEvents = filterEventsByDate(allEvents);
        
        // è·å–æ‰€æœ‰æ ‡ç­¾ï¼ˆå±‚çº§ç»“æ„ï¼Œéœ€è¦æ‰å¹³åŒ–ï¼‰
        const hierarchicalTags = TagService.getTags() || [];
        allTags = flattenTags(hierarchicalTags);

        // æ¸²æŸ“æ€»è§ˆ
        renderOverview(filteredEvents);

        // æ¸²æŸ“å½“å‰ tab çš„å†…å®¹
        switch (currentTab) {
          case 'tags':
            renderTagStats(filteredEvents);
            break;
          case 'calendars':
            renderCalendarStats(filteredEvents);
            break;
          case 'correlation':
            renderCorrelation(filteredEvents);
            break;
          case 'trends':
            renderTrends(filteredEvents);
            break;
        }

        console.log('ğŸ“Š ç»Ÿè®¡æ•°æ®åŠ è½½å®Œæˆ', {
          æ€»äº‹ä»¶æ•°: allEvents.length,
          è¿‡æ»¤åäº‹ä»¶æ•°: filteredEvents.length,
          æ ‡ç­¾æ•°: allTags.length,
          æ—¥æœŸèŒƒå›´: { startDate, endDate }
        });
      } catch (error) {
        console.error('âŒ åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
        alert('åŠ è½½ç»Ÿè®¡å¤±è´¥: ' + error.message);
      }
    };

    // è¿‡æ»¤æ—¥æœŸèŒƒå›´
    function filterEventsByDate(events) {
      if (!startDate && !endDate) return events;

      return events.filter(event => {
        if (!event.startTime) return false;
        const eventDate = new Date(event.startTime);
        
        if (startDate && eventDate < startDate) return false;
        if (endDate && eventDate > endDate) return false;
        
        return true;
      });
    }

    // è®¡ç®—äº‹ä»¶æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
    function getEventDuration(event) {
      if (!event.startTime || !event.endTime) return 0;
      return new Date(event.endTime) - new Date(event.startTime);
    }

    // æ ¼å¼åŒ–æ—¶é•¿
    function formatDuration(ms) {
      const hours = Math.floor(ms / 3600000);
      const minutes = Math.floor((ms % 3600000) / 60000);
      
      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      }
      return `${minutes}m`;
    }

    // æ¸²æŸ“æ€»è§ˆ
    function renderOverview(events) {
      const totalDuration = events.reduce((sum, e) => sum + getEventDuration(e), 0);
      const totalEvents = events.length;
      
      // ç»Ÿè®¡æœ‰æ ‡ç­¾å’Œæœ‰æ—¥å†çš„äº‹ä»¶
      const eventsWithTags = events.filter(e => e.tags && e.tags.length > 0).length;
      const eventsWithCalendars = events.filter(e => e.calendarIds && e.calendarIds.length > 0).length;

      const html = `
        <div class="summary-item">
          <div class="summary-value">${totalEvents}</div>
          <div class="summary-label">æ€»äº‹ä»¶æ•°</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">${formatDuration(totalDuration)}</div>
          <div class="summary-label">æ€»æ—¶é•¿</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">${eventsWithTags}</div>
          <div class="summary-label">æœ‰æ ‡ç­¾äº‹ä»¶</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">${eventsWithCalendars}</div>
          <div class="summary-label">æœ‰æ—¥å†äº‹ä»¶</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">${totalEvents - eventsWithTags - eventsWithCalendars}</div>
          <div class="summary-label">æ— åˆ†ç»„äº‹ä»¶</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">${allTags.length}</div>
          <div class="summary-label">æ ‡ç­¾æ€»æ•°</div>
        </div>
      `;

      document.getElementById('overview').innerHTML = html;
    }

    // æ¸²æŸ“æ ‡ç­¾ç»Ÿè®¡
    function renderTagStats(events) {
      const tagStatsMap = new Map();
      
      // ç»Ÿè®¡æ¯ä¸ªæ ‡ç­¾çš„æ—¶é•¿å’Œé¢‘æ¬¡
      events.forEach(event => {
        const duration = getEventDuration(event);
        
        if (event.tags && event.tags.length > 0) {
          event.tags.forEach(tagId => {
            if (!tagStatsMap.has(tagId)) {
              tagStatsMap.set(tagId, {
                duration: 0,
                count: 0,
                events: []
              });
            }
            const stats = tagStatsMap.get(tagId);
            stats.duration += duration;
            stats.count += 1;
            stats.events.push(event.id);
          });
        }
      });

      // è·å–æ ‡ç­¾è¯¦ç»†ä¿¡æ¯å¹¶æ’åº
      const tagStats = Array.from(tagStatsMap.entries())
        .map(([tagId, stats]) => {
          const tag = allTags.find(t => t.id === tagId);
          return {
            id: tagId,
            name: tag?.name || tagId,
            emoji: tag?.emoji,
            color: tag?.color || '#999',
            level: tag?.level || 0,
            duration: stats.duration,
            count: stats.count,
            percentage: 0
          };
        })
        .sort((a, b) => b.duration - a.duration);

      // è®¡ç®—ç™¾åˆ†æ¯”
      const totalDuration = tagStats.reduce((sum, t) => sum + t.duration, 0);
      tagStats.forEach(tag => {
        tag.percentage = totalDuration > 0 ? (tag.duration / totalDuration * 100) : 0;
      });

      // æ¸²æŸ“
      if (tagStats.length === 0) {
        document.getElementById('tagStats').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ·ï¸</div>
            <p>æš‚æ— æ ‡ç­¾ç»Ÿè®¡æ•°æ®</p>
          </div>
        `;
        return;
      }

      const html = tagStats.map(tag => `
        <div class="tag-item" onclick="showTagDetail('${tag.id}')">
          <div class="tag-icon">${tag.emoji || 'ğŸ“Œ'}</div>
          <div class="item-info">
            <div class="item-name">
              ${tag.name}
              <span class="item-level">L${tag.level}</span>
            </div>
            <div class="item-stats">
              <span>${tag.count} ä¸ªäº‹ä»¶</span>
              <span>${tag.percentage.toFixed(1)}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${tag.percentage}%"></div>
            </div>
          </div>
          <div class="item-duration">${formatDuration(tag.duration)}</div>
        </div>
      `).join('');

      document.getElementById('tagStats').innerHTML = html;
    }

    // æ¸²æŸ“æ—¥å†ç»Ÿè®¡
    function renderCalendarStats(events) {
      const calendarStatsMap = new Map();
      
      // ç»Ÿè®¡æ¯ä¸ªæ—¥å†çš„æ—¶é•¿å’Œé¢‘æ¬¡
      events.forEach(event => {
        const duration = getEventDuration(event);
        
        // ç»Ÿè®¡ calendarIds
        if (event.calendarIds && event.calendarIds.length > 0) {
          event.calendarIds.forEach(calId => {
            if (!calendarStatsMap.has(calId)) {
              calendarStatsMap.set(calId, {
                duration: 0,
                count: 0,
                events: [],
                source: 'calendar'
              });
            }
            const stats = calendarStatsMap.get(calId);
            stats.duration += duration;
            stats.count += 1;
            stats.events.push(event.id);
          });
        }

        // ç»Ÿè®¡äº‹ä»¶æ¥æºï¼ˆæ²¡æœ‰ calendarIds çš„æƒ…å†µï¼‰
        if ((!event.calendarIds || event.calendarIds.length === 0) && event.source) {
          const sourceKey = `source:${event.source}`;
          if (!calendarStatsMap.has(sourceKey)) {
            calendarStatsMap.set(sourceKey, {
              duration: 0,
              count: 0,
              events: [],
              source: event.source
            });
          }
          const stats = calendarStatsMap.get(sourceKey);
          stats.duration += duration;
          stats.count += 1;
          stats.events.push(event.id);
        }
      });

      // æ’åº
      const calendarStats = Array.from(calendarStatsMap.entries())
        .map(([id, stats]) => {
          let name, color;
          
          if (stats.source === 'calendar') {
            // ä»ç¼“å­˜è·å–æ—¥å†åç§°
            name = getCalendarName(id);
            color = calendarCache.has(id) ? calendarCache.get(id).color : getCalendarColor(id, stats.source);
          } else {
            // æ¥æºç±»å‹
            const sourceNames = {
              'outlook': 'Outlook å¯¼å…¥',
              'google': 'Google å¯¼å…¥',
              'icloud': 'iCloud å¯¼å…¥',
              'local': 'æœ¬åœ°åˆ›å»º'
            };
            name = sourceNames[stats.source] || `${stats.source} å¯¼å…¥`;
            color = getCalendarColor(id, stats.source);
          }
          
          return {
            id,
            name,
            color,
            duration: stats.duration,
            count: stats.count,
            source: stats.source,
            percentage: 0
          };
        })
        .sort((a, b) => b.duration - a.duration);

      // è®¡ç®—ç™¾åˆ†æ¯”
      const totalDuration = calendarStats.reduce((sum, c) => sum + c.duration, 0);
      calendarStats.forEach(cal => {
        cal.percentage = totalDuration > 0 ? (cal.duration / totalDuration * 100) : 0;
      });

      // æ¸²æŸ“
      if (calendarStats.length === 0) {
        document.getElementById('calendarStats').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“…</div>
            <p>æš‚æ— æ—¥å†ç»Ÿè®¡æ•°æ®</p>
          </div>
        `;
        return;
      }

      const html = calendarStats.map(cal => `
        <div class="calendar-item" onclick="showCalendarDetail('${cal.id}')">
          <div class="calendar-icon" style="background: ${cal.color}"></div>
          <div class="item-info">
            <div class="item-name">
              ${cal.name}
              <span class="source-badge ${cal.source}">${cal.source}</span>
            </div>
            <div class="item-stats">
              <span>${cal.count} ä¸ªäº‹ä»¶</span>
              <span>${cal.percentage.toFixed(1)}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${cal.percentage}%"></div>
            </div>
          </div>
          <div class="item-duration">${formatDuration(cal.duration)}</div>
        </div>
      `).join('');

      document.getElementById('calendarStats').innerHTML = html;
    }

    // è·å–æ—¥å†é¢œè‰²
    function getCalendarColor(id, source) {
      if (source === 'outlook') return '#0078d4';
      if (source === 'google') return '#ea4335';
      if (source === 'local') return '#7b1fa2';
      
      // æ ¹æ® ID ç”Ÿæˆé¢œè‰²
      const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
      const hash = id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
      return colors[hash % colors.length];
    }

    // æ¸²æŸ“æ ‡ç­¾å…³è”åˆ†æ
    function renderCorrelation(events) {
      // è®¡ç®—æ ‡ç­¾å…±ç°çŸ©é˜µ
      const coOccurrence = new Map();
      
      events.forEach(event => {
        if (!event.tags || event.tags.length < 2) return;
        
        // å¯¹äºæ¯å¯¹æ ‡ç­¾ï¼Œè®°å½•å…±ç°
        for (let i = 0; i < event.tags.length; i++) {
          for (let j = i + 1; j < event.tags.length; j++) {
            const tag1 = event.tags[i];
            const tag2 = event.tags[j];
            const key = [tag1, tag2].sort().join(':');
            
            if (!coOccurrence.has(key)) {
              coOccurrence.set(key, 0);
            }
            coOccurrence.set(key, coOccurrence.get(key) + 1);
          }
        }
      });

      // è·å–å‰10ä¸ªæœ€å¸¸å…³è”çš„æ ‡ç­¾å¯¹
      const topPairs = Array.from(coOccurrence.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([key, count]) => {
          const [tag1Id, tag2Id] = key.split(':');
          const tag1 = allTags.find(t => t.id === tag1Id);
          const tag2 = allTags.find(t => t.id === tag2Id);
          return {
            tag1: tag1?.name || tag1Id,
            tag2: tag2?.name || tag2Id,
            count
          };
        });

      if (topPairs.length === 0) {
        document.getElementById('correlationMatrix').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ”—</div>
            <p>æš‚æ— æ ‡ç­¾å…³è”æ•°æ®ï¼ˆéœ€è¦è‡³å°‘2ä¸ªæ ‡ç­¾çš„äº‹ä»¶ï¼‰</p>
          </div>
        `;
        return;
      }

      const html = `
        <h3 style="margin-bottom: 16px;">æ ‡ç­¾å…±ç°é¢‘æ¬¡ Top 10</h3>
        ${topPairs.map(pair => `
          <div class="correlation-row">
            <div class="correlation-cell active" style="flex: 0 0 120px;">${pair.tag1}</div>
            <div class="correlation-cell" style="flex: 0 0 40px;">+</div>
            <div class="correlation-cell active" style="flex: 0 0 120px;">${pair.tag2}</div>
            <div class="correlation-cell" style="flex: 1;">${pair.count} æ¬¡</div>
          </div>
        `).join('')}
      `;

      document.getElementById('correlationMatrix').innerHTML = html;
    }

    // åˆ‡æ¢è¶‹åŠ¿è§†å›¾
    window.switchTrendView = function(view) {
      currentTrendView = view;
      
      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.getElementById('btn-trend-pixels').classList.toggle('btn-primary', view === 'pixels');
      document.getElementById('btn-trend-pixels').classList.toggle('btn-secondary', view !== 'pixels');
      document.getElementById('btn-trend-line').classList.toggle('btn-primary', view === 'line');
      document.getElementById('btn-trend-line').classList.toggle('btn-secondary', view !== 'line');
      
      // é‡æ–°æ¸²æŸ“
      if (dailyStatsCache.length > 0) {
        renderTrendsView(dailyStatsCache);
      }
    };

    // æ¸²æŸ“è¶‹åŠ¿åˆ†æ
    function renderTrends(events) {
      // æŒ‰å¤©åˆ†ç»„ç»Ÿè®¡ï¼ˆåŒ…å«å°æ—¶çº§æ•°æ®ç”¨äºåƒç´ å—ï¼‰
      const dailyStats = new Map();
      
      events.forEach(event => {
        if (!event.startTime) return;
        
        const date = event.startTime.split(' ')[0]; // YYYY-MM-DD
        const timePart = event.startTime.split(' ')[1]; // HH:mm:ss
        if (!timePart) return;
        
        const hour = parseInt(timePart.split(':')[0]);
        const minute = parseInt(timePart.split(':')[1]);
        const quarter = Math.floor(minute / 15); // 0, 1, 2, 3
        
        if (!dailyStats.has(date)) {
          dailyStats.set(date, {
            count: 0,
            duration: 0,
            tags: new Set(),
            hours: {} // { '9': { quarters: [tag1, tag2, tag3, tag4] } }
          });
        }
        
        const stats = dailyStats.get(date);
        stats.count += 1;
        stats.duration += getEventDuration(event);
        
        if (event.tags) {
          event.tags.forEach(tag => stats.tags.add(tag));
        }
        
        // è®°å½•æ—¶é—´å—
        if (!stats.hours[hour]) {
          stats.hours[hour] = { quarters: [null, null, null, null] };
        }
        
        // ä¼˜å…ˆä½¿ç”¨æ—¥å† IDï¼Œå…¶æ¬¡ä½¿ç”¨æ ‡ç­¾
        let blockType = null;
        let blockColor = null;
        
        if (event.calendarIds && event.calendarIds.length > 0) {
          // ä½¿ç”¨æ—¥å† ID ä½œä¸ºç±»å‹
          blockType = event.calendarIds[0];
          blockColor = calendarCache.has(blockType) 
            ? calendarCache.get(blockType).color 
            : getCalendarColor(blockType, 'calendar');
        } else if (event.tags && event.tags.length > 0) {
          // ä½¿ç”¨æ ‡ç­¾ä½œä¸ºç±»å‹
          const tag = allTags.find(t => t.id === event.tags[0]);
          blockType = tag?.name?.toLowerCase() || 'tag';
          blockColor = tag?.color || null;
        } else {
          // é»˜è®¤ç±»å‹
          blockType = 'default';
        }
        
        if (blockType) {
          stats.hours[hour].quarters[quarter] = {
            type: blockType,
            color: blockColor,
            title: event.title?.simpleTitle || 'æœªå‘½å',
            eventId: event.id
          };
        }
      });

      // æ’åº
      const sortedDays = Array.from(dailyStats.entries())
        .sort((a, b) => a[0].localeCompare(b[0]));

      if (sortedDays.length === 0) {
        document.getElementById('trendChart').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‰</div>
            <p>æš‚æ— è¶‹åŠ¿æ•°æ®</p>
          </div>
        `;
        return;
      }

      // ç¼“å­˜æ•°æ®
      dailyStatsCache = sortedDays;
      
      // æ ¹æ®å½“å‰è§†å›¾æ¸²æŸ“
      renderTrendsView(sortedDays);
    }

    // æ¸²æŸ“è¶‹åŠ¿è§†å›¾ï¼ˆåƒç´ å—æˆ–æŠ˜çº¿å›¾ï¼‰
    function renderTrendsView(sortedDays) {
      if (currentTrendView === 'pixels') {
        renderPixelView(sortedDays);
      } else {
        renderLineChart(sortedDays);
      }
    }

    // æ¸²æŸ“15åˆ†é’Ÿåƒç´ å—è§†å›¾
    function renderPixelView(sortedDays) {
      // è·å–å—çš„é¢œè‰²
      const getBlockColor = (blockData) => {
        if (!blockData) return '#f5f5f5';
        
        // å¦‚æœå·²ç»æœ‰é¢œè‰²ï¼Œç›´æ¥ä½¿ç”¨
        if (blockData.color) {
          return blockData.color;
        }
        
        // é»˜è®¤é¢œè‰²æ˜ å°„
        const colorMap = {
          work: '#667eea',
          study: '#a78bfa',
          life: '#fb923c',
          meeting: '#f43f5e',
          social: '#34d399',
          default: '#94a3b8'
        };
        
        // ä»ç±»å‹è·å–é¢œè‰²
        const type = blockData.type || blockData;
        if (typeof type === 'string') {
          // æ£€æŸ¥æ˜¯å¦æ˜¯æ—¥å† ID
          if (calendarCache.has(type)) {
            return calendarCache.get(type).color;
          }
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯æ ‡ç­¾
          const tag = allTags.find(t => t.name?.toLowerCase() === type.toLowerCase());
          if (tag && tag.color) {
            return tag.color;
          }
          
          // ä½¿ç”¨é»˜è®¤é¢œè‰²æˆ–ç”Ÿæˆ
          return colorMap[type] || hashToColor(type);
        }
        
        return colorMap.default;
      };

      // è·å–å—çš„æ˜¾ç¤ºåç§°
      const getBlockName = (blockData) => {
        if (!blockData) return 'ç©ºé—²';
        if (typeof blockData === 'string') return blockData;
        
        const type = blockData.type;
        
        // ä»æ—¥å†ç¼“å­˜è·å–åç§°
        if (calendarCache.has(type)) {
          return calendarCache.get(type).name;
        }
        
        // ä»æ ‡ç­¾è·å–åç§°
        const tag = allTags.find(t => t.id === type || t.name?.toLowerCase() === type.toLowerCase());
        if (tag) {
          return tag.name;
        }
        
        return type || 'æœªçŸ¥';
      };

      // å­—ç¬¦ä¸²è½¬é¢œè‰²
      const hashToColor = (str) => {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = Math.abs(hash) % 360;
        return `hsl(${hue}, 65%, 55%)`;
      };

      // æ”¶é›†æ‰€æœ‰ä½¿ç”¨çš„æ—¥å†å’Œæ ‡ç­¾ï¼ˆç”¨äºå›¾ä¾‹ï¼‰
      const legendItems = new Map();
      sortedDays.forEach(([_, stats]) => {
        Object.values(stats.hours).forEach(hourData => {
          hourData.quarters.forEach(blockData => {
            if (blockData) {
              const type = blockData.type || blockData;
              if (!legendItems.has(type)) {
                legendItems.set(type, {
                  name: getBlockName(blockData),
                  color: getBlockColor(blockData),
                  count: 0
                });
              }
              legendItems.get(type).count++;
            }
          });
        });
      });

      // æŒ‰ä½¿ç”¨é¢‘æ¬¡æ’åº
      const sortedLegend = Array.from(legendItems.entries())
        .sort((a, b) => b[1].count - a[1].count);

      // æŒ‰å‘¨åˆ†ç»„
      const weekGroups = [];
      let currentWeek = [];
      let currentWeekNumber = null;

      // è·å–å‘¨æ•°çš„å‡½æ•°
      function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      }

      sortedDays.forEach(([date, stats]) => {
        const dateObj = new Date(date);
        const weekNumber = getWeekNumber(dateObj);
        
        if (currentWeekNumber !== null && weekNumber !== currentWeekNumber) {
          // æ–°çš„ä¸€å‘¨ï¼Œä¿å­˜å½“å‰å‘¨
          weekGroups.push({
            weekNumber: currentWeekNumber,
            days: currentWeek
          });
          currentWeek = [];
        }
        
        currentWeekNumber = weekNumber;
        currentWeek.push([date, stats, dateObj]);
      });
      
      // ä¿å­˜æœ€åä¸€å‘¨
      if (currentWeek.length > 0) {
        weekGroups.push({
          weekNumber: currentWeekNumber,
          days: currentWeek
        });
      }

      const html = `
        <div class="pixel-container">
          <div class="pixel-header">
            <div style="flex: 1;">
              <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                <span>ğŸ“Š</span> Daily Pixels
                <span style="font-size: 12px; color: #999; font-weight: normal;">ï¼ˆæ¯å— = 15åˆ†é’Ÿï¼‰</span>
              </h3>
            </div>
            <div class="pixel-legend">
              ${sortedLegend.slice(0, 10).map(([type, info]) => `
                <div class="legend-item">
                  <div class="legend-color" style="background: ${info.color}"></div>
                  <span>${info.name} (${info.count})</span>
                </div>
              `).join('')}
            </div>
          </div>

          <div style="position: relative; padding-left: 80px;">
            <!-- å°æ—¶æ ‡ç­¾ -->
            <div class="hour-labels">
              <div class="hour-labels-am">
                ${[11, 10, 9, 8, 7, 6].map(h => `
                  <div class="hour-label">${h}:00</div>
                `).join('')}
              </div>
              <div class="hour-labels-pm">
                ${[12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11].map(h => `
                  <div class="hour-label">${h}:00</div>
                `).join('')}
              </div>
            </div>

            <!-- AM/PM æ ‡ç­¾ -->
            <div class="am-pm-badge am-badge">AM</div>
            <div class="am-pm-badge pm-badge">PM</div>

            <!-- æ—¥æœŸåˆ—ï¼ˆæŒ‰å‘¨åˆ†ç»„ï¼‰ -->
            <div class="pixel-grid">
              ${weekGroups.map(week => `
                <div class="pixel-week-group">
                  ${week.days.map(([date, stats, dateObj]) => {
                    const weekday = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][dateObj.getDay()];
                    const monthDay = date.substring(5); // MM-DD
                    const year = dateObj.getFullYear();
                    
                    return `
                      <div class="pixel-day-column">
                        <!-- Hover å¼¹å‡ºä¿¡æ¯ -->
                        <div class="pixel-date-popup">
                          ${year}å¹´ ç¬¬${week.weekNumber}å‘¨<br/>
                          ${monthDay} å‘¨${weekday}
                        </div>
                        
                        <!-- éšè—çš„æ—¥æœŸæ ‡ç­¾ï¼ˆå ä½ç”¨ï¼‰ -->
                        <div class="pixel-date-label">${monthDay}</div>
                        <div class="pixel-day-label">${weekday}</div>
                    
                    <div class="pixel-timeline">
                      <!-- AM éƒ¨åˆ†ï¼ˆ6-11ç‚¹ï¼Œå‘ä¸Šï¼‰ -->
                      <div class="pixel-am">
                        ${[6, 7, 8, 9, 10, 11].map(hour => {
                          const hourData = stats.hours[hour] || { quarters: [null, null, null, null] };
                          return `
                            <div class="pixel-hour-group">
                              ${hourData.quarters.map((blockData, qIdx) => {
                                const minutes = qIdx * 15;
                                const time = `${hour}:${minutes.toString().padStart(2, '0')}`;
                                if (!blockData) {
                                  return `<div class="pixel-block empty" title="${time} - ç©ºé—²"></div>`;
                                }
                                const name = getBlockName(blockData);
                                const title = blockData.title || name;
                                return `
                                  <div 
                                    class="pixel-block" 
                                    style="background: ${getBlockColor(blockData)};"
                                    title="${time} - ${name}\n${title}"
                                  ></div>
                                `;
                              }).join('')}
                            </div>
                          `;
                        }).join('')}
                      </div>

                      <!-- PM éƒ¨åˆ†ï¼ˆ12-23ç‚¹ï¼Œå‘ä¸‹ï¼‰ -->
                      <div class="pixel-pm">
                        ${[12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23].map(hour => {
                          const hourData = stats.hours[hour] || { quarters: [null, null, null, null] };
                          return `
                            <div class="pixel-hour-group">
                              ${hourData.quarters.map((blockData, qIdx) => {
                                const minutes = qIdx * 15;
                                const displayHour = hour > 12 ? hour - 12 : hour;
                                const time = `${displayHour}:${minutes.toString().padStart(2, '0')} PM`;
                                if (!blockData) {
                                  return `<div class="pixel-block empty" title="${time} - ç©ºé—²"></div>`;
                                }
                                const name = getBlockName(blockData);
                                const title = blockData.title || name;
                                return `
                                  <div 
                                    class="pixel-block" 
                                    style="background: ${getBlockColor(blockData)};"
                                    title="${time} - ${name}\n${title}"
                                  ></div>
                                `;
                              }).join('')}
                            </div>
                          `;
                        }).join('')}
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `).join('')}
        </div>
          </div>

          <!-- ç»Ÿè®¡æ‘˜è¦ -->
          <div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #e9ecef; text-align: center; color: #666; font-size: 12px;">
            å…± ${sortedDays.length} å¤© | 
            æ€»æ—¶é•¿: ${formatDuration(sortedDays.reduce((sum, [_, s]) => sum + s.duration, 0))} |
            æ€»äº‹ä»¶: ${sortedDays.reduce((sum, [_, s]) => sum + s.count, 0)} ä¸ª
          </div>
        </div>
      `;

      document.getElementById('trendChart').innerHTML = html;
    }

    // æ¸²æŸ“æŠ˜çº¿å›¾è§†å›¾
    function renderLineChart(sortedDays) {
      const maxDuration = Math.max(...sortedDays.map(([_, s]) => s.duration), 1);
      const maxCount = Math.max(...sortedDays.map(([_, s]) => s.count), 1);
      
      const width = 800;
      const height = 300;
      const padding = { top: 20, right: 40, bottom: 40, left: 60 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      // è®¡ç®—ç‚¹çš„åæ ‡
      const points = sortedDays.map(([date, stats], idx) => {
        const x = padding.left + (idx / (sortedDays.length - 1)) * chartWidth;
        const y = padding.top + (1 - stats.duration / maxDuration) * chartHeight;
        return { x, y, date, stats };
      });

      // ç”Ÿæˆè·¯å¾„
      const linePath = points.map((p, i) => 
        `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
      ).join(' ');

      // ç”Ÿæˆå¡«å……åŒºåŸŸè·¯å¾„
      const areaPath = `
        M ${padding.left} ${height - padding.bottom}
        ${linePath.replace('M', 'L')}
        L ${padding.left + chartWidth} ${height - padding.bottom}
        Z
      `;

      const html = `
        <div class="line-chart">
          <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ“ˆ</span> æ—¶é•¿è¶‹åŠ¿å›¾
          </h3>
          <div style="position: relative;">
            <svg class="chart-svg" viewBox="0 0 ${width} ${height}">
              <!-- æ¸å˜å®šä¹‰ -->
              <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#667eea;stop-opacity:0.8" />
                  <stop offset="100%" style="stop-color:#764ba2;stop-opacity:0.2" />
                </linearGradient>
              </defs>
              
              <!-- ç½‘æ ¼çº¿ -->
              ${[0, 0.25, 0.5, 0.75, 1].map(ratio => `
                <line 
                  x1="${padding.left}" 
                  y1="${padding.top + ratio * chartHeight}" 
                  x2="${width - padding.right}" 
                  y2="${padding.top + ratio * chartHeight}" 
                  class="chart-grid"
                />
              `).join('')}
              
              <!-- å¡«å……åŒºåŸŸ -->
              <path d="${areaPath}" class="chart-area" />
              
              <!-- æŠ˜çº¿ -->
              <path d="${linePath}" class="chart-line" />
              
              <!-- æ•°æ®ç‚¹ -->
              ${points.map(p => `
                <circle 
                  cx="${p.x}" 
                  cy="${p.y}" 
                  r="4" 
                  class="chart-point"
                  data-date="${p.date}"
                  data-duration="${formatDuration(p.stats.duration)}"
                  data-count="${p.stats.count}"
                />
              `).join('')}
              
              <!-- Xè½´æ ‡ç­¾ -->
              ${points.map((p, i) => {
                if (sortedDays.length > 10 && i % Math.ceil(sortedDays.length / 7) !== 0) return '';
                return `
                  <text 
                    x="${p.x}" 
                    y="${height - padding.bottom + 20}" 
                    class="chart-label" 
                    text-anchor="middle"
                  >
                    ${p.date.substring(5)}
                  </text>
                `;
              }).join('')}
              
              <!-- Yè½´æ ‡ç­¾ -->
              ${[0, 0.5, 1].map(ratio => `
                <text 
                  x="${padding.left - 10}" 
                  y="${padding.top + (1 - ratio) * chartHeight}" 
                  class="chart-label" 
                  text-anchor="end"
                  dominant-baseline="middle"
                >
                  ${formatDuration(maxDuration * ratio)}
                </text>
              `).join('')}
            </svg>
            <div class="chart-tooltip" id="chartTooltip"></div>
          </div>
        </div>
      `;

      document.getElementById('trendChart').innerHTML = html;

      // æ·»åŠ æ‚¬åœäº¤äº’
      document.querySelectorAll('.chart-point').forEach(point => {
        point.addEventListener('mouseenter', (e) => {
          const tooltip = document.getElementById('chartTooltip');
          tooltip.style.display = 'block';
          tooltip.innerHTML = `
            <strong>${e.target.dataset.date}</strong><br/>
            æ—¶é•¿: ${e.target.dataset.duration}<br/>
            äº‹ä»¶: ${e.target.dataset.count} ä¸ª
          `;
        });
        
        point.addEventListener('mousemove', (e) => {
          const tooltip = document.getElementById('chartTooltip');
          tooltip.style.left = (e.pageX + 10) + 'px';
          tooltip.style.top = (e.pageY - 30) + 'px';
        });
        
        point.addEventListener('mouseleave', () => {
          document.getElementById('chartTooltip').style.display = 'none';
        });
      });
    }

    // åˆ‡æ¢ Tab
    window.switchTab = function(tab) {
      currentTab = tab;
      
      // æ›´æ–° tab æ ·å¼
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab:nth-child(${['tags', 'calendars', 'correlation', 'trends'].indexOf(tab) + 1})`).classList.add('active');
      
      // æ˜¾ç¤ºå¯¹åº”å†…å®¹
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      document.getElementById(`tab-${tab}`).style.display = 'block';
      
      // é‡æ–°æ¸²æŸ“
      loadStats();
    };

    // æ˜¾ç¤ºæ ‡ç­¾è¯¦æƒ…
    window.showTagDetail = function(tagId) {
      const events = allEvents.filter(e => e.tags && e.tags.includes(tagId));
      console.log(`ğŸ·ï¸ æ ‡ç­¾è¯¦æƒ…: ${tagId}`, {
        äº‹ä»¶æ•°: events.length,
        äº‹ä»¶åˆ—è¡¨: events.map(e => ({
          id: e.id,
          title: e.title?.simpleTitle,
          startTime: e.startTime,
          duration: formatDuration(getEventDuration(e))
        }))
      });
    };

    // æ˜¾ç¤ºæ—¥å†è¯¦æƒ…
    window.showCalendarDetail = function(calendarId) {
      const events = allEvents.filter(e => 
        (e.calendarIds && e.calendarIds.includes(calendarId)) ||
        (calendarId.startsWith('source:') && e.source === calendarId.replace('source:', ''))
      );
      console.log(`ğŸ“… æ—¥å†è¯¦æƒ…: ${calendarId}`, {
        äº‹ä»¶æ•°: events.length,
        äº‹ä»¶åˆ—è¡¨: events.map(e => ({
          id: e.id,
          title: e.title?.simpleTitle,
          startTime: e.startTime,
          duration: formatDuration(getEventDuration(e))
        }))
      });
    };

    // å¯åŠ¨
    init();
  </script>
</body>
</html>
