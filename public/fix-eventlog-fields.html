<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ğŸ”§ ä¿®å¤ EventLog ç¼ºå¤±å­—æ®µ</title>
  <style>
    body {
      font-family: system-ui;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: linear-gradient(to bottom, #fff, #f0f0f0);
    }
    button:hover { background: linear-gradient(to bottom, #f0f0f0, #e0e0e0); }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      max-height: 600px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-top: 20px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .info { background: #e3f2fd; color: #1565c0; }
    .success { background: #e8f5e9; color: #2e7d32; }
    .error { background: #ffebee; color: #c62828; }
    .warning { background: #fff3e0; color: #ef6c00; }
  </style>
</head>
<body>
  <h1>ğŸ”§ EventLog å­—æ®µä¿®å¤å·¥å…·</h1>
  
  <div class="status info">
    <p><strong>é—®é¢˜è¯Šæ–­</strong>ï¼šæ•°æ®åº“ä¸­çš„äº‹ä»¶ç¼ºå°‘ html/plainText å­—æ®µ</p>
    <p>æ¯æ¬¡è¯»å–äº‹ä»¶æ—¶éƒ½è¦ä» slateJson é‡æ–°ç”Ÿæˆï¼Œå¯¼è‡´ä¸¥é‡æ€§èƒ½é—®é¢˜ï¼š</p>
    <ul>
      <li>æ¯æ¬¡æŸ¥è¯¢ 1631 ä¸ªäº‹ä»¶è€—æ—¶ 27 ç§’</li>
      <li>Plan é¡µé¢æ‰“å¼€æ—¶è§¦å‘ 15+ æ¬¡é‡å¤æŸ¥è¯¢</li>
      <li>æ€»è€—æ—¶ 400+ ç§’ï¼Œå®Œå…¨å¡æ­»</li>
    </ul>
  </div>

  <div class="status warning">
    <p><strong>ä¿®å¤æ–¹æ¡ˆ</strong>ï¼šæ‰¹é‡ç”Ÿæˆå¹¶ä¿å­˜ html/plainText åˆ°æ•°æ®åº“</p>
    <p>é¢„è®¡è€—æ—¶ï¼š~30 ç§’ï¼ˆä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰äº‹ä»¶ï¼‰</p>
  </div>

  <button id="diagnoseBtn" onclick="diagnose()">1ï¸âƒ£ è¯Šæ–­é—®é¢˜</button>
  <button id="fixBtn" onclick="fixAllEvents()" disabled>2ï¸âƒ£ å¼€å§‹ä¿®å¤</button>
  <button onclick="verifyFix()" disabled id="verifyBtn">3ï¸âƒ£ éªŒè¯ä¿®å¤</button>

  <div id="log"></div>

  <script type="module">
    import { EventService } from '../src/services/EventService.js';
    import { jsonToSlateNodes, slateNodesToHtml } from '../src/utils/slate-to-html.js';
    
    window.EventService = EventService;
    window.jsonToSlateNodes = jsonToSlateNodes;
    window.slateNodesToHtml = slateNodesToHtml;

    let logEl;
    window.addEventListener('DOMContentLoaded', () => {
      logEl = document.getElementById('log');
      log('âœ… å·¥å…·å·²åŠ è½½ï¼Œè¯·ç‚¹å‡» "è¯Šæ–­é—®é¢˜" å¼€å§‹');
    });

    function log(msg, color = '#d4d4d4') {
      const time = new Date().toLocaleTimeString();
      logEl.innerHTML += `<span style="color: ${color}">[${time}] ${msg}</span>\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }

    window.diagnose = async function() {
      log('ğŸ“Š å¼€å§‹è¯Šæ–­...', '#4fc3f7');
      const diagnoseBtn = document.getElementById('diagnoseBtn');
      diagnoseBtn.disabled = true;

      try {
        const all = await EventService.getAllEvents();
        log(`âœ… è¯»å–äº‹ä»¶ï¼š${all.length} ä¸ª`, '#81c784');

        let missingCount = 0;
        let sampleEvents = [];

        for (const event of all) {
          const eventlog = event.eventlog;
          
          if (!eventlog || typeof eventlog !== 'object') continue;

          const missing = !eventlog.html || !eventlog.plainText;
          if (missing) {
            missingCount++;
            if (sampleEvents.length < 5) {
              sampleEvents.push({
                id: event.id.slice(-8),
                title: event.title?.simpleTitle || '(æ— æ ‡é¢˜)',
                hasSlateJson: !!eventlog.slateJson,
                hasHtml: !!eventlog.html,
                hasPlainText: !!eventlog.plainText
              });
            }
          }
        }

        log('\nğŸ“‹ è¯Šæ–­ç»“æœ:', '#ffb74d');
        log(`  æ€»äº‹ä»¶æ•°: ${all.length}`, '#fff');
        log(`  ç¼ºå¤±å­—æ®µ: ${missingCount} ä¸ª (${(missingCount/all.length*100).toFixed(1)}%)`, '#ff7043');
        
        if (missingCount > 0) {
          log('\nğŸ” ç¤ºä¾‹äº‹ä»¶ï¼ˆå‰5ä¸ªï¼‰:', '#ba68c8');
          sampleEvents.forEach(e => {
            log(`  - ${e.id}: ${e.title}`, '#fff');
            log(`    slateJson: ${e.hasSlateJson ? 'âœ…' : 'âŒ'}, html: ${e.hasHtml ? 'âœ…' : 'âŒ'}, plainText: ${e.hasPlainText ? 'âœ…' : 'âŒ'}`, '#9e9e9e');
          });

          log(`\nâš ï¸ å‘ç° ${missingCount} ä¸ªäº‹ä»¶éœ€è¦ä¿®å¤`, '#ff9800');
          document.getElementById('fixBtn').disabled = false;
        } else {
          log('\nâœ… æ‰€æœ‰äº‹ä»¶å­—æ®µå®Œæ•´ï¼Œæ— éœ€ä¿®å¤', '#4caf50');
        }

      } catch (err) {
        log(`\nâŒ è¯Šæ–­å¤±è´¥: ${err.message}`, '#f44336');
        console.error(err);
      } finally {
        diagnoseBtn.disabled = false;
      }
    };

    window.fixAllEvents = async function() {
      if (!confirm('ç¡®è®¤è¦ä¿®å¤æ‰€æœ‰ç¼ºå¤±å­—æ®µçš„äº‹ä»¶ï¼Ÿ\nè¿™ä¼šæ‰¹é‡æ›´æ–°æ•°æ®åº“ï¼Œé¢„è®¡è€—æ—¶ 30 ç§’ã€‚')) {
        return;
      }

      log('\nğŸ”§ å¼€å§‹æ‰¹é‡ä¿®å¤...', '#4fc3f7');
      const fixBtn = document.getElementById('fixBtn');
      fixBtn.disabled = true;

      const startTime = Date.now();
      let fixed = 0;
      let skipped = 0;
      let failed = 0;

      try {
        const all = await EventService.getAllEvents();
        log(`ğŸ“¥ åŠ è½½äº† ${all.length} ä¸ªäº‹ä»¶`, '#81c784');

        for (let i = 0; i < all.length; i++) {
          const event = all[i];
          const eventlog = event.eventlog;

          if (!eventlog || typeof eventlog !== 'object') {
            skipped++;
            continue;
          }

          const needsFix = !eventlog.html || !eventlog.plainText;
          if (!needsFix) {
            skipped++;
            continue;
          }

          try {
            // ä» slateJson ç”Ÿæˆ html å’Œ plainText
            const slateNodes = typeof eventlog.slateJson === 'string' 
              ? JSON.parse(eventlog.slateJson)
              : eventlog.slateJson;

            const nodes = jsonToSlateNodes(slateNodes);
            const html = slateNodesToHtml(nodes);
            const plainText = html.replace(/<[^>]*>/g, '');

            // æ›´æ–° eventlog
            const updatedEventlog = {
              ...eventlog,
              html: eventlog.html || html,
              plainText: eventlog.plainText || plainText
            };

            // é™é»˜æ›´æ–°åˆ°æ•°æ®åº“ï¼ˆä¸è§¦å‘ eventsUpdatedï¼‰
            await EventService.updateEvent(event.id, { eventlog: updatedEventlog }, false);

            fixed++;

            if (fixed % 100 === 0) {
              const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
              const speed = (fixed / (Date.now() - startTime) * 1000).toFixed(1);
              log(`  è¿›åº¦: ${fixed}/${all.length - skipped} (${speed} äº‹ä»¶/ç§’, å·²ç”¨ ${elapsed}s)`, '#90caf9');
            }

          } catch (err) {
            failed++;
            log(`  âŒ ä¿®å¤å¤±è´¥ [${event.id.slice(-8)}]: ${err.message}`, '#f44336');
          }
        }

        const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
        log(`\nâœ… ä¿®å¤å®Œæˆï¼`, '#4caf50');
        log(`  è€—æ—¶: ${totalTime} ç§’`, '#fff');
        log(`  å·²ä¿®å¤: ${fixed} ä¸ª`, '#81c784');
        log(`  å·²è·³è¿‡: ${skipped} ä¸ª (æ— éœ€ä¿®å¤)`, '#9e9e9e');
        if (failed > 0) {
          log(`  å¤±è´¥: ${failed} ä¸ª`, '#f44336');
        }

        document.getElementById('verifyBtn').disabled = false;

      } catch (err) {
        log(`\nâŒ ä¿®å¤å¤±è´¥: ${err.message}`, '#f44336');
        console.error(err);
      } finally {
        fixBtn.disabled = false;
      }
    };

    window.verifyFix = async function() {
      log('\nğŸ” éªŒè¯ä¿®å¤ç»“æœ...', '#4fc3f7');
      const verifyBtn = document.getElementById('verifyBtn');
      verifyBtn.disabled = true;

      try {
        const all = await EventService.getAllEvents();
        let stillMissing = 0;

        for (const event of all) {
          const eventlog = event.eventlog;
          if (!eventlog || typeof eventlog !== 'object') continue;

          if (!eventlog.html || !eventlog.plainText) {
            stillMissing++;
          }
        }

        if (stillMissing === 0) {
          log(`âœ… éªŒè¯é€šè¿‡ï¼æ‰€æœ‰äº‹ä»¶å­—æ®µå®Œæ•´`, '#4caf50');
          log(`\nğŸ‰ ç°åœ¨å¯ä»¥å…³é—­æ­¤é¡µé¢ï¼Œåˆ·æ–° Plan é¡µé¢æµ‹è¯•æ€§èƒ½`, '#4fc3f7');
        } else {
          log(`âš ï¸ ä»æœ‰ ${stillMissing} ä¸ªäº‹ä»¶ç¼ºå°‘å­—æ®µ`, '#ff9800');
        }

      } catch (err) {
        log(`âŒ éªŒè¯å¤±è´¥: ${err.message}`, '#f44336');
        console.error(err);
      } finally {
        verifyBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
