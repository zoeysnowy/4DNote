<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CompleteMeta V2 - ä¸‰å±‚å®¹é”™åŒ¹é…</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #1976d2;
      border-bottom: 3px solid #1976d2;
      padding-bottom: 10px;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      color: #424242;
      margin-top: 0;
    }
    .two-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .column {
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #616161;
    }
    textarea {
      width: 100%;
      min-height: 250px;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      resize: vertical;
    }
    .html-preview {
      border: 1px solid #e0e0e0;
      padding: 15px;
      background: #fafafa;
      min-height: 250px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      word-break: break-all;
    }
    .meta-display {
      background: #fff3e0;
      border: 1px solid #ff9800;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
    }
    .diff-result {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 11px;
    }
    .diff-item {
      padding: 8px;
      margin: 5px 0;
      border-radius: 3px;
      border-left: 4px solid transparent;
    }
    .diff-match {
      background: #c8e6c9;
      border-left-color: #4caf50;
    }
    .diff-insert {
      background: #fff9c4;
      border-left-color: #ffc107;
    }
    .diff-delete {
      background: #ffcdd2;
      border-left-color: #f44336;
    }
    .diff-sandwich {
      background: #e1bee7;
      border-left-color: #9c27b0;
    }
    .diff-fuzzy {
      background: #b3e5fc;
      border-left-color: #03a9f4;
    }
    button {
      padding: 10px 20px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #1565c0;
    }
    button:active {
      background: #0d47a1;
    }
    .scenario-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    .scenario-buttons button {
      background: #673ab7;
    }
    .scenario-buttons button:hover {
      background: #5e35b1;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
    }
    .info-box h3 {
      margin-top: 0;
      color: #1976d2;
    }
    .info-box.success {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    .info-box.success h3 {
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <h1>ğŸš€ CompleteMeta V2 - ä¸‰å±‚å®¹é”™åŒ¹é…ç®—æ³•</h1>
  
  <div class="info-box success">
    <h3>ğŸ¯ V2 æ ¸å¿ƒæ”¹è¿›ï¼ˆåŸºäºGeminiå»ºè®®ï¼‰</h3>
    <ul>
      <li><strong>å¢å¼ºhintç»“æ„</strong>ï¼šä¸å†åªå­˜å‰10å­—ç¬¦ï¼Œæ”¹ä¸º <code>{ s: "å¼€å¤´5å­—", e: "ç»“å°¾5å­—", l: é•¿åº¦ }</code></li>
      <li><strong>ä¸‰å±‚å®¹é”™åŒ¹é…</strong>ï¼š
        <ol>
          <li><strong>ç¬¬ä¸€å±‚ï¼šç²¾ç¡®é”šå®š</strong> - åŒ¹é…å®Œå…¨ç›¸åŒçš„æ®µè½ä½œä¸º"é”šç‚¹"</li>
          <li><strong>ç¬¬äºŒå±‚ï¼šä¸‰æ˜æ²»æ¨å¯¼</strong> - åˆ©ç”¨é”šç‚¹ä¹‹é—´çš„æ‹“æ‰‘å…³ç³»ï¼Œæ¨æ–­è¢«ä¿®æ”¹çš„æ®µè½ID</li>
          <li><strong>ç¬¬ä¸‰å±‚ï¼šæ¨¡ç³Šæ‰“åˆ†</strong> - å¯¹æ— æ³•æ¨å¯¼çš„æ®µè½ï¼Œç”¨å¼€å¤´+ç»“å°¾+é•¿åº¦ç»¼åˆæ‰“åˆ†</li>
        </ol>
      </li>
      <li><strong>æŠ—ä¿®æ”¹èƒ½åŠ›æå‡</strong>ï¼šå³ä½¿ç”¨æˆ·æŠŠ "ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦" æ”¹æˆ "ä»Šå¤©ä¸‹åˆè®¨è®ºé¡¹ç›®è¿›åº¦"ï¼Œåªè¦å‰åæ®µè½æœªå˜ï¼Œä»èƒ½ä¿ç•™ID</li>
    </ul>
  </div>

  <!-- æµ‹è¯•åœºæ™¯ -->
  <div class="test-section">
    <h2>æ­¥éª¤1ï¸âƒ£ï¼šåºåˆ—åŒ–Eventåˆ°HTMLï¼ˆå¢å¼ºhintï¼‰</h2>
    
    <div class="scenario-buttons">
      <button onclick="loadScenario('simple')">ç®€å•äº‹ä»¶</button>
      <button onclick="loadScenario('complex')">å¤æ‚äº‹ä»¶</button>
    </div>

    <div class="two-columns">
      <div class="column">
        <label>è¾“å…¥Event JSONï¼š</label>
        <textarea id="eventInput"></textarea>
        <button onclick="serializeEvent()" style="margin-top: 10px;">ğŸ”„ åºåˆ—åŒ–ï¼ˆV2å¢å¼ºhintï¼‰</button>
      </div>
      
      <div class="column">
        <label>ç”Ÿæˆçš„HTMLï¼ˆå¸¦å¢å¼ºMetaï¼‰ï¼š</label>
        <div class="html-preview" id="htmlOutput"></div>
      </div>
    </div>

    <div>
      <label>è§£ç çš„Meta JSONï¼ˆæ³¨æ„hintç»“æ„å˜åŒ–ï¼‰ï¼š</label>
      <div class="meta-display" id="metaDisplay"></div>
      <div style="background: #e8f5e9; border: 1px solid #4caf50; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 12px;">
        <strong>ğŸ’¡ V2æ”¹è¿›ï¼š</strong>hintä»å•ä¸€å‰ç¼€æ”¹ä¸ºä¸‰å…ƒç»„ <code>{s, e, l}</code><br>
        â€¢ <strong>s</strong>: start - å‰5ä¸ªå­—ç¬¦<br>
        â€¢ <strong>e</strong>: end - å5ä¸ªå­—ç¬¦<br>
        â€¢ <strong>l</strong>: length - æ€»é•¿åº¦<br>
        è¿™æ ·å³ä½¿å¼€å¤´è¢«ä¿®æ”¹ï¼Œä»èƒ½é€šè¿‡ç»“å°¾å’Œé•¿åº¦åˆ¤æ–­ç›¸ä¼¼åº¦ã€‚
      </div>
    </div>
  </div>

  <!-- æ¨¡æ‹Ÿç¼–è¾‘ -->
  <div class="test-section">
    <h2>æ­¥éª¤2ï¸âƒ£ï¼šæ¨¡æ‹ŸOutlookç¼–è¾‘ï¼ˆæç«¯åœºæ™¯ï¼‰</h2>
    
    <div class="scenario-buttons">
      <button onclick="simulateEdit('modifyStart')">âœï¸ ä¿®æ”¹å¼€å¤´ï¼ˆV1å¤±è´¥ï¼‰</button>
      <button onclick="simulateEdit('modifyMiddle')">âœï¸ ä¿®æ”¹ä¸­é—´æ®µè½</button>
      <button onclick="simulateEdit('addAndModify')">â• æ–°å¢+ä¿®æ”¹</button>
      <button onclick="simulateEdit('deleteAndModify')">â– åˆ é™¤+ä¿®æ”¹</button>
    </div>

    <div class="two-columns">
      <div class="column">
        <label>åŸå§‹HTMLï¼š</label>
        <textarea id="originalHtml" readonly></textarea>
      </div>
      
      <div class="column">
        <label>ç¼–è¾‘åHTMLï¼š</label>
        <textarea id="editedHtml"></textarea>
      </div>
    </div>
  </div>

  <!-- Diffå¯¹é½ -->
  <div class="test-section">
    <h2>æ­¥éª¤3ï¸âƒ£ï¼šä¸‰å±‚å®¹é”™åŒ¹é…ï¼ˆDiffå¯¹é½ï¼‰</h2>
    
    <button onclick="deserializeHtml()">ğŸ” è¿è¡Œä¸‰å±‚åŒ¹é…ç®—æ³•</button>

    <div style="margin-top: 20px;">
      <label>Diffå¯¹é½ç»“æœï¼ˆæ˜¾ç¤ºåŒ¹é…ç­–ç•¥ï¼‰ï¼š</label>
      <div class="diff-result" id="diffResult"></div>
      
      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px;">
        <div style="background: #c8e6c9; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">
          <div style="font-weight: bold;" id="layer1Count">0</div>
          <div>ç¬¬ä¸€å±‚ï¼šç²¾ç¡®é”šå®š</div>
        </div>
        <div style="background: #e1bee7; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">
          <div style="font-weight: bold;" id="layer2Count">0</div>
          <div>ç¬¬äºŒå±‚ï¼šä¸‰æ˜æ²»</div>
        </div>
        <div style="background: #b3e5fc; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">
          <div style="font-weight: bold;" id="layer3Count">0</div>
          <div>ç¬¬ä¸‰å±‚ï¼šæ¨¡ç³Šæ‰“åˆ†</div>
        </div>
        <div style="background: #fff9c4; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">
          <div style="font-weight: bold;" id="insertCount">0</div>
          <div>æ–°å¢æ®µè½</div>
        </div>
        <div style="background: #ffcdd2; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px;">
          <div style="font-weight: bold;" id="deleteCount">0</div>
          <div>åˆ é™¤æ®µè½</div>
        </div>
      </div>
    </div>

    <div style="margin-top: 20px;">
      <label>æ¢å¤çš„Event JSONï¼š</label>
      <textarea id="restoredEvent" readonly style="min-height: 200px;"></textarea>
    </div>
  </div>

  <script>
    // ==================== æµ‹è¯•æ•°æ® ====================
    
    const scenarios = {
      simple: {
        id: 'evt_simple_001',
        eventlog: {
          slateJson: JSON.stringify([
            { id: 'p-001', type: 'paragraph', children: [{ text: 'ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦' }] },
            { id: 'p-002', type: 'paragraph', children: [{ text: 'ç¡®è®¤ä¸‹å‘¨çš„äº¤ä»˜æ—¶é—´' }] },
            { id: 'p-003', type: 'paragraph', children: [{ text: 'åˆ†é…å…·ä½“ä»»åŠ¡ç»™å›¢é˜Ÿæˆå‘˜' }] }
          ])
        },
        createdAt: '2025-12-19 10:00:00',
        updatedAt: '2025-12-19 10:30:00'
      },
      
      complex: {
        id: 'evt_complex_001',
        eventlog: {
          slateJson: JSON.stringify([
            { id: 'p-001', type: 'paragraph', children: [{ text: 'è¿™æ˜¯ç¬¬ä¸€æ®µï¼Œä¿æŒä¸å˜çš„é”šç‚¹æ®µè½' }] },
            { id: 'p-002', type: 'paragraph', children: [{ text: 'è¿™æ˜¯ç¬¬äºŒæ®µï¼Œä¼šè¢«å¤§å¹…ä¿®æ”¹' }] },
            { id: 'p-003', type: 'paragraph', children: [{ text: 'è¿™æ˜¯ç¬¬ä¸‰æ®µï¼Œä¹Ÿæ˜¯é”šç‚¹' }] },
            { id: 'p-004', type: 'paragraph', children: [{ text: 'ç¬¬å››æ®µå¤¹åœ¨ä¸¤ä¸ªé”šç‚¹ä¹‹é—´' }] },
            { id: 'p-005', type: 'paragraph', children: [{ text: 'æœ€åä¸€æ®µï¼Œä¿æŒä¸å˜' }] }
          ])
        },
        createdAt: '2025-12-19 09:00:00',
        updatedAt: '2025-12-19 09:45:00'
      }
    };

    // ==================== å·¥å…·å‡½æ•° ====================
    
    function extractText(node) {
      if (!node.children) return '';
      return node.children.map(child => {
        if (child.text) return child.text;
        if (child.children) return extractText(child);
        return '';
      }).join('');
    }

    function generateNodeId() {
      return 'node_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // ==================== V2å¢å¼ºï¼šç”Ÿæˆhintä¸‰å…ƒç»„ ====================
    
    function generateEnhancedHint(text) {
      const len = text.length;
      if (len === 0) return { s: '', e: '', l: 0 };
      
      const start = text.substring(0, Math.min(5, len));
      const end = len > 5 ? text.substring(len - 5) : text;
      
      return {
        s: start,    // start: å‰5å­—ç¬¦
        e: end,      // end: å5å­—ç¬¦
        l: len       // length: æ€»é•¿åº¦
      };
    }

    // ==================== åºåˆ—åŒ–ï¼ˆV2å¢å¼ºï¼‰====================
    
    function serializeEvent() {
      const input = document.getElementById('eventInput').value;
      if (!input.trim()) {
        alert('è¯·è¾“å…¥Event JSON');
        return;
      }

      try {
        const event = JSON.parse(input);
        const nodes = JSON.parse(event.eventlog.slateJson);

        // ç”ŸæˆV2å¢å¼ºMeta
        const meta = {
          v: 2,  // ç‰ˆæœ¬å·å‡çº§åˆ°2
          id: event.id,
          slate: {
            nodes: nodes.map(node => {
              const textContent = extractText(node);
              const hint = generateEnhancedHint(textContent);  // V2å¢å¼ºhint
              
              const metaNode = {};
              if (node.id) metaNode.id = node.id;
              if (hint.s) metaNode.s = hint.s;  // start
              if (hint.e) metaNode.e = hint.e;  // end
              if (hint.l) metaNode.l = hint.l;  // length
              if (node.createdAt) metaNode.ts = node.createdAt;
              if (node.updatedAt) metaNode.ut = node.updatedAt;
              if (node.level !== undefined) metaNode.lvl = node.level;
              if (node.bulletLevel !== undefined) metaNode.bullet = node.bulletLevel;
              if (node.mention) metaNode.mention = node.mention;
              
              return metaNode;
            })
          },
          signature: {
            createdAt: event.createdAt,
            updatedAt: event.updatedAt,
            fourDNoteSource: event.fourDNoteSource ?? true,
            source: event.source || 'local',
            lastModifiedSource: event.lastModifiedSource || '4dnote'
          }
        };

        // Base64ç¼–ç 
        const metaJson = JSON.stringify(meta, null, 2);
        const metaBase64 = btoa(unescape(encodeURIComponent(metaJson)));

        // ç”ŸæˆHTML
        const visibleHtml = slateNodesToHtml(nodes);
        const fullHtml = `<div class="4dnote-content-wrapper" data-4dnote-version="2">
  ${visibleHtml}
  
  <!-- Meta Data Zone (V2) -->
  <div id="4dnote-meta" style="display:none;">
    ${metaBase64}
  </div>
</div>`;

        document.getElementById('htmlOutput').textContent = fullHtml;
        document.getElementById('metaDisplay').textContent = metaJson;
        document.getElementById('originalHtml').value = fullHtml;

      } catch (err) {
        alert('JSONè§£æé”™è¯¯ï¼š' + err.message);
        console.error(err);
      }
    }

    function slateNodesToHtml(nodes) {
      return nodes.map(node => {
        const text = extractText(node);
        return `<p>${text}</p>`;
      }).join('\n  ');
    }

    // ==================== åŠ è½½åœºæ™¯ ====================
    
    function loadScenario(name) {
      const event = scenarios[name];
      document.getElementById('eventInput').value = JSON.stringify(event, null, 2);
    }

    // ==================== æ¨¡æ‹Ÿç¼–è¾‘ ====================
    
    function simulateEdit(action) {
      const html = document.getElementById('originalHtml').value;
      if (!html.trim()) {
        alert('è¯·å…ˆåœ¨æ­¥éª¤1ç”ŸæˆHTML');
        return;
      }

      let edited = html;
      const paragraphs = html.match(/<p>(.*?)<\/p>/g) || [];

      switch (action) {
        case 'modifyStart':
          // V1ä¼šå¤±è´¥çš„åœºæ™¯ï¼šä¿®æ”¹å¼€å¤´
          edited = html.replace(/<p>ä¼šè®®å¼€å§‹æ—¶è®¨è®ºé¡¹ç›®è¿›åº¦<\/p>/, 
                               '<p>ä»Šå¤©ä¸‹åˆè®¨è®ºé¡¹ç›®è¿›åº¦å’Œå®‰æ’</p>');
          alert('âœ… V2èƒ½å¤„ç†ï¼\nç¬¬ä¸€æ®µå’Œç¬¬ä¸‰æ®µä½œä¸ºé”šç‚¹ï¼Œç¬¬äºŒæ®µé€šè¿‡"ä¸‰æ˜æ²»æ¨å¯¼"ä»èƒ½ä¿ç•™ID');
          break;

        case 'modifyMiddle':
          // ä¿®æ”¹complexåœºæ™¯çš„ä¸­é—´æ®µè½
          edited = html.replace(/<p>è¿™æ˜¯ç¬¬äºŒæ®µï¼Œä¼šè¢«å¤§å¹…ä¿®æ”¹<\/p>/, 
                               '<p>å®Œå…¨ä¸åŒçš„å†…å®¹è¢«å†™åœ¨è¿™é‡Œ</p>');
          edited = edited.replace(/<p>ç¬¬å››æ®µå¤¹åœ¨ä¸¤ä¸ªé”šç‚¹ä¹‹é—´<\/p>/, 
                                 '<p>ç¬¬å››æ®µä¹Ÿæ”¹äº†</p>');
          break;

        case 'addAndModify':
          // æ–°å¢+ä¿®æ”¹
          edited = html.replace(/<p>(.*?)<\/p>/, '<p>$1</p>\n  <p>ã€æ–°å¢ã€‘æ’å…¥çš„æ®µè½</p>');
          edited = edited.replace(/<p>ç¡®è®¤ä¸‹å‘¨çš„äº¤ä»˜æ—¶é—´<\/p>/, '<p>ç¡®è®¤æœ¬æœˆåº•äº¤ä»˜</p>');
          break;

        case 'deleteAndModify':
          // åˆ é™¤ç¬¬ä¸€æ®µ+ä¿®æ”¹ç¬¬äºŒæ®µ
          edited = html.replace(/<p>.*?<\/p>\n\s*/, '');
          const remaining = edited.match(/<p>(.*?)<\/p>/);
          if (remaining) {
            edited = edited.replace(/<p>(.*?)<\/p>/, '<p>è¿™æ®µè¢«ä¿®æ”¹äº†</p>');
          }
          break;
      }

      document.getElementById('editedHtml').value = edited;
    }

    // ==================== ä¸‰å±‚å®¹é”™åŒ¹é…ç®—æ³• ====================
    
    function deserializeHtml() {
      const html = document.getElementById('editedHtml').value || document.getElementById('originalHtml').value;
      if (!html.trim()) {
        alert('è¯·è¾“å…¥HTML');
        return;
      }

      try {
        // æå–Meta - æ”¹è¿›æ­£åˆ™è¡¨è¾¾å¼ï¼Œé¿å…è´ªå©ªåŒ¹é…
        const metaMatch = html.match(/<div id="4dnote-meta"[^>]*>([\s\S]*?)<\/div>/);
        if (!metaMatch) {
          alert('æœªæ‰¾åˆ°Metaæ•°æ®\nè¯·å…ˆç‚¹å‡»"åºåˆ—åŒ–ï¼ˆV2å¢å¼ºhintï¼‰"æŒ‰é’®ç”ŸæˆHTML');
          console.error('HTMLå†…å®¹:', html.substring(0, 200));
          return;
        }

        const metaBase64 = metaMatch[1].trim();
        console.log('Meta Base64 (å‰50å­—ç¬¦):', metaBase64.substring(0, 50));
        console.log('Meta Base64 (å‰50å­—ç¬¦):', metaBase64.substring(0, 50));
        
        const metaJson = decodeURIComponent(escape(atob(metaBase64)));
        const meta = JSON.parse(metaJson);
        console.log('è§£æçš„Meta:', meta);

        // æå–HTMLæ®µè½ - æ”¹è¿›ï¼šå…ˆç§»é™¤Meta divå†æå–
        const htmlWithoutMeta = html.replace(/<div id="4dnote-meta"[\s\S]*?<\/div>/, '');
        const htmlParagraphs = Array.from(htmlWithoutMeta.matchAll(/<p>(.*?)<\/p>/g)).map(m => ({
          text: m[1],
          fullText: m[1]
        }));
        
        console.log('æå–çš„HTMLæ®µè½æ•°:', htmlParagraphs.length);
        console.log('MetaèŠ‚ç‚¹æ•°:', meta.slate?.nodes?.length || 0);

        // è¿è¡Œä¸‰å±‚åŒ¹é…
        const result = threeLayerMatch(meta.slate.nodes, htmlParagraphs);

        // æ˜¾ç¤ºç»“æœ
        displayDiffResults(result);
        
        // æ„é€ æ¢å¤çš„Event
        const restoredNodes = result.alignedNodes.map(item => ({
          id: item.id,
          type: 'paragraph',
          children: [{ text: item.text }],
          ...(item.createdAt && { createdAt: item.createdAt }),
          ...(item.updatedAt && { updatedAt: item.updatedAt })
        }));

        const restoredEvent = {
          id: meta.id,
          eventlog: {
            slateJson: JSON.stringify(restoredNodes, null, 2)
          },
          ...meta.signature
        };

        document.getElementById('restoredEvent').value = JSON.stringify(restoredEvent, null, 2);

        // ç»Ÿè®¡
        document.getElementById('layer1Count').textContent = result.stats.layer1;
        document.getElementById('layer2Count').textContent = result.stats.layer2;
        document.getElementById('layer3Count').textContent = result.stats.layer3;
        document.getElementById('insertCount').textContent = result.stats.insert;
        document.getElementById('deleteCount').textContent = result.stats.delete;

      } catch (err) {
        alert('ååºåˆ—åŒ–é”™è¯¯ï¼š' + err.message);
        console.error(err);
      }
    }

    // ==================== æ ¸å¿ƒï¼šä¸‰å±‚å®¹é”™åŒ¹é… ====================
    
    function threeLayerMatch(metaNodes, htmlParagraphs) {
      const results = [];
      const stats = { layer1: 0, layer2: 0, layer3: 0, insert: 0, delete: 0 };
      
      const metaUsed = new Array(metaNodes.length).fill(false);
      const htmlUsed = new Array(htmlParagraphs.length).fill(false);

      // ===== ç¬¬ä¸€å±‚ï¼šç²¾ç¡®é”šå®š (Exact Anchor) =====
      console.log('=== ç¬¬ä¸€å±‚ï¼šç²¾ç¡®é”šå®š ===');
      for (let h = 0; h < htmlParagraphs.length; h++) {
        for (let m = 0; m < metaNodes.length; m++) {
          if (metaUsed[m] || htmlUsed[h]) continue;
          
          if (isExactMatch(metaNodes[m], htmlParagraphs[h].text)) {
            results.push({
              type: 'layer1',
              metaIndex: m,
              htmlIndex: h,
              id: metaNodes[m].id,
              text: htmlParagraphs[h].text,
              matchStrategy: 'ç¬¬ä¸€å±‚ï¼šç²¾ç¡®é”šå®š'
            });
            metaUsed[m] = true;
            htmlUsed[h] = true;
            stats.layer1++;
            console.log(`ç²¾ç¡®åŒ¹é…: Meta[${m}] <-> HTML[${h}]`, htmlParagraphs[h].text.substring(0, 20));
            break;
          }
        }
      }

      // ===== ç¬¬äºŒå±‚ï¼šä¸‰æ˜æ²»æ¨å¯¼ (Sandwich Inference) =====
      console.log('=== ç¬¬äºŒå±‚ï¼šä¸‰æ˜æ²»æ¨å¯¼ ===');
      for (let h = 0; h < htmlParagraphs.length; h++) {
        if (htmlUsed[h]) continue;

        // æ‰¾åˆ°å‰åæœ€è¿‘çš„é”šç‚¹
        const prevAnchor = findPreviousAnchor(results, h);
        const nextAnchor = findNextAnchor(results, h);

        if (prevAnchor !== null && nextAnchor !== null) {
          // è®¡ç®—HTML gap
          const htmlGapSize = nextAnchor.htmlIndex - prevAnchor.htmlIndex - 1;
          const htmlUnusedInGap = countUnusedInRange(htmlUsed, prevAnchor.htmlIndex + 1, nextAnchor.htmlIndex);

          // è®¡ç®—Meta gap
          const metaGapSize = nextAnchor.metaIndex - prevAnchor.metaIndex - 1;
          const metaUnusedInGap = countUnusedInRange(metaUsed, prevAnchor.metaIndex + 1, nextAnchor.metaIndex);

          console.log(`ä¸‰æ˜æ²»åŒºé—´: HTML[${prevAnchor.htmlIndex}]-[${nextAnchor.htmlIndex}], Meta[${prevAnchor.metaIndex}]-[${nextAnchor.metaIndex}]`);
          console.log(`  HTML gapæœªä½¿ç”¨: ${htmlUnusedInGap}, Meta gapæœªä½¿ç”¨: ${metaUnusedInGap}`);

          // å¦‚æœgapç›¸ç­‰ï¼Œå¯ä»¥ä¸€å¯¹ä¸€æ¨å¯¼
          if (htmlUnusedInGap === metaUnusedInGap && htmlUnusedInGap === 1) {
            // æ‰¾åˆ°Meta gapä¸­æœªä½¿ç”¨çš„èŠ‚ç‚¹
            for (let m = prevAnchor.metaIndex + 1; m < nextAnchor.metaIndex; m++) {
              if (!metaUsed[m]) {
                results.push({
                  type: 'layer2',
                  metaIndex: m,
                  htmlIndex: h,
                  id: metaNodes[m].id,
                  text: htmlParagraphs[h].text,
                  matchStrategy: 'ç¬¬äºŒå±‚ï¼šä¸‰æ˜æ²»æ¨å¯¼ï¼ˆæ‹“æ‰‘ä½ç½®ï¼‰',
                  sandwichInfo: `å¤¹åœ¨é”šç‚¹[${prevAnchor.metaIndex}]å’Œ[${nextAnchor.metaIndex}]ä¹‹é—´`
                });
                metaUsed[m] = true;
                htmlUsed[h] = true;
                stats.layer2++;
                console.log(`ä¸‰æ˜æ²»æ¨å¯¼æˆåŠŸ: Meta[${m}] <-> HTML[${h}]`, htmlParagraphs[h].text.substring(0, 20));
                break;
              }
            }
          }
        }
      }

      // ===== ç¬¬ä¸‰å±‚ï¼šæ¨¡ç³Šæ‰“åˆ† (Fuzzy Scoring) - æ”¹è¿›ï¼šå…¨å±€æœ€ä¼˜åŒ¹é… =====
      console.log('=== ç¬¬ä¸‰å±‚ï¼šæ¨¡ç³Šæ‰“åˆ†ï¼ˆå…¨å±€æœ€ä¼˜ï¼‰ ===');
      
      // 1. æ„å»ºæ‰€æœ‰å¯èƒ½çš„é…å¯¹åŠå…¶å¾—åˆ†
      const candidates = [];
      for (let h = 0; h < htmlParagraphs.length; h++) {
        if (htmlUsed[h]) continue;

        for (let m = 0; m < metaNodes.length; m++) {
          if (metaUsed[m]) continue;

          const score = calculateFuzzyScore(metaNodes[m], htmlParagraphs[h].text);
          if (score >= 50) {  // åªè€ƒè™‘è¶…è¿‡é˜ˆå€¼çš„é…å¯¹
            candidates.push({
              score,
              metaIndex: m,
              htmlIndex: h,
              metaNode: metaNodes[m],
              htmlText: htmlParagraphs[h].text
            });
          }
        }
      }

      // 2. æŒ‰åˆ†æ•°ä»é«˜åˆ°ä½æ’åº
      candidates.sort((a, b) => b.score - a.score);

      // 3. è´ªå¿ƒç®—æ³•ï¼šä¼˜å…ˆåŒ¹é…é«˜åˆ†çš„é…å¯¹
      for (const candidate of candidates) {
        const { score, metaIndex, htmlIndex, htmlText } = candidate;
        
        // æ£€æŸ¥æ˜¯å¦å·²è¢«ä½¿ç”¨
        if (metaUsed[metaIndex] || htmlUsed[htmlIndex]) continue;

        results.push({
          type: 'layer3',
          metaIndex,
          htmlIndex,
          id: metaNodes[metaIndex].id,
          text: htmlText,
          matchStrategy: `ç¬¬ä¸‰å±‚ï¼šæ¨¡ç³Šæ‰“åˆ†ï¼ˆ${score}åˆ†ï¼‰`
        });
        metaUsed[metaIndex] = true;
        htmlUsed[htmlIndex] = true;
        stats.layer3++;
        console.log(`æ¨¡ç³ŠåŒ¹é…: Meta[${metaIndex}] <-> HTML[${htmlIndex}], å¾—åˆ†=${score}`, htmlText.substring(0, 20));
      }

      // ===== å¤„ç†æ–°å¢å’Œåˆ é™¤ =====
      for (let h = 0; h < htmlParagraphs.length; h++) {
        if (!htmlUsed[h]) {
          results.push({
            type: 'insert',
            htmlIndex: h,
            id: generateNodeId(),
            text: htmlParagraphs[h].text,
            matchStrategy: 'æ–°å¢æ®µè½'
          });
          stats.insert++;
          console.log(`æ–°å¢æ®µè½: HTML[${h}]`, htmlParagraphs[h].text.substring(0, 20));
        }
      }

      for (let m = 0; m < metaNodes.length; m++) {
        if (!metaUsed[m]) {
          results.push({
            type: 'delete',
            metaIndex: m,
            id: metaNodes[m].id,
            matchStrategy: 'åˆ é™¤æ®µè½',
            deletedHint: `${metaNodes[m].s}...${metaNodes[m].e} (é•¿åº¦${metaNodes[m].l})`
          });
          stats.delete++;
          console.log(`åˆ é™¤æ®µè½: Meta[${m}]`, metaNodes[m].s);
        }
      }

      // æŒ‰HTMLé¡ºåºæ’åº
      results.sort((a, b) => (a.htmlIndex ?? 9999) - (b.htmlIndex ?? 9999));

      return {
        alignedNodes: results.filter(r => r.type !== 'delete'),
        allResults: results,
        stats
      };
    }

    // ==================== è¾…åŠ©å‡½æ•° ====================
    
    function isExactMatch(metaNode, htmlText) {
      const start = htmlText.substring(0, Math.min(5, htmlText.length));
      const end = htmlText.length > 5 ? htmlText.substring(htmlText.length - 5) : htmlText;
      
      return metaNode.s === start && metaNode.e === end && metaNode.l === htmlText.length;
    }

    function findPreviousAnchor(results, htmlIndex) {
      for (let i = results.length - 1; i >= 0; i--) {
        if ((results[i].type === 'layer1' || results[i].type === 'layer2') && results[i].htmlIndex < htmlIndex) {
          return results[i];
        }
      }
      return null;
    }

    function findNextAnchor(results, htmlIndex) {
      for (let i = 0; i < results.length; i++) {
        if ((results[i].type === 'layer1' || results[i].type === 'layer2') && results[i].htmlIndex > htmlIndex) {
          return results[i];
        }
      }
      return null;
    }

    function countUnusedInRange(usedArray, start, end) {
      let count = 0;
      for (let i = start; i < end; i++) {
        if (!usedArray[i]) count++;
      }
      return count;
    }

    function calculateFuzzyScore(metaNode, htmlText) {
      let score = 0;

      const htmlStart = htmlText.substring(0, Math.min(5, htmlText.length));
      const htmlEnd = htmlText.length > 5 ? htmlText.substring(htmlText.length - 5) : htmlText;
      const htmlLen = htmlText.length;

      // å¼€å¤´åŒ¹é…ï¼š+40åˆ†
      if (metaNode.s === htmlStart) {
        score += 40;
      } else {
        // éƒ¨åˆ†åŒ¹é…
        const startSimilarity = stringSimilarity(metaNode.s, htmlStart);
        score += startSimilarity * 40;
      }

      // ç»“å°¾åŒ¹é…ï¼š+40åˆ†
      if (metaNode.e === htmlEnd) {
        score += 40;
      } else {
        const endSimilarity = stringSimilarity(metaNode.e, htmlEnd);
        score += endSimilarity * 40;
      }

      // é•¿åº¦ç›¸ä¼¼ï¼š+20åˆ†
      const lengthDiff = Math.abs(metaNode.l - htmlLen);
      const lengthRatio = 1 - (lengthDiff / Math.max(metaNode.l, htmlLen));
      if (lengthRatio > 0.8) {
        score += 20;
      } else if (lengthRatio > 0.5) {
        score += 10;
      }

      return score;
    }

    function stringSimilarity(a, b) {
      const minLen = Math.min(a.length, b.length);
      if (minLen === 0) return 0;
      
      let matches = 0;
      for (let i = 0; i < minLen; i++) {
        if (a[i] === b[i]) matches++;
      }
      return matches / minLen;
    }

    // ==================== æ˜¾ç¤ºç»“æœ ====================
    
    function displayDiffResults(result) {
      const container = document.getElementById('diffResult');
      container.innerHTML = result.allResults.map(r => {
        let className = 'diff-item ';
        let icon = '';
        
        if (r.type === 'layer1') {
          className += 'diff-match';
          icon = 'ğŸ¯';
        } else if (r.type === 'layer2') {
          className += 'diff-sandwich';
          icon = 'ğŸ¥ª';
        } else if (r.type === 'layer3') {
          className += 'diff-fuzzy';
          icon = 'ğŸ”';
        } else if (r.type === 'insert') {
          className += 'diff-insert';
          icon = 'â•';
        } else if (r.type === 'delete') {
          className += 'diff-delete';
          icon = 'â–';
        }

        const text = r.text || r.deletedHint || '';
        const displayText = text.length > 50 ? text.substring(0, 50) + '...' : text;
        
        return `<div class="${className}">
          ${icon} <strong>${r.matchStrategy}</strong><br>
          ${r.type !== 'delete' ? 'HTML: ' + displayText : 'å·²åˆ é™¤: ' + displayText}<br>
          <span style="color: #666; font-size: 10px;">ID: ${r.id}${r.sandwichInfo ? ' | ' + r.sandwichInfo : ''}</span>
        </div>`;
      }).join('');
    }

    // ==================== åˆå§‹åŒ– ====================
    
    window.addEventListener('DOMContentLoaded', () => {
      loadScenario('simple');
    });
  </script>
</body>
</html>
