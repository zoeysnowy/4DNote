<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Outlook è§„èŒƒåŒ–æµ‹è¯• - P0 ä¼˜åŒ–éªŒè¯</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .test-section {
      margin-bottom: 40px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      background: #fafafa;
    }
    
    .test-section h2 {
      margin-top: 0;
      color: #764ba2;
      border-bottom: 2px solid #764ba2;
      padding-bottom: 10px;
    }
    
    .test-case {
      background: white;
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }
    
    .test-case h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 16px;
    }
    
    .input-output {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
    }
    
    .panel {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      overflow-x: auto;
    }
    
    .panel h4 {
      margin: 0 0 10px 0;
      color: #666;
      font-size: 12px;
      text-transform: uppercase;
    }
    
    .html-preview {
      background: white;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      line-height: 1.6;
    }
    
    .stats {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      padding: 10px;
      background: #e8f4f8;
      border-radius: 4px;
    }
    
    .stat-item {
      flex: 1;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .success { color: #10b981; }
    .warning { color: #f59e0b; }
    .error { color: #ef4444; }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    button:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .dark-mode-test {
      background: #1a1a1a;
      color: #ffffff;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .dark-mode-test h4 {
      color: #10b981;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”¬ Outlook è§„èŒƒåŒ–æµ‹è¯•ï¼ˆv2.20.0ï¼‰</h1>
    <p class="subtitle">
      æµ‹è¯• P0 ä¼˜åŒ–ï¼šMsoList ä¼ªåˆ—è¡¨è¯†åˆ« + æ ·å¼ç™½åå•æ¸…æ´—ï¼ˆé˜²é»‘åº•é»‘å­—ï¼‰
    </p>

    <!-- Test 1: MsoList æœ‰åºåˆ—è¡¨ -->
    <div class="test-section">
      <h2>æµ‹è¯• 1ï¸âƒ£ - MsoList æœ‰åºåˆ—è¡¨è¯†åˆ«</h2>
      
      <div class="test-case">
        <h3>åœºæ™¯ï¼šOutlook æ¡Œé¢ç‰ˆçš„æœ‰åºåˆ—è¡¨ï¼ˆ3 å±‚åµŒå¥—ï¼‰</h3>
        
        <div class="input-output">
          <div class="panel">
            <h4>è¾“å…¥ï¼šOutlook HTMLï¼ˆä¼ªåˆ—è¡¨ï¼‰</h4>
            <pre id="test1-input"></pre>
          </div>
          
          <div class="panel">
            <h4>è¾“å‡ºï¼šæ ‡å‡† HTMLï¼ˆ<code>&lt;ol&gt;</code>ï¼‰</h4>
            <pre id="test1-output"></pre>
          </div>
        </div>
        
        <div class="stats">
          <div class="stat-item">
            <div class="stat-value" id="test1-mso-count">0</div>
            <div class="stat-label">æ£€æµ‹åˆ° MsoList</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="test1-list-count">0</div>
            <div class="stat-label">ç”Ÿæˆ &lt;ol&gt;</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="test1-level-max">0</div>
            <div class="stat-label">æœ€å¤§å±‚çº§</div>
          </div>
        </div>
        
        <div class="html-preview" id="test1-preview"></div>
      </div>
    </div>

    <!-- Test 2: MsoList æ— åºåˆ—è¡¨ -->
    <div class="test-section">
      <h2>æµ‹è¯• 2ï¸âƒ£ - MsoList æ— åºåˆ—è¡¨è¯†åˆ«</h2>
      
      <div class="test-case">
        <h3>åœºæ™¯ï¼šOutlook æ¡Œé¢ç‰ˆçš„æ— åºåˆ—è¡¨ï¼ˆé¡¹ç›®ç¬¦å·ï¼‰</h3>
        
        <div class="input-output">
          <div class="panel">
            <h4>è¾“å…¥ï¼šOutlook HTMLï¼ˆä¼ªåˆ—è¡¨ï¼‰</h4>
            <pre id="test2-input"></pre>
          </div>
          
          <div class="panel">
            <h4>è¾“å‡ºï¼šæ ‡å‡† HTMLï¼ˆ<code>&lt;ul&gt;</code>ï¼‰</h4>
            <pre id="test2-output"></pre>
          </div>
        </div>
        
        <div class="html-preview" id="test2-preview"></div>
      </div>
    </div>

    <!-- Test 3: æ ·å¼ç™½åå•æ¸…æ´— -->
    <div class="test-section">
      <h2>æµ‹è¯• 3ï¸âƒ£ - æ ·å¼ç™½åå•æ¸…æ´—ï¼ˆé˜²é»‘åº•é»‘å­—ï¼‰</h2>
      
      <div class="test-case">
        <h3>åœºæ™¯ï¼šOutlook HTML æºå¸¦é»‘è‰²æ–‡å­— + Calibri å­—ä½“</h3>
        
        <div class="input-output">
          <div class="panel">
            <h4>è¾“å…¥ï¼šOutlook HTMLï¼ˆæ±¡æŸ“æ ·å¼ï¼‰</h4>
            <pre id="test3-input"></pre>
          </div>
          
          <div class="panel">
            <h4>è¾“å‡ºï¼šæ¸…æ´—åï¼ˆä»…ä¿ç•™ç™½åå•ï¼‰</h4>
            <pre id="test3-output"></pre>
          </div>
        </div>
        
        <div class="stats">
          <div class="stat-item">
            <div class="stat-value" id="test3-removed-color">0</div>
            <div class="stat-label">å‰”é™¤ color</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="test3-removed-font">0</div>
            <div class="stat-label">å‰”é™¤ font-family</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="test3-kept-styles">0</div>
            <div class="stat-label">ä¿ç•™æ ·å¼</div>
          </div>
        </div>
        
        <h4>æ·±è‰²æ¨¡å¼å¯è§æ€§æµ‹è¯•</h4>
        <div class="dark-mode-test" id="test3-dark-preview">
          <h4>å¦‚æœèƒ½çœ‹åˆ°æ–‡å­—ï¼Œè¯´æ˜ä¿®å¤æˆåŠŸ âœ…</h4>
          <div id="test3-dark-content"></div>
        </div>
      </div>
    </div>

    <!-- Test 4: ç©ºè¡Œå»å™ª -->
    <div class="test-section">
      <h2>æµ‹è¯• 4ï¸âƒ£ - ç©ºè¡Œå»å™ªï¼ˆP2ï¼‰</h2>
      
      <div class="test-case">
        <h3>åœºæ™¯ï¼šOutlook HTML å……æ»¡ <code>&lt;p&gt;&nbsp;&lt;/p&gt;</code></h3>
        
        <div class="input-output">
          <div class="panel">
            <h4>è¾“å…¥ï¼š5 ä¸ªè¿ç»­ç©ºè¡Œ</h4>
            <pre id="test4-input"></pre>
          </div>
          
          <div class="panel">
            <h4>è¾“å‡ºï¼šæŠ˜å ä¸º 1 ä¸ªç©ºè¡Œ</h4>
            <pre id="test4-output"></pre>
          </div>
        </div>
        
        <div class="stats">
          <div class="stat-item">
            <div class="stat-value" id="test4-before">0</div>
            <div class="stat-label">å¤„ç†å‰æ®µè½æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="test4-after">0</div>
            <div class="stat-label">å¤„ç†åæ®µè½æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="test4-removed">0</div>
            <div class="stat-label">å‰”é™¤ç©ºè¡Œ</div>
          </div>
        </div>
      </div>
    </div>

    <button onclick="runAllTests()">ğŸš€ è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
  </div>

  <script>
    // ============== æ¨¡æ‹Ÿ EventService çš„ç§æœ‰æ–¹æ³• ==============
    
    function cleanOutlookXmlTags(html) {
      return html
        .replace(/<o:p>[\s\S]*?<\/o:p>/gi, '')
        .replace(/<w:sdtPr>[\s\S]*?<\/w:sdtPr>/gi, '')
        .replace(/xmlns:o="[^"]*"/gi, '')
        .replace(/xmlns:w="[^"]*"/gi, '');
    }

    function processMsoLists(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const msoElements = Array.from(doc.querySelectorAll('p.MsoListParagraph, p[style*="mso-list"]'));
      
      if (msoElements.length === 0) return { html, count: 0 };
      
      // è¯†åˆ«è¿ç»­çš„åˆ—è¡¨æ®µè½
      const listGroups = [];
      let currentGroup = [];
      
      for (const element of msoElements) {
        if (isMsoListParagraph(element)) {
          currentGroup.push(element);
        } else if (currentGroup.length > 0) {
          listGroups.push(currentGroup);
          currentGroup = [];
        }
      }
      if (currentGroup.length > 0) listGroups.push(currentGroup);
      
      let maxLevel = 0;
      
      // è½¬æ¢æ¯ä¸ªåˆ—è¡¨ç»„
      for (const group of listGroups) {
        const listType = extractMsoListType(group[0]);
        const listElement = doc.createElement(listType === 'numbered' ? 'ol' : 'ul');
        
        for (const p of group) {
          const li = doc.createElement('li');
          li.innerHTML = cleanMsoListText(p);
          
          const level = extractMsoListLevel(p);
          maxLevel = Math.max(maxLevel, level);
          
          if (level > 1) {
            li.setAttribute('data-bullet-level', String(level - 1));
            li.style.marginLeft = `${(level - 1) * 20}px`;
          }
          
          listElement.appendChild(li);
        }
        
        group[0].replaceWith(listElement);
        for (let i = 1; i < group.length; i++) {
          group[i].remove();
        }
      }
      
      return { 
        html: doc.body.innerHTML, 
        count: msoElements.length,
        listCount: listGroups.length,
        maxLevel
      };
    }

    function isMsoListParagraph(element) {
      const className = element.className || '';
      const style = element.getAttribute('style') || '';
      return className.includes('MsoListParagraph') || style.includes('mso-list:');
    }

    function extractMsoListLevel(element) {
      const style = element.getAttribute('style') || '';
      const match = style.match(/mso-list:.*?level(\d+)/);
      return match ? parseInt(match[1], 10) : 1;
    }

    function extractMsoListType(element) {
      const ignoreSpan = element.querySelector('[style*="mso-list:Ignore"]');
      if (ignoreSpan) {
        const text = (ignoreSpan.textContent || '').trim();
        if (/^[\d\w]+\.$/.test(text)) {
          return 'numbered';
        }
      }
      return 'bullet';
    }

    function cleanMsoListText(element) {
      const clone = element.cloneNode(true);
      clone.querySelectorAll('[style*="mso-list:Ignore"]').forEach(el => el.remove());
      let html = clone.innerHTML;
      html = html.replace(/<!\[if !supportLists\]>[\s\S]*?<!\[endif\]>/gi, '');
      return html.trim();
    }

    function sanitizeInlineStyles(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      const allElements = doc.querySelectorAll('[style]');
      let removedColor = 0;
      let removedFont = 0;
      let keptStyles = 0;
      
      allElements.forEach(element => {
        const result = sanitizeElementStyle(element);
        removedColor += result.removedColor;
        removedFont += result.removedFont;
        keptStyles += result.keptStyles;
      });
      
      return { 
        html: doc.body.innerHTML, 
        removedColor, 
        removedFont, 
        keptStyles 
      };
    }

    function sanitizeElementStyle(element) {
      const style = element.style;
      const cleanedStyles = {};
      let removedColor = 0;
      let removedFont = 0;
      let keptStyles = 0;
      
      const ALLOWED_STYLES = {
        'font-weight': ['bold', '700', '800', '900'],
        'font-style': ['italic'],
        'text-decoration': ['underline', 'line-through'],
        'background-color': true
      };
      
      const ALLOWED_HIGHLIGHT_COLORS = [
        '#ffff00', '#00ff00', '#ff00ff', '#ffa500',
        'yellow', 'lime', 'cyan', 'magenta'
      ];
      
      for (let i = 0; i < style.length; i++) {
        const prop = style[i];
        const value = style.getPropertyValue(prop);
        
        if (prop === 'color') removedColor++;
        if (prop.startsWith('font-family')) removedFont++;
        
        if (ALLOWED_STYLES[prop]) {
          if (Array.isArray(ALLOWED_STYLES[prop])) {
            if (ALLOWED_STYLES[prop].includes(value)) {
              cleanedStyles[prop] = value;
              keptStyles++;
            }
          } else if (prop === 'background-color') {
            const normalized = normalizeColor(value);
            if (ALLOWED_HIGHLIGHT_COLORS.includes(normalized) &&
                normalized !== '#000000' && 
                normalized !== '#ffffff') {
              cleanedStyles[prop] = value;
              keptStyles++;
              
              // ğŸ†• ä¸ºæµ…è‰²é«˜äº®èƒŒæ™¯è‡ªåŠ¨æ·»åŠ æ·±è‰²æ–‡å­—ï¼ˆé˜²æ­¢æ·±è‰²æ¨¡å¼é»„åº•ç™½å­—ï¼‰
              const isLight = isLightColor(normalized);
              if (isLight) {
                cleanedStyles['color'] = '#000000';  // å¼ºåˆ¶é»‘è‰²æ–‡å­—
                keptStyles++;
              }
            }
          }
        }
      }
      
      element.removeAttribute('style');
      Object.entries(cleanedStyles).forEach(([prop, value]) => {
        element.style.setProperty(prop, value);
      });
      
      return { removedColor, removedFont, keptStyles };
    }

    function isLightColor(hex) {
      // åˆ¤æ–­é¢œè‰²æ˜¯å¦ä¸ºæµ…è‰²ï¼ˆéœ€è¦æ·±è‰²æ–‡å­—ï¼‰
      // ä½¿ç”¨ YIQ äº®åº¦å…¬å¼
      const rgb = hexToRgb(hex);
      if (!rgb) return false;
      
      const yiq = ((rgb.r * 299) + (rgb.g * 587) + (rgb.b * 114)) / 1000;
      return yiq >= 128;  // äº®åº¦ >= 128 ä¸ºæµ…è‰²
    }

    function hexToRgb(hex) {
      hex = hex.replace('#', '');
      if (hex.length === 3) {
        hex = hex.split('').map(c => c + c).join('');
      }
      if (hex.length !== 6) return null;
      
      return {
        r: parseInt(hex.substring(0, 2), 16),
        g: parseInt(hex.substring(2, 4), 16),
        b: parseInt(hex.substring(4, 6), 16)
      };
    }

    function normalizeColor(color) {
      if (color.startsWith('rgb')) {
        const match = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (match) {
          const r = parseInt(match[1]).toString(16).padStart(2, '0');
          const g = parseInt(match[2]).toString(16).padStart(2, '0');
          const b = parseInt(match[3]).toString(16).padStart(2, '0');
          return `#${r}${g}${b}`;
        }
      }
      return color.toLowerCase();
    }

    function collapseEmptyParagraphs(slateNodes) {
      const result = [];
      let consecutiveEmptyCount = 0;
      
      for (const node of slateNodes) {
        const isEmpty = isEmptyParagraph(node);
        
        if (isEmpty) {
          consecutiveEmptyCount++;
          if (consecutiveEmptyCount === 1) {
            result.push(node);
          }
        } else {
          consecutiveEmptyCount = 0;
          result.push(node);
        }
      }
      
      return result;
    }

    function isEmptyParagraph(node) {
      if (node.type !== 'paragraph') return false;
      const text = extractNodeText(node);
      return text.trim() === '' || text === '\u00A0';
    }

    function extractNodeText(node) {
      if ('text' in node) return node.text;
      if ('children' in node) {
        return node.children.map(child => extractNodeText(child)).join('');
      }
      return '';
    }

    // ============== æµ‹è¯•æ¡ˆä¾‹ ==============

    function runAllTests() {
      runTest1();
      runTest2();
      runTest3();
      runTest4();
    }

    function runTest1() {
      const input = `<p class="MsoListParagraph" style="mso-list:l0 level1 lfo1">
  <![if !supportLists]>
  <span style="mso-list:Ignore">1.<span style="font:7.0pt 'Times New Roman'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
  <![endif]>
  ä¼šè®®çºªè¦ç¬¬ä¸€ç‚¹
</p>
<p class="MsoListParagraph" style="mso-list:l0 level2 lfo1">
  <![if !supportLists]>
  <span style="mso-list:Ignore">a.<span style="font:7.0pt 'Times New Roman'">&nbsp;&nbsp;&nbsp;</span></span>
  <![endif]>
  å­é¡¹ç›® A
</p>
<p class="MsoListParagraph" style="mso-list:l0 level3 lfo1">
  <![if !supportLists]>
  <span style="mso-list:Ignore">i.<span style="font:7.0pt 'Times New Roman'">&nbsp;&nbsp;</span></span>
  <![endif]>
  æ›´æ·±å±‚çš„å­é¡¹ç›®
</p>
<p class="MsoListParagraph" style="mso-list:l0 level1 lfo1">
  <![if !supportLists]>
  <span style="mso-list:Ignore">2.<span style="font:7.0pt 'Times New Roman'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
  <![endif]>
  ä¼šè®®çºªè¦ç¬¬äºŒç‚¹
</p>`;

      const result = processMsoLists(input);
      
      document.getElementById('test1-input').textContent = input;
      document.getElementById('test1-output').textContent = result.html;
      document.getElementById('test1-preview').innerHTML = result.html;
      
      document.getElementById('test1-mso-count').textContent = result.count;
      document.getElementById('test1-list-count').textContent = result.listCount;
      document.getElementById('test1-level-max').textContent = result.maxLevel;
    }

    function runTest2() {
      const input = `<p class="MsoListParagraph" style="mso-list:l1 level1 lfo2">
  <![if !supportLists]>
  <span style="mso-list:Ignore">Â·<span style="font:7.0pt 'Times New Roman'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
  <![endif]>
  é¡¹ç›®ä»»åŠ¡æ¸…å•
</p>
<p class="MsoListParagraph" style="mso-list:l1 level1 lfo2">
  <![if !supportLists]>
  <span style="mso-list:Ignore">Â·<span style="font:7.0pt 'Times New Roman'">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>
  <![endif]>
  å¾…åŠäº‹é¡¹
</p>`;

      const result = processMsoLists(input);
      
      document.getElementById('test2-input').textContent = input;
      document.getElementById('test2-output').textContent = result.html;
      document.getElementById('test2-preview').innerHTML = result.html;
    }

    function runTest3() {
      const input = `<p><span style="color: #000000; font-family: Calibri; font-size: 11pt;">è¿™æ®µæ–‡å­—æ˜¯é»‘è‰²çš„</span></p>
<p><span style="font-weight: bold; color: #000000;">åŠ ç²—çš„é»‘è‰²æ–‡å­—</span></p>
<p><span style="font-style: italic; font-family: Arial;">æ–œä½“æ–‡å­—</span></p>
<p><span style="text-decoration: underline; color: #000000;">ä¸‹åˆ’çº¿é»‘è‰²æ–‡å­—</span></p>
<p><span style="background-color: #ffff00; color: #000000;">é»„è‰²é«˜äº®+é»‘è‰²æ–‡å­—</span></p>`;

      const result = sanitizeInlineStyles(input);
      
      document.getElementById('test3-input').textContent = input;
      document.getElementById('test3-output').textContent = result.html;
      
      document.getElementById('test3-removed-color').textContent = result.removedColor;
      document.getElementById('test3-removed-font').textContent = result.removedFont;
      document.getElementById('test3-kept-styles').textContent = result.keptStyles;
      
      // æ·±è‰²æ¨¡å¼æµ‹è¯•
      document.getElementById('test3-dark-content').innerHTML = result.html;
    }

    function runTest4() {
      const input = [
        { type: 'paragraph', children: [{ text: 'ç¬¬ä¸€æ®µ' }] },
        { type: 'paragraph', children: [{ text: '' }] },
        { type: 'paragraph', children: [{ text: '' }] },
        { type: 'paragraph', children: [{ text: '' }] },
        { type: 'paragraph', children: [{ text: '' }] },
        { type: 'paragraph', children: [{ text: '' }] },
        { type: 'paragraph', children: [{ text: 'ç¬¬äºŒæ®µ' }] }
      ];

      const result = collapseEmptyParagraphs(input);
      
      document.getElementById('test4-input').textContent = JSON.stringify(input, null, 2);
      document.getElementById('test4-output').textContent = JSON.stringify(result, null, 2);
      
      document.getElementById('test4-before').textContent = input.length;
      document.getElementById('test4-after').textContent = result.length;
      document.getElementById('test4-removed').textContent = input.length - result.length;
    }

    // è‡ªåŠ¨è¿è¡Œæµ‹è¯•
    window.addEventListener('load', runAllTests);
  </script>
</body>
</html>
