<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®Œæ•´Meta-Commentæ¶æ„æµ‹è¯•å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .content {
      padding: 30px;
    }

    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .test-card {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      background: #f8f9fa;
    }

    .test-card h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.3em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .btn {
      padding: 10px 20px;
      font-size: 0.95em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      color: white;
      margin: 5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .btn-warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .btn-info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .output-box {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
      margin-left: 10px;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }

    .input-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      min-height: 120px;
      resize: vertical;
      font-size: 0.9em;
    }

    .diff-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85em;
    }

    .diff-table th {
      background: #667eea;
      color: white;
      padding: 8px;
      text-align: left;
      font-size: 0.9em;
    }

    .diff-table td {
      padding: 6px;
      border-bottom: 1px solid #dee2e6;
    }

    .diff-match {
      background: #d4edda;
    }

    .diff-mismatch {
      background: #f8d7da;
    }

    .info-card {
      background: #e7f3ff;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }

    .info-card h3 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .info-card ul {
      list-style: none;
      padding-left: 0;
    }

    .info-card ul li {
      padding: 4px 0;
      padding-left: 20px;
      position: relative;
      font-size: 0.9em;
    }

    .info-card ul li:before {
      content: "âœ“";
      position: absolute;
      left: 0;
      color: #667eea;
      font-weight: bold;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #dee2e6;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1em;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom: 3px solid #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”¬ å®Œæ•´ Meta-Comment æ¶æ„æµ‹è¯•å·¥å…·</h1>
      <p>æµ‹è¯•ç­¾åæå–ã€Metaç”Ÿæˆã€OutlookåŒæ­¥ã€è§£ææ¢å¤ã€DifféªŒè¯</p>
    </div>

    <div class="content">
      <!-- æµ‹è¯•è¯´æ˜ -->
      <div class="info-card">
        <h3>ğŸ¯ æµ‹è¯•ç›®æ ‡</h3>
        <ul>
          <li>ç­¾åæå–ï¼šextractTimestamps/Creator/Updaterã€extractCoreContent</li>
          <li>Metaç”Ÿæˆï¼šSlate/Signature ç»Ÿä¸€åºåˆ—åŒ–ï¼ˆ<strong>ä¸å«Tags/Treeå…³ç³»æ•°æ®</strong>ï¼‰</li>
          <li>Outlookæ¨¡æ‹Ÿï¼šHTMLé‡å†™ã€Metaæ¸…é™¤ã€ç­¾åæ··æ·†</li>
          <li>Metaè§£æï¼šparseMetaCommentsä¼˜å…ˆã€Block-Levelé™çº§</li>
          <li>å®Œæ•´æ€§éªŒè¯ï¼šID/EventLog/æ—¶é—´æˆ³/ç­¾åä¿¡æ¯å¯¹æ¯”</li>
          <li>ğŸ”‘ Signatureæ¸…ç†ï¼šä»Metaæ¢å¤åæ¸…é™¤signatureå­—æ®µï¼Œé¿å…ä¸‹æ¬¡åŒæ­¥å†²çª</li>
        </ul>
      </div>

      <div class="info-card" style="background:#e7f3ff;border-left-color:#2196f3;">
        <h3>ğŸ“‹ Metaæ¶æ„åŸåˆ™ï¼šå†…å®¹è¿˜åŸ vs å…³ç³»è¿˜åŸ</h3>
        <ul style="list-style:none;padding-left:10px;">
          <li style="padding-left:0;">âœ… <strong>ä¿ç•™åœ¨Metaä¸­</strong>ï¼ˆOutlookä¼šç ´åçš„å†…å®¹çº§å…ƒæ•°æ®ï¼‰ï¼š</li>
          <li style="padding-left:20px;">â€¢ Event IDï¼ˆå¿…éœ€ï¼Œç”¨äºæœ¬åœ°æŸ¥è¯¢å…³ç³»æ•°æ®ï¼‰</li>
          <li style="padding-left:20px;">â€¢ Slate nodesï¼ˆUnifiedMentionã€timestamp nodesã€è¡¨æ ¼ã€åˆ†çº§æ ‡é¢˜ï¼‰</li>
          <li style="padding-left:20px;">â€¢ Signatureï¼ˆæ—¶é—´æˆ³ã€æ¥æºä¿¡æ¯ï¼‰</li>
          <li style="padding-left:0;margin-top:10px;">âŒ <strong>ä»æœ¬åœ°æŸ¥è¯¢</strong>ï¼ˆå…³ç³»æ•°æ®ï¼Œé¿å…è¿‡æœŸï¼‰ï¼š</li>
          <li style="padding-left:20px;">â€¢ Tags â†’ TagService.getEventTags(eventId)</li>
          <li style="padding-left:20px;">â€¢ Tree (parent/children/bulletLevel/order) â†’ EventTreeService.getEventNode(eventId)</li>
          <li style="padding-left:20px;">â€¢ Attendees â†’ ContactService.getEventAttendees(eventId)</li>
        </ul>
      </div>

      <div class="info-card" style="background:#fff3cd;border-left-color:#ffc107;">
        <h3>âš ï¸ é‡è¦ï¼šSignatureå­—æ®µçš„ç”Ÿå‘½å‘¨æœŸ</h3>
        <ul style="list-style:decimal;padding-left:20px;">
          <li style="padding-left:0;"><strong>åŒæ­¥å‡ºå»ï¼ˆ4DNoteâ†’Outlookï¼‰</strong>ï¼šEvent â†’ Meta.signatureï¼ˆJSONï¼‰ + Descriptionç­¾åï¼ˆæ–‡æœ¬ï¼‰</li>
          <li style="padding-left:0;"><strong>åŒæ­¥å›æ¥ï¼ˆOutlookâ†’4DNoteï¼‰</strong>ï¼šMeta.signature â†’ Eventå­—æ®µ + <strong>åˆ é™¤Meta.signature</strong></li>
          <li style="padding-left:0;"><strong>ä¸‹æ¬¡åŒæ­¥</strong>ï¼šæ ¹æ®Eventå½“å‰çŠ¶æ€é‡æ–°ç”ŸæˆMeta.signature</li>
          <li style="padding-left:0;"><strong>ä¸ºä»€ä¹ˆè¦æ¸…é™¤</strong>ï¼šé¿å…æ—§Meta.signatureä¸Eventå½“å‰çŠ¶æ€å†²çª</li>
        </ul>
      </div>

      <!-- Tabå¯¼èˆª -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('signature')">1. ç­¾åæµ‹è¯•</button>
        <button class="tab" onclick="switchTab('meta-gen')">2. Metaç”Ÿæˆ</button>
        <button class="tab" onclick="switchTab('outlook')">3. Outlookæ¨¡æ‹Ÿ</button>
        <button class="tab" onclick="switchTab('parse')">4. Metaè§£æ</button>
        <button class="tab" onclick="switchTab('full')">5. å®Œæ•´æµ‹è¯•</button>
      </div>

      <!-- Tab 1: ç­¾åæµ‹è¯• -->
      <div id="tab-signature" class="tab-content active">
        <div class="test-grid">
          <div class="test-card">
            <h2>ç­¾åç”Ÿæˆ</h2>
            <div class="input-group">
              <label>äº‹ä»¶ä¿¡æ¯ï¼š</label>
              <textarea id="sig-event-input" placeholder='{"createdAt":1734620000000,"fourDNoteSource":"4dnote","updatedAt":1734621000000}'></textarea>
            </div>
            <div>
              <button class="btn btn-primary" onclick="generateSignature()">ç”Ÿæˆç­¾å</button>
              <button class="btn btn-info" onclick="loadSignatureSample()">åŠ è½½ç¤ºä¾‹</button>
              <button class="btn btn-success" onclick="copySignatureToExtract()">ğŸ‘‡ å¤åˆ¶åˆ°ä¸‹æ–¹æå–æ¡†</button>
            </div>
            <div id="sig-gen-output" class="output-box" style="display:none;"></div>
          </div>

          <div class="test-card">
            <h2>ç­¾åæå–</h2>
            <div class="input-group">
              <label>å¸¦ç­¾åçš„HTMLï¼š</label>
              <textarea id="sig-html-input" placeholder="ç²˜è´´åŒ…å«ç­¾åçš„HTML...æˆ–ç‚¹å‡»ä¸Šæ–¹"å¤åˆ¶åˆ°ä¸‹æ–¹æå–æ¡†"æŒ‰é’®"></textarea>
            </div>
            <div>
              <button class="btn btn-primary" onclick="extractSignature()">æå–ç­¾åä¿¡æ¯</button>
              <button class="btn btn-success" onclick="extractCoreContent()">æå–æ ¸å¿ƒå†…å®¹</button>
            </div>
            <div id="sig-extract-output" class="output-box" style="display:none;"></div>
          </div>
        </div>

        <div class="test-card">
          <h2>ç­¾å + Block-Level äº¤äº’æµ‹è¯•</h2>
          <p style="margin-bottom:10px;color:#666;">æµ‹è¯•ç­¾åå‰”é™¤æ˜¯å¦å½±å“Block-Levelæ—¶é—´æˆ³è§£æ</p>
          <div>
            <button class="btn btn-warning" onclick="testSignatureBlockLevelInteraction()">è¿è¡Œäº¤äº’æµ‹è¯•</button>
          </div>
          <div id="sig-blocklevel-output" class="output-box" style="display:none;"></div>
        </div>
      </div>

      <!-- Tab 2: Metaç”Ÿæˆ -->
      <div id="tab-meta-gen" class="tab-content">
        <div class="test-grid">
          <div class="test-card">
            <h2>å®Œæ•´Eventè¾“å…¥</h2>
            <div class="input-group">
              <label>Event JSONï¼š</label>
              <textarea id="meta-event-input" placeholder='{"eventlog":{"slateJson":"[...]"},"tags":["å·¥ä½œ"],"parentEventId":"event_abc"}'></textarea>
            </div>
            <div>
              <button class="btn btn-primary" onclick="generateCompleteMeta()">ç”Ÿæˆå®Œæ•´Meta</button>
              <button class="btn btn-info" onclick="loadMetaSample()">åŠ è½½ç¤ºä¾‹Event</button>
            </div>
          </div>

          <div class="test-card">
            <h2>ç”Ÿæˆçš„Meta-Comment</h2>
            <div id="meta-gen-output" class="output-box"></div>
            <div style="margin-top:10px;">
              <button class="btn btn-success" onclick="showMetaBreakdown()">æŸ¥çœ‹Metaç»“æ„</button>
            </div>
          </div>
        </div>

        <div class="test-card">
          <h2>Metaç»“æ„åˆ†æ</h2>
          <div id="meta-breakdown-output" class="output-box" style="display:none;"></div>
        </div>
      </div>

      <!-- Tab 3: Outlookæ¨¡æ‹Ÿ -->
      <div id="tab-outlook" class="tab-content">
        <div class="test-card">
          <h2>Outlook ç ´åæ€§æ¨¡æ‹Ÿ</h2>
          <div class="input-group">
            <label>åŸå§‹Descriptionï¼ˆå«Metaï¼‰ï¼š</label>
            <textarea id="outlook-input"></textarea>
          </div>
          <div style="margin-top:15px;">
            <label style="display:block;margin-bottom:10px;font-weight:600;">é€‰æ‹©æ¨¡æ‹Ÿåœºæ™¯ï¼š</label>
            <label style="display:inline-block;margin-right:20px;">
              <input type="checkbox" id="outlook-strip-meta"> æ¸…é™¤Meta-Comment
            </label>
            <label style="display:inline-block;margin-right:20px;">
              <input type="checkbox" id="outlook-rewrite-html"> é‡å†™HTMLæ ‡ç­¾
            </label>
            <label style="display:inline-block;margin-right:20px;">
              <input type="checkbox" id="outlook-corrupt-signature"> æ··æ·†ç­¾å
            </label>
          </div>
          <div style="margin-top:15px;">
            <button class="btn btn-warning" onclick="simulateOutlook()">æ¨¡æ‹ŸOutlookå¾€è¿”</button>
            <button class="btn btn-info" onclick="useMetaOutput()">ä½¿ç”¨ä¸Šä¸€æ­¥çš„Metaè¾“å‡º</button>
          </div>
          <div id="outlook-output" class="output-box" style="display:none;"></div>
        </div>
      </div>

      <!-- Tab 4: Metaè§£æ -->
      <div id="tab-parse" class="tab-content">
        <div class="test-grid">
          <div class="test-card">
            <h2>Metaè§£æ</h2>
            <div class="input-group">
              <label>Outlookè¿”å›çš„Descriptionï¼š</label>
              <textarea id="parse-input"></textarea>
            </div>
            <div>
              <button class="btn btn-primary" onclick="parseMeta()">è§£æMeta</button>
              <button class="btn btn-info" onclick="useOutlookOutput()">ä½¿ç”¨Outlookè¾“å‡º</button>
            </div>
            <div id="parse-output" class="output-box" style="display:none;"></div>
          </div>

          <div class="test-card">
            <h2>è§£æåçš„Event</h2>
            <div id="parse-event-output" class="output-box"></div>
          </div>
        </div>
      </div>

      <!-- Tab 5: å®Œæ•´æµ‹è¯• -->
      <div id="tab-full" class="tab-content">
        <div class="test-card">
          <h2>ğŸš€ å®Œæ•´ç”Ÿå‘½å‘¨æœŸæµ‹è¯•</h2>
          <p style="margin-bottom:15px;color:#666;">
            è‡ªåŠ¨è¿è¡Œï¼šåˆ›å»ºEvent â†’ ç”ŸæˆMeta â†’ Outlookæ¨¡æ‹Ÿ â†’ è§£ææ¢å¤ â†’ DifféªŒè¯
          </p>
          <div>
            <button class="btn btn-success" onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button class="btn btn-warning" onclick="runFullTestWithCorruption()">è¿è¡Œæµ‹è¯•ï¼ˆå¯ç”¨æ‰€æœ‰ç ´åï¼‰</button>
          </div>
          <div id="full-test-output" class="output-box" style="display:none;"></div>
        </div>

        <div class="test-card">
          <h2>å…ƒæ•°æ®å®Œæ•´æ€§æŠ¥å‘Š</h2>
          <table class="diff-table" id="full-diff-table">
            <thead>
              <tr>
                <th>ç±»åˆ«</th>
                <th>å­—æ®µ</th>
                <th>åŸå§‹å€¼</th>
                <th>è§£æåå€¼</th>
                <th>çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody id="full-diff-tbody">
              <tr>
                <td colspan="5" style="text-align:center;color:#999;">è¿è¡Œå®Œæ•´æµ‹è¯•åæ˜¾ç¤º</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== å…¨å±€çŠ¶æ€ ==========
    let testState = {
      originalEvent: null,
      generatedMeta: null,
      outlookHtml: null,
      parsedEvent: null,
      lastGeneratedSignature: null  // ä¿å­˜æœ€åç”Ÿæˆçš„ç­¾å
    };

    // ========== Tabåˆ‡æ¢ ==========
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // ========== æ—¶é—´å·¥å…·å‡½æ•°ï¼ˆæ¨¡æ‹Ÿ timeUtils.tsï¼‰==========
    function formatTimeForStorage(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // ========== ç­¾åå·¥å…·å‡½æ•°ï¼ˆæ¨¡æ‹Ÿ EventService.maintainDescriptionSignatureï¼‰==========
    function generateSignature() {
      const input = document.getElementById('sig-event-input').value;
      try {
        const event = JSON.parse(input);
        
        // ğŸ“ çœŸå®é€»è¾‘æ¥è‡ª EventService.maintainDescriptionSignature
        const lines = [];
        lines.push('---');
        
        // ç¡®å®šåˆ›å»ºæ¥æºå’Œæ—¶é—´
        const isLocalCreated = event.fourDNoteSource === true || event.source === 'local' || !event.source;
        const createSource = isLocalCreated ? 'ğŸ”® 4DNote' : 'ğŸ“§ Outlook';
        const createSourceKey = isLocalCreated ? '4dnote' : 'outlook';
        // âœ… createdAtå·²ç»æ˜¯TimeSpecå­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
        const createTime = event.createdAt || formatTimeForStorage(new Date());
        
        // ç¡®å®šä¿®æ”¹æ¥æº
        const modifySourceKey = event.lastModifiedSource || createSourceKey;
        const modifySource = modifySourceKey === '4dnote' ? 'ğŸ”® 4DNote' : 'ğŸ“§ Outlook';
        
        // ç”Ÿæˆç­¾å
        if (event.updatedAt && event.updatedAt !== event.createdAt) {
          // âœ… updatedAtå·²ç»æ˜¯TimeSpecå­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
          const modifyTime = event.updatedAt;
          
          if (createSourceKey === modifySourceKey) {
            // åŒä¸€æ¥æºï¼šä¸€è¡Œç­¾å
            lines.push(`ç”± ${createSource} åˆ›å»ºäº ${createTime}ï¼Œæœ€åä¿®æ”¹äº ${modifyTime}`);
          } else {
            // ä¸åŒæ¥æºï¼šä¸¤è¡Œç­¾å
            lines.push(`ç”± ${createSource} åˆ›å»ºäº ${createTime}`);
            lines.push(`ç”± ${modifySource} æœ€åä¿®æ”¹äº ${modifyTime}`);
          }
        } else {
          // æœªä¿®æ”¹ï¼šåªæ˜¾ç¤ºåˆ›å»ºä¿¡æ¯
          lines.push(`ç”± ${createSource} åˆ›å»ºäº ${createTime}`);
        }
        
        const signature = '\n\n' + lines.join('\n');
        
        const output = document.getElementById('sig-gen-output');
        output.style.display = 'block';
        output.textContent = `ç”Ÿæˆçš„ç­¾åï¼š${signature}`;
        
        // ä¿å­˜åˆ°å…¨å±€çŠ¶æ€ï¼Œä¾›å¤åˆ¶åŠŸèƒ½ä½¿ç”¨
        testState.lastGeneratedSignature = signature;
      } catch (err) {
        alert(`è§£æå¤±è´¥ï¼š${err.message}`);
      }
    }

    function copySignatureToExtract() {
      if (!testState.lastGeneratedSignature) {
        alert('è¯·å…ˆç‚¹å‡»"ç”Ÿæˆç­¾å"æŒ‰é’®ï¼');
        return;
      }
      
      // æ„é€ å®Œæ•´çš„HTMLï¼ˆæ¨¡æ‹Ÿå®é™…åœºæ™¯ï¼‰
      const fullHtml = `<p>äº‹ä»¶å†…å®¹</p>${testState.lastGeneratedSignature}`;
      document.getElementById('sig-html-input').value = fullHtml;
      alert('âœ… å·²å¤åˆ¶åˆ°æå–æ¡†ï¼ç°åœ¨å¯ä»¥ç‚¹å‡»"æå–ç­¾åä¿¡æ¯"æµ‹è¯•æå–é€»è¾‘ã€‚');
    }

    function loadSignatureSample() {
      // ğŸ“ Eventæ¥å£ä¸­æ—¶é—´å­—æ®µæ˜¯å­—ç¬¦ä¸²ï¼ˆTimeSpecæ ¼å¼ï¼‰ï¼Œä¸æ˜¯timestamp
      const now = new Date();
      const yesterday = new Date(now.getTime() - 86400000);
      
      document.getElementById('sig-event-input').value = JSON.stringify({
        createdAt: formatTimeForStorage(yesterday),  // string: 'YYYY-MM-DD HH:mm:ss'
        fourDNoteSource: true,  // boolean: true=4DNoteåˆ›å»º, false=Outlookåˆ›å»º
        source: 'local',
        updatedAt: formatTimeForStorage(now),  // string: 'YYYY-MM-DD HH:mm:ss'
        lastModifiedSource: 'outlook'  // 'outlook' | '4dnote'
      }, null, 2);
    }

    function extractSignature() {
      const html = document.getElementById('sig-html-input').value;
      
      // ğŸ› è°ƒè¯•ï¼šæ˜¾ç¤ºè¾“å…¥å†…å®¹
      console.log('=== æå–ç­¾åè°ƒè¯• ===');
      console.log('è¾“å…¥HTML:', html);
      console.log('HTMLé•¿åº¦:', html.length);
      
      let result = {
        extractSource: '',  // æå–æ¥æºï¼ˆMeta/ç­¾åæ–‡æœ¬/ç¼ºå¤±ï¼‰
        createdAt: null,
        fourDNoteSource: null,  // boolean: Event.fourDNoteSource
        source: null,           // 'local' | 'outlook': Event.source
        updatedAt: null,
        lastModifiedSource: null,  // '4dnote' | 'outlook': Event.lastModifiedSource
        debugInfo: []  // è°ƒè¯•ä¿¡æ¯
      };
      
      // ä¼˜å…ˆçº§1ï¼šä»Meta-Commentä¸­æå–ï¼ˆæœ€å¯é ï¼‰
      const metaMatch = html.match(/<!--4DNOTE-META:(.*?)-->/);
      if (metaMatch) {
        try {
          const meta = JSON.parse(metaMatch[1]);
          if (meta.signature) {
            result.extractSource = 'Meta-Commentï¼ˆä¼˜å…ˆï¼‰';
            result.createdAt = meta.signature.createdAt || null;
            result.fourDNoteSource = meta.signature.fourDNoteSource;
            result.source = meta.signature.source || null;
            result.updatedAt = meta.signature.updatedAt || null;
            result.lastModifiedSource = meta.signature.lastModifiedSource || null;
          }
        } catch (e) {
          // Metaè§£æå¤±è´¥ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæ–¹æ³•
        }
      }
      
      // ä¼˜å…ˆçº§2ï¼šä»ç­¾åæ–‡æœ¬ä¸­æå–ï¼ˆFallbackï¼‰ - çœŸå®é€»è¾‘æ¥è‡ª extractTimestampsFromSignature + extractCreatorFromSignature
      if (!result.extractSource) {
        // extractTimestampsFromSignature: æå–æ—¶é—´æˆ³
        const createTimeMatch = html.match(/ç”±\s+(?:ğŸ”®|ğŸ“§|ğŸŸ£)?\s*(?:4DNote|Outlook)\s*åˆ›å»ºäº\s+(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})/i);
        const updateTimeMatch = html.match(/(?:æœ€åä¿®æ”¹äº|æœ€åç¼–è¾‘äº|ç¼–è¾‘äº)\s+(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})/i);
        
        // ğŸ› è°ƒè¯•è¾“å‡º
        result.debugInfo.push(`åˆ›å»ºæ—¶é—´æ­£åˆ™: ${!!createTimeMatch}, åŒ¹é…: ${createTimeMatch ? createTimeMatch[0] : 'null'}`);
        result.debugInfo.push(`ä¿®æ”¹æ—¶é—´æ­£åˆ™: ${!!updateTimeMatch}, åŒ¹é…: ${updateTimeMatch ? updateTimeMatch[0] : 'null'}`);
        console.log('createTimeMatch:', createTimeMatch);
        console.log('updateTimeMatch:', updateTimeMatch);
        
        // extractCreatorFromSignature: æå–åˆ›å»ºè€…
        const creatorMatch = html.match(/ç”±\s+(?:ğŸ”®|ğŸ“§|ğŸŸ£)?\s*(4DNote|Outlook)\s*åˆ›å»ºäº/i);
        
        // extractCreatorFromSignature: æå–ä¿®æ”¹è€…
        const modifierMatch = html.match(/ç”±\s+(?:ğŸ”®|ğŸ“§|ğŸŸ£)?\s*(4DNote|Outlook)\s*æœ€å(?:ä¿®æ”¹|ç¼–è¾‘)äº/i);
        
        result.debugInfo.push(`åˆ›å»ºè€…æ­£åˆ™: ${!!creatorMatch}, åŒ¹é…: ${creatorMatch ? creatorMatch[0] : 'null'}`);
        result.debugInfo.push(`ä¿®æ”¹è€…æ­£åˆ™: ${!!modifierMatch}, åŒ¹é…: ${modifierMatch ? modifierMatch[0] : 'null'}`);
        console.log('creatorMatch:', creatorMatch);
        console.log('modifierMatch:', modifierMatch);
        
        if (createTimeMatch || updateTimeMatch) {
          result.extractSource = 'ç­¾åæ–‡æœ¬æå–ï¼ˆFallbackï¼‰';
          result.createdAt = createTimeMatch ? createTimeMatch[1] : null; // ä¿æŒ TimeSpec æ ¼å¼
          result.updatedAt = updateTimeMatch ? updateTimeMatch[1] : null; // ä¿æŒ TimeSpec æ ¼å¼
          
          // æ˜ å°„åˆ°Eventå­—æ®µ
          if (creatorMatch) {
            const creator = creatorMatch[1].toLowerCase();
            result.fourDNoteSource = (creator === '4dnote');
            result.source = (creator === '4dnote') ? 'local' : 'outlook';
          }
          if (modifierMatch) {
            result.lastModifiedSource = modifierMatch[1].toLowerCase() === '4dnote' ? '4dnote' : 'outlook';
          }
        }
      }
      
      // ä¼˜å…ˆçº§3ï¼šæ— æ³•æå–ï¼ˆéœ€è¦Block-Levelï¼‰
      if (!result.extractSource) {
        result.extractSource = 'âŒ Metaå’Œç­¾åéƒ½ç¼ºå¤±ï¼ˆéœ€Fallbackåˆ°Block-Levelï¼‰';
      }
      
      const output = document.getElementById('sig-extract-output');
      output.style.display = 'block';
      
      let debugText = result.debugInfo.length > 0 ? `\n\nğŸ› è°ƒè¯•ä¿¡æ¯ï¼š\n${result.debugInfo.join('\n')}` : '';
      
      output.textContent = `æå–æ¥æºï¼š${result.extractSource}

ğŸ“… æ—¶é—´å­—æ®µï¼š
createdAt: ${result.createdAt}
updatedAt: ${result.updatedAt}

ğŸ‘¤ æ¥æºå­—æ®µï¼ˆEventæ¥å£ï¼‰ï¼š
fourDNoteSource: ${result.fourDNoteSource}  (boolean: true=4DNoteåˆ›å»º, false=Outlookåˆ›å»º)
source: ${result.source}  ('local' | 'outlook')
lastModifiedSource: ${result.lastModifiedSource}  ('4dnote' | 'outlook')${debugText}

ğŸ’¡ æå–ä¼˜å…ˆçº§ï¼š
1ï¸âƒ£ Meta-Commentï¼ˆç»“æ„åŒ–JSONï¼Œæœ€å¯é ï¼‰
2ï¸âƒ£ ç­¾åæ–‡æœ¬ï¼ˆæ­£åˆ™æå–ï¼Œå¯èƒ½å› æ ¼å¼å˜åŒ–å¤±è´¥ï¼‰
3ï¸âƒ£ Block-Levelï¼ˆæœ€åçš„é˜²çº¿ï¼Œä»æ®µè½æ—¶é—´æˆ³æ¨æ–­ï¼‰

ğŸ’» æç¤ºï¼šæ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ConsoleæŸ¥çœ‹è¯¦ç»†è°ƒè¯•æ—¥å¿—`;
    }

    function extractCoreContent() {
      const html = document.getElementById('sig-html-input').value;
      
      // ğŸ“ çœŸå®é€»è¾‘æ¥è‡ª EventService.extractCoreContentFromDescription
      let core = html
        // ç§»é™¤å®Œæ•´ç­¾åå—ï¼ˆ---\nç”±...åˆ›å»ºäº...ï¼‰
        .replace(/\n?---\nç”±\s+(?:ğŸ”®|ğŸ“§|ğŸŸ£)?\s*(?:4DNote|Outlook)\s*åˆ›å»ºäº\s+\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}[\s\S]*$/i, '')
        // ç§»é™¤å•è¡Œç­¾åï¼ˆåˆ›å»ºï¼‰
        .replace(/\n?ç”±\s+(?:ğŸ”®|ğŸ“§|ğŸŸ£)?\s*(?:4DNote|Outlook)\s*åˆ›å»ºäº\s+\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}[\s\S]*$/gi, '')
        // ç§»é™¤å•è¡Œç­¾åï¼ˆç¼–è¾‘/ä¿®æ”¹ï¼‰
        .replace(/\n?ç”±\s+(?:ğŸ”®|ğŸ“§|ğŸŸ£)?\s*(?:4DNote|Outlook)\s*(?:ç¼–è¾‘äº|æœ€å(?:ç¼–è¾‘|ä¿®æ”¹)äº)\s+\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}[\s\S]*$/gi, '');
      
      core = core.trim();
      
      const output = document.getElementById('sig-extract-output');
      output.style.display = 'block';
      output.textContent = `æ ¸å¿ƒå†…å®¹ï¼ˆå·²ç§»é™¤ç­¾åï¼‰ï¼š\n\n${core}`;
    }

    function testSignatureBlockLevelInteraction() {
      const htmlWithSig = `2025-12-19 14:30:00 ç¬¬ä¸€æ®µ
2025-12-19 14:31:00 ç¬¬äºŒæ®µ

--- ç”± ğŸ”® 4DNote åˆ›å»ºäº 2025-12-19 14:30:00 ---
æœ€åç”± outlook ä¿®æ”¹äº 2025-12-19 14:35:00`;

      // æ­¥éª¤1ï¼šæå–æ ¸å¿ƒå†…å®¹ï¼ˆç§»é™¤ç­¾åï¼‰
      const coreContent = htmlWithSig.replace(/\n\n--- ç”± ğŸ”® 4DNote åˆ›å»ºäº[\s\S]*?---[\s\S]*?$/g, '');
      
      // æ­¥éª¤2ï¼šè§£æBlock-Levelæ—¶é—´æˆ³
      const lines = coreContent.split('\n');
      const timestamps = [];
      
      for (const line of lines) {
        const match = line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
        if (match) {
          timestamps.push({
            timestamp: new Date(match[1]).getTime(),
            text: line.substring(match[0].length).trim()
          });
        }
      }
      
      const output = document.getElementById('sig-blocklevel-output');
      output.style.display = 'block';
      output.textContent = `âœ… ç­¾åå‰”é™¤ + Block-Levelè§£æ æµ‹è¯•é€šè¿‡

æ­¥éª¤1ï¼šåŸå§‹HTMLï¼ˆå«ç­¾åï¼‰
${htmlWithSig}

æ­¥éª¤2ï¼šæå–æ ¸å¿ƒå†…å®¹ï¼ˆç§»é™¤ç­¾åï¼‰
${coreContent}

æ­¥éª¤3ï¼šè§£æBlock-Levelæ—¶é—´æˆ³
${JSON.stringify(timestamps, null, 2)}

ç»“è®ºï¼šç­¾åæå–ä¸å½±å“Block-Levelè§£æ âœ…`;
    }

    // ========== Metaç”Ÿæˆ ==========
    function generateCompleteMeta() {
      const input = document.getElementById('meta-event-input').value;
      
      console.log('=== Metaç”Ÿæˆè°ƒè¯• ===');
      console.log('è¾“å…¥JSONé•¿åº¦:', input.length);
      console.log('è¾“å…¥JSONå†…å®¹:', input);
      
      if (!input || input.trim() === '') {
        alert('âŒ è¾“å…¥æ¡†ä¸ºç©ºï¼è¯·å…ˆç‚¹å‡»"åŠ è½½ç¤ºä¾‹Event"æˆ–ç²˜è´´Event JSON');
        return;
      }
      
      try {
        const event = JSON.parse(input);
        console.log('âœ… JSONè§£ææˆåŠŸ');
        console.log('è§£æåçš„Event:', event);
        
        testState.originalEvent = event;
        
        // ç”Ÿæˆå®Œæ•´Metaï¼ˆåªåŒ…å«å†…å®¹çº§å…ƒæ•°æ®ï¼‰
        const meta = {
          v: 1,
          id: event.id,  // ğŸ”‘ ä¿å­˜Eventçš„internal IDï¼ˆç”¨äºæœ¬åœ°æŸ¥è¯¢å…³ç³»æ•°æ®ï¼‰
          slate: generateSlateMeta(event),
          // âŒ ä¸åŒ…å«tags/treeï¼ˆå…³ç³»æ•°æ®ï¼Œä»æœ¬åœ°ServiceæŸ¥è¯¢ï¼‰
          signature: generateSignatureMeta(event)
        };
        
        console.log('ç”Ÿæˆçš„Meta:', meta);
        testState.generatedMeta = meta;
        
        const metaComment = `<!--4DNOTE-META:${JSON.stringify(meta)}-->`;
        
        const output = document.getElementById('meta-gen-output');
        output.style.display = 'block';  // ğŸ”‘ å…³é”®ï¼šæ˜¾ç¤ºè¾“å‡ºæ¡†
        output.textContent = metaComment;
        
        console.log('âœ… Metaç”ŸæˆæˆåŠŸ');
      } catch (err) {
        console.error('âŒ Metaç”Ÿæˆé”™è¯¯:', err);
        console.error('é”™è¯¯å †æ ˆ:', err.stack);
        alert(`ç”Ÿæˆå¤±è´¥ï¼š${err.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. JSONæ ¼å¼æ˜¯å¦æ­£ç¡®\n2. æ˜¯å¦æœ‰æœªé—­åˆçš„å¼•å·æˆ–æ‹¬å·\n3. æ‰“å¼€ConsoleæŸ¥çœ‹è¯¦ç»†é”™è¯¯`);
      }
    }

    function generateSlateMeta(event) {
      if (!event.eventlog?.slateJson) return null;
      // ğŸ¯ å…³é”®ï¼šç›´æ¥ä¿å­˜å®Œæ•´çš„SlateJSONå­—ç¬¦ä¸²
      // ä¸éœ€è¦è§£æã€å‹ç¼©ã€è½¬æ¢ - ä¿è¯100%å‡†ç¡®
      return event.eventlog.slateJson;
    }

    function generateSignatureMeta(event) {
      const meta = {};
      // ğŸ“ çœŸå®å­—æ®µæ˜ å°„ï¼ˆæ¥è‡ªEventæ¥å£ï¼‰
      if (event.createdAt) meta.createdAt = event.createdAt;
      if (event.fourDNoteSource !== undefined) meta.fourDNoteSource = event.fourDNoteSource; // boolean
      if (event.source) meta.source = event.source; // 'local' | 'outlook'
      if (event.updatedAt) meta.updatedAt = event.updatedAt;
      if (event.lastModifiedSource) meta.lastModifiedSource = event.lastModifiedSource; // '4dnote' | 'outlook'
      return Object.keys(meta).length > 0 ? meta : null;
    }

    function loadMetaSample() {
      const now = new Date();
      const hourAgo = new Date(now.getTime() - 3600000);
      
      document.getElementById('meta-event-input').value = JSON.stringify({
        id: 'event_test_001',  // ğŸ”‘ Eventçš„internal ID
        eventlog: {
          slateJson: JSON.stringify([
            { 
              type: 'paragraph', 
              id: 'p-001', 
              createdAt: formatTimeForStorage(hourAgo), 
              children: [{ text: 'ç¬¬ä¸€æ®µï¼ˆå¸¦æ—¶é—´æˆ³èŠ‚ç‚¹ï¼‰' }] 
            },
            { 
              type: 'heading', 
              id: 'h-001', 
              level: 2, 
              createdAt: formatTimeForStorage(now), 
              children: [{ text: 'äºŒçº§æ ‡é¢˜' }] 
            },
            { 
              type: 'paragraph', 
              id: 'p-002', 
              bulletLevel: 1, 
              children: [{ text: 'åˆ—è¡¨é¡¹ï¼ˆç¼©è¿›1çº§ï¼‰' }] 
            },
            { 
              type: 'paragraph', 
              id: 'p-003', 
              mention: { 
                type: 'tag', 
                targetName: 'å·¥ä½œ/é¡¹ç›®A', 
                displayText: '#é¡¹ç›®A' 
              },
              children: [{ text: 'å¸¦æ ‡ç­¾Mentionçš„æ®µè½' }] 
            }
          ])
        },
        // âŒ ä¸åŒ…å«tagsã€treeå­—æ®µï¼ˆå…³ç³»æ•°æ®ï¼Œåº”ä»æœ¬åœ°æŸ¥è¯¢ï¼‰
        createdAt: formatTimeForStorage(hourAgo),  // TimeSpecå­—ç¬¦ä¸²
        fourDNoteSource: true,  // booleanï¼Œä¸æ˜¯å­—ç¬¦ä¸²
        source: 'local',
        updatedAt: formatTimeForStorage(now),  // TimeSpecå­—ç¬¦ä¸²
        lastModifiedSource: 'outlook'
      }, null, 2);
    }

    function showMetaBreakdown() {
      if (!testState.generatedMeta) {
        alert('è¯·å…ˆç”ŸæˆMetaï¼');
        return;
      }
      
      const output = document.getElementById('meta-breakdown-output');
      output.style.display = 'block';
      output.textContent = `Metaç»“æ„åˆ†æï¼š

${JSON.stringify(testState.generatedMeta, null, 2)}

å­—æ®µç»Ÿè®¡ï¼š
- Event ID: ${testState.generatedMeta.id || 'æœªè®¾ç½®'}
- SlateèŠ‚ç‚¹: ${testState.generatedMeta.slate?.nodes?.length || 0}
- Signatureä¿¡æ¯: ${testState.generatedMeta.signature ? 'æ˜¯' : 'å¦'}

âš ï¸ æ³¨æ„ï¼šMetaä¸­ä¸åŒ…å«Tags/Tree/Attendeesï¼ˆå…³ç³»æ•°æ®ï¼‰
è¿™äº›æ•°æ®åº”è¯¥ä»æœ¬åœ°ServiceæŸ¥è¯¢ï¼š
- Tags â†’ TagService.getEventTags(eventId)
- Tree â†’ EventTreeService.getEventNode(eventId)
- Attendees â†’ ContactService.getEventAttendees(eventId)`;
    }

    // ========== Outlookæ¨¡æ‹Ÿ ==========
    function simulateOutlook() {
      const input = document.getElementById('outlook-input').value;
      if (!input) {
        alert('è¯·è¾“å…¥Descriptionï¼');
        return;
      }
      
      let html = input;
      
      const stripMeta = document.getElementById('outlook-strip-meta').checked;
      const rewriteHtml = document.getElementById('outlook-rewrite-html').checked;
      const corruptSig = document.getElementById('outlook-corrupt-signature').checked;
      
      if (stripMeta) {
        html = html.replace(/<!--4DNOTE-META:.*?-->/g, '');
      }
      
      if (rewriteHtml) {
        html = html.replace(/<p>/g, '<div>').replace(/<\/p>/g, '</div>');
      }
      
      if (corruptSig) {
        html = html.replace(/ğŸ”®/g, '').replace(/4DNote/g, '4D Note');
      }
      
      testState.outlookHtml = html;
      
      const output = document.getElementById('outlook-output');
      output.style.display = 'block';
      output.textContent = `Outlookå¤„ç†åçš„HTMLï¼š\n\n${html}`;
    }

    function useMetaOutput() {
      const metaOutput = document.getElementById('meta-gen-output').textContent;
      if (metaOutput) {
        document.getElementById('outlook-input').value = metaOutput + '\n<p>äº‹ä»¶å†…å®¹</p>';
      }
    }

    // ========== Metaè§£æ ==========
    function parseMeta() {
      const input = document.getElementById('parse-input').value;
      if (!input) {
        alert('è¯·è¾“å…¥Descriptionï¼');
        return;
      }
      
      // æå–Meta
      const metaMatch = input.match(/<!--4DNOTE-META:(.*?)-->/);
      
      const output = document.getElementById('parse-output');
      const eventOutput = document.getElementById('parse-event-output');
      
      if (metaMatch) {
        try {
          const meta = JSON.parse(metaMatch[1]);
          testState.parsedEvent = deserializeMeta(meta);
          
          output.style.display = 'block';
          output.textContent = `âœ… Metaè§£ææˆåŠŸ

è§£æåˆ°çš„Metaï¼š
${JSON.stringify(meta, null, 2)}`;
          
          eventOutput.textContent = `è§£æåçš„Eventï¼š
${JSON.stringify(testState.parsedEvent, null, 2)}`;
        } catch (err) {
          output.style.display = 'block';
          output.textContent = `âŒ Metaè§£æå¤±è´¥ï¼š${err.message}`;
        }
      } else {
        output.style.display = 'block';
        output.textContent = `âš ï¸ æœªæ‰¾åˆ°Meta-Commentï¼Œå°è¯•Block-Levelè§£æ...`;
      }
    }

    function deserializeMeta(meta) {
      const event = {};
      
      // ğŸ”‘ æ¢å¤Eventçš„internal IDï¼ˆç”¨äºæœ¬åœ°æŸ¥è¯¢å…³ç³»æ•°æ®ï¼‰
      if (meta.id) event.id = meta.id;
      
      // æ¢å¤Slateå†…å®¹ï¼ˆEventLogï¼‰
      if (meta.slate) {
        // ğŸ¯ å…³é”®ï¼šç›´æ¥ä½¿ç”¨Metaä¸­çš„SlateJSONå­—ç¬¦ä¸²
        // ä¸éœ€è¦HTMLè§£æ - 100%å‡†ç¡®æ¢å¤
        event.eventlog = {
          slateJson: meta.slate  // ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€è½¬æ¢
          // htmlå’ŒplainTextç”±normalizeEventLogä»slateJsonç”Ÿæˆ
        };
      }
      
      // âŒ ä¸ä»Metaæ¢å¤å…³ç³»æ•°æ®ï¼ˆtags/tree/attendeesï¼‰
      // æ­£ç¡®åšæ³•ï¼šä»æœ¬åœ°ServiceæŸ¥è¯¢
      // event.tags = await tagService.getEventTags(event.id);
      // const treeNode = await eventTreeService.getEventNode(event.id);
      // event.parentEventId = treeNode?.parent;
      // event.childEventIds = treeNode?.children;
      // event.bulletLevel = treeNode?.bulletLevel;
      
      // ğŸ”‘ æ¢å¤ç­¾åä¿¡æ¯ï¼ˆEventè‡ªèº«å±æ€§ï¼‰
      if (meta.signature) {
        if (meta.signature.createdAt) event.createdAt = meta.signature.createdAt;
        if (meta.signature.fourDNoteSource !== undefined) event.fourDNoteSource = meta.signature.fourDNoteSource; // boolean
        if (meta.signature.source) event.source = meta.signature.source;
        if (meta.signature.updatedAt) event.updatedAt = meta.signature.updatedAt;
        if (meta.signature.lastModifiedSource) event.lastModifiedSource = meta.signature.lastModifiedSource;
        
        // âš ï¸ å®é™…å®ç°æ—¶åº”è¯¥åˆ é™¤signatureå­—æ®µï¼ˆæœ¬æµ‹è¯•å·¥å…·æ¼”ç¤ºç”¨ä¿ç•™ï¼‰
        // delete meta.signature;
      }
      
      return event;
    }

    function useOutlookOutput() {
      if (testState.outlookHtml) {
        document.getElementById('parse-input').value = testState.outlookHtml;
      }
    }

    // ========== å®Œæ•´æµ‹è¯• ==========
    function runFullTest() {
      runFullTestInternal(false);
    }

    function runFullTestWithCorruption() {
      runFullTestInternal(true);
    }

    function runFullTestInternal(enableCorruption) {
      const output = document.getElementById('full-test-output');
      output.style.display = 'block';
      output.textContent = 'å¼€å§‹å®Œæ•´ç”Ÿå‘½å‘¨æœŸæµ‹è¯•...\n\n';
      
      // æ­¥éª¤1ï¼šåˆ›å»ºEvent
      const originalEvent = {
        id: 'event_test_001',
        eventlog: {
          slateJson: JSON.stringify([
            { type: 'paragraph', id: 'p-001', createdAt: Date.now(), children: [{ text: 'ä»»åŠ¡1' }] },
            { type: 'paragraph', id: 'p-002', createdAt: Date.now() + 1000, level: 1, bulletLevel: 1, children: [{ text: 'å­ä»»åŠ¡' }] }
          ])
        },
        tags: ['æµ‹è¯•', 'å®Œæ•´æµç¨‹'],
        parentEventId: 'event_root',
        bulletLevel: 1,
        createdAt: Date.now() - 3600000,
        fourDNoteSource: '4dnote',
        updatedAt: Date.now(),
        lastModifiedSource: 'outlook'
      };
      
      output.textContent += 'âœ… æ­¥éª¤1ï¼šåˆ›å»ºEvent\n';
      
      // æ­¥éª¤2ï¼šç”ŸæˆMetaï¼ˆåªåŒ…å«å†…å®¹çº§å…ƒæ•°æ®ï¼‰
      const meta = {
        v: 1,
        id: originalEvent.id,  // ğŸ”‘ Event ID
        slate: generateSlateMeta(originalEvent),
        // âŒ ä¸åŒ…å«tags/treeï¼ˆå…³ç³»æ•°æ®ï¼‰
        signature: generateSignatureMeta(originalEvent)
      };
      
      let description = `<!--4DNOTE-META:${JSON.stringify(meta)}-->\n<p>ä»»åŠ¡1</p>\n<p>å­ä»»åŠ¡</p>`;
      output.textContent += 'âœ… æ­¥éª¤2ï¼šç”ŸæˆMeta-Commentï¼ˆåªå«id/slate/signatureï¼‰\n';
      
      // æ­¥éª¤3ï¼šOutlookæ¨¡æ‹Ÿ
      if (enableCorruption) {
        description = description.replace(/<!--4DNOTE-META:.*?-->/g, '');
        description = description.replace(/<p>/g, '<div>').replace(/<\/p>/g, '</div>');
        output.textContent += 'âš ï¸ æ­¥éª¤3ï¼šOutlookç ´åï¼ˆæ¸…é™¤Meta + é‡å†™HTMLï¼‰\n';
      } else {
        output.textContent += 'âœ… æ­¥éª¤3ï¼šOutlookä¿æŒMetaå®Œæ•´\n';
      }
      
      // æ­¥éª¤4ï¼šè§£æMeta
      const metaMatch = description.match(/<!--4DNOTE-META:(.*?)-->/);
      let parsedEvent;
      
      if (metaMatch) {
        const parsedMeta = JSON.parse(metaMatch[1]);
        parsedEvent = deserializeMeta(parsedMeta);
        output.textContent += 'âœ… æ­¥éª¤4ï¼šMeta-Commentè§£ææˆåŠŸ\n';
      } else {
        parsedEvent = { eventlog: { slateJson: '[]' }, tags: [] };
        output.textContent += 'âš ï¸ æ­¥éª¤4ï¼šé™çº§åˆ°Block-Levelè§£æ\n';
      }
      
      // æ­¥éª¤5ï¼šDifféªŒè¯ï¼ˆåªéªŒè¯Metaä¸­ä¿å­˜çš„å­—æ®µï¼‰
      output.textContent += '\nâœ… æ­¥éª¤5ï¼šè¿è¡ŒDifféªŒè¯...\n';
      
      const tbody = document.getElementById('full-diff-tbody');
      tbody.innerHTML = '';
      
      const comparisons = [
        { category: 'Event ID', field: 'id', orig: originalEvent.id, parsed: parsedEvent.id },
        { category: 'Slate', field: 'èŠ‚ç‚¹æ•°é‡', orig: JSON.parse(originalEvent.eventlog.slateJson).length, parsed: parsedEvent.eventlog ? JSON.parse(parsedEvent.eventlog.slateJson).length : 0 },
        { category: 'Signature', field: 'createdAt', orig: originalEvent.createdAt, parsed: parsedEvent.createdAt },
        { category: 'Signature', field: 'updatedAt', orig: originalEvent.updatedAt, parsed: parsedEvent.updatedAt },
        { category: 'Signature', field: 'fourDNoteSource', orig: originalEvent.fourDNoteSource, parsed: parsedEvent.fourDNoteSource },
        { category: 'Signature', field: 'source', orig: originalEvent.source, parsed: parsedEvent.source }
        // âŒ ä¸éªŒè¯tags/treeï¼ˆMetaä¸­ä¸ä¿å­˜ï¼Œéœ€ä»æœ¬åœ°ServiceæŸ¥è¯¢ï¼‰
      ];
      
      let matchCount = 0;
      
      for (const comp of comparisons) {
        const match = comp.orig === comp.parsed;
        if (match) matchCount++;
        
        const row = tbody.insertRow();
        row.className = match ? 'diff-match' : 'diff-mismatch';
        row.innerHTML = `
          <td>${comp.category}</td>
          <td>${comp.field}</td>
          <td>${comp.orig}</td>
          <td>${comp.parsed}</td>
          <td>${match ? 'âœ“ åŒ¹é…' : 'âœ— ä¸åŒ¹é…'}</td>
        `;
      }
      
      const accuracy = ((matchCount / comparisons.length) * 100).toFixed(1);
      output.textContent += `\nå®Œæ•´æ€§ï¼š${accuracy}% (${matchCount}/${comparisons.length})\n`;
      output.textContent += accuracy >= 95 ? '\nâœ… æµ‹è¯•é€šè¿‡ï¼Meta-Commentå·¥ä½œæ­£å¸¸' : '\nâš ï¸ éƒ¨åˆ†å…ƒæ•°æ®ä¸¢å¤±';
    }

    // ========== åˆå§‹åŒ– ==========
    window.onload = function() {
      loadSignatureSample();
      console.log('æµ‹è¯•å·¥å…·åŠ è½½å®Œæˆ');
    };
  </script>
</body>
</html>
