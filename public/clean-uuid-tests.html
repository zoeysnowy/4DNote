<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ğŸ§¹ æ¸…ç† UUID æµ‹è¯•æ•°æ®</title>
  <style>
    body {
      font-family: 'Consolas', 'Monaco', monospace;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
      border-radius: 6px;
      border: 1px solid #555;
      background: linear-gradient(to bottom, #3a3a3a, #2a2a2a);
      color: #fff;
    }
    button:hover { background: linear-gradient(to bottom, #4a4a4a, #3a3a3a); }
    button.danger {
      background: linear-gradient(to bottom, #d32f2f, #c62828);
      border-color: #b71c1c;
    }
    button.danger:hover {
      background: linear-gradient(to bottom, #e53935, #d32f2f);
    }
    #output {
      background: #252526;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 13px;
      max-height: 600px;
      overflow-y: auto;
    }
    .info { color: #4fc3f7; }
    .success { color: #81c784; }
    .warning { color: #ffb74d; }
    .error { color: #e57373; }
  </style>
</head>
<body>
  <h1>ğŸ§¹ æ¸…ç† UUID æµ‹è¯•æ•°æ®</h1>
  <p>åˆ é™¤æ‰€æœ‰æ ‡é¢˜åŒ…å« "UUIDæ ¹äº‹ä»¶" æˆ– "L1-"ã€"L2-" ç­‰çš„æµ‹è¯•äº‹ä»¶</p>
  
  <button onclick="scan()">1ï¸âƒ£ æ‰«ææµ‹è¯•æ•°æ®</button>
  <button onclick="cleanAll()" id="cleanBtn" class="danger" disabled>2ï¸âƒ£ åˆ é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®</button>
  
  <div id="output"></div>

  <script type="module">
    import { EventService } from '../src/services/EventService.js';
    import { EventHub } from '../src/services/EventHub.js';
    window.EventService = EventService;
    window.EventHub = EventHub;

    let testEvents = [];

    function log(msg, type = 'info') {
      const output = document.getElementById('output');
      const colors = {
        info: '#4fc3f7',
        success: '#81c784',
        warning: '#ffb74d',
        error: '#e57373'
      };
      const time = new Date().toLocaleTimeString();
      output.innerHTML += `<span style="color: ${colors[type]}">[${time}] ${msg}</span>\n`;
      output.scrollTop = output.scrollHeight;
      console.log(msg);
    }

    window.scan = async function() {
      document.getElementById('output').innerHTML = '';
      log('ğŸ” æ‰«ææµ‹è¯•æ•°æ®...', 'info');

      try {
        const all = await EventService.getAllEvents();
        log(`âœ… è¯»å–äº‹ä»¶ï¼š${all.length} ä¸ª`, 'success');

        // æ‰¾å‡ºæ‰€æœ‰ UUID æµ‹è¯•äº‹ä»¶
        testEvents = all.filter(e => {
          const t = e.title?.simpleTitle || '';
          return t.includes('UUIDæ ¹äº‹ä»¶') || 
                 t.includes('L1-') || t.includes('L2-') || 
                 t.includes('L3-') || t.includes('L4-');
        });

        log(`\nğŸ“Š å‘ç° UUID æµ‹è¯•äº‹ä»¶ï¼š${testEvents.length} ä¸ª`, 'warning');

        // æŒ‰ bulletLevel åˆ†ç»„
        const byLevel = {};
        testEvents.forEach(e => {
          const level = e.bulletLevel || 0;
          if (!byLevel[level]) byLevel[level] = [];
          byLevel[level].push(e);
        });

        Object.keys(byLevel).sort((a, b) => Number(a) - Number(b)).forEach(level => {
          log(`  L${level}: ${byLevel[level].length} ä¸ªäº‹ä»¶`, 'info');
        });

        // æ˜¾ç¤ºæ—¶é—´åˆ†å¸ƒ
        const byTime = {};
        testEvents.forEach(e => {
          const t = e.title?.simpleTitle || '';
          const match = t.match(/(\d{2}:\d{2}:\d{2})/);
          if (match) {
            const time = match[1];
            if (!byTime[time]) byTime[time] = 0;
            byTime[time]++;
          }
        });

        log(`\nâ° æ—¶é—´åˆ†å¸ƒï¼š`, 'info');
        Object.entries(byTime).sort().forEach(([time, count]) => {
          log(`  ${time}: ${count} ä¸ªäº‹ä»¶`, 'info');
        });

        if (testEvents.length > 0) {
          document.getElementById('cleanBtn').disabled = false;
          log(`\nâš ï¸ å‡†å¤‡åˆ é™¤ ${testEvents.length} ä¸ªæµ‹è¯•äº‹ä»¶`, 'warning');
        } else {
          log(`\nâœ… æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ•°æ®`, 'success');
        }

      } catch (err) {
        log(`\nâŒ æ‰«æå¤±è´¥: ${err.message}`, 'error');
        console.error(err);
      }
    };

    window.cleanAll = async function() {
      if (testEvents.length === 0) {
        log('æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ•°æ®', 'info');
        return;
      }

      const confirm1 = confirm(`ç¡®è®¤åˆ é™¤ ${testEvents.length} ä¸ª UUID æµ‹è¯•äº‹ä»¶ï¼Ÿ\n\nè¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®ï¼`);
      if (!confirm1) return;

      const confirm2 = confirm(`å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤ ${testEvents.length} ä¸ªäº‹ä»¶å—ï¼Ÿ`);
      if (!confirm2) return;

      log(`\nğŸ§¹ å¼€å§‹åˆ é™¤ ${testEvents.length} ä¸ªäº‹ä»¶...`, 'warning');
      document.getElementById('cleanBtn').disabled = true;

      let deleted = 0;
      let failed = 0;

      for (const event of testEvents) {
        try {
          await EventHub.deleteEvent(event.id, false);
          deleted++;

          if (deleted % 50 === 0) {
            log(`  è¿›åº¦: ${deleted}/${testEvents.length}`, 'info');
          }
        } catch (err) {
          failed++;
          if (failed <= 5) {
            log(`  âŒ åˆ é™¤å¤±è´¥ [${event.id.slice(-8)}]: ${err.message}`, 'error');
          }
        }
      }

      log(`\nâœ… åˆ é™¤å®Œæˆï¼`, 'success');
      log(`  æˆåŠŸ: ${deleted} ä¸ª`, 'success');
      if (failed > 0) {
        log(`  å¤±è´¥: ${failed} ä¸ª`, 'error');
      }

      log(`\nğŸ’¡ å»ºè®®ï¼š`, 'info');
      log(`  1. åˆ·æ–° Plan é¡µé¢ï¼ŒéªŒè¯äº‹ä»¶å·²åˆ é™¤`, 'info');
      log(`  2. è¿è¡Œ test-uuid-migration.html é‡æ–°åˆ›å»ºæµ‹è¯•æ•°æ®`, 'info');

      testEvents = [];
    };
  </script>
</body>
</html>
