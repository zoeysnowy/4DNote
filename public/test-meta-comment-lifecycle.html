<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meta-Comment ç”Ÿå‘½å‘¨æœŸæµ‹è¯•å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .content {
      padding: 30px;
    }

    .info-card {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
    }

    .info-card h3 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .test-section {
      margin-bottom: 30px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
    }

    .test-section h2 {
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      color: white;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
    }

    .btn-warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
    }

    .btn-info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .btn-info:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
    }

    .output-box {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
    }

    .result-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
    }

    .result-panel h4 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .result-panel pre {
      background: white;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.85em;
      max-height: 300px;
      overflow-y: auto;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
      margin-left: 10px;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
    }

    .status-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .diff-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9em;
    }

    .diff-table th {
      background: #667eea;
      color: white;
      padding: 10px;
      text-align: left;
    }

    .diff-table td {
      padding: 8px;
      border-bottom: 1px solid #dee2e6;
    }

    .diff-table tr:hover {
      background: #f8f9fa;
    }

    .diff-match {
      background: #d4edda;
    }

    .diff-mismatch {
      background: #f8d7da;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      padding: 0 20px;
    }

    .step {
      flex: 1;
      text-align: center;
      position: relative;
      padding: 10px;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: -50%;
      width: 100%;
      height: 2px;
      background: #dee2e6;
      z-index: -1;
    }

    .step.active {
      color: #667eea;
      font-weight: 600;
    }

    .step.active::before {
      content: 'â—';
      display: block;
      font-size: 2em;
      color: #667eea;
    }

    .step.completed::before {
      content: 'âœ“';
      display: block;
      font-size: 2em;
      color: #38ef7d;
    }

    .step:not(.active):not(.completed)::before {
      content: 'â—‹';
      display: block;
      font-size: 2em;
      color: #dee2e6;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }

    .input-group input,
    .input-group textarea,
    .input-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.95em;
    }

    .input-group textarea {
      font-family: 'Courier New', monospace;
      min-height: 150px;
      resize: vertical;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .log-entry {
      padding: 8px;
      margin: 4px 0;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .log-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .log-success {
      background: #d4edda;
      color: #155724;
    }

    .log-error {
      background: #f8d7da;
      color: #721c24;
    }

    .log-warning {
      background: #fff3cd;
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”¬ Meta-Comment ç”Ÿå‘½å‘¨æœŸæµ‹è¯•å·¥å…·</h1>
      <p>æµ‹è¯• EventLog çš„ä¿å­˜ã€æ¸²æŸ“ã€åŒæ­¥ã€è§£æã€å­˜å‚¨å’Œ Diff æ¯”å¯¹</p>
    </div>

    <div class="content">
      <!-- æµ‹è¯•æµç¨‹æŒ‡ç¤ºå™¨ -->
      <div class="step-indicator">
        <div class="step" id="step1">åˆ›å»ºäº‹ä»¶</div>
        <div class="step" id="step2">ç”ŸæˆMeta-Comment</div>
        <div class="step" id="step3">æ¨¡æ‹ŸOutlookåŒæ­¥</div>
        <div class="step" id="step4">è§£æå›æ¥</div>
        <div class="step" id="step5">Diffæ¯”å¯¹</div>
      </div>

      <!-- æµ‹è¯•è¯´æ˜ -->
      <div class="info-card">
        <h3>ğŸ“‹ æµ‹è¯•æµç¨‹è¯´æ˜</h3>
        <ul>
          <li>æ­¥éª¤1ï¼šåˆ›å»ºåŒ…å«å¤æ‚SlateèŠ‚ç‚¹çš„Eventï¼ˆparagraphã€headingã€bulletLevelç­‰ï¼‰</li>
          <li>æ­¥éª¤2ï¼šè°ƒç”¨ slateNodesToHtmlWithMeta() ç”Ÿæˆå¸¦Meta-Commentçš„HTML</li>
          <li>æ­¥éª¤3ï¼šæ¨¡æ‹ŸOutlookå¾€è¿”ï¼ˆå¯é€‰æ‹©æ¸…é™¤Meta-Commentæµ‹è¯•é™çº§ï¼‰</li>
          <li>æ­¥éª¤4ï¼šè°ƒç”¨ parseMetaComments() æˆ– parseTextWithBlockTimestamps() è§£æ</li>
          <li>æ­¥éª¤5ï¼šå¯¹æ¯”åŸå§‹SlateèŠ‚ç‚¹ä¸è§£æåèŠ‚ç‚¹ï¼ŒéªŒè¯å…ƒæ•°æ®å®Œæ•´æ€§</li>
        </ul>
      </div>

      <!-- æ­¥éª¤1ï¼šåˆ›å»ºæµ‹è¯•æ•°æ® -->
      <div class="test-section">
        <h2>æ­¥éª¤1ï¼šåˆ›å»ºæµ‹è¯• EventLog</h2>
        
        <div class="input-group">
          <label>é€‰æ‹©æµ‹è¯•åœºæ™¯ï¼š</label>
          <select id="scenario-select" onchange="loadScenario()">
            <option value="simple">ç®€å•æ®µè½ï¼ˆ1ä¸ªparagraphï¼‰</option>
            <option value="multi">å¤šæ®µè½ï¼ˆ3ä¸ªparagraphï¼‰</option>
            <option value="headings">å±‚çº§æ ‡é¢˜ï¼ˆheading-one/two + paragraphsï¼‰</option>
            <option value="nested">åµŒå¥—äº‹ä»¶ï¼ˆbulletLevel 0-2ï¼‰</option>
            <option value="complex">å¤æ‚æ··åˆï¼ˆæ‰€æœ‰ç±»å‹ï¼‰</option>
            <option value="custom">è‡ªå®šä¹‰JSON</option>
          </select>
        </div>

        <div class="input-group">
          <label>Slate JSON æ•°æ®ï¼š</label>
          <textarea id="slate-json" placeholder='[{"type":"paragraph","id":"p-001","createdAt":1734620000000,"children":[{"text":"æµ‹è¯•æ®µè½"}]}]'></textarea>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" onclick="createTestEvent()">åˆ›å»ºäº‹ä»¶</button>
          <button class="btn btn-info" onclick="validateSlateJson()">éªŒè¯JSON</button>
        </div>

        <div id="create-output" class="output-box" style="display:none;"></div>
      </div>

      <!-- æ­¥éª¤2ï¼šç”ŸæˆMeta-Comment -->
      <div class="test-section">
        <h2>æ­¥éª¤2ï¼šç”Ÿæˆ Meta-Comment HTML</h2>
        
        <div class="button-group">
          <button class="btn btn-primary" onclick="generateMetaComment()">ç”Ÿæˆ Meta-Comment</button>
          <button class="btn btn-success" onclick="renderHtml()">æ¸²æŸ“é¢„è§ˆ</button>
        </div>

        <div class="result-grid">
          <div class="result-panel">
            <h4>Meta-Comment HTML</h4>
            <pre id="meta-html-output"></pre>
          </div>
          <div class="result-panel">
            <h4>æ¸²æŸ“é¢„è§ˆ</h4>
            <div id="render-preview" style="padding:10px;background:white;border-radius:4px;"></div>
          </div>
        </div>
      </div>

      <!-- æ­¥éª¤3ï¼šæ¨¡æ‹ŸOutlookåŒæ­¥ -->
      <div class="test-section">
        <h2>æ­¥éª¤3ï¼šæ¨¡æ‹Ÿ Outlook å¾€è¿”</h2>
        
        <div class="checkbox-group">
          <input type="checkbox" id="strip-meta" onchange="updateOutlookSimulation()">
          <label for="strip-meta">æ¨¡æ‹Ÿ Outlook æ¸…é™¤ Meta-Commentï¼ˆæµ‹è¯•é™çº§åˆ°Block-Levelï¼‰</label>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="rewrite-html" onchange="updateOutlookSimulation()">
          <label for="rewrite-html">æ¨¡æ‹Ÿ Outlook é‡å†™HTMLæ ‡ç­¾</label>
        </div>

        <div class="button-group">
          <button class="btn btn-warning" onclick="simulateOutlookSync()">æ¨¡æ‹ŸåŒæ­¥å¾€è¿”</button>
        </div>

        <div class="result-panel">
          <h4>Outlook è¿”å›çš„ HTML</h4>
          <pre id="outlook-html-output"></pre>
        </div>
      </div>

      <!-- æ­¥éª¤4ï¼šè§£æå›æ¥ -->
      <div class="test-section">
        <h2>æ­¥éª¤4ï¼šè§£æ Description</h2>
        
        <div class="button-group">
          <button class="btn btn-primary" onclick="parseDescription()">è§£æ Meta-Comment</button>
          <button class="btn btn-success" onclick="parseBlockLevel()">é™çº§ Block-Level è§£æ</button>
        </div>

        <div class="result-grid">
          <div class="result-panel">
            <h4>è§£ææ–¹å¼</h4>
            <pre id="parse-method-output"></pre>
          </div>
          <div class="result-panel">
            <h4>è§£æåçš„ Slate JSON</h4>
            <pre id="parsed-slate-output"></pre>
          </div>
        </div>
      </div>

      <!-- æ­¥éª¤5ï¼šDiffæ¯”å¯¹ -->
      <div class="test-section">
        <h2>æ­¥éª¤5ï¼šå…ƒæ•°æ®å®Œæ•´æ€§éªŒè¯</h2>
        
        <div class="button-group">
          <button class="btn btn-primary" onclick="runDiffComparison()">è¿è¡Œ Diff æ¯”å¯¹</button>
          <button class="btn btn-success" onclick="runFullLifecycleTest()">ğŸš€ è¿è¡Œå®Œæ•´ç”Ÿå‘½å‘¨æœŸæµ‹è¯•</button>
        </div>

        <div id="diff-output" class="output-box" style="display:none;"></div>

        <div class="result-panel" style="margin-top:20px;">
          <h4>å…ƒæ•°æ®å®Œæ•´æ€§æŠ¥å‘Š</h4>
          <table class="diff-table" id="metadata-table">
            <thead>
              <tr>
                <th>å­—æ®µ</th>
                <th>åŸå§‹å€¼</th>
                <th>è§£æåå€¼</th>
                <th>çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody id="metadata-tbody">
              <tr>
                <td colspan="4" style="text-align:center;color:#999;">è¿è¡ŒDiffæ¯”å¯¹åæ˜¾ç¤ºç»“æœ</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- æµ‹è¯•æ—¥å¿— -->
      <div class="test-section">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <div id="test-log" class="output-box"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== å…¨å±€çŠ¶æ€ ==========
    let currentState = {
      originalSlateNodes: null,
      metaCommentHtml: null,
      outlookHtml: null,
      parsedSlateNodes: null,
      parseMethod: null
    };

    // ========== æµ‹è¯•åœºæ™¯ ==========
    const testScenarios = {
      simple: [
        {
          type: 'paragraph',
          id: 'p-001',
          createdAt: Date.now(),
          children: [{ text: 'è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ®µè½æµ‹è¯•' }]
        }
      ],
      multi: [
        {
          type: 'paragraph',
          id: 'p-001',
          createdAt: Date.now(),
          children: [{ text: 'ç¬¬ä¸€æ®µï¼šåˆ›å»ºæµ‹è¯•äº‹ä»¶' }]
        },
        {
          type: 'paragraph',
          id: 'p-002',
          createdAt: Date.now() + 1000,
          children: [{ text: 'ç¬¬äºŒæ®µï¼šåŒæ­¥åˆ°Outlook' }]
        },
        {
          type: 'paragraph',
          id: 'p-003',
          createdAt: Date.now() + 2000,
          children: [{ text: 'ç¬¬ä¸‰æ®µï¼šéªŒè¯å…ƒæ•°æ®å®Œæ•´æ€§' }]
        }
      ],
      headings: [
        {
          type: 'heading-one',
          id: 'h1-001',
          createdAt: Date.now(),
          level: 0,
          children: [{ text: 'ä¸€çº§æ ‡é¢˜ï¼šé¡¹ç›®è§„åˆ’' }]
        },
        {
          type: 'paragraph',
          id: 'p-001',
          createdAt: Date.now() + 500,
          level: 1,
          children: [{ text: 'éœ€æ±‚åˆ†æé˜¶æ®µ' }]
        },
        {
          type: 'heading-two',
          id: 'h2-001',
          createdAt: Date.now() + 1000,
          level: 1,
          children: [{ text: 'äºŒçº§æ ‡é¢˜ï¼šæŠ€æœ¯é€‰å‹' }]
        },
        {
          type: 'paragraph',
          id: 'p-002',
          createdAt: Date.now() + 1500,
          level: 2,
          children: [{ text: 'React + TypeScript' }]
        }
      ],
      nested: [
        {
          type: 'paragraph',
          id: 'p-root',
          createdAt: Date.now(),
          bulletLevel: 0,
          children: [{ text: 'æ ¹äº‹ä»¶' }]
        },
        {
          type: 'paragraph',
          id: 'p-child1',
          createdAt: Date.now() + 1000,
          bulletLevel: 1,
          level: 1,
          children: [{ text: 'å­äº‹ä»¶1' }]
        },
        {
          type: 'paragraph',
          id: 'p-child2',
          createdAt: Date.now() + 2000,
          bulletLevel: 1,
          level: 1,
          children: [{ text: 'å­äº‹ä»¶2' }]
        },
        {
          type: 'paragraph',
          id: 'p-grandchild',
          createdAt: Date.now() + 3000,
          bulletLevel: 2,
          level: 2,
          children: [{ text: 'å­™äº‹ä»¶' }]
        }
      ],
      complex: [
        {
          type: 'heading-one',
          id: 'h1-001',
          createdAt: Date.now(),
          bulletLevel: 0,
          level: 0,
          children: [{ text: 'å¤æ‚æµ‹è¯•åœºæ™¯' }]
        },
        {
          type: 'paragraph',
          id: 'p-001',
          createdAt: Date.now() + 500,
          updatedAt: Date.now() + 1000,
          bulletLevel: 0,
          level: 1,
          children: [{ text: 'åŒ…å«æ›´æ–°æ—¶é—´æˆ³çš„æ®µè½' }]
        },
        {
          type: 'heading-two',
          id: 'h2-001',
          createdAt: Date.now() + 1500,
          bulletLevel: 1,
          level: 1,
          children: [{ text: 'å­ä»»åŠ¡ç»„' }]
        },
        {
          type: 'paragraph',
          id: 'p-002',
          createdAt: Date.now() + 2000,
          bulletLevel: 1,
          level: 2,
          children: [{ text: 'å­ä»»åŠ¡1ï¼šè®¾è®¡Meta-Commentæ ¼å¼' }]
        },
        {
          type: 'paragraph',
          id: 'p-003',
          createdAt: Date.now() + 2500,
          bulletLevel: 1,
          level: 2,
          children: [{ text: 'å­ä»»åŠ¡2ï¼šå®ç°è§£æé€»è¾‘' }]
        },
        {
          type: 'paragraph',
          id: 'p-004',
          createdAt: Date.now() + 3000,
          bulletLevel: 2,
          level: 3,
          children: [{ text: 'åµŒå¥—ä»»åŠ¡ï¼šå•å…ƒæµ‹è¯•' }]
        }
      ]
    };

    // ========== å·¥å…·å‡½æ•° ==========
    function log(message, type = 'info') {
      const logDiv = document.getElementById('test-log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStep(stepNum, state) {
      for (let i = 1; i <= 5; i++) {
        const step = document.getElementById(`step${i}`);
        step.classList.remove('active', 'completed');
        if (i < stepNum) {
          step.classList.add('completed');
        } else if (i === stepNum) {
          step.classList.add('active');
        }
      }
    }

    // ========== æ­¥éª¤1ï¼šåŠ è½½åœºæ™¯ ==========
    function loadScenario() {
      const scenario = document.getElementById('scenario-select').value;
      const textarea = document.getElementById('slate-json');
      
      if (scenario === 'custom') {
        textarea.value = '';
        textarea.placeholder = 'è¯·è¾“å…¥è‡ªå®šä¹‰ Slate JSON...';
      } else {
        textarea.value = JSON.stringify(testScenarios[scenario], null, 2);
      }
      
      log(`åŠ è½½æµ‹è¯•åœºæ™¯: ${scenario}`, 'info');
    }

    function validateSlateJson() {
      const jsonText = document.getElementById('slate-json').value;
      try {
        const nodes = JSON.parse(jsonText);
        if (!Array.isArray(nodes)) {
          throw new Error('Slate JSON å¿…é¡»æ˜¯æ•°ç»„');
        }
        
        for (const node of nodes) {
          if (!node.type) throw new Error('èŠ‚ç‚¹ç¼ºå°‘ type å­—æ®µ');
          if (!node.children) throw new Error('èŠ‚ç‚¹ç¼ºå°‘ children å­—æ®µ');
        }
        
        log('âœ… Slate JSON éªŒè¯é€šè¿‡', 'success');
        alert('âœ… JSON æ ¼å¼æ­£ç¡®ï¼');
      } catch (err) {
        log(`âŒ JSON éªŒè¯å¤±è´¥: ${err.message}`, 'error');
        alert(`âŒ JSON æ ¼å¼é”™è¯¯ï¼š${err.message}`);
      }
    }

    function createTestEvent() {
      const jsonText = document.getElementById('slate-json').value;
      
      if (!jsonText || !jsonText.trim()) {
        alert('âŒ è¯·å…ˆè¾“å…¥æˆ–é€‰æ‹©æµ‹è¯•åœºæ™¯ï¼');
        log('åˆ›å»ºå¤±è´¥ï¼šJSONæ•°æ®ä¸ºç©º', 'error');
        return;
      }
      
      try {
        const nodes = JSON.parse(jsonText);
        
        if (!Array.isArray(nodes)) {
          throw new Error('Slate JSON å¿…é¡»æ˜¯æ•°ç»„');
        }
        
        if (nodes.length === 0) {
          throw new Error('Slate JSON æ•°ç»„ä¸èƒ½ä¸ºç©º');
        }
        
        currentState.originalSlateNodes = nodes;
        
        const output = document.getElementById('create-output');
        output.style.display = 'block';
        output.innerHTML = `
<span class="status-badge status-success">âœ“ åˆ›å»ºæˆåŠŸ</span>

åŸå§‹ Slate èŠ‚ç‚¹æ•°é‡: ${nodes.length}
èŠ‚ç‚¹ç±»å‹: ${nodes.map(n => n.type).join(', ')}
åŒ…å«æ—¶é—´æˆ³: ${nodes.filter(n => n.createdAt).length}/${nodes.length}
åŒ…å«ID: ${nodes.filter(n => n.id).length}/${nodes.length}

å®Œæ•´æ•°æ®:
${JSON.stringify(nodes, null, 2)}
        `;
        
        // æ»šåŠ¨åˆ°è¾“å‡ºæ¡†
        output.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        log(`âœ… åˆ›å»ºäº‹ä»¶æˆåŠŸï¼ŒåŒ…å« ${nodes.length} ä¸ªèŠ‚ç‚¹`, 'success');
        updateStep(2, 'active');
        
        alert(`âœ… åˆ›å»ºæˆåŠŸï¼åŒ…å« ${nodes.length} ä¸ªèŠ‚ç‚¹ï¼Œç°åœ¨å¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥äº†`);
      } catch (err) {
        log(`âŒ åˆ›å»ºäº‹ä»¶å¤±è´¥: ${err.message}`, 'error');
        alert(`âŒ åˆ›å»ºå¤±è´¥ï¼š${err.message}\n\nè¯·æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æ­£ç¡®`);
        console.error('createEvent error:', err);
      }
    }

    // ========== æ­¥éª¤2ï¼šç”ŸæˆMeta-Comment ==========
    function slateNodesToHtmlWithMeta(nodes) {
      if (!nodes || !Array.isArray(nodes)) return '';
      
      return nodes.map(node => {
        // æ„å»ºå…ƒæ•°æ®
        const meta = {
          v: 1,
          t: node.type || 'paragraph'
        };
        
        if (node.id) meta.id = node.id;
        if (node.createdAt) meta.ts = node.createdAt;
        if (node.updatedAt) meta.ut = node.updatedAt;
        if (node.level !== undefined) meta.lvl = node.level;
        if (node.bulletLevel !== undefined) meta.bullet = node.bulletLevel;
        
        // ç”ŸæˆHTMLå†…å®¹
        const text = node.children?.map(c => c.text || '').join('') || '';
        const htmlTag = getHtmlTag(node.type);
        const htmlContent = `<${htmlTag}>${text}</${htmlTag}>`;
        
        // åŒ…è£¹ Meta-Comment
        return `<!--SLATE:${JSON.stringify(meta)}-->${htmlContent}<!--/SLATE-->`;
      }).join('\n');
    }

    function getHtmlTag(type) {
      const tagMap = {
        'paragraph': 'p',
        'heading-one': 'h1',
        'heading-two': 'h2',
        'heading-three': 'h3',
        'heading-four': 'h4',
        'heading-five': 'h5',
        'heading-six': 'h6'
      };
      return tagMap[type] || 'p';
    }

    function generateMetaComment() {
      if (!currentState.originalSlateNodes) {
        alert('è¯·å…ˆåˆ›å»ºäº‹ä»¶ï¼');
        return;
      }
      
      const html = slateNodesToHtmlWithMeta(currentState.originalSlateNodes);
      currentState.metaCommentHtml = html;
      
      document.getElementById('meta-html-output').textContent = html;
      
      log('ç”Ÿæˆ Meta-Comment HTML æˆåŠŸ', 'success');
      updateStep(3, 'active');
    }

    function renderHtml() {
      if (!currentState.metaCommentHtml) {
        alert('è¯·å…ˆç”Ÿæˆ Meta-Commentï¼');
        return;
      }
      
      // ç§»é™¤Meta-Commentåæ¸²æŸ“
      const cleanHtml = currentState.metaCommentHtml
        .replace(/<!--SLATE:.*?-->/g, '')
        .replace(/<!--\/SLATE-->/g, '');
      
      document.getElementById('render-preview').innerHTML = cleanHtml;
      log('æ¸²æŸ“HTMLé¢„è§ˆ', 'info');
    }

    // ========== æ­¥éª¤3ï¼šæ¨¡æ‹ŸOutlookåŒæ­¥ ==========
    function updateOutlookSimulation() {
      // å®æ—¶é¢„è§ˆä¼šå‘ç”Ÿä»€ä¹ˆ
      const stripMeta = document.getElementById('strip-meta').checked;
      const rewriteHtml = document.getElementById('rewrite-html').checked;
      
      let desc = 'æ¨¡æ‹Ÿè®¾ç½®ï¼š';
      if (stripMeta) desc += ' [æ¸…é™¤Meta-Comment]';
      if (rewriteHtml) desc += ' [é‡å†™HTML]';
      if (!stripMeta && !rewriteHtml) desc += ' [ä¿æŒåŸæ ·]';
      
      log(desc, 'info');
    }

    function simulateOutlookSync() {
      if (!currentState.metaCommentHtml) {
        alert('è¯·å…ˆç”Ÿæˆ Meta-Commentï¼');
        return;
      }
      
      let outlookHtml = currentState.metaCommentHtml;
      const stripMeta = document.getElementById('strip-meta').checked;
      const rewriteHtml = document.getElementById('rewrite-html').checked;
      
      // æ¨¡æ‹ŸOutlookæ¸…é™¤Meta-Comment
      if (stripMeta) {
        outlookHtml = outlookHtml
          .replace(/<!--SLATE:.*?-->/g, '')
          .replace(/<!--\/SLATE-->/g, '');
        log('âš ï¸ Outlook æ¸…é™¤äº† Meta-Commentï¼ˆæµ‹è¯•é™çº§ï¼‰', 'warning');
      }
      
      // æ¨¡æ‹ŸOutlooké‡å†™HTML
      if (rewriteHtml) {
        outlookHtml = outlookHtml
          .replace(/<p>/g, '<div>')
          .replace(/<\/p>/g, '</div>');
        log('âš ï¸ Outlook é‡å†™äº†HTMLæ ‡ç­¾ (pâ†’div)', 'warning');
      }
      
      currentState.outlookHtml = outlookHtml;
      document.getElementById('outlook-html-output').textContent = outlookHtml;
      
      log('æ¨¡æ‹Ÿ Outlook å¾€è¿”å®Œæˆ', 'success');
      updateStep(4, 'active');
    }

    // ========== æ­¥éª¤4ï¼šè§£æ ==========
    function parseMetaComments(html) {
      if (!html || typeof html !== 'string') return null;
      
      const metaPattern = /<!--SLATE:(.*?)-->([\s\S]*?)<!--\/SLATE-->/g;
      const matches = [...html.matchAll(metaPattern)];
      
      if (matches.length === 0) return null;
      
      const nodes = [];
      for (const match of matches) {
        try {
          const meta = JSON.parse(match[1]);
          const htmlContent = match[2];
          
          const node = {
            type: meta.t,
            children: [{ text: htmlContent.replace(/<[^>]+>/g, '') }]
          };
          
          if (meta.id) node.id = meta.id;
          if (meta.ts) node.createdAt = meta.ts;
          if (meta.ut) node.updatedAt = meta.ut;
          if (meta.lvl !== undefined) node.level = meta.lvl;
          if (meta.bullet !== undefined) node.bulletLevel = meta.bullet;
          
          nodes.push(node);
        } catch (err) {
          console.warn('è§£æå¤±è´¥:', err);
          continue;
        }
      }
      
      return nodes.length > 0 ? nodes : null;
    }

    function parseTextWithBlockTimestamps(text) {
      const lines = text.split('\n');
      const nodes = [];
      
      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;
        
        // æ£€æµ‹æ—¶é—´æˆ³æ ¼å¼
        const timestampPattern = /^(\d{4}[-\/]\d{1,2}[-\/]\d{1,2}\s+\d{2}:\d{2}:\d{2})/;
        const match = trimmed.match(timestampPattern);
        
        if (match) {
          const timestamp = new Date(match[1].replace(/\//g, '-'));
          const remainingText = trimmed.substring(match[0].length).trim();
          
          nodes.push({
            type: 'paragraph',
            createdAt: timestamp.getTime(),
            children: [{ text: remainingText || '' }]
          });
        } else {
          nodes.push({
            type: 'paragraph',
            children: [{ text: trimmed }]
          });
        }
      }
      
      return nodes;
    }

    function parseDescription() {
      if (!currentState.outlookHtml) {
        alert('è¯·å…ˆæ¨¡æ‹Ÿ Outlook åŒæ­¥ï¼');
        return;
      }
      
      const nodes = parseMetaComments(currentState.outlookHtml);
      
      if (nodes) {
        currentState.parsedSlateNodes = nodes;
        currentState.parseMethod = 'Meta-Comment';
        
        document.getElementById('parse-method-output').innerHTML = `
<span class="status-badge status-success">âœ“ Meta-Comment è§£æ</span>

è§£ææ–¹å¼: parseMetaComments()
æˆåŠŸè§£æ: ${nodes.length} ä¸ªèŠ‚ç‚¹
å…ƒæ•°æ®å®Œæ•´æ€§: 100%
        `;
        
        document.getElementById('parsed-slate-output').textContent = JSON.stringify(nodes, null, 2);
        
        log('âœ… Meta-Comment è§£ææˆåŠŸ', 'success');
        updateStep(5, 'active');
      } else {
        log('âš ï¸ æœªæ‰¾åˆ° Meta-Commentï¼Œå°è¯•é™çº§è§£æ', 'warning');
        parseBlockLevel();
      }
    }

    function parseBlockLevel() {
      if (!currentState.outlookHtml) {
        alert('è¯·å…ˆæ¨¡æ‹Ÿ Outlook åŒæ­¥ï¼');
        return;
      }
      
      // ç§»é™¤HTMLæ ‡ç­¾ï¼Œæå–çº¯æ–‡æœ¬
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = currentState.outlookHtml;
      const plainText = tempDiv.textContent || tempDiv.innerText || '';
      
      const nodes = parseTextWithBlockTimestamps(plainText);
      
      currentState.parsedSlateNodes = nodes;
      currentState.parseMethod = 'Block-Level (é™çº§)';
      
      document.getElementById('parse-method-output').innerHTML = `
<span class="status-badge status-warning">âš  Block-Level é™çº§è§£æ</span>

è§£ææ–¹å¼: parseTextWithBlockTimestamps()
æˆåŠŸè§£æ: ${nodes.length} ä¸ªèŠ‚ç‚¹
å…ƒæ•°æ®å®Œæ•´æ€§: éƒ¨åˆ†ï¼ˆæ—¶é—´æˆ³+æ–‡æœ¬ï¼‰
IDä¿æŒ: âŒ é‡æ–°ç”Ÿæˆ
ç±»å‹è¯†åˆ«: âŒ å…¨éƒ¨ä¸º paragraph
      `;
      
      document.getElementById('parsed-slate-output').textContent = JSON.stringify(nodes, null, 2);
      
      log('âš ï¸ é™çº§åˆ° Block-Level è§£æ', 'warning');
      updateStep(5, 'active');
    }

    // ========== æ­¥éª¤5ï¼šDiffæ¯”å¯¹ ==========
    function runDiffComparison() {
      if (!currentState.originalSlateNodes || !currentState.parsedSlateNodes) {
        alert('è¯·å…ˆå®Œæˆå‰é¢çš„æ­¥éª¤ï¼');
        return;
      }
      
      const original = currentState.originalSlateNodes;
      const parsed = currentState.parsedSlateNodes;
      
      const tbody = document.getElementById('metadata-tbody');
      tbody.innerHTML = '';
      
      let totalFields = 0;
      let matchedFields = 0;
      
      // å¯¹æ¯”æ¯ä¸ªèŠ‚ç‚¹
      for (let i = 0; i < Math.max(original.length, parsed.length); i++) {
        const origNode = original[i];
        const parsedNode = parsed[i];
        
        if (!origNode || !parsedNode) {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td colspan="4" class="diff-mismatch">
              èŠ‚ç‚¹ ${i}: ${!origNode ? 'è§£æåç¼ºå¤±' : 'åŸå§‹ç¼ºå¤±'}
            </td>
          `;
          continue;
        }
        
        // æ·»åŠ èŠ‚ç‚¹åˆ†éš”
        const headerRow = tbody.insertRow();
        headerRow.innerHTML = `<td colspan="4" style="background:#667eea;color:white;font-weight:600;">èŠ‚ç‚¹ ${i} (${origNode.type})</td>`;
        
        // å¯¹æ¯”å­—æ®µ
        const fields = ['id', 'type', 'createdAt', 'updatedAt', 'level', 'bulletLevel'];
        
        for (const field of fields) {
          if (origNode[field] === undefined && parsedNode[field] === undefined) continue;
          
          totalFields++;
          const origValue = origNode[field];
          const parsedValue = parsedNode[field];
          const match = origValue === parsedValue;
          
          if (match) matchedFields++;
          
          const row = tbody.insertRow();
          row.className = match ? 'diff-match' : 'diff-mismatch';
          row.innerHTML = `
            <td>${field}</td>
            <td>${formatValue(origValue)}</td>
            <td>${formatValue(parsedValue)}</td>
            <td>${match ? 'âœ“ åŒ¹é…' : 'âœ— ä¸åŒ¹é…'}</td>
          `;
        }
        
        // å¯¹æ¯”æ–‡æœ¬å†…å®¹
        const origText = origNode.children?.map(c => c.text).join('') || '';
        const parsedText = parsedNode.children?.map(c => c.text).join('') || '';
        totalFields++;
        const textMatch = origText === parsedText;
        if (textMatch) matchedFields++;
        
        const textRow = tbody.insertRow();
        textRow.className = textMatch ? 'diff-match' : 'diff-mismatch';
        textRow.innerHTML = `
          <td>text</td>
          <td>${origText}</td>
          <td>${parsedText}</td>
          <td>${textMatch ? 'âœ“ åŒ¹é…' : 'âœ— ä¸åŒ¹é…'}</td>
        `;
      }
      
      // ç”ŸæˆæŠ¥å‘Š
      const accuracy = totalFields > 0 ? ((matchedFields / totalFields) * 100).toFixed(1) : 0;
      const diffOutput = document.getElementById('diff-output');
      diffOutput.style.display = 'block';
      diffOutput.innerHTML = `
<span class="status-badge ${accuracy >= 95 ? 'status-success' : accuracy >= 70 ? 'status-warning' : 'status-error'}">
  å…ƒæ•°æ®å®Œæ•´æ€§: ${accuracy}%
</span>

è§£ææ–¹å¼: ${currentState.parseMethod}
æ€»å­—æ®µæ•°: ${totalFields}
åŒ¹é…å­—æ®µæ•°: ${matchedFields}
ä¸åŒ¹é…å­—æ®µæ•°: ${totalFields - matchedFields}

${accuracy >= 95 ? 'âœ… Meta-Comment å·¥ä½œæ­£å¸¸ï¼Œå…ƒæ•°æ®å®Œæ•´ä¿ç•™ï¼' : 
  accuracy >= 70 ? 'âš ï¸ éƒ¨åˆ†å…ƒæ•°æ®ä¸¢å¤±ï¼Œå¯èƒ½æ˜¯é™çº§åˆ°Block-Levelè§£æ' :
  'âŒ å¤§é‡å…ƒæ•°æ®ä¸¢å¤±ï¼Œéœ€è¦æ£€æŸ¥å®ç°'}
      `;
      
      log(`Diff æ¯”å¯¹å®Œæˆï¼Œå‡†ç¡®ç‡: ${accuracy}%`, accuracy >= 95 ? 'success' : accuracy >= 70 ? 'warning' : 'error');
    }

    function formatValue(val) {
      if (val === undefined) return '<span style="color:#999;">undefined</span>';
      if (val === null) return '<span style="color:#999;">null</span>';
      if (typeof val === 'number' && val > 1000000000000) {
        return `${val} (${new Date(val).toLocaleString()})`;
      }
      return val;
    }

    // ========== å®Œæ•´ç”Ÿå‘½å‘¨æœŸæµ‹è¯• ==========
    function runFullLifecycleTest() {
      log('========== å¼€å§‹å®Œæ•´ç”Ÿå‘½å‘¨æœŸæµ‹è¯• ==========', 'info');
      
      // è‡ªåŠ¨è¿è¡Œæ‰€æœ‰æ­¥éª¤
      setTimeout(() => {
        loadScenario();
        setTimeout(() => {
          createTestEvent();
          setTimeout(() => {
            generateMetaComment();
            setTimeout(() => {
              simulateOutlookSync();
              setTimeout(() => {
                parseDescription();
                setTimeout(() => {
                  runDiffComparison();
                  log('========== å®Œæ•´ç”Ÿå‘½å‘¨æœŸæµ‹è¯•å®Œæˆ ==========', 'success');
                }, 500);
              }, 500);
            }, 500);
          }, 500);
        }, 500);
      }, 100);
    }

    // ========== åˆå§‹åŒ– ==========
    window.onload = function() {
      // è®¾ç½®é»˜è®¤åœºæ™¯ä¸ºmultiï¼ˆå¤šæ®µè½ï¼‰
      document.getElementById('scenario-select').value = 'multi';
      loadScenario();
      updateStep(1, 'active');
      log('æµ‹è¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'success');
      log('æç¤ºï¼šé€‰æ‹©æµ‹è¯•åœºæ™¯åï¼Œtextareaä¼šè‡ªåŠ¨å¡«å……æ•°æ®', 'info');
    };
  </script>
</body>
</html>
