<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº‹ä»¶è¯Šæ–­å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 32px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    h2 {
      color: #333;
      margin-bottom: 16px;
      font-size: 20px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .input-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      color: #555;
      font-weight: 500;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      margin-right: 10px;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .output {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      padding: 16px;
      margin-top: 16px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 600px;
      overflow-y: auto;
    }

    .success {
      background: #d4edda;
      border-color: #28a745;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }

    .warning {
      background: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }

    .info {
      background: #d1ecf1;
      border-color: #17a2b8;
      color: #0c5460;
    }

    .log-entry {
      padding: 8px;
      margin: 4px 0;
      border-left: 4px solid #999;
      background: white;
      border-radius: 4px;
    }

    .log-error {
      border-left-color: #dc3545;
      background: #fff5f5;
    }

    .log-warn {
      border-left-color: #ffc107;
      background: #fffef5;
    }

    .log-info {
      border-left-color: #17a2b8;
      background: #f5fbfc;
    }

    .log-success {
      border-left-color: #28a745;
      background: #f5fdf7;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” äº‹ä»¶å¤„ç†è¯Šæ–­å·¥å…·</h1>

    <div class="section">
      <h2>è¾“å…¥äº‹ä»¶ ID æˆ–æ ‡é¢˜</h2>
      <div class="input-group">
        <label>äº‹ä»¶ IDï¼ˆå¯é€‰ï¼‰:</label>
        <input type="text" id="eventId" placeholder="ä¾‹å¦‚: evt-xxx">
      </div>
      <div class="input-group">
        <label>äº‹ä»¶æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰:</label>
        <input type="text" id="eventTitle" placeholder="ä¾‹å¦‚: 4DNoteå¼€å‘">
      </div>
      <button onclick="diagnoseEvent()">è¯Šæ–­äº‹ä»¶</button>
      <button onclick="checkConsoleErrors()">æ£€æŸ¥æ§åˆ¶å°é”™è¯¯</button>
      <button onclick="clearOutput()">æ¸…ç©º</button>
      <div id="output" class="output" style="display: none;"></div>
    </div>

    <div class="section">
      <h2>å®æ—¶æ—¥å¿—ç›‘æ§</h2>
      <button onclick="startLogCapture()">å¼€å§‹æ•è·æ—¥å¿—</button>
      <button onclick="stopLogCapture()">åœæ­¢æ•è·</button>
      <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
      <div id="logOutput" class="output" style="display: none;"></div>
    </div>
  </div>

  <script>
    let logCapturing = false;
    let capturedLogs = [];
    const originalConsole = {
      log: console.log,
      warn: console.warn,
      error: console.error,
      info: console.info
    };

    function startLogCapture() {
      logCapturing = true;
      capturedLogs = [];
      const logOutput = document.getElementById('logOutput');
      logOutput.style.display = 'block';
      logOutput.textContent = 'ğŸ“¡ å¼€å§‹æ•è·æ—¥å¿—...\n\n';

      // æ‹¦æˆª console æ–¹æ³•
      console.log = function(...args) {
        originalConsole.log.apply(console, args);
        if (logCapturing) {
          addLog('info', args);
        }
      };

      console.warn = function(...args) {
        originalConsole.warn.apply(console, args);
        if (logCapturing) {
          addLog('warn', args);
        }
      };

      console.error = function(...args) {
        originalConsole.error.apply(console, args);
        if (logCapturing) {
          addLog('error', args);
        }
      };
    }

    function stopLogCapture() {
      logCapturing = false;
      // æ¢å¤åŸå§‹ console
      console.log = originalConsole.log;
      console.warn = originalConsole.warn;
      console.error = originalConsole.error;
      
      const logOutput = document.getElementById('logOutput');
      logOutput.textContent = 'â¸ï¸ åœæ­¢æ•è·\n\n' + logOutput.textContent;
    }

    function addLog(type, args) {
      const timestamp = new Date().toLocaleTimeString('zh-CN');
      const message = args.map(arg => {
        if (typeof arg === 'object') {
          return JSON.stringify(arg, null, 2);
        }
        return String(arg);
      }).join(' ');

      capturedLogs.push({ type, timestamp, message });

      const logOutput = document.getElementById('logOutput');
      const logDiv = document.createElement('div');
      logDiv.className = `log-entry log-${type}`;
      
      let prefix = '';
      switch(type) {
        case 'error': prefix = 'âŒ'; break;
        case 'warn': prefix = 'âš ï¸'; break;
        case 'info': prefix = 'â„¹ï¸'; break;
        default: prefix = 'âœ…';
      }
      
      logDiv.textContent = `[${timestamp}] ${prefix} ${message}`;
      logOutput.appendChild(logDiv);
      
      // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    function clearLogs() {
      capturedLogs = [];
      const logOutput = document.getElementById('logOutput');
      logOutput.style.display = 'none';
      logOutput.innerHTML = '';
    }

    async function diagnoseEvent() {
      const eventId = document.getElementById('eventId').value.trim();
      const eventTitle = document.getElementById('eventTitle').value.trim();
      const output = document.getElementById('output');
      
      output.style.display = 'block';
      output.className = 'output info';
      output.textContent = 'ğŸ” æ­£åœ¨è¯Šæ–­...\n';

      try {
        // å°è¯•ä» IndexedDB è¯»å–äº‹ä»¶
        const db = await openDB();
        let event = null;

        if (eventId) {
          event = await getEventById(db, eventId);
        } else if (eventTitle) {
          event = await getEventByTitle(db, eventTitle);
        }

        if (!event) {
          output.className = 'output warning';
          output.textContent = 'âš ï¸ æœªæ‰¾åˆ°äº‹ä»¶\n\n';
          output.textContent += `æœç´¢æ¡ä»¶:\n`;
          if (eventId) output.textContent += `  ID: ${eventId}\n`;
          if (eventTitle) output.textContent += `  æ ‡é¢˜: ${eventTitle}\n`;
          return;
        }

        // åˆ†æäº‹ä»¶æ•°æ®
        let report = `âœ… æ‰¾åˆ°äº‹ä»¶\n\n`;
        report += `${'='.repeat(60)}\n`;
        report += `åŸºæœ¬ä¿¡æ¯\n`;
        report += `${'='.repeat(60)}\n`;
        report += `ID: ${event.id}\n`;
        report += `æ ‡é¢˜: ${typeof event.title === 'object' ? event.title.simpleTitle : event.title}\n`;
        report += `æ¥æº: ${event.source || 'N/A'}\n`;
        report += `åˆ›å»ºæ—¶é—´: ${event.createdAt}\n`;
        report += `æ›´æ–°æ—¶é—´: ${event.updatedAt}\n`;
        report += `åŒæ­¥çŠ¶æ€: ${event.syncStatus}\n\n`;

        // æ£€æŸ¥ eventlog
        report += `${'='.repeat(60)}\n`;
        report += `EventLog æ£€æŸ¥\n`;
        report += `${'='.repeat(60)}\n`;
        
        let eventlog = event.eventlog;
        if (typeof eventlog === 'string') {
          try {
            eventlog = JSON.parse(eventlog);
            report += `âœ… eventlog ç±»å‹: string â†’ å·²è§£æä¸º object\n`;
          } catch (e) {
            report += `âŒ eventlog è§£æå¤±è´¥: ${e.message}\n`;
          }
        } else {
          report += `âœ… eventlog ç±»å‹: object\n`;
        }

        if (eventlog && eventlog.slateJson) {
          let slateJson = eventlog.slateJson;
          if (typeof slateJson === 'string') {
            try {
              slateJson = JSON.parse(slateJson);
              report += `âœ… slateJson ç±»å‹: string â†’ å·²è§£æä¸º array\n`;
            } catch (e) {
              report += `âŒ slateJson è§£æå¤±è´¥: ${e.message}\n`;
            }
          } else {
            report += `âœ… slateJson ç±»å‹: ${Array.isArray(slateJson) ? 'array' : typeof slateJson}\n`;
          }

          if (Array.isArray(slateJson)) {
            report += `èŠ‚ç‚¹æ€»æ•°: ${slateJson.length}\n\n`;

            // åˆ†ææ¯ä¸ªèŠ‚ç‚¹
            slateJson.forEach((node, index) => {
              report += `  èŠ‚ç‚¹ ${index + 1}:\n`;
              report += `    ç±»å‹: ${node.type}\n`;
              
              if (node.createdAt) {
                const date = new Date(node.createdAt);
                report += `    âœ… createdAt: ${node.createdAt} (${date.toLocaleString('zh-CN')})\n`;
              } else {
                report += `    âš ï¸ createdAt: ç¼ºå¤±ï¼ˆä¼šå›é€€åˆ° Event.createdAtï¼‰\n`;
              }

              if (node.updatedAt) {
                const date = new Date(node.updatedAt);
                report += `    âœ… updatedAt: ${node.updatedAt} (${date.toLocaleString('zh-CN')})\n`;
              }

              if (node.children) {
                const text = node.children.map(c => c.text || '').join('');
                report += `    å†…å®¹: ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}\n`;
              }
              report += `\n`;
            });
          }
        } else {
          report += `âŒ slateJson ç¼ºå¤±\n`;
        }

        // æ£€æŸ¥ description
        report += `\n${'='.repeat(60)}\n`;
        report += `Description æ£€æŸ¥\n`;
        report += `${'='.repeat(60)}\n`;
        if (event.description) {
          report += `é•¿åº¦: ${event.description.length} å­—ç¬¦\n`;
          report += `å†…å®¹é¢„è§ˆ:\n${event.description.substring(0, 200)}\n`;
          
          // æ£€æŸ¥æ˜¯å¦åŒ…å«ç­¾å
          if (event.description.includes('ç”±') && event.description.includes('åˆ›å»ºäº')) {
            report += `\nâœ… åŒ…å«ç­¾å\n`;
          } else {
            report += `\nâš ï¸ æœªæ£€æµ‹åˆ°ç­¾å\n`;
          }
        } else {
          report += `âš ï¸ description ä¸ºç©º\n`;
        }

        // æ¨¡æ‹Ÿ EventNodeService å¤„ç†
        report += `\n${'='.repeat(60)}\n`;
        report += `EventNode ç”Ÿæˆé¢„æµ‹\n`;
        report += `${'='.repeat(60)}\n`;

        if (Array.isArray(slateJson)) {
          let nodeCount = 0;
          let hasBlockTimestamp = 0;
          let needsFallback = 0;

          slateJson.forEach(node => {
            if (node.type === 'paragraph') {
              const text = node.children?.map(c => c.text || '').join('').trim();
              if (text) {
                nodeCount++;
                if (node.createdAt) {
                  hasBlockTimestamp++;
                } else {
                  needsFallback++;
                }
              }
            }
          });

          report += `å¯ç”Ÿæˆçš„ EventNode æ•°é‡: ${nodeCount}\n`;
          report += `  - æœ‰ Block-Level Timestamp: ${hasBlockTimestamp}\n`;
          report += `  - éœ€è¦å›é€€åˆ° Event.createdAt: ${needsFallback}\n`;

          if (needsFallback > 0 && !event.createdAt) {
            report += `\nâŒ è­¦å‘Š: æœ‰ ${needsFallback} ä¸ªèŠ‚ç‚¹éœ€è¦å›é€€ï¼Œä½† Event.createdAt ç¼ºå¤±ï¼\n`;
          } else if (needsFallback > 0) {
            report += `\nâœ… P1 ä¿®å¤ç”Ÿæ•ˆ: ${needsFallback} ä¸ªèŠ‚ç‚¹å°†ä½¿ç”¨ Event.createdAt (${event.createdAt})\n`;
          }
        }

        output.textContent = report;
        output.className = 'output success';

      } catch (error) {
        output.className = 'output error';
        output.textContent = `âŒ è¯Šæ–­å¤±è´¥:\n${error.message}\n\n${error.stack}`;
      }
    }

    function checkConsoleErrors() {
      const output = document.getElementById('output');
      output.style.display = 'block';
      
      let report = `ğŸ” æ§åˆ¶å°é”™è¯¯æ£€æŸ¥\n\n`;
      report += `è¯·æ‰“å¼€æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼Œç„¶å:\n\n`;
      report += `1. åˆ‡æ¢åˆ° Console æ ‡ç­¾\n`;
      report += `2. ç­›é€‰ "Error" å’Œ "Warning"\n`;
      report += `3. æŸ¥æ‰¾åŒ…å«ä»¥ä¸‹å…³é”®è¯çš„æ—¥å¿—:\n`;
      report += `   - EventNodeService\n`;
      report += `   - extractParagraphs\n`;
      report += `   - syncNodesFromEvent\n`;
      report += `   - Block-Level\n`;
      report += `   - timestamp\n\n`;
      report += `æˆ–è€…ä½¿ç”¨ä¸Šæ–¹çš„ "å®æ—¶æ—¥å¿—ç›‘æ§" åŠŸèƒ½æ•è·æ—¥å¿—ã€‚\n`;
      
      output.textContent = report;
      output.className = 'output info';
    }

    function clearOutput() {
      document.getElementById('output').style.display = 'none';
    }

    // IndexedDB å·¥å…·å‡½æ•°
    async function openDB() {
      return new Promise((resolve, reject) => {
        // å°è¯•æ‰“å¼€æ•°æ®åº“ï¼Œä¸æŒ‡å®šç‰ˆæœ¬å·ï¼ˆä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼‰
        const request = indexedDB.open('4DNote');
        request.onsuccess = () => {
          const db = request.result;
          console.log('âœ… æ‰“å¼€æ•°æ®åº“æˆåŠŸ:', {
            name: db.name,
            version: db.version,
            objectStoreNames: Array.from(db.objectStoreNames)
          });
          resolve(db);
        };
        request.onerror = () => reject(request.error);
      });
    }

    async function findEventStore(db) {
      const storeNames = Array.from(db.objectStoreNames);
      console.log('ğŸ“‹ å¯ç”¨çš„ object stores:', storeNames);
      
      // å¯èƒ½çš„äº‹ä»¶å­˜å‚¨åç§°
      const possibleNames = ['events', 'Events', 'event', 'Event'];
      
      for (const name of possibleNames) {
        if (storeNames.includes(name)) {
          console.log('âœ… æ‰¾åˆ°äº‹ä»¶å­˜å‚¨:', name);
          return name;
        }
      }
      
      // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ªåŒ…å« 'event' çš„
      const eventStore = storeNames.find(name => name.toLowerCase().includes('event'));
      if (eventStore) {
        console.log('âœ… æ‰¾åˆ°å¯èƒ½çš„äº‹ä»¶å­˜å‚¨:', eventStore);
        return eventStore;
      }
      
      throw new Error(`æœªæ‰¾åˆ°äº‹ä»¶å­˜å‚¨ã€‚å¯ç”¨çš„å­˜å‚¨: ${storeNames.join(', ')}`);
    }

    async function getEventById(db, id) {
      const storeName = await findEventStore(db);
      return new Promise((resolve, reject) => {
        const tx = db.transaction([storeName], 'readonly');
        const store = tx.objectStore(storeName);
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function getEventByTitle(db, title) {
      const storeName = await findEventStore(db);
      return new Promise((resolve, reject) => {
        const tx = db.transaction([storeName], 'readonly');
        const store = tx.objectStore(storeName);
        const request = store.openCursor();
        
        request.onsuccess = (e) => {
          const cursor = e.target.result;
          if (cursor) {
            const event = cursor.value;
            const eventTitle = typeof event.title === 'object' 
              ? event.title.simpleTitle 
              : event.title;
            
            if (eventTitle && eventTitle.includes(title)) {
              resolve(event);
              return;
            }
            cursor.continue();
          } else {
            resolve(null);
          }
        };
        request.onerror = () => reject(request.error);
      });
    }

    console.log('ğŸš€ äº‹ä»¶è¯Šæ–­å·¥å…·å·²åŠ è½½');
    console.log('æç¤º: è¾“å…¥äº‹ä»¶ ID æˆ–æ ‡é¢˜ï¼Œç„¶åç‚¹å‡»"è¯Šæ–­äº‹ä»¶"æŒ‰é’®');
  </script>
</body>
</html>
