<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” éªŒè¯æ•°æ®åº“çˆ¶å­å…³ç³»</title>
  <style>
    body {
      font-family: 'Consolas', 'Monaco', monospace;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
      border-radius: 6px;
      border: 1px solid #555;
      background: linear-gradient(to bottom, #3a3a3a, #2a2a2a);
      color: #fff;
    }
    button:hover { background: linear-gradient(to bottom, #4a4a4a, #3a3a3a); }
    #output {
      background: #252526;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 13px;
      max-height: 800px;
      overflow-y: auto;
    }
    .info { color: #4fc3f7; }
    .success { color: #81c784; }
    .warning { color: #ffb74d; }
    .error { color: #e57373; }
    .row { margin: 8px 0; padding: 8px; background: #2d2d30; border-left: 3px solid #4fc3f7; }
    .parent { border-left-color: #81c784; }
    .child { border-left-color: #ffb74d; }
  </style>
</head>
<body>
  <h1>ğŸ” éªŒè¯æ•°æ®åº“çˆ¶å­å…³ç³»</h1>
  <p>ç›´æ¥ä»æ•°æ®åº“è¯»å–äº‹ä»¶ï¼ŒéªŒè¯ parentEventId å¼•ç”¨å®Œæ•´æ€§ï¼ˆADR-001ï¼šchildEventIds ä¸º legacy å­—æ®µï¼Œä¸ä½œä¸ºæ­£ç¡®æ€§ä¾æ®ï¼‰</p>
  
  <button onclick="verifyDatabase()">éªŒè¯æ•°æ®åº“</button>
  <button onclick="showRecentEvents()">æ˜¾ç¤ºæœ€è¿‘åˆ›å»ºçš„äº‹ä»¶</button>
  <button onclick="clearOutput()">æ¸…ç©º</button>
  
  <div id="output"></div>

  <script type="module">
    import { EventService } from '../src/services/EventService.js';
    import { storageManager } from '../src/services/storage/index.js';
    
    window.EventService = EventService;
    window.storageManager = storageManager;

    function log(msg, type = 'info') {
      const output = document.getElementById('output');
      const colors = {
        info: '#4fc3f7',
        success: '#81c784',
        warning: '#ffb74d',
        error: '#e57373'
      };
      const time = new Date().toLocaleTimeString();
      output.innerHTML += `<span style="color: ${colors[type]}">[${time}] ${msg}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    window.clearOutput = function() {
      document.getElementById('output').innerHTML = '';
    };

    window.verifyDatabase = async function() {
      log('ğŸ” å¼€å§‹éªŒè¯æ•°æ®åº“...', 'info');
      
      try {
        // ç›´æ¥ä» StorageManager è¯»å–æ‰€æœ‰äº‹ä»¶
        const result = await storageManager.queryEvents({
          limit: 1000
        });
        
        const events = result.items;
        log(`âœ… ä»æ•°æ®åº“è¯»å–äº† ${events.length} ä¸ªäº‹ä»¶`, 'success');
        
        // ç»Ÿè®¡æœ‰çˆ¶å­å…³ç³»çš„äº‹ä»¶
        const hasParent = events.filter(e => e.parentEventId);
        const hasChildren = events.filter(e => e.childEventIds && e.childEventIds.length > 0);
        
        log(`\nğŸ“Š çˆ¶å­å…³ç³»ç»Ÿè®¡:`, 'info');
        log(`  æœ‰ parentEventId: ${hasParent.length} ä¸ª`, 'info');
        log(`  æœ‰ childEventIds(legacy): ${hasChildren.length} ä¸ª`, 'info');
        
        // éªŒè¯ parentEventId å¼•ç”¨å®Œæ•´æ€§ï¼ˆADR-001ï¼šchildEventIds æ¼‚ç§»ä¸ç®—ç»“æ„é”™è¯¯ï¼‰
        let consistent = 0;
        let inconsistent = 0;
        const issues = [];
        let legacyDrift = 0;
        
        hasParent.forEach(child => {
          const parent = events.find(e => e.id === child.parentEventId);
          
          if (!parent) {
            inconsistent++;
            issues.push({
              type: 'missing_parent',
              child: child.id.slice(-8),
              childTitle: child.title?.simpleTitle || 'Untitled',
              missingParentId: child.parentEventId?.slice(-8)
            });
          } else {
            consistent++;

            // legacy driftï¼ˆä»…æç¤ºï¼‰ï¼šparent.childEventIds æœªå¿…ç»´æŠ¤
            if (parent.childEventIds && Array.isArray(parent.childEventIds) && !parent.childEventIds.includes(child.id)) {
              legacyDrift++;
              issues.push({
                type: 'legacy_drift',
                parent: parent.id.slice(-8),
                parentTitle: parent.title?.simpleTitle || 'Untitled',
                child: child.id.slice(-8),
                childTitle: child.title?.simpleTitle || 'Untitled',
                parentChildIds: parent.childEventIds || []
              });
            }
          }
        });
        
        log(`\nğŸ” parentEventId å¼•ç”¨å®Œæ•´æ€§æ£€æŸ¥:`, 'info');
        log(`  âœ… å¼•ç”¨å­˜åœ¨çˆ¶äº‹ä»¶: ${consistent} ä¸ª`, 'success');
        log(`  âŒ å¼•ç”¨ç¼ºå¤±çˆ¶äº‹ä»¶: ${inconsistent} ä¸ª`, inconsistent > 0 ? 'error' : 'info');
        log(`  â„¹ï¸ childEventIds æ¼‚ç§»(legacyï¼Œä»…æç¤º): ${legacyDrift} ä¸ª`, legacyDrift > 0 ? 'warning' : 'info');
        
        if (issues.length > 0) {
          log(`\nâš ï¸ å‘ç°çš„é—®é¢˜:`, 'warning');
          issues.forEach((issue, index) => {
            if (issue.type === 'missing_parent') {
              log(`  ${index + 1}. å­äº‹ä»¶ ${issue.child} "${issue.childTitle}" å¼•ç”¨äº†ä¸å­˜åœ¨çš„çˆ¶äº‹ä»¶ ${issue.missingParentId}`, 'error');
            } else if (issue.type === 'legacy_drift') {
              log(`  ${index + 1}. (legacy) çˆ¶äº‹ä»¶ ${issue.parent} "${issue.parentTitle}" çš„ childEventIds æœªåŒ…å«å­äº‹ä»¶ ${issue.child} "${issue.childTitle}"`, 'warning');
              log(`     å½“å‰ childEventIds: [${issue.parentChildIds.map(id => id.slice(-8)).join(', ')}]`, 'info');
            }
          });
        } else {
          log(`\nğŸ‰ parentEventId å¼•ç”¨å®Œæ•´ï¼`, 'success');
        }
        
      } catch (error) {
        log(`âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };

    window.showRecentEvents = async function() {
      log('ğŸ” æŸ¥è¯¢æœ€è¿‘åˆ›å»ºçš„äº‹ä»¶...', 'info');
      
      try {
        const result = await storageManager.queryEvents({
          limit: 20,
          sortBy: 'createdAt',
          sortOrder: 'desc'
        });
        
        const events = result.items;
        log(`âœ… æ‰¾åˆ° ${events.length} ä¸ªæœ€è¿‘åˆ›å»ºçš„äº‹ä»¶\n`, 'success');
        
        events.forEach((event, index) => {
          const baseId = event.id.slice(-8);
          const title = event.title?.simpleTitle || 'Untitled';
          const level = event.bulletLevel || 0;
          const parentId = event.parentEventId ? event.parentEventId.slice(-8) : 'null';
          const childIds = event.childEventIds ? event.childEventIds.map(id => id.slice(-8)).join(', ') : '[]';
          const createdAt = new Date(event.createdAt).toLocaleString();
          
          log(`${index + 1}. [${baseId}] "${title}"`, 'info');
          log(`   Level: ${level} | Parent: ${parentId} | childEventIds(legacy): [${childIds}]`, 'info');
          log(`   Created: ${createdAt}`, 'info');
          
          // éªŒè¯å…³ç³»
          if (event.parentEventId) {
            const parent = events.find(e => e.id === event.parentEventId);
            if (parent) {
              const legacyHasChild = parent.childEventIds?.includes(event.id);
              log(`   âœ“ çˆ¶äº‹ä»¶å­˜åœ¨(æœ€è¿‘åˆ—è¡¨å†…): ${parent.title?.simpleTitle || 'Untitled'}`, 'success');
              log(`     childEventIds(legacy) æ˜¯å¦åŒ…å«æ­¤å­äº‹ä»¶: ${legacyHasChild ? 'âœ…' : 'â€”ï¼ˆä¸è¦æ±‚ï¼‰'}`,
                  legacyHasChild ? 'info' : 'info');
            } else {
              log(`   âœ— çˆ¶äº‹ä»¶ä¸åœ¨æœ€è¿‘20ä¸ªäº‹ä»¶ä¸­ï¼ˆå¯èƒ½æ˜¯æ›´æ—©çš„äº‹ä»¶ï¼‰`, 'warning');
            }
          }
          log('', 'info');
        });
        
      } catch (error) {
        log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    };
    
    // è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡éªŒè¯
    setTimeout(() => {
      log('ğŸš€ è‡ªåŠ¨æ‰§è¡Œæ•°æ®åº“éªŒè¯...\n', 'info');
      verifyDatabase();
    }, 500);
  </script>
</body>
</html>
