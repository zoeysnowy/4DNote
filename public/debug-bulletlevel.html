<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BulletLevel è°ƒè¯•å·¥å…·</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; border-bottom: 3px solid #2196F3; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 30px; }
        button { 
            padding: 12px 24px; 
            margin: 5px; 
            cursor: pointer; 
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        button:hover { background: #1976D2; }
        button:active { background: #0D47A1; }
        pre { 
            background: #f9f9f9; 
            padding: 15px; 
            border-left: 4px solid #2196F3;
            overflow-x: auto;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
        }
        .event-item { 
            margin: 10px 0; 
            padding: 12px; 
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fafafa;
        }
        .indent-0 { margin-left: 0; }
        .indent-1 { margin-left: 30px; background: #e3f2fd; }
        .indent-2 { margin-left: 60px; background: #bbdefb; }
        .indent-3 { margin-left: 90px; background: #90caf9; }
        .warning { color: #f44336; font-weight: bold; }
        .success { color: #4caf50; font-weight: bold; }
        .info { color: #2196F3; font-weight: bold; }
        .event-id { font-family: monospace; color: #666; font-size: 11px; }
        .event-title { font-weight: 500; color: #333; }
        .event-meta { font-size: 12px; color: #888; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” BulletLevel æ•°æ®æµè°ƒè¯•å·¥å…·</h1>
        
        <div>
            <button onclick="checkBulletLevelData()">1ï¸âƒ£ æ£€æŸ¥æ•°æ®åº“ä¸­çš„ EventTree å­—æ®µ</button>
            <button onclick="checkSlateState()">2ï¸âƒ£ æ£€æŸ¥ Slate ç¼–è¾‘å™¨çŠ¶æ€</button>
            <button onclick="checkSortOrder()">3ï¸âƒ£ æ£€æŸ¥æ’åºç®—æ³•</button>
            <button onclick="simulateRefresh()">4ï¸âƒ£ æ¨¡æ‹Ÿåˆ·æ–°æµç¨‹</button>
            <button onclick="checkSerialization()">5ï¸âƒ£ æ£€æŸ¥åºåˆ—åŒ–è¿‡ç¨‹</button>
            <button onclick="checkTempIdIssues()" style="background: #e74c3c; color: white;">ğŸ”¥ 6ï¸âƒ£ æ£€æŸ¥ä¸´æ—¶IDé—®é¢˜</button>
            <button onclick="checkTempIdTracking()" style="background: #9b59b6; color: white;">ğŸ†• 7ï¸âƒ£ æ£€æŸ¥ä¸´æ—¶IDè¿½è¸ªç³»ç»Ÿï¼ˆv2.15ï¼‰</button>
        </div>
        
        <h2>ğŸ“Š æ£€æŸ¥ç»“æœï¼š</h2>
        <div id="output"></div>
    </div>

    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.innerHTML = `<span class="${type}">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            output.appendChild(div);
        }
        
        function logPre(data) {
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(data, null, 2);
            output.appendChild(pre);
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }

        // 1. æ£€æŸ¥æ•°æ®åº“ä¸­çš„ EventTree å­—æ®µ
        async function checkBulletLevelData() {
            clearOutput();
            log('ğŸ” æ­£åœ¨æ£€æŸ¥æ•°æ®åº“ä¸­çš„ EventTree æ•°æ®...', 'info');
            
            let events = [];
            const storageManager = window.storageManagerInstance;
            
            if (!storageManager) {
                log('âš ï¸ StorageManager æœªæ‰¾åˆ°ï¼Œå°è¯•ç›´æ¥è®¿é—® IndexedDB...', 'info');
                
                try {
                    const db = await new Promise((resolve, reject) => {
                        const request = indexedDB.open('4DNoteDB');  // ä¸æŒ‡å®šç‰ˆæœ¬ï¼Œä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                    
                    const tx = db.transaction(['events'], 'readonly');
                    const store = tx.objectStore('events');
                    const allEvents = await new Promise((resolve, reject) => {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                    
                    events = allEvents.filter(e => e.isPlan && !e.deletedAt);
                    log(`âœ… ç›´æ¥ä» IndexedDB æ‰¾åˆ° ${events.length} ä¸ª Plan äº‹ä»¶`, 'success');
                } catch (error) {
                    log('âŒ æ— æ³•è®¿é—® IndexedDB: ' + error.message, 'warning');
                    log('ğŸ’¡ è¯·åœ¨ä¸»åº”ç”¨é¡µé¢çš„æ§åˆ¶å°ä¸­è¿è¡Œæ­¤å·¥å…·', 'info');
                    return;
                }
            } else {
                // æŸ¥è¯¢æ‰€æœ‰ Plan äº‹ä»¶
                const result = await storageManager.queryEvents({ 
                    filters: { isPlan: true }, 
                    limit: 1000 
                });
                
                events = result.items;
                log(`âœ… æ‰¾åˆ° ${events.length} ä¸ª Plan äº‹ä»¶`, 'success');
            }
            
            // ç»Ÿè®¡ EventTree å­—æ®µ
            const withParent = events.filter(e => e.parentEventId);
            const withChildren = events.filter(e => e.childEventIds && e.childEventIds.length > 0);
            const withBulletLevel = events.filter(e => e.bulletLevel !== undefined);
            
            log(`ğŸ“Š ç»Ÿè®¡æ•°æ®ï¼š`, 'info');
            logPre({
                'æ€»äº‹ä»¶æ•°': events.length,
                'æœ‰ parentEventId': withParent.length,
                'æœ‰ childEventIds': withChildren.length,
                'æœ‰ bulletLevel': withBulletLevel.length,
                'å­¤ç«‹äº‹ä»¶ï¼ˆæ— çˆ¶æ— å­ï¼‰': events.filter(e => !e.parentEventId && (!e.childEventIds || e.childEventIds.length === 0)).length
            });
            
            // æ˜¾ç¤ºå‰10ä¸ªäº‹ä»¶çš„ EventTree æ•°æ®
            log(`\nğŸ“ å‰10ä¸ªäº‹ä»¶çš„è¯¦ç»†æ•°æ®ï¼š`, 'info');
            events.slice(0, 10).forEach((e, i) => {
                const div = document.createElement('div');
                div.className = `event-item indent-${e.bulletLevel || 0}`;
                div.innerHTML = `
                    <div class="event-title">${i + 1}. ${e.title?.simpleTitle || e.title || '(æ— æ ‡é¢˜)'}</div>
                    <div class="event-id">ID: ${e.id}</div>
                    <div class="event-meta">
                        bulletLevel: ${e.bulletLevel ?? 'undefined'} | 
                        parentEventId: ${e.parentEventId ? e.parentEventId.slice(-8) : 'null'} | 
                        childEventIds: ${e.childEventIds ? e.childEventIds.length : 0}
                    </div>
                `;
                output.appendChild(div);
            });
            
            // æ£€æŸ¥ ID æ ¼å¼
            const invalidIds = events.filter(e => !e.id || e.id.length !== 27);
            if (invalidIds.length > 0) {
                log(`âš ï¸ å‘ç° ${invalidIds.length} ä¸ªäº‹ä»¶ ID æ ¼å¼å¼‚å¸¸`, 'warning');
                logPre(invalidIds.map(e => ({ id: e.id, length: e.id?.length })));
            }
            
            // æ£€æŸ¥çˆ¶å­å…³ç³»å®Œæ•´æ€§
            log(`\nğŸ”— æ£€æŸ¥çˆ¶å­å…³ç³»å®Œæ•´æ€§ï¼š`, 'info');
            const eventMap = new Map(events.map(e => [e.id, e]));
            let brokenLinks = 0;
            
            events.forEach(e => {
                if (e.parentEventId && !eventMap.has(e.parentEventId)) {
                    brokenLinks++;
                    log(`âš ï¸ æ–­è£‚é“¾æ¥: ${e.id.slice(-8)} çš„çˆ¶äº‹ä»¶ ${e.parentEventId.slice(-8)} ä¸å­˜åœ¨`, 'warning');
                }
            });
            
            if (brokenLinks === 0) {
                log(`âœ… æ‰€æœ‰çˆ¶å­å…³ç³»å®Œæ•´`, 'success');
            } else {
                log(`âš ï¸ å‘ç° ${brokenLinks} ä¸ªæ–­è£‚çš„çˆ¶å­å…³ç³»`, 'warning');
            }
        }

        // 2. æ£€æŸ¥ Slate ç¼–è¾‘å™¨çŠ¶æ€
        function checkSlateState() {
            clearOutput();
            log('ğŸ” æ­£åœ¨æ£€æŸ¥ Slate ç¼–è¾‘å™¨çŠ¶æ€...', 'info');
            
            const planEvents = window.__PLAN_EVENTS__;
            if (!planEvents) {
                log('âŒ æ‰¾ä¸åˆ° __PLAN_EVENTS__ï¼Œè¯·åœ¨ Plan é¡µé¢è¿è¡Œæ­¤å·¥å…·', 'warning');
                return;
            }
            
            log(`âœ… æ‰¾åˆ° ${planEvents.length} ä¸ªå½“å‰æ¸²æŸ“çš„äº‹ä»¶`, 'success');
            
            // æ£€æŸ¥ bulletLevel åˆ†å¸ƒ
            const levelDistribution = {};
            planEvents.forEach(e => {
                const level = e.bulletLevel ?? 0;
                levelDistribution[level] = (levelDistribution[level] || 0) + 1;
            });
            
            log(`ğŸ“Š å±‚çº§åˆ†å¸ƒï¼š`, 'info');
            logPre(levelDistribution);
            
            // æ£€æŸ¥æ¸²æŸ“é¡ºåº
            log(`\nğŸ“ å½“å‰æ¸²æŸ“é¡ºåºï¼ˆå‰15ä¸ªï¼‰ï¼š`, 'info');
            planEvents.slice(0, 15).forEach((e, i) => {
                const div = document.createElement('div');
                div.className = `event-item indent-${e.bulletLevel || 0}`;
                div.innerHTML = `
                    <div class="event-title">${i + 1}. ${e.title?.simpleTitle || '(æ— æ ‡é¢˜)'}</div>
                    <div class="event-id">ID: ${e.id?.slice(-8)}</div>
                    <div class="event-meta">
                        bulletLevel: ${e.bulletLevel ?? 'undefined'} | 
                        parentEventId: ${e.parentEventId?.slice(-8) || 'null'}
                    </div>
                `;
                output.appendChild(div);
            });
        }

        // 3. æ£€æŸ¥æ’åºç®—æ³•
        async function checkSortOrder() {
            clearOutput();
            log('ğŸ” æ­£åœ¨æµ‹è¯•æ’åºç®—æ³•...', 'info');
            
            const storageManager = window.storageManagerInstance;
            const result = await storageManager.queryEvents({ 
                filters: { isPlan: true }, 
                limit: 1000 
            });
            
            const events = result.items;
            
            // æ¨¡æ‹Ÿ PlanManager çš„æ’åºé€»è¾‘
            const eventMap = new Map(events.map(e => [e.id, e]));
            const visited = new Set();
            const sortedEvents = [];
            
            // é€’å½’æ·»åŠ å‡½æ•°
            const addEventWithChildren = (event) => {
                if (visited.has(event.id)) return;
                
                visited.add(event.id);
                sortedEvents.push(event);
                
                const children = (event.childEventIds || [])
                    .map(childId => eventMap.get(childId))
                    .filter(child => !!child)
                    .sort((a, b) => {
                        const timeA = new Date(a.createdAt || 0).getTime();
                        const timeB = new Date(b.createdAt || 0).getTime();
                        return timeA - timeB;
                    });
                
                children.forEach(child => addEventWithChildren(child));
            };
            
            // æ‰¾å‡ºé¡¶å±‚äº‹ä»¶
            const topLevelEvents = events
                .filter(e => !e.parentEventId || !eventMap.get(e.parentEventId))
                .sort((a, b) => {
                    const timeA = new Date(a.createdAt || 0).getTime();
                    const timeB = new Date(b.createdAt || 0).getTime();
                    return timeA - timeB;
                });
            
            log(`âœ… æ‰¾åˆ° ${topLevelEvents.length} ä¸ªé¡¶å±‚äº‹ä»¶`, 'success');
            
            // æ‰§è¡Œæ’åº
            topLevelEvents.forEach(event => addEventWithChildren(event));
            
            // æ£€æŸ¥é—æ¼äº‹ä»¶
            const orphaned = events.filter(e => !visited.has(e.id));
            if (orphaned.length > 0) {
                log(`âš ï¸ å‘ç° ${orphaned.length} ä¸ªå­¤ç«‹äº‹ä»¶`, 'warning');
                orphaned.forEach(e => sortedEvents.push(e));
            }
            
            log(`\nğŸ“Š æ’åºç»“æœï¼š`, 'info');
            logPre({
                'åŸå§‹é¡ºåº': events.slice(0, 5).map(e => ({
                    id: e.id.slice(-8),
                    title: e.title?.simpleTitle?.slice(0, 20),
                    bulletLevel: e.bulletLevel
                })),
                'æ’åºåé¡ºåº': sortedEvents.slice(0, 5).map(e => ({
                    id: e.id.slice(-8),
                    title: e.title?.simpleTitle?.slice(0, 20),
                    bulletLevel: e.bulletLevel
                }))
            });
            
            // éªŒè¯çˆ¶å­é¡ºåº
            log(`\nğŸ”— éªŒè¯çˆ¶å­é¡ºåºï¼š`, 'info');
            let orderErrors = 0;
            sortedEvents.forEach((e, i) => {
                if (e.parentEventId) {
                    const parentIndex = sortedEvents.findIndex(p => p.id === e.parentEventId);
                    if (parentIndex === -1) {
                        log(`âš ï¸ äº‹ä»¶ ${e.id.slice(-8)} çš„çˆ¶äº‹ä»¶ä¸åœ¨åˆ—è¡¨ä¸­`, 'warning');
                        orderErrors++;
                    } else if (parentIndex > i) {
                        log(`âŒ é¡ºåºé”™è¯¯: å­äº‹ä»¶ ${e.id.slice(-8)} (ä½ç½®${i}) åœ¨çˆ¶äº‹ä»¶ ${e.parentEventId.slice(-8)} (ä½ç½®${parentIndex}) ä¹‹å‰`, 'warning');
                        orderErrors++;
                    }
                }
            });
            
            if (orderErrors === 0) {
                log(`âœ… æ‰€æœ‰çˆ¶å­é¡ºåºæ­£ç¡®`, 'success');
            } else {
                log(`âŒ å‘ç° ${orderErrors} ä¸ªé¡ºåºé”™è¯¯`, 'warning');
            }
        }

        // 4. æ¨¡æ‹Ÿåˆ·æ–°æµç¨‹
        async function simulateRefresh() {
            clearOutput();
            log('ğŸ”„ æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°æµç¨‹...', 'info');
            
            // å¯¼å…¥ EventService
            const EventService = window.EventService;
            if (!EventService) {
                log('âŒ EventService æœªåŠ è½½', 'warning');
                return;
            }
            
            const storageManager = window.storageManagerInstance;
            const result = await storageManager.queryEvents({ 
                filters: { isPlan: true }, 
                limit: 100 
            });
            
            const events = result.items;
            log(`âœ… åŠ è½½äº† ${events.length} ä¸ªäº‹ä»¶`, 'success');
            
            // è®¡ç®— bulletLevel
            log(`\nğŸ”¢ è®¡ç®— bulletLevel...`, 'info');
            const bulletLevels = EventService.calculateAllBulletLevels(events);
            
            log(`âœ… è®¡ç®—å®Œæˆ: ${bulletLevels.size} ä¸ªäº‹ä»¶`, 'success');
            
            // æ˜¾ç¤ºè®¡ç®—ç»“æœ
            const levelsArray = Array.from(bulletLevels.entries()).slice(0, 10);
            logPre(levelsArray.map(([id, level]) => ({
                id: id.slice(-8),
                level,
                event: events.find(e => e.id === id)?.title?.simpleTitle?.slice(0, 20)
            })));
            
            // é™„åŠ  bulletLevel
            const eventsWithLevels = events.map(e => ({
                ...e,
                bulletLevel: bulletLevels.get(e.id) || 0
            }));
            
            log(`\nğŸ“Š bulletLevel åˆ†å¸ƒï¼š`, 'info');
            const distribution = {};
            eventsWithLevels.forEach(e => {
                distribution[e.bulletLevel] = (distribution[e.bulletLevel] || 0) + 1;
            });
            logPre(distribution);
        }

        // 5. æ£€æŸ¥åºåˆ—åŒ–è¿‡ç¨‹
        function checkSerialization() {
            clearOutput();
            log('ğŸ” æ£€æŸ¥åºåˆ—åŒ–è¿‡ç¨‹...', 'info');
            
            const planEvents = window.__PLAN_EVENTS__;
            if (!planEvents) {
                log('âŒ æ‰¾ä¸åˆ° __PLAN_EVENTS__', 'warning');
                return;
            }
            
            log(`ğŸ“ æ£€æŸ¥åºåˆ—åŒ–å…³é”®å­—æ®µï¼š`, 'info');
            
            planEvents.slice(0, 10).forEach((e, i) => {
                const div = document.createElement('div');
                div.className = `event-item indent-${e.bulletLevel || 0}`;
                
                const checks = [];
                if (e.bulletLevel !== undefined) checks.push('âœ… bulletLevel');
                if (e.parentEventId) checks.push('âœ… parentEventId');
                if (e.childEventIds && e.childEventIds.length > 0) checks.push(`âœ… childEventIds(${e.childEventIds.length})`);
                
                div.innerHTML = `
                    <div class="event-title">${i + 1}. ${e.title?.simpleTitle || '(æ— æ ‡é¢˜)'}</div>
                    <div class="event-meta">
                        ${checks.join(' | ')}
                    </div>
                    <div class="event-id">bulletLevel: ${e.bulletLevel} | parentEventId: ${e.parentEventId?.slice(-8) || 'null'}</div>
                `;
                output.appendChild(div);
            });
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ bulletLevel ä¸º undefined çš„äº‹ä»¶
            const missingLevel = planEvents.filter(e => e.bulletLevel === undefined);
            if (missingLevel.length > 0) {
                log(`\nâš ï¸ å‘ç° ${missingLevel.length} ä¸ªäº‹ä»¶ç¼ºå°‘ bulletLevel`, 'warning');
            } else {
                log(`\nâœ… æ‰€æœ‰äº‹ä»¶éƒ½æœ‰ bulletLevel`, 'success');
            }
        }
        
        // ğŸ”¥ 6. æ£€æŸ¥ä¸´æ—¶IDé—®é¢˜ï¼ˆæ–°å¢ï¼‰
        async function checkTempIdIssues() {
            clearOutput();
            log('ğŸ”¥ å¼€å§‹æ£€æŸ¥ä¸´æ—¶IDé—®é¢˜...', 'info');
            
            try {
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('4DNoteDB');  // ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                const tx = db.transaction(['events'], 'readonly');
                const store = tx.objectStore('events');
                const allEvents = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                log(`âœ… æˆåŠŸè¯»å– ${allEvents.length} ä¸ªäº‹ä»¶`, 'success');
                
                // æ£€æŸ¥1: æŸ¥æ‰¾æ‰€æœ‰åŒ…å«ä¸´æ—¶IDçš„ parentEventId
                const tempIdParents = allEvents.filter(e => 
                    e.parentEventId && e.parentEventId.startsWith('line-')
                );
                
                if (tempIdParents.length > 0) {
                    log(`\nâŒ å‘ç° ${tempIdParents.length} ä¸ªäº‹ä»¶çš„ parentEventId æ˜¯ä¸´æ—¶IDï¼`, 'warning');
                    tempIdParents.forEach(e => {
                        log(`  â€¢ äº‹ä»¶ ${e.id.slice(-8)}: parentEventId = ${e.parentEventId}`, 'warning');
                        log(`    æ ‡é¢˜: ${e.title?.simpleTitle || e.content || '(ç©º)'}`, 'info');
                    });
                } else {
                    log(`\nâœ… æ²¡æœ‰å‘ç°ä¸´æ—¶IDä½œä¸º parentEventId`, 'success');
                }
                
                // æ£€æŸ¥2: æŸ¥æ‰¾æ‰€æœ‰ childEventIds ä¸­åŒ…å«ä¸´æ—¶IDçš„äº‹ä»¶
                const tempIdChildren = allEvents.filter(e => 
                    e.childEventIds && Array.isArray(e.childEventIds) && 
                    e.childEventIds.some(id => id.startsWith('line-'))
                );
                
                if (tempIdChildren.length > 0) {
                    log(`\nâŒ å‘ç° ${tempIdChildren.length} ä¸ªäº‹ä»¶çš„ childEventIds åŒ…å«ä¸´æ—¶IDï¼`, 'warning');
                    tempIdChildren.forEach(e => {
                        const tempIds = e.childEventIds.filter(id => id.startsWith('line-'));
                        log(`  â€¢ äº‹ä»¶ ${e.id.slice(-8)}: ä¸´æ—¶å­ID = ${tempIds.join(', ')}`, 'warning');
                    });
                } else {
                    log(`\nâœ… æ²¡æœ‰å‘ç° childEventIds ä¸­åŒ…å«ä¸´æ—¶ID`, 'success');
                }
                
                // æ£€æŸ¥3: æŸ¥æ‰¾å­¤å„¿äº‹ä»¶ï¼ˆparentEventIdæŒ‡å‘çš„çˆ¶äº‹ä»¶ä¸å­˜åœ¨ï¼‰
                const eventMap = new Map(allEvents.map(e => [e.id, e]));
                const orphans = allEvents.filter(e => {
                    if (!e.parentEventId) return false;
                    return !eventMap.has(e.parentEventId);
                });
                
                if (orphans.length > 0) {
                    log(`\nâš ï¸ å‘ç° ${orphans.length} ä¸ªå­¤å„¿äº‹ä»¶ï¼ˆçˆ¶äº‹ä»¶ä¸å­˜åœ¨ï¼‰ï¼`, 'warning');
                    orphans.forEach(e => {
                        log(`  â€¢ äº‹ä»¶ ${e.id.slice(-8)}: çˆ¶ID ${e.parentEventId?.slice(-8)} ä¸å­˜åœ¨`, 'warning');
                        log(`    æ ‡é¢˜: ${e.title?.simpleTitle || e.content || '(ç©º)'}`, 'info');
                    });
                } else {
                    log(`\nâœ… æ²¡æœ‰å‘ç°å­¤å„¿äº‹ä»¶`, 'success');
                }
                
                // æ£€æŸ¥4: æ£€æŸ¥åŒå‘å…³ç³»ä¸€è‡´æ€§
                let inconsistencies = 0;
                allEvents.forEach(event => {
                    if (event.childEventIds && Array.isArray(event.childEventIds)) {
                        event.childEventIds.forEach(childId => {
                            const child = eventMap.get(childId);
                            if (child && child.parentEventId !== event.id) {
                                log(`\nâŒ å…³ç³»ä¸ä¸€è‡´: ${event.id.slice(-8)} â†’ ${childId.slice(-8)}`, 'warning');
                                inconsistencies++;
                            }
                        });
                    }
                });
                
                if (inconsistencies === 0) {
                    log(`\nâœ… EventTree åŒå‘å…³ç³»ä¸€è‡´`, 'success');
                } else {
                    log(`\nâŒ å‘ç° ${inconsistencies} ä¸ªå…³ç³»ä¸ä¸€è‡´`, 'warning');
                }
                
                // æ£€æŸ¥5: ç»Ÿè®¡
                const topLevel = allEvents.filter(e => !e.parentEventId).length;
                const children = allEvents.filter(e => e.parentEventId).length;
                log(`\nğŸ“Š EventTree ç»Ÿè®¡:`, 'info');
                log(`  â€¢ é¡¶å±‚äº‹ä»¶: ${topLevel}`, 'info');
                log(`  â€¢ å­äº‹ä»¶: ${children}`, 'info');
                
                log(`\nâœ… ä¸´æ—¶IDæ£€æŸ¥å®Œæˆ`, 'success');
                
            } catch (error) {
                log(`\nâŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'warning');
                console.error(error);
            }
        }
        
        // ğŸ”¥ æ–°å¢ï¼šæ£€æŸ¥ä¸´æ—¶IDè¿½è¸ªç³»ç»Ÿï¼ˆv2.15ï¼‰
        async function checkTempIdTracking() {
            clearOutput();
            log('ğŸ”¥ æ£€æŸ¥ä¸´æ—¶IDè¿½è¸ªç³»ç»Ÿï¼ˆv2.15æ–°åŠŸèƒ½ï¼‰...', 'info');
            
            try {
                const db = await new Promise((resolve, reject) => {
                    const request = indexedDB.open('4DNoteDB');  // ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                // æ£€æŸ¥1: æŸ¥è¯¢æ‰€æœ‰å¸¦æœ‰ä¸´æ—¶IDæ ‡è®°çš„äº‹ä»¶
                const tx = db.transaction(['events'], 'readonly');
                const store = tx.objectStore('events');
                const allEvents = await new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                const tempIdEvents = allEvents.filter(e => e._isTempId || e._originalTempId);
                
                if (tempIdEvents.length > 0) {
                    log(`\nâš ï¸ å‘ç° ${tempIdEvents.length} ä¸ªäº‹ä»¶ä»å¸¦æœ‰ä¸´æ—¶IDæ ‡è®°ï¼š`, 'warning');
                    tempIdEvents.forEach(e => {
                        log(`  â€¢ ID: ${e.id} | åŸå§‹ä¸´æ—¶ID: ${e._originalTempId}`, 'info');
                        log(`    æ ‡é¢˜: ${e.title?.simpleTitle || '(ç©º)'}`, 'info');
                    });
                } else {
                    log(`\nâœ… æ‰€æœ‰äº‹ä»¶å·²æ­£ç¡®è½¬æ¢ä¸ºçœŸå®ID`, 'success');
                }
                
                // æ£€æŸ¥2: æŸ¥è¯¢EventHistoryä¸­çš„ä¸´æ—¶IDæ˜ å°„è®°å½•
                // æ³¨æ„ï¼šéœ€è¦è®¿é—®SQLiteï¼Œè¿™é‡Œç®€åŒ–ä¸ºæ£€æŸ¥localStorageå¤‡ä»½
                log(`\nğŸ” æ£€æŸ¥EventHistoryä¸­çš„ä¸´æ—¶IDæ˜ å°„è®°å½•...`, 'info');
                log(`ğŸ“ æç¤ºï¼šå®Œæ•´æ˜ å°„è®°å½•åœ¨SQLiteæ•°æ®åº“ä¸­ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—`, 'info');
                
                // æ£€æŸ¥3: éªŒè¯çˆ¶å­å…³ç³»æ˜¯å¦å·²è‡ªåŠ¨ä¿®å¤
                const eventsWithParent = allEvents.filter(e => e.parentEventId);
                let fixedCount = 0;
                
                eventsWithParent.forEach(e => {
                    if (e.parentEventId && !e.parentEventId.startsWith('line-')) {
                        fixedCount++;
                    }
                });
                
                log(`\nğŸ“Š çˆ¶å­å…³ç³»éªŒè¯:`, 'info');
                log(`  â€¢ æœ‰çˆ¶äº‹ä»¶çš„äº‹ä»¶æ€»æ•°: ${eventsWithParent.length}`, 'info');
                log(`  â€¢ ä½¿ç”¨çœŸå®IDçš„äº‹ä»¶: ${fixedCount}`, 'success');
                log(`  â€¢ ä»ä½¿ç”¨ä¸´æ—¶IDçš„äº‹ä»¶: ${eventsWithParent.length - fixedCount}`, eventsWithParent.length === fixedCount ? 'success' : 'warning');
                
                if (eventsWithParent.length === fixedCount) {
                    log(`\nâœ… ä¸´æ—¶IDè¿½è¸ªç³»ç»Ÿå·¥ä½œæ­£å¸¸ï¼`, 'success');
                } else {
                    log(`\nâš ï¸ è¿˜æœ‰äº‹ä»¶æœªä¿®å¤ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—`, 'warning');
                }
                
            } catch (error) {
                log(`\nâŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'warning');
                console.error(error);
            }
        }
    </script>
</body>
</html>
