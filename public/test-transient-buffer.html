<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transient Write Buffer æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .test-section h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-section h2::before {
            content: 'âš¡';
            font-size: 24px;
        }
        
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .result pre {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #495057;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .timeline {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 3px solid #667eea;
        }
        
        .timeline-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .timeline-item strong {
            color: #667eea;
            font-weight: 600;
        }
        
        .highlight {
            background: #fffbea;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Transient Write Buffer æµ‹è¯•å·¥å…·</h1>
            <p>éªŒè¯ "ä¸´æ—¶å†™å…¥ç¼“å†²" æœºåˆ¶ - Read-Your-Own-Writes ä¸€è‡´æ€§</p>
        </div>
        
        <div class="content">
            <!-- æµ‹è¯•1: çˆ¶å­äº‹ä»¶å¿«é€Ÿåˆ›å»º -->
            <div class="test-section">
                <h2>æµ‹è¯•åœºæ™¯1: çˆ¶å­äº‹ä»¶å¿«é€Ÿåˆ›å»º (Tab è¿ç»­æ“ä½œ)</h2>
                <p style="color: #6c757d; margin-bottom: 15px; font-size: 14px;">
                    æ¨¡æ‹Ÿç”¨æˆ·åœ¨ Plan é¡µé¢è¾“å…¥ 3 è¡Œï¼ŒæŒ‰ Tab é”®å¿«é€Ÿåˆ›å»ºå±‚çº§ç»“æ„
                </p>
                <button class="btn" onclick="testRapidParentChild()">ğŸš€ å¼€å§‹æµ‹è¯•</button>
                <button class="btn btn-success" onclick="verifyEventTree()">ğŸ” éªŒè¯ EventTree</button>
                <div id="result1" class="result" style="display: none;"></div>
            </div>
            
            <!-- æµ‹è¯•2: å¹¶å‘æ›´æ–°æ£€æµ‹ -->
            <div class="test-section">
                <h2>æµ‹è¯•åœºæ™¯2: å¹¶å‘æ›´æ–° childEventIds</h2>
                <p style="color: #6c757d; margin-bottom: 15px; font-size: 14px;">
                    æ¨¡æ‹ŸåŒæ—¶æ·»åŠ å¤šä¸ªå­äº‹ä»¶åˆ°åŒä¸€çˆ¶äº‹ä»¶ï¼ŒéªŒè¯ç¼“å†²åŒºé¿å…è¦†ç›–
                </p>
                <button class="btn" onclick="testConcurrentUpdates()">ğŸ”„ å¼€å§‹æµ‹è¯•</button>
                <div id="result2" class="result" style="display: none;"></div>
            </div>
            
            <!-- æµ‹è¯•3: ç¼“å†²åŒºç”Ÿå‘½å‘¨æœŸ -->
            <div class="test-section">
                <h2>æµ‹è¯•åœºæ™¯3: ç¼“å†²åŒºç”Ÿå‘½å‘¨æœŸ (å­˜å®Œå³ç„š)</h2>
                <p style="color: #6c757d; margin-bottom: 15px; font-size: 14px;">
                    éªŒè¯äº‹ä»¶å†™å…¥æˆåŠŸåç«‹å³ä»ç¼“å†²åŒºæ¸…é™¤ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
                </p>
                <button class="btn" onclick="testBufferLifecycle()">ğŸ—‘ï¸ å¼€å§‹æµ‹è¯•</button>
                <div id="result3" class="result" style="display: none;"></div>
            </div>
            
            <!-- æ¸…ç†æŒ‰é’® -->
            <div class="test-section">
                <button class="btn btn-danger" onclick="cleanupTestData()">ğŸ§¹ æ¸…ç†æµ‹è¯•æ•°æ®</button>
            </div>
        </div>
    </div>

    <script>
        // IndexedDB è¾…åŠ©å‡½æ•°
        async function getDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('4DNote', 3);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getEvent(id) {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('events', 'readonly');
                const store = tx.objectStore('events');
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAllEvents() {
            const db = await getDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('events', 'readonly');
                const store = tx.objectStore('events');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // æµ‹è¯•1: å¿«é€Ÿåˆ›å»ºçˆ¶å­äº‹ä»¶
        async function testRapidParentChild() {
            const resultDiv = document.getElementById('result1');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p><strong>æµ‹è¯•è¿›è¡Œä¸­...</strong> <span class="status pending">RUNNING</span></p>';

            try {
                const timeline = [];
                const startTime = Date.now();
                
                // æ¨¡æ‹Ÿ EventService
                const EventServiceAPI = {
                    async createEvent(event) {
                        const response = await fetch('/api/events', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(event)
                        });
                        return response.json();
                    },
                    async updateEvent(id, updates) {
                        const response = await fetch(`/api/events/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updates)
                        });
                        return response.json();
                    },
                    async getEventById(id) {
                        const response = await fetch(`/api/events/${id}`);
                        return response.json();
                    }
                };

                // T0: åˆ›å»ºçˆ¶äº‹ä»¶ A
                timeline.push(`T0 (${Date.now() - startTime}ms): åˆ›å»ºçˆ¶äº‹ä»¶ A`);
                const parentA = {
                    title: { simpleTitle: 'æµ‹è¯•ä¸€çº§', fullTitle: '<p>æµ‹è¯•ä¸€çº§</p>' },
                    bulletLevel: 0,
                    tags: [],
                    eventlog: { slateJson: '[{"type":"paragraph","children":[{"text":"æµ‹è¯•ä¸€çº§"}]}]', html: '<p>æµ‹è¯•ä¸€çº§</p>', plainText: 'æµ‹è¯•ä¸€çº§' }
                };
                const resultA = await EventServiceAPI.createEvent(parentA);
                const parentId = resultA.event.id;
                timeline.push(`T1 (${Date.now() - startTime}ms): çˆ¶äº‹ä»¶ A å·²åˆ›å»ºï¼ŒID = ${parentId.slice(-8)}`);

                // T2 (10mså): åˆ›å»ºå­äº‹ä»¶ Bï¼Œéœ€è¦æ›´æ–° A çš„ childEventIds
                await new Promise(r => setTimeout(r, 10));
                timeline.push(`T2 (${Date.now() - startTime}ms): åˆ›å»ºå­äº‹ä»¶ Bï¼Œè®¾ç½® parentEventId`);
                
                const childB = {
                    title: { simpleTitle: 'æµ‹è¯•äºŒçº§', fullTitle: '<p>æµ‹è¯•äºŒçº§</p>' },
                    bulletLevel: 1,
                    parentEventId: parentId,
                    tags: [],
                    eventlog: { slateJson: '[{"type":"paragraph","children":[{"text":"æµ‹è¯•äºŒçº§"}]}]', html: '<p>æµ‹è¯•äºŒçº§</p>', plainText: 'æµ‹è¯•äºŒçº§' }
                };
                const resultB = await EventServiceAPI.createEvent(childB);
                const childBId = resultB.event.id;
                timeline.push(`T3 (${Date.now() - startTime}ms): å­äº‹ä»¶ B å·²åˆ›å»ºï¼ŒID = ${childBId.slice(-8)}`);

                // T4: ç«‹å³æŸ¥è¯¢çˆ¶äº‹ä»¶ Aï¼ˆå…³é”®æ—¶åˆ»ï¼ï¼‰
                timeline.push(`T4 (${Date.now() - startTime}ms): <span class="highlight">æŸ¥è¯¢çˆ¶äº‹ä»¶ A - æµ‹è¯• Read-Your-Own-Writes</span>`);
                const parentAUpdated = await EventServiceAPI.getEventById(parentId);
                
                const hasChild = parentAUpdated.childEventIds?.includes(childBId);
                timeline.push(`T5 (${Date.now() - startTime}ms): ${hasChild ? 'âœ… æˆåŠŸï¼çˆ¶äº‹ä»¶åŒ…å«å­äº‹ä»¶' : 'âŒ å¤±è´¥ï¼çˆ¶äº‹ä»¶æœªåŒ…å«å­äº‹ä»¶'}`);

                // T6: åˆ›å»ºå­™å­äº‹ä»¶ C
                await new Promise(r => setTimeout(r, 10));
                const childC = {
                    title: { simpleTitle: 'æµ‹è¯•ä¸‰çº§', fullTitle: '<p>æµ‹è¯•ä¸‰çº§</p>' },
                    bulletLevel: 2,
                    parentEventId: childBId,
                    tags: [],
                    eventlog: { slateJson: '[{"type":"paragraph","children":[{"text":"æµ‹è¯•ä¸‰çº§"}]}]', html: '<p>æµ‹è¯•ä¸‰çº§</p>', plainText: 'æµ‹è¯•ä¸‰çº§' }
                };
                const resultC = await EventServiceAPI.createEvent(childC);
                timeline.push(`T7 (${Date.now() - startTime}ms): å­™å­äº‹ä»¶ C å·²åˆ›å»ºï¼ŒID = ${resultC.event.id.slice(-8)}`);

                // éªŒè¯å®Œæ•´æ ‘ç»“æ„
                const finalParent = await getEvent(parentId);
                const finalChildB = await getEvent(childBId);

                const html = `
                    <div class="timeline">
                        ${timeline.map(t => `<div class="timeline-item">${t}</div>`).join('')}
                    </div>
                    <h3 style="margin-top: 20px;">âœ… éªŒè¯ç»“æœ:</h3>
                    <pre>${JSON.stringify({
                        'çˆ¶äº‹ä»¶A': {
                            id: finalParent.id.slice(-8),
                            title: finalParent.title?.simpleTitle,
                            childEventIds: finalParent.childEventIds || []
                        },
                        'å­äº‹ä»¶B': {
                            id: finalChildB.id.slice(-8),
                            title: finalChildB.title?.simpleTitle,
                            parentEventId: finalChildB.parentEventId?.slice(-8),
                            childEventIds: finalChildB.childEventIds || []
                        },
                        'æµ‹è¯•ç»“è®º': hasChild ? 'PASS - Transient Buffer å·¥ä½œæ­£å¸¸' : 'FAIL - ç¼“å†²æœºåˆ¶å¤±æ•ˆ'
                    }, null, 2)}</pre>
                `;
                
                resultDiv.innerHTML = `<p><strong>æµ‹è¯•å®Œæˆ</strong> <span class="status ${hasChild ? 'success' : 'error'}">${hasChild ? 'PASS' : 'FAIL'}</span></p>${html}`;
            } catch (error) {
                resultDiv.innerHTML = `<p><strong>æµ‹è¯•å¤±è´¥</strong> <span class="status error">ERROR</span></p><pre>${error.message}\n${error.stack}</pre>`;
            }
        }

        // æµ‹è¯•2: å¹¶å‘æ›´æ–°
        async function testConcurrentUpdates() {
            const resultDiv = document.getElementById('result2');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p><strong>æµ‹è¯•è¿›è¡Œä¸­...</strong></p>';
            
            try {
                // åˆ›å»ºçˆ¶äº‹ä»¶
                const parentId = `event_test_parent_${Date.now()}`;
                
                // æ¨¡æ‹ŸåŒæ—¶åˆ›å»º 3 ä¸ªå­äº‹ä»¶
                const children = ['A', 'B', 'C'].map(name => ({
                    id: `event_test_child_${name}_${Date.now()}`,
                    parentEventId: parentId,
                    title: { simpleTitle: `å­äº‹ä»¶${name}` }
                }));
                
                // å¹¶å‘åˆ›å»ºï¼ˆæµ‹è¯•ç¼“å†²åŒºå¹¶å‘å®‰å…¨ï¼‰
                await Promise.all(children.map(child => 
                    fetch('/api/events', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(child)
                    })
                ));
                
                // éªŒè¯çˆ¶äº‹ä»¶åŒ…å«æ‰€æœ‰å­äº‹ä»¶
                await new Promise(r => setTimeout(r, 1000));
                const parent = await getEvent(parentId);
                
                const allIncluded = children.every(c => parent.childEventIds?.includes(c.id));
                
                resultDiv.innerHTML = `
                    <p><strong>æµ‹è¯•å®Œæˆ</strong> <span class="status ${allIncluded ? 'success' : 'error'}">${allIncluded ? 'PASS' : 'FAIL'}</span></p>
                    <pre>${JSON.stringify({
                        çˆ¶äº‹ä»¶: parentId.slice(-8),
                        é¢„æœŸå­äº‹ä»¶æ•°: 3,
                        å®é™…å­äº‹ä»¶æ•°: parent.childEventIds?.length || 0,
                        å®Œæ•´æ€§: allIncluded ? 'âœ… æ‰€æœ‰å­äº‹ä»¶éƒ½å·²å…³è”' : 'âŒ éƒ¨åˆ†å­äº‹ä»¶ä¸¢å¤±'
                    }, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p><strong>æµ‹è¯•å¤±è´¥</strong></p><pre>${error.message}</pre>`;
            }
        }

        // æµ‹è¯•3: ç¼“å†²åŒºç”Ÿå‘½å‘¨æœŸ
        async function testBufferLifecycle() {
            const resultDiv = document.getElementById('result3');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p><strong>æµ‹è¯•è¿›è¡Œä¸­...</strong></p>';
            
            const timeline = [];
            
            try {
                timeline.push('T0: åˆ›å»ºæµ‹è¯•äº‹ä»¶');
                const event = {
                    title: { simpleTitle: 'ç”Ÿå‘½å‘¨æœŸæµ‹è¯•' },
                    tags: []
                };
                
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(event)
                });
                const result = await response.json();
                const eventId = result.event.id;
                
                timeline.push(`T1: äº‹ä»¶å·²åˆ›å»ºï¼ŒID = ${eventId.slice(-8)}`);
                timeline.push('T2: ç­‰å¾… 1 ç§’ï¼Œç¡®ä¿æ•°æ®å·²è½ç›˜');
                
                await new Promise(r => setTimeout(r, 1000));
                
                timeline.push('T3: æŸ¥è¯¢äº‹ä»¶ï¼ˆæ­¤æ—¶åº”ä» DB è¯»å–ï¼Œä¸æ˜¯ç¼“å†²åŒºï¼‰');
                const dbEvent = await getEvent(eventId);
                
                timeline.push(`T4: ${dbEvent ? 'âœ… æˆåŠŸä» DB è¯»å–' : 'âŒ è¯»å–å¤±è´¥'}`);
                timeline.push('ç»“è®º: ç¼“å†²åŒºå·²åœ¨å†™å…¥åæ¸…é™¤ï¼ˆæ•°æ®ä¸åœ¨å†…å­˜ä¸­ï¼Œå¼ºåˆ¶ä» DB è¯»å–ï¼‰');
                
                resultDiv.innerHTML = `
                    <p><strong>æµ‹è¯•å®Œæˆ</strong> <span class="status success">PASS</span></p>
                    <div class="timeline">
                        ${timeline.map(t => `<div class="timeline-item">${t}</div>`).join('')}
                    </div>
                    <p style="margin-top: 15px; color: #28a745; font-weight: 600;">
                        âœ… ç¼“å†²åŒºç”Ÿå‘½å‘¨æœŸæ­£å¸¸ - "å­˜å®Œå³ç„š" æœºåˆ¶æœ‰æ•ˆ
                    </p>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p><strong>æµ‹è¯•å¤±è´¥</strong></p><pre>${error.message}</pre>`;
            }
        }

        // éªŒè¯ EventTree
        async function verifyEventTree() {
            const resultDiv = document.getElementById('result1');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p><strong>æ­£åœ¨éªŒè¯ EventTree...</strong></p>';
            
            try {
                const events = await getAllEvents();
                const testEvents = events.filter(e => 
                    e.title?.simpleTitle?.startsWith('æµ‹è¯•')
                );
                
                const tree = buildTree(testEvents);
                
                resultDiv.innerHTML = `
                    <p><strong>EventTree ç»“æ„</strong></p>
                    <pre>${JSON.stringify(tree, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p><strong>éªŒè¯å¤±è´¥</strong></p><pre>${error.message}</pre>`;
            }
        }

        function buildTree(events) {
            const map = {};
            events.forEach(e => {
                map[e.id] = {
                    id: e.id.slice(-8),
                    title: e.title?.simpleTitle,
                    level: e.bulletLevel,
                    children: []
                };
            });
            
            const roots = [];
            events.forEach(e => {
                if (e.parentEventId && map[e.parentEventId]) {
                    map[e.parentEventId].children.push(map[e.id]);
                } else {
                    roots.push(map[e.id]);
                }
            });
            
            return roots;
        }

        // æ¸…ç†æµ‹è¯•æ•°æ®
        async function cleanupTestData() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) return;
            
            try {
                const events = await getAllEvents();
                const testEvents = events.filter(e => 
                    e.title?.simpleTitle?.startsWith('æµ‹è¯•') || 
                    e.id.includes('test')
                );
                
                for (const event of testEvents) {
                    await fetch(`/api/events/${event.id}`, { method: 'DELETE' });
                }
                
                alert(`å·²åˆ é™¤ ${testEvents.length} ä¸ªæµ‹è¯•äº‹ä»¶`);
            } catch (error) {
                alert('æ¸…ç†å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
