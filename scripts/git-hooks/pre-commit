#!/usr/bin/env node
/**
 * Git Pre-commit Hook - SSOTæž¶æž„æ£€æŸ¥
 * 
 * åœ¨æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ä»£ç æ˜¯å¦ç¬¦åˆSSOTè§„èŒƒ
 * 
 * å®‰è£…æ–¹æ³•ï¼š
 *   npm run setup-git-hooks
 * 
 * æˆ–æ‰‹åŠ¨å¤åˆ¶åˆ° .git/hooks/pre-commit
 * 
 * @created 2026-01-09
 * @version 1.0.0
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// ANSIé¢œè‰²
const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
};

function log(color, ...args) {
  console.log(color, ...args, colors.reset);
}

function getStagedFiles() {
  try {
    const output = execSync('git diff --cached --name-only --diff-filter=ACM', {
      encoding: 'utf-8',
    });
    return output
      .trim()
      .split('\n')
      .filter(file => file.endsWith('.ts') || file.endsWith('.tsx'))
      .filter(file => !file.includes('__tests__') && !file.includes('.test.'));
  } catch (error) {
    return [];
  }
}

function checkDeprecatedFields(files) {
  const violations = [];
  
  const deprecatedPatterns = [
    { pattern: /\.isTask\b/, message: 'Use hasTaskFacet(event) instead of event.isTask' },
    { pattern: /\.isPlan\b/, message: 'Use shouldShowInPlan(event) instead of event.isPlan' },
    { pattern: /\.isTimeCalendar\b/, message: 'Use shouldShowInTimeCalendar(event) instead' },
    { pattern: /\.content\b(?!\s*[:=])/, message: 'Use resolveDisplayTitle(event) instead of event.content' },
    { pattern: /\.isTimer\b/, message: 'Use event.id.startsWith("timer-") instead' },
    { pattern: /\.isTimeLog\b/, message: 'Use event.source === "local:timelog" instead' },
    { pattern: /\.toISOString\(\)/, message: 'Use formatTimeForStorage() instead of toISOString()' },
    { pattern: /\.toJSON\(\)/, message: 'Use formatTimeForStorage() instead of toJSON()' },
  ];
  
  for (const file of files) {
    if (!fs.existsSync(file)) continue;
    
    const content = fs.readFileSync(file, 'utf-8');
    const lines = content.split('\n');
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      for (const { pattern, message } of deprecatedPatterns) {
        if (pattern.test(line)) {
          violations.push({
            file,
            line: i + 1,
            content: line.trim(),
            message,
          });
        }
      }
    }
  }
  
  return violations;
}

function checkForbiddenSignalFields(files) {
  const violations = [];
  
  const forbiddenFields = [
    'isHighlight',
    'hasQuestions',
    'signalCount',
    'importanceLevel',
    'isImportant',
    'hasDoubt',
    'needsAction',
  ];
  
  for (const file of files) {
    if (!fs.existsSync(file)) continue;
    
    const content = fs.readFileSync(file, 'utf-8');
    const lines = content.split('\n');
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      for (const field of forbiddenFields) {
        const pattern = new RegExp(`\\b${field}\\b`);
        if (pattern.test(line)) {
          violations.push({
            file,
            line: i + 1,
            content: line.trim(),
            message: `Forbidden Signal field: ${field}. Use SignalService instead.`,
          });
        }
      }
    }
  }
  
  return violations;
}

function checkISOTimeFormat(files) {
  const violations = [];
  
  // åŒ¹é…ISOæ—¶é—´æ ¼å¼çš„å­—ç¬¦ä¸²å­—é¢é‡
  const isoPattern = /['"`](\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[^'"`]*?)['"`]/g;
  
  for (const file of files) {
    if (!fs.existsSync(file)) continue;
    
    const content = fs.readFileSync(file, 'utf-8');
    const lines = content.split('\n');
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      if (isoPattern.test(line)) {
        violations.push({
          file,
          line: i + 1,
          content: line.trim(),
          message: 'ISO time format detected. Use local format (YYYY-MM-DD HH:mm:ss)',
        });
      }
    }
  }
  
  return violations;
}

function main() {
  log(colors.cyan, '\nðŸ” SSOTæž¶æž„æ£€æŸ¥ä¸­...\n');
  
  const stagedFiles = getStagedFiles();
  
  if (stagedFiles.length === 0) {
    log(colors.green, 'âœ… æ²¡æœ‰éœ€è¦æ£€æŸ¥çš„TypeScriptæ–‡ä»¶\n');
    process.exit(0);
  }
  
  log(colors.blue, `ðŸ“‚ æ£€æŸ¥ ${stagedFiles.length} ä¸ªæ–‡ä»¶...\n`);
  
  const deprecatedViolations = checkDeprecatedFields(stagedFiles);
  const signalViolations = checkForbiddenSignalFields(stagedFiles);
  const timeFormatViolations = checkISOTimeFormat(stagedFiles);
  
  const allViolations = [
    ...deprecatedViolations,
    ...signalViolations,
    ...timeFormatViolations,
  ];
  
  if (allViolations.length === 0) {
    log(colors.green, 'âœ… æ‰€æœ‰æ–‡ä»¶ç¬¦åˆSSOTè§„èŒƒï¼\n');
    process.exit(0);
  }
  
  // æŠ¥å‘Šè¿è§„
  log(colors.red, `\nâŒ å‘çŽ° ${allViolations.length} ä¸ªSSOTè¿è§„ï¼š\n`);
  
  for (const violation of allViolations) {
    log(colors.yellow, `  ${violation.file}:${violation.line}`);
    log(colors.reset, `    ${violation.content}`);
    log(colors.cyan, `    ðŸ’¡ ${violation.message}\n`);
  }
  
  log(colors.red, 'âŒ æäº¤è¢«é˜»æ­¢ã€‚è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åŽé‡è¯•ã€‚\n');
  log(colors.cyan, 'ðŸ’¡ æç¤ºï¼š');
  log(colors.reset, '   1. è¿è¡Œ node scripts/clean-deprecated-fields.js --fix è‡ªåŠ¨ä¿®å¤');
  log(colors.reset, '   2. å‚è€ƒ docs/SSOT_LINTER_README.md äº†è§£è¿ç§»æŒ‡å—');
  log(colors.reset, '   3. ä½¿ç”¨ git commit --no-verify è·³è¿‡æ£€æŸ¥ï¼ˆä¸æŽ¨èï¼‰\n');
  
  process.exit(1);
}

main();
