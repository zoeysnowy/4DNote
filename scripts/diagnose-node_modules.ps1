param(
  [string]$Root = (Resolve-Path "$PSScriptRoot\.."),
  [int]$Top = 30
)

$ErrorActionPreference = 'Stop'

$nm = Join-Path $Root 'node_modules'
if (-not (Test-Path -LiteralPath $nm)) {
  Write-Output "node_modules not found: $nm"
  exit 1
}

function Get-DirSizeBytes([string]$path) {
  try {
    (Get-ChildItem -LiteralPath $path -Recurse -File -Force -ErrorAction SilentlyContinue |
      Measure-Object -Property Length -Sum).Sum
  } catch {
    $null
  }
}

Write-Output "Root: $Root"
Write-Output "node_modules: $nm"
Write-Output "Counting files (streaming)..."

$fileCount = ([System.IO.Directory]::EnumerateFiles($nm, '*', [System.IO.SearchOption]::AllDirectories) | Measure-Object).Count
Write-Output "node_modules_files=$fileCount"

$bytesTotal = Get-DirSizeBytes $nm
Write-Output "node_modules_bytes=$bytesTotal"

Write-Output "\nTop folders by size under node_modules (may take a bit)..."

$children = Get-ChildItem -LiteralPath $nm -Directory -Force
$rows = foreach ($d in $children) {
  $b = Get-DirSizeBytes $d.FullName
  [pscustomobject]@{ name = $d.Name; bytes = $b }
}

$rows |
  Sort-Object bytes -Descending |
  Select-Object -First $Top |
  ForEach-Object {
    $mb = if ($_.bytes -ne $null) { [math]::Round($_.bytes / 1MB, 1) } else { $null }
    [pscustomobject]@{ name = $_.name; mb = $mb }
  } |
  Format-Table -AutoSize |
  Out-String |
  Write-Output

Write-Output "\nIf installs hang: run 'npm install --foreground-scripts --loglevel verbose' and paste the last ~40 lines." 
